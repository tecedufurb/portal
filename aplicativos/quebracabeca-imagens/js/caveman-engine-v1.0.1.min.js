var Prototype={Version:"1.6.0.2",Browser:{IE:!!(window.attachEvent&&!window.opera),Opera:!!window.opera,WebKit:navigator.userAgent.indexOf("AppleWebKit/")>-1,Gecko:navigator.userAgent.indexOf("Gecko")>-1&&navigator.userAgent.indexOf("KHTML")==-1,MobileSafari:!!navigator.userAgent.match(/Apple.*Mobile.*Safari/)},BrowserFeatures:{XPath:!!document.evaluate,ElementExtensions:!!window.HTMLElement,SpecificElementExtensions:document.createElement("div").__proto__&&document.createElement("div").__proto__!==document.createElement("form").__proto__},ScriptFragment:"<script[^>]*>([\\S\\s]*?)</script>",JSONFilter:/^\/\*-secure-([\s\S]*)\*\/\s*$/,emptyFunction:function(){},K:function(x){return x}};if(Prototype.Browser.MobileSafari)Prototype.BrowserFeatures.SpecificElementExtensions=false;var Class={create:function(){var parent=null,properties=$A(arguments);if(Object.isFunction(properties[0]))parent=properties.shift();function klass(){this.initialize.apply(this,arguments)}Object.extend(klass,Class.Methods);klass.superclass=parent;klass.subclasses=[];if(parent){var subclass=function(){};subclass.prototype=parent.prototype;klass.prototype=new subclass;parent.subclasses.push(klass)}for(var i=0;i<properties.length;i++)klass.addMethods(properties[i]);if(!klass.prototype.initialize)klass.prototype.initialize=Prototype.emptyFunction;klass.prototype.constructor=klass;return klass}};Class.Methods={addMethods:function(source){var ancestor=this.superclass&&this.superclass.prototype;var properties=Object.keys(source);if(!Object.keys({toString:true}).length)properties.push("toString","valueOf");for(var i=0,length=properties.length;i<length;i++){var property=properties[i],value=source[property];if(ancestor&&Object.isFunction(value)&&value.argumentNames().first()=="$super"){var method=value,value=Object.extend(function(m){return function(){return ancestor[m].apply(this,arguments)}}(property).wrap(method),{valueOf:function(){return method},toString:function(){return method.toString()}})}this.prototype[property]=value}return this}};var Abstract={};Object.extend=function(destination,source){for(var property in source)destination[property]=source[property];return destination};Object.extend(Object,{inspect:function(object){try{if(Object.isUndefined(object))return"undefined";if(object===null)return"null";return object.inspect?object.inspect():String(object)}catch(e){if(e instanceof RangeError)return"...";throw e}},toJSON:function(object){var type=typeof object;switch(type){case"undefined":case"function":case"unknown":return;case"boolean":return object.toString()}if(object===null)return"null";if(object.toJSON)return object.toJSON();if(Object.isElement(object))return;var results=[];for(var property in object){var value=Object.toJSON(object[property]);if(!Object.isUndefined(value))results.push(property.toJSON()+": "+value)}return"{"+results.join(", ")+"}"},toQueryString:function(object){return $H(object).toQueryString()},toHTML:function(object){return object&&object.toHTML?object.toHTML():String.interpret(object)},keys:function(object){var keys=[];for(var property in object)keys.push(property);return keys},values:function(object){var values=[];for(var property in object)values.push(object[property]);return values},clone:function(object){return Object.extend({},object)},isElement:function(object){return object&&object.nodeType==1},isArray:function(object){return object!=null&&typeof object=="object"&&"splice"in object&&"join"in object},isHash:function(object){return object instanceof Hash},isFunction:function(object){return typeof object=="function"},isString:function(object){return typeof object=="string"},isNumber:function(object){return typeof object=="number"},isUndefined:function(object){return typeof object=="undefined"}});Object.extend(Function.prototype,{argumentNames:function(){var names=this.toString().match(/^[\s\(]*function[^(]*\((.*?)\)/)[1].split(",").invoke("strip");return names.length==1&&!names[0]?[]:names},bind:function(){if(arguments.length<2&&Object.isUndefined(arguments[0]))return this;var __method=this,args=$A(arguments),object=args.shift();return function(){return __method.apply(object,args.concat($A(arguments)))}},bindAsEventListener:function(){var __method=this,args=$A(arguments),object=args.shift();return function(event){return __method.apply(object,[event||window.event].concat(args))}},curry:function(){if(!arguments.length)return this;var __method=this,args=$A(arguments);return function(){return __method.apply(this,args.concat($A(arguments)))}},delay:function(){var __method=this,args=$A(arguments),timeout=args.shift()*1e3;return window.setTimeout(function(){return __method.apply(__method,args)},timeout)},wrap:function(wrapper){var __method=this;return function(){return wrapper.apply(this,[__method.bind(this)].concat($A(arguments)))}},methodize:function(){if(this._methodized)return this._methodized;var __method=this;return this._methodized=function(){return __method.apply(null,[this].concat($A(arguments)))}}});Function.prototype.defer=Function.prototype.delay.curry(.01);Date.prototype.toJSON=function(){return'"'+this.getUTCFullYear()+"-"+(this.getUTCMonth()+1).toPaddedString(2)+"-"+this.getUTCDate().toPaddedString(2)+"T"+this.getUTCHours().toPaddedString(2)+":"+this.getUTCMinutes().toPaddedString(2)+":"+this.getUTCSeconds().toPaddedString(2)+'Z"'};var Try={these:function(){var returnValue;for(var i=0,length=arguments.length;i<length;i++){var lambda=arguments[i];try{returnValue=lambda();break}catch(e){}}return returnValue}};RegExp.prototype.match=RegExp.prototype.test;RegExp.escape=function(str){return String(str).replace(/([.*+?^=!:${}()|[\]\/\\])/g,"\\$1")};var PeriodicalExecuter=Class.create({initialize:function(callback,frequency){this.callback=callback;this.frequency=frequency;this.currentlyExecuting=false;this.registerCallback()},registerCallback:function(){this.timer=setInterval(this.onTimerEvent.bind(this),this.frequency*1e3)},execute:function(){this.callback(this)},stop:function(){if(!this.timer)return;clearInterval(this.timer);this.timer=null},onTimerEvent:function(){if(!this.currentlyExecuting){try{this.currentlyExecuting=true;this.execute()}finally{this.currentlyExecuting=false}}}});Object.extend(String,{interpret:function(value){return value==null?"":String(value)},specialChar:{"\b":"\\b","	":"\\t","\n":"\\n","\f":"\\f","\r":"\\r","\\":"\\\\"}});Object.extend(String.prototype,{gsub:function(pattern,replacement){var result="",source=this,match;replacement=arguments.callee.prepareReplacement(replacement);while(source.length>0){if(match=source.match(pattern)){result+=source.slice(0,match.index);result+=String.interpret(replacement(match));source=source.slice(match.index+match[0].length)}else{result+=source,source=""}}return result},sub:function(pattern,replacement,count){replacement=this.gsub.prepareReplacement(replacement);count=Object.isUndefined(count)?1:count;return this.gsub(pattern,function(match){if(--count<0)return match[0];return replacement(match)})},scan:function(pattern,iterator){this.gsub(pattern,iterator);return String(this)},truncate:function(length,truncation){length=length||30;truncation=Object.isUndefined(truncation)?"...":truncation;return this.length>length?this.slice(0,length-truncation.length)+truncation:String(this)},strip:function(){return this.replace(/^\s+/,"").replace(/\s+$/,"")},stripTags:function(){return this.replace(/<\/?[^>]+>/gi,"")},stripScripts:function(){return this.replace(new RegExp(Prototype.ScriptFragment,"img"),"")},extractScripts:function(){var matchAll=new RegExp(Prototype.ScriptFragment,"img");var matchOne=new RegExp(Prototype.ScriptFragment,"im");return(this.match(matchAll)||[]).map(function(scriptTag){return(scriptTag.match(matchOne)||["",""])[1]})},evalScripts:function(){return this.extractScripts().map(function(script){return eval(script)})},escapeHTML:function(){var self=arguments.callee;self.text.data=this;return self.div.innerHTML},unescapeHTML:function(){var div=new Element("div");div.innerHTML=this.stripTags();return div.childNodes[0]?div.childNodes.length>1?$A(div.childNodes).inject("",function(memo,node){return memo+node.nodeValue}):div.childNodes[0].nodeValue:""},toQueryParams:function(separator){var match=this.strip().match(/([^?#]*)(#.*)?$/);if(!match)return{};return match[1].split(separator||"&").inject({},function(hash,pair){if((pair=pair.split("="))[0]){var key=decodeURIComponent(pair.shift());var value=pair.length>1?pair.join("="):pair[0];if(value!=undefined)value=decodeURIComponent(value);if(key in hash){if(!Object.isArray(hash[key]))hash[key]=[hash[key]];hash[key].push(value)}else hash[key]=value}return hash})},toArray:function(){return this.split("")},succ:function(){return this.slice(0,this.length-1)+String.fromCharCode(this.charCodeAt(this.length-1)+1)},times:function(count){return count<1?"":new Array(count+1).join(this)},camelize:function(){var parts=this.split("-"),len=parts.length;if(len==1)return parts[0];var camelized=this.charAt(0)=="-"?parts[0].charAt(0).toUpperCase()+parts[0].substring(1):parts[0];for(var i=1;i<len;i++)camelized+=parts[i].charAt(0).toUpperCase()+parts[i].substring(1);return camelized},capitalize:function(){return this.charAt(0).toUpperCase()+this.substring(1).toLowerCase()},underscore:function(){return this.gsub(/::/,"/").gsub(/([A-Z]+)([A-Z][a-z])/,"#{1}_#{2}").gsub(/([a-z\d])([A-Z])/,"#{1}_#{2}").gsub(/-/,"_").toLowerCase()},dasherize:function(){return this.gsub(/_/,"-")},inspect:function(useDoubleQuotes){var escapedString=this.gsub(/[\x00-\x1f\\]/,function(match){var character=String.specialChar[match[0]];return character?character:"\\u00"+match[0].charCodeAt().toPaddedString(2,16)});if(useDoubleQuotes)return'"'+escapedString.replace(/"/g,'\\"')+'"';return"'"+escapedString.replace(/'/g,"\\'")+"'"},toJSON:function(){return this.inspect(true)},unfilterJSON:function(filter){return this.sub(filter||Prototype.JSONFilter,"#{1}")},isJSON:function(){var str=this;if(str.blank())return false;str=this.replace(/\\./g,"@").replace(/"[^"\\\n\r]*"/g,"");return/^[,:{}\[\]0-9.\-+Eaeflnr-u \n\r\t]*$/.test(str)},evalJSON:function(sanitize){var json=this.unfilterJSON();try{if(!sanitize||json.isJSON())return eval("("+json+")")}catch(e){}throw new SyntaxError("Badly formed JSON string: "+this.inspect())},include:function(pattern){return this.indexOf(pattern)>-1},startsWith:function(pattern){return this.indexOf(pattern)===0},endsWith:function(pattern){var d=this.length-pattern.length;return d>=0&&this.lastIndexOf(pattern)===d},empty:function(){return this==""},blank:function(){return/^\s*$/.test(this)},interpolate:function(object,pattern){return new Template(this,pattern).evaluate(object)}});if(Prototype.Browser.WebKit||Prototype.Browser.IE)Object.extend(String.prototype,{escapeHTML:function(){return this.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")},unescapeHTML:function(){return this.replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">")}});String.prototype.gsub.prepareReplacement=function(replacement){if(Object.isFunction(replacement))return replacement;var template=new Template(replacement);return function(match){return template.evaluate(match)}};String.prototype.parseQuery=String.prototype.toQueryParams;Object.extend(String.prototype.escapeHTML,{div:document.createElement("div"),text:document.createTextNode("")});with(String.prototype.escapeHTML)div.appendChild(text);var Template=Class.create({initialize:function(template,pattern){this.template=template.toString();this.pattern=pattern||Template.Pattern},evaluate:function(object){if(Object.isFunction(object.toTemplateReplacements))object=object.toTemplateReplacements();return this.template.gsub(this.pattern,function(match){if(object==null)return"";var before=match[1]||"";if(before=="\\")return match[2];var ctx=object,expr=match[3];var pattern=/^([^.[]+|\[((?:.*?[^\\])?)\])(\.|\[|$)/;match=pattern.exec(expr);if(match==null)return before;while(match!=null){var comp=match[1].startsWith("[")?match[2].gsub("\\\\]","]"):match[1];ctx=ctx[comp];if(null==ctx||""==match[3])break;expr=expr.substring("["==match[3]?match[1].length:match[0].length);match=pattern.exec(expr)}return before+String.interpret(ctx)})}});Template.Pattern=/(^|.|\r|\n)(#\{(.*?)\})/;var $break={};var Enumerable={each:function(iterator,context){var index=0;iterator=iterator.bind(context);try{this._each(function(value){iterator(value,index++)})}catch(e){if(e!=$break)throw e}return this},eachSlice:function(number,iterator,context){iterator=iterator?iterator.bind(context):Prototype.K;var index=-number,slices=[],array=this.toArray();while((index+=number)<array.length)slices.push(array.slice(index,index+number));return slices.collect(iterator,context)},all:function(iterator,context){iterator=iterator?iterator.bind(context):Prototype.K;var result=true;this.each(function(value,index){result=result&&!!iterator(value,index);if(!result)throw $break});return result},any:function(iterator,context){iterator=iterator?iterator.bind(context):Prototype.K;var result=false;this.each(function(value,index){if(result=!!iterator(value,index))throw $break});return result},collect:function(iterator,context){iterator=iterator?iterator.bind(context):Prototype.K;var results=[];this.each(function(value,index){results.push(iterator(value,index))});return results},detect:function(iterator,context){iterator=iterator.bind(context);var result;this.each(function(value,index){if(iterator(value,index)){result=value;throw $break}});return result},findAll:function(iterator,context){iterator=iterator.bind(context);var results=[];this.each(function(value,index){if(iterator(value,index))results.push(value)});return results},grep:function(filter,iterator,context){iterator=iterator?iterator.bind(context):Prototype.K;var results=[];if(Object.isString(filter))filter=new RegExp(filter);this.each(function(value,index){if(filter.match(value))results.push(iterator(value,index))});return results},include:function(object){if(Object.isFunction(this.indexOf))if(this.indexOf(object)!=-1)return true;var found=false;this.each(function(value){if(value==object){found=true;throw $break}});return found},inGroupsOf:function(number,fillWith){fillWith=Object.isUndefined(fillWith)?null:fillWith;return this.eachSlice(number,function(slice){while(slice.length<number)slice.push(fillWith);return slice})},inject:function(memo,iterator,context){iterator=iterator.bind(context);this.each(function(value,index){memo=iterator(memo,value,index)});return memo},invoke:function(method){var args=$A(arguments).slice(1);return this.map(function(value){return value[method].apply(value,args)})},max:function(iterator,context){iterator=iterator?iterator.bind(context):Prototype.K;var result;this.each(function(value,index){value=iterator(value,index);if(result==null||value>=result)result=value});return result},min:function(iterator,context){iterator=iterator?iterator.bind(context):Prototype.K;var result;this.each(function(value,index){value=iterator(value,index);if(result==null||value<result)result=value});return result},partition:function(iterator,context){iterator=iterator?iterator.bind(context):Prototype.K;var trues=[],falses=[];this.each(function(value,index){(iterator(value,index)?trues:falses).push(value)});return[trues,falses]},pluck:function(property){var results=[];this.each(function(value){results.push(value[property])});return results},reject:function(iterator,context){iterator=iterator.bind(context);var results=[];this.each(function(value,index){if(!iterator(value,index))results.push(value)});return results},sortBy:function(iterator,context){iterator=iterator.bind(context);return this.map(function(value,index){return{value:value,criteria:iterator(value,index)}}).sort(function(left,right){var a=left.criteria,b=right.criteria;return a<b?-1:a>b?1:0}).pluck("value")},toArray:function(){return this.map()},zip:function(){var iterator=Prototype.K,args=$A(arguments);if(Object.isFunction(args.last()))iterator=args.pop();var collections=[this].concat(args).map($A);return this.map(function(value,index){return iterator(collections.pluck(index))})},size:function(){return this.toArray().length},inspect:function(){return"#<Enumerable:"+this.toArray().inspect()+">"}};Object.extend(Enumerable,{map:Enumerable.collect,find:Enumerable.detect,select:Enumerable.findAll,filter:Enumerable.findAll,member:Enumerable.include,entries:Enumerable.toArray,every:Enumerable.all,some:Enumerable.any});function $A(iterable){if(!iterable)return[];if(iterable.toArray)return iterable.toArray();var length=iterable.length||0,results=new Array(length);while(length--)results[length]=iterable[length];return results}if(Prototype.Browser.WebKit){$A=function(iterable){if(!iterable)return[];if(!(Object.isFunction(iterable)&&iterable=="[object NodeList]")&&iterable.toArray)return iterable.toArray();var length=iterable.length||0,results=new Array(length);while(length--)results[length]=iterable[length];return results}}Array.from=$A;Object.extend(Array.prototype,Enumerable);if(!Array.prototype._reverse)Array.prototype._reverse=Array.prototype.reverse;Object.extend(Array.prototype,{_each:function(iterator){for(var i=0,length=this.length;i<length;i++)iterator(this[i])},clear:function(){this.length=0;return this},first:function(){return this[0]},last:function(){return this[this.length-1]},compact:function(){return this.select(function(value){return value!=null})},flatten:function(){return this.inject([],function(array,value){return array.concat(Object.isArray(value)?value.flatten():[value])})},without:function(){var values=$A(arguments);return this.select(function(value){return!values.include(value)})},reverse:function(inline){return(inline!==false?this:this.toArray())._reverse()},reduce:function(){return this.length>1?this:this[0]},uniq:function(sorted){return this.inject([],function(array,value,index){if(0==index||(sorted?array.last()!=value:!array.include(value)))array.push(value);return array})},intersect:function(array){return this.uniq().findAll(function(item){return array.detect(function(value){return item===value})})},clone:function(){return[].concat(this)},size:function(){return this.length},inspect:function(){return"["+this.map(Object.inspect).join(", ")+"]"},toJSON:function(){var results=[];this.each(function(object){var value=Object.toJSON(object);if(!Object.isUndefined(value))results.push(value)});return"["+results.join(", ")+"]"}});if(Object.isFunction(Array.prototype.forEach))Array.prototype._each=Array.prototype.forEach;if(!Array.prototype.indexOf)Array.prototype.indexOf=function(item,i){i||(i=0);var length=this.length;if(i<0)i=length+i;for(;i<length;i++)if(this[i]===item)return i;return-1};if(!Array.prototype.lastIndexOf)Array.prototype.lastIndexOf=function(item,i){i=isNaN(i)?this.length:(i<0?this.length+i:i)+1;var n=this.slice(0,i).reverse().indexOf(item);return n<0?n:i-n-1};Array.prototype.toArray=Array.prototype.clone;function $w(string){if(!Object.isString(string))return[];string=string.strip();return string?string.split(/\s+/):[]}if(Prototype.Browser.Opera){Array.prototype.concat=function(){var array=[];for(var i=0,length=this.length;i<length;i++)array.push(this[i]);for(var i=0,length=arguments.length;i<length;i++){if(Object.isArray(arguments[i])){for(var j=0,arrayLength=arguments[i].length;j<arrayLength;j++)array.push(arguments[i][j])}else{array.push(arguments[i])}}return array}}Object.extend(Number.prototype,{toColorPart:function(){return this.toPaddedString(2,16)},succ:function(){return this+1},times:function(iterator){$R(0,this,true).each(iterator);return this},toPaddedString:function(length,radix){var string=this.toString(radix||10);return"0".times(length-string.length)+string},toJSON:function(){return isFinite(this)?this.toString():"null"}});$w("abs round ceil floor").each(function(method){Number.prototype[method]=Math[method].methodize()});function $H(object){return new Hash(object)}var Hash=Class.create(Enumerable,function(){function toQueryPair(key,value){if(Object.isUndefined(value))return key;return key+"="+encodeURIComponent(String.interpret(value))}return{initialize:function(object){this._object=Object.isHash(object)?object.toObject():Object.clone(object)},_each:function(iterator){for(var key in this._object){var value=this._object[key],pair=[key,value];pair.key=key;pair.value=value;iterator(pair)}},set:function(key,value){return this._object[key]=value},get:function(key){return this._object[key]},unset:function(key){var value=this._object[key];delete this._object[key];return value},toObject:function(){return Object.clone(this._object)},keys:function(){return this.pluck("key")},values:function(){return this.pluck("value")},index:function(value){var match=this.detect(function(pair){return pair.value===value});return match&&match.key},merge:function(object){return this.clone().update(object)},update:function(object){return new Hash(object).inject(this,function(result,pair){result.set(pair.key,pair.value);return result})},toQueryString:function(){return this.map(function(pair){var key=encodeURIComponent(pair.key),values=pair.value;if(values&&typeof values=="object"){if(Object.isArray(values))return values.map(toQueryPair.curry(key)).join("&")}return toQueryPair(key,values)}).join("&")},inspect:function(){return"#<Hash:{"+this.map(function(pair){return pair.map(Object.inspect).join(": ")}).join(", ")+"}>"},toJSON:function(){return Object.toJSON(this.toObject())},clone:function(){return new Hash(this)}}}());Hash.prototype.toTemplateReplacements=Hash.prototype.toObject;Hash.from=$H;var ObjectRange=Class.create(Enumerable,{initialize:function(start,end,exclusive){this.start=start;this.end=end;this.exclusive=exclusive},_each:function(iterator){var value=this.start;while(this.include(value)){iterator(value);value=value.succ()}},include:function(value){if(value<this.start)return false;if(this.exclusive)return value<this.end;return value<=this.end}});var $R=function(start,end,exclusive){return new ObjectRange(start,end,exclusive)};var Ajax={getTransport:function(){return Try.these(function(){return new XMLHttpRequest},function(){return new ActiveXObject("Msxml2.XMLHTTP")},function(){return new ActiveXObject("Microsoft.XMLHTTP")})||false},activeRequestCount:0};Ajax.Responders={responders:[],_each:function(iterator){this.responders._each(iterator)},register:function(responder){if(!this.include(responder))this.responders.push(responder)},unregister:function(responder){this.responders=this.responders.without(responder)},dispatch:function(callback,request,transport,json){this.each(function(responder){if(Object.isFunction(responder[callback])){try{responder[callback].apply(responder,[request,transport,json])}catch(e){}}})}};Object.extend(Ajax.Responders,Enumerable);Ajax.Responders.register({onCreate:function(){Ajax.activeRequestCount++},onComplete:function(){Ajax.activeRequestCount--}});Ajax.Base=Class.create({initialize:function(options){this.options={method:"post",asynchronous:true,contentType:"application/x-www-form-urlencoded",encoding:"UTF-8",parameters:"",evalJSON:true,evalJS:true};Object.extend(this.options,options||{});this.options.method=this.options.method.toLowerCase();if(Object.isString(this.options.parameters))this.options.parameters=this.options.parameters.toQueryParams();else if(Object.isHash(this.options.parameters))this.options.parameters=this.options.parameters.toObject()}});Ajax.Request=Class.create(Ajax.Base,{_complete:false,initialize:function($super,url,options){$super(options);this.transport=Ajax.getTransport();this.request(url)},request:function(url){this.url=url;this.method=this.options.method;var params=Object.clone(this.options.parameters);if(!["get","post"].include(this.method)){params["_method"]=this.method;this.method="post"}this.parameters=params;if(params=Object.toQueryString(params)){if(this.method=="get")this.url+=(this.url.include("?")?"&":"?")+params;else if(/Konqueror|Safari|KHTML/.test(navigator.userAgent))params+="&_="}try{var response=new Ajax.Response(this);if(this.options.onCreate)this.options.onCreate(response);Ajax.Responders.dispatch("onCreate",this,response);this.transport.open(this.method.toUpperCase(),this.url,this.options.asynchronous);if(this.options.asynchronous)this.respondToReadyState.bind(this).defer(1);this.transport.onreadystatechange=this.onStateChange.bind(this);this.setRequestHeaders();this.body=this.method=="post"?this.options.postBody||params:null;this.transport.send(this.body);if(!this.options.asynchronous&&this.transport.overrideMimeType)this.onStateChange()}catch(e){this.dispatchException(e)}},onStateChange:function(){var readyState=this.transport.readyState;if(readyState>1&&!(readyState==4&&this._complete))this.respondToReadyState(this.transport.readyState)},setRequestHeaders:function(){var headers={"X-Requested-With":"XMLHttpRequest","X-Prototype-Version":Prototype.Version,Accept:"text/javascript, text/html, application/xml, text/xml, */*"};if(this.method=="post"){headers["Content-type"]=this.options.contentType+(this.options.encoding?"; charset="+this.options.encoding:"");if(this.transport.overrideMimeType&&(navigator.userAgent.match(/Gecko\/(\d{4})/)||[0,2005])[1]<2005)headers["Connection"]="close"}if(typeof this.options.requestHeaders=="object"){var extras=this.options.requestHeaders;if(Object.isFunction(extras.push))for(var i=0,length=extras.length;i<length;i+=2)headers[extras[i]]=extras[i+1];else $H(extras).each(function(pair){headers[pair.key]=pair.value})}for(var name in headers)this.transport.setRequestHeader(name,headers[name])},success:function(){var status=this.getStatus();return!status||status>=200&&status<300},getStatus:function(){try{return this.transport.status||0}catch(e){return 0}},respondToReadyState:function(readyState){var state=Ajax.Request.Events[readyState],response=new Ajax.Response(this);if(state=="Complete"){try{this._complete=true;(this.options["on"+response.status]||this.options["on"+(this.success()?"Success":"Failure")]||Prototype.emptyFunction)(response,response.headerJSON)}catch(e){this.dispatchException(e)}var contentType=response.getHeader("Content-type");if(this.options.evalJS=="force"||this.options.evalJS&&this.isSameOrigin()&&contentType&&contentType.match(/^\s*(text|application)\/(x-)?(java|ecma)script(;.*)?\s*$/i))this.evalResponse()}try{(this.options["on"+state]||Prototype.emptyFunction)(response,response.headerJSON);Ajax.Responders.dispatch("on"+state,this,response,response.headerJSON)}catch(e){this.dispatchException(e)}if(state=="Complete"){this.transport.onreadystatechange=Prototype.emptyFunction}},isSameOrigin:function(){var m=this.url.match(/^\s*https?:\/\/[^\/]*/);return!m||m[0]=="#{protocol}//#{domain}#{port}".interpolate({protocol:location.protocol,domain:document.domain,port:location.port?":"+location.port:""})},getHeader:function(name){try{return this.transport.getResponseHeader(name)||null}catch(e){return null}},evalResponse:function(){try{return eval((this.transport.responseText||"").unfilterJSON())}catch(e){this.dispatchException(e)}},dispatchException:function(exception){(this.options.onException||Prototype.emptyFunction)(this,exception);Ajax.Responders.dispatch("onException",this,exception)}});Ajax.Request.Events=["Uninitialized","Loading","Loaded","Interactive","Complete"];Ajax.Response=Class.create({initialize:function(request){this.request=request;var transport=this.transport=request.transport,readyState=this.readyState=transport.readyState;if(readyState>2&&!Prototype.Browser.IE||readyState==4){this.status=this.getStatus();this.statusText=this.getStatusText();this.responseText=String.interpret(transport.responseText);this.headerJSON=this._getHeaderJSON()}if(readyState==4){var xml=transport.responseXML;this.responseXML=Object.isUndefined(xml)?null:xml;this.responseJSON=this._getResponseJSON()}},status:0,statusText:"",getStatus:Ajax.Request.prototype.getStatus,getStatusText:function(){try{return this.transport.statusText||""}catch(e){return""}},getHeader:Ajax.Request.prototype.getHeader,getAllHeaders:function(){try{return this.getAllResponseHeaders()}catch(e){return null}},getResponseHeader:function(name){return this.transport.getResponseHeader(name)},getAllResponseHeaders:function(){return this.transport.getAllResponseHeaders()},_getHeaderJSON:function(){var json=this.getHeader("X-JSON");if(!json)return null;json=decodeURIComponent(escape(json));try{return json.evalJSON(this.request.options.sanitizeJSON||!this.request.isSameOrigin())}catch(e){this.request.dispatchException(e)}},_getResponseJSON:function(){var options=this.request.options;if(!options.evalJSON||options.evalJSON!="force"&&!(this.getHeader("Content-type")||"").include("application/json")||this.responseText.blank())return null;try{return this.responseText.evalJSON(options.sanitizeJSON||!this.request.isSameOrigin())}catch(e){this.request.dispatchException(e)}}});Ajax.Updater=Class.create(Ajax.Request,{initialize:function($super,container,url,options){this.container={success:container.success||container,failure:container.failure||(container.success?null:container)};options=Object.clone(options);var onComplete=options.onComplete;options.onComplete=function(response,json){this.updateContent(response.responseText);if(Object.isFunction(onComplete))onComplete(response,json)}.bind(this);$super(url,options)},updateContent:function(responseText){var receiver=this.container[this.success()?"success":"failure"],options=this.options;if(!options.evalScripts)responseText=responseText.stripScripts();if(receiver=$$$(receiver)){if(options.insertion){if(Object.isString(options.insertion)){var insertion={};insertion[options.insertion]=responseText;receiver.insert(insertion)}else options.insertion(receiver,responseText)}else receiver.update(responseText)}}});Ajax.PeriodicalUpdater=Class.create(Ajax.Base,{initialize:function($super,container,url,options){$super(options);this.onComplete=this.options.onComplete;this.frequency=this.options.frequency||2;this.decay=this.options.decay||1;this.updater={};this.container=container;this.url=url;this.start()},start:function(){this.options.onComplete=this.updateComplete.bind(this);this.onTimerEvent()},stop:function(){this.updater.options.onComplete=undefined;clearTimeout(this.timer);(this.onComplete||Prototype.emptyFunction).apply(this,arguments)},updateComplete:function(response){if(this.options.decay){this.decay=response.responseText==this.lastText?this.decay*this.options.decay:1;this.lastText=response.responseText}this.timer=this.onTimerEvent.bind(this).delay(this.decay*this.frequency)},onTimerEvent:function(){this.updater=new Ajax.Updater(this.container,this.url,this.options)}});function $$$(element){if(arguments.length>1){for(var i=0,elements=[],length=arguments.length;i<length;i++)elements.push($$$(arguments[i]));return elements}if(Object.isString(element))element=document.getElementById(element);return Element.extend(element)}if(Prototype.BrowserFeatures.XPath){document._getElementsByXPath=function(expression,parentElement){var results=[];var query=document.evaluate(expression,$$$(parentElement)||document,null,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null);for(var i=0,length=query.snapshotLength;i<length;i++)results.push(Element.extend(query.snapshotItem(i)));return results}}if(!window.Node)var Node={};if(!Node.ELEMENT_NODE){Object.extend(Node,{ELEMENT_NODE:1,ATTRIBUTE_NODE:2,TEXT_NODE:3,CDATA_SECTION_NODE:4,ENTITY_REFERENCE_NODE:5,ENTITY_NODE:6,PROCESSING_INSTRUCTION_NODE:7,COMMENT_NODE:8,DOCUMENT_NODE:9,DOCUMENT_TYPE_NODE:10,DOCUMENT_FRAGMENT_NODE:11,NOTATION_NODE:12})}(function(){var element=this.Element;this.Element=function(tagName,attributes){attributes=attributes||{};tagName=tagName.toLowerCase();var cache=Element.cache;if(Prototype.Browser.IE&&attributes.name){tagName="<"+tagName+' name="'+attributes.name+'">';delete attributes.name;return Element.writeAttribute(document.createElement(tagName),attributes)}if(!cache[tagName])cache[tagName]=Element.extend(document.createElement(tagName));return Element.writeAttribute(cache[tagName].cloneNode(false),attributes)};Object.extend(this.Element,element||{})
}).call(window);Element.cache={};Element.Methods={visible:function(element){return $$$(element).style.display!="none"},toggle:function(element){element=$$$(element);Element[Element.visible(element)?"hide":"show"](element);return element},hide:function(element){$$$(element).style.display="none";return element},show:function(element){$$$(element).style.display="";return element},remove:function(element){element=$$$(element);element.parentNode.removeChild(element);return element},update:function(element,content){element=$$$(element);if(content&&content.toElement)content=content.toElement();if(Object.isElement(content))return element.update().insert(content);content=Object.toHTML(content);element.innerHTML=content.stripScripts();content.evalScripts.bind(content).defer();return element},replace:function(element,content){element=$$$(element);if(content&&content.toElement)content=content.toElement();else if(!Object.isElement(content)){content=Object.toHTML(content);var range=element.ownerDocument.createRange();range.selectNode(element);content.evalScripts.bind(content).defer();content=range.createContextualFragment(content.stripScripts())}element.parentNode.replaceChild(content,element);return element},insert:function(element,insertions){element=$$$(element);if(Object.isString(insertions)||Object.isNumber(insertions)||Object.isElement(insertions)||insertions&&(insertions.toElement||insertions.toHTML))insertions={bottom:insertions};var content,insert,tagName,childNodes;for(var position in insertions){content=insertions[position];position=position.toLowerCase();insert=Element._insertionTranslations[position];if(content&&content.toElement)content=content.toElement();if(Object.isElement(content)){insert(element,content);continue}content=Object.toHTML(content);tagName=(position=="before"||position=="after"?element.parentNode:element).tagName.toUpperCase();childNodes=Element._getContentFromAnonymousElement(tagName,content.stripScripts());if(position=="top"||position=="after")childNodes.reverse();childNodes.each(insert.curry(element));content.evalScripts.bind(content).defer()}return element},wrap:function(element,wrapper,attributes){element=$$$(element);if(Object.isElement(wrapper))$$$(wrapper).writeAttribute(attributes||{});else if(Object.isString(wrapper))wrapper=new Element(wrapper,attributes);else wrapper=new Element("div",wrapper);if(element.parentNode)element.parentNode.replaceChild(wrapper,element);wrapper.appendChild(element);return wrapper},inspect:function(element){element=$$$(element);var result="<"+element.tagName.toLowerCase();$H({id:"id",className:"class"}).each(function(pair){var property=pair.first(),attribute=pair.last();var value=(element[property]||"").toString();if(value)result+=" "+attribute+"="+value.inspect(true)});return result+">"},recursivelyCollect:function(element,property){element=$$$(element);var elements=[];while(element=element[property])if(element.nodeType==1)elements.push(Element.extend(element));return elements},ancestors:function(element){return $$$(element).recursivelyCollect("parentNode")},descendants:function(element){return $$$(element).select("*")},firstDescendant:function(element){element=$$$(element).firstChild;while(element&&element.nodeType!=1)element=element.nextSibling;return $$$(element)},immediateDescendants:function(element){if(!(element=$$$(element).firstChild))return[];while(element&&element.nodeType!=1)element=element.nextSibling;if(element)return[element].concat($$$(element).nextSiblings());return[]},previousSiblings:function(element){return $$$(element).recursivelyCollect("previousSibling")},nextSiblings:function(element){return $$$(element).recursivelyCollect("nextSibling")},siblings:function(element){element=$$$(element);return element.previousSiblings().reverse().concat(element.nextSiblings())},match:function(element,selector){if(Object.isString(selector))selector=new Selector(selector);return selector.match($$$(element))},up:function(element,expression,index){element=$$$(element);if(arguments.length==1)return $$$(element.parentNode);var ancestors=element.ancestors();return Object.isNumber(expression)?ancestors[expression]:Selector.findElement(ancestors,expression,index)},down:function(element,expression,index){element=$$$(element);if(arguments.length==1)return element.firstDescendant();return Object.isNumber(expression)?element.descendants()[expression]:element.select(expression)[index||0]},previous:function(element,expression,index){element=$$$(element);if(arguments.length==1)return $$$(Selector.handlers.previousElementSibling(element));var previousSiblings=element.previousSiblings();return Object.isNumber(expression)?previousSiblings[expression]:Selector.findElement(previousSiblings,expression,index)},next:function(element,expression,index){element=$$$(element);if(arguments.length==1)return $$$(Selector.handlers.nextElementSibling(element));var nextSiblings=element.nextSiblings();return Object.isNumber(expression)?nextSiblings[expression]:Selector.findElement(nextSiblings,expression,index)},select:function(){var args=$A(arguments),element=$$$(args.shift());return Selector.findChildElements(element,args)},adjacent:function(){var args=$A(arguments),element=$$$(args.shift());return Selector.findChildElements(element.parentNode,args).without(element)},identify:function(element){element=$$$(element);var id=element.readAttribute("id"),self=arguments.callee;if(id)return id;do{id="anonymous_element_"+self.counter++}while($$$(id));element.writeAttribute("id",id);return id},readAttribute:function(element,name){element=$$$(element);if(Prototype.Browser.IE){var t=Element._attributeTranslations.read;if(t.values[name])return t.values[name](element,name);if(t.names[name])name=t.names[name];if(name.include(":")){return!element.attributes||!element.attributes[name]?null:element.attributes[name].value}}return element.getAttribute(name)},writeAttribute:function(element,name,value){element=$$$(element);var attributes={},t=Element._attributeTranslations.write;if(typeof name=="object")attributes=name;else attributes[name]=Object.isUndefined(value)?true:value;for(var attr in attributes){name=t.names[attr]||attr;value=attributes[attr];if(t.values[attr])name=t.values[attr](element,value);if(value===false||value===null)element.removeAttribute(name);else if(value===true)element.setAttribute(name,name);else element.setAttribute(name,value)}return element},getHeight:function(element){return $$$(element).getDimensions().height},getWidth:function(element){return $$$(element).getDimensions().width},classNames:function(element){return new Element.ClassNames(element)},hasClassName:function(element,className){if(!(element=$$$(element)))return;var elementClassName=element.className;return elementClassName.length>0&&(elementClassName==className||new RegExp("(^|\\s)"+className+"(\\s|$)").test(elementClassName))},addClassName:function(element,className){if(!(element=$$$(element)))return;if(!element.hasClassName(className))element.className+=(element.className?" ":"")+className;return element},removeClassName:function(element,className){if(!(element=$$$(element)))return;element.className=element.className.replace(new RegExp("(^|\\s+)"+className+"(\\s+|$)")," ").strip();return element},toggleClassName:function(element,className){if(!(element=$$$(element)))return;return element[element.hasClassName(className)?"removeClassName":"addClassName"](className)},cleanWhitespace:function(element){element=$$$(element);var node=element.firstChild;while(node){var nextNode=node.nextSibling;if(node.nodeType==3&&!/\S/.test(node.nodeValue))element.removeChild(node);node=nextNode}return element},empty:function(element){return $$$(element).innerHTML.blank()},descendantOf:function(element,ancestor){element=$$$(element),ancestor=$$$(ancestor);var originalAncestor=ancestor;if(element.compareDocumentPosition)return(element.compareDocumentPosition(ancestor)&8)===8;if(element.sourceIndex&&!Prototype.Browser.Opera){var e=element.sourceIndex,a=ancestor.sourceIndex,nextAncestor=ancestor.nextSibling;if(!nextAncestor){do{ancestor=ancestor.parentNode}while(!(nextAncestor=ancestor.nextSibling)&&ancestor.parentNode)}if(nextAncestor&&nextAncestor.sourceIndex)return e>a&&e<nextAncestor.sourceIndex}while(element=element.parentNode)if(element==originalAncestor)return true;return false},scrollTo:function(element){element=$$$(element);var pos=element.cumulativeOffset();window.scrollTo(pos[0],pos[1]);return element},getStyle:function(element,style){element=$$$(element);style=style=="float"?"cssFloat":style.camelize();var value=element.style[style];if(!value){var css=document.defaultView.getComputedStyle(element,null);value=css?css[style]:null}if(style=="opacity")return value?parseFloat(value):1;return value=="auto"?null:value},getOpacity:function(element){return $$$(element).getStyle("opacity")},setStyle:function(element,styles){element=$$$(element);var elementStyle=element.style,match;if(Object.isString(styles)){element.style.cssText+=";"+styles;return styles.include("opacity")?element.setOpacity(styles.match(/opacity:\s*(\d?\.?\d*)/)[1]):element}for(var property in styles)if(property=="opacity")element.setOpacity(styles[property]);else elementStyle[property=="float"||property=="cssFloat"?Object.isUndefined(elementStyle.styleFloat)?"cssFloat":"styleFloat":property]=styles[property];return element},setOpacity:function(element,value){element=$$$(element);element.style.opacity=value==1||value===""?"":value<1e-5?0:value;return element},getDimensions:function(element){element=$$$(element);var display=$$$(element).getStyle("display");if(display!="none"&&display!=null)return{width:element.offsetWidth,height:element.offsetHeight};var els=element.style;var originalVisibility=els.visibility;var originalPosition=els.position;var originalDisplay=els.display;els.visibility="hidden";els.position="absolute";els.display="block";var originalWidth=element.clientWidth;var originalHeight=element.clientHeight;els.display=originalDisplay;els.position=originalPosition;els.visibility=originalVisibility;return{width:originalWidth,height:originalHeight}},makePositioned:function(element){element=$$$(element);var pos=Element.getStyle(element,"position");if(pos=="static"||!pos){element._madePositioned=true;element.style.position="relative";if(window.opera){element.style.top=0;element.style.left=0}}return element},undoPositioned:function(element){element=$$$(element);if(element._madePositioned){element._madePositioned=undefined;element.style.position=element.style.top=element.style.left=element.style.bottom=element.style.right=""}return element},makeClipping:function(element){element=$$$(element);if(element._overflow)return element;element._overflow=Element.getStyle(element,"overflow")||"auto";if(element._overflow!=="hidden")element.style.overflow="hidden";return element},undoClipping:function(element){element=$$$(element);if(!element._overflow)return element;element.style.overflow=element._overflow=="auto"?"":element._overflow;element._overflow=null;return element},cumulativeOffset:function(element){var valueT=0,valueL=0;do{valueT+=element.offsetTop||0;valueL+=element.offsetLeft||0;element=element.offsetParent}while(element);return Element._returnOffset(valueL,valueT)},positionedOffset:function(element){var valueT=0,valueL=0;do{valueT+=element.offsetTop||0;valueL+=element.offsetLeft||0;element=element.offsetParent;if(element){if(element.tagName=="BODY")break;var p=Element.getStyle(element,"position");if(p!=="static")break}}while(element);return Element._returnOffset(valueL,valueT)},absolutize:function(element){element=$$$(element);if(element.getStyle("position")=="absolute")return;var offsets=element.positionedOffset();var top=offsets[1];var left=offsets[0];var width=element.clientWidth;var height=element.clientHeight;element._originalLeft=left-parseFloat(element.style.left||0);element._originalTop=top-parseFloat(element.style.top||0);element._originalWidth=element.style.width;element._originalHeight=element.style.height;element.style.position="absolute";element.style.top=top+"px";element.style.left=left+"px";element.style.width=width+"px";element.style.height=height+"px";return element},relativize:function(element){element=$$$(element);if(element.getStyle("position")=="relative")return;element.style.position="relative";var top=parseFloat(element.style.top||0)-(element._originalTop||0);var left=parseFloat(element.style.left||0)-(element._originalLeft||0);element.style.top=top+"px";element.style.left=left+"px";element.style.height=element._originalHeight;element.style.width=element._originalWidth;return element},cumulativeScrollOffset:function(element){var valueT=0,valueL=0;do{valueT+=element.scrollTop||0;valueL+=element.scrollLeft||0;element=element.parentNode}while(element);return Element._returnOffset(valueL,valueT)},getOffsetParent:function(element){if(element.offsetParent)return $$$(element.offsetParent);if(element==document.body)return $$$(element);while((element=element.parentNode)&&element!=document.body)if(Element.getStyle(element,"position")!="static")return $$$(element);return $$$(document.body)},viewportOffset:function(forElement){var valueT=0,valueL=0;var element=forElement;do{valueT+=element.offsetTop||0;valueL+=element.offsetLeft||0;if(element.offsetParent==document.body&&Element.getStyle(element,"position")=="absolute")break}while(element=element.offsetParent);element=forElement;do{if(!Prototype.Browser.Opera||element.tagName=="BODY"){valueT-=element.scrollTop||0;valueL-=element.scrollLeft||0}}while(element=element.parentNode);return Element._returnOffset(valueL,valueT)},clonePosition:function(element,source){var options=Object.extend({setLeft:true,setTop:true,setWidth:true,setHeight:true,offsetTop:0,offsetLeft:0},arguments[2]||{});source=$$$(source);var p=source.viewportOffset();element=$$$(element);var delta=[0,0];var parent=null;if(Element.getStyle(element,"position")=="absolute"){parent=element.getOffsetParent();delta=parent.viewportOffset()}if(parent==document.body){delta[0]-=document.body.offsetLeft;delta[1]-=document.body.offsetTop}if(options.setLeft)element.style.left=p[0]-delta[0]+options.offsetLeft+"px";if(options.setTop)element.style.top=p[1]-delta[1]+options.offsetTop+"px";if(options.setWidth)element.style.width=source.offsetWidth+"px";if(options.setHeight)element.style.height=source.offsetHeight+"px";return element}};Element.Methods.identify.counter=1;Object.extend(Element.Methods,{getElementsBySelector:Element.Methods.select,childElements:Element.Methods.immediateDescendants});Element._attributeTranslations={write:{names:{className:"class",htmlFor:"for"},values:{}}};if(Prototype.Browser.Opera){Element.Methods.getStyle=Element.Methods.getStyle.wrap(function(proceed,element,style){switch(style){case"left":case"top":case"right":case"bottom":if(proceed(element,"position")==="static")return null;case"height":case"width":if(!Element.visible(element))return null;var dim=parseInt(proceed(element,style),10);if(dim!==element["offset"+style.capitalize()])return dim+"px";var properties;if(style==="height"){properties=["border-top-width","padding-top","padding-bottom","border-bottom-width"]}else{properties=["border-left-width","padding-left","padding-right","border-right-width"]}return properties.inject(dim,function(memo,property){var val=proceed(element,property);return val===null?memo:memo-parseInt(val,10)})+"px";default:return proceed(element,style)}});Element.Methods.readAttribute=Element.Methods.readAttribute.wrap(function(proceed,element,attribute){if(attribute==="title")return element.title;return proceed(element,attribute)})}else if(Prototype.Browser.IE){Element.Methods.getOffsetParent=Element.Methods.getOffsetParent.wrap(function(proceed,element){element=$$$(element);var position=element.getStyle("position");if(position!=="static")return proceed(element);element.setStyle({position:"relative"});var value=proceed(element);element.setStyle({position:position});return value});$w("positionedOffset viewportOffset").each(function(method){Element.Methods[method]=Element.Methods[method].wrap(function(proceed,element){element=$$$(element);var position=element.getStyle("position");if(position!=="static")return proceed(element);var offsetParent=element.getOffsetParent();if(offsetParent&&offsetParent.getStyle("position")==="fixed")offsetParent.setStyle({zoom:1});element.setStyle({position:"relative"});var value=proceed(element);element.setStyle({position:position});return value})});Element.Methods.getStyle=function(element,style){element=$$$(element);style=style=="float"||style=="cssFloat"?"styleFloat":style.camelize();var value=element.style[style];if(!value&&element.currentStyle)value=element.currentStyle[style];if(style=="opacity"){if(value=(element.getStyle("filter")||"").match(/alpha\(opacity=(.*)\)/))if(value[1])return parseFloat(value[1])/100;return 1}if(value=="auto"){if((style=="width"||style=="height")&&element.getStyle("display")!="none")return element["offset"+style.capitalize()]+"px";return null}return value};Element.Methods.setOpacity=function(element,value){function stripAlpha(filter){return filter.replace(/alpha\([^\)]*\)/gi,"")}element=$$$(element);var currentStyle=element.currentStyle;if(currentStyle&&!currentStyle.hasLayout||!currentStyle&&element.style.zoom=="normal")element.style.zoom=1;var filter=element.getStyle("filter"),style=element.style;if(value==1||value===""){(filter=stripAlpha(filter))?style.filter=filter:style.removeAttribute("filter");return element}else if(value<1e-5)value=0;style.filter=stripAlpha(filter)+"alpha(opacity="+value*100+")";return element};Element._attributeTranslations={read:{names:{"class":"className","for":"htmlFor"},values:{_getAttr:function(element,attribute){return element.getAttribute(attribute,2)},_getAttrNode:function(element,attribute){var node=element.getAttributeNode(attribute);return node?node.value:""},_getEv:function(element,attribute){attribute=element.getAttribute(attribute);return attribute?attribute.toString().slice(23,-2):null},_flag:function(element,attribute){return $$$(element).hasAttribute(attribute)?attribute:null},style:function(element){return element.style.cssText.toLowerCase()},title:function(element){return element.title}}}};Element._attributeTranslations.write={names:Object.extend({cellpadding:"cellPadding",cellspacing:"cellSpacing"},Element._attributeTranslations.read.names),values:{checked:function(element,value){element.checked=!!value},style:function(element,value){element.style.cssText=value?value:""}}};Element._attributeTranslations.has={};$w("colSpan rowSpan vAlign dateTime accessKey tabIndex "+"encType maxLength readOnly longDesc").each(function(attr){Element._attributeTranslations.write.names[attr.toLowerCase()]=attr;Element._attributeTranslations.has[attr.toLowerCase()]=attr});(function(v){Object.extend(v,{href:v._getAttr,src:v._getAttr,type:v._getAttr,action:v._getAttrNode,disabled:v._flag,checked:v._flag,readonly:v._flag,multiple:v._flag,onload:v._getEv,onunload:v._getEv,onclick:v._getEv,ondblclick:v._getEv,onmousedown:v._getEv,onmouseup:v._getEv,onmouseover:v._getEv,onmousemove:v._getEv,onmouseout:v._getEv,onfocus:v._getEv,onblur:v._getEv,onkeypress:v._getEv,onkeydown:v._getEv,onkeyup:v._getEv,onsubmit:v._getEv,onreset:v._getEv,onselect:v._getEv,onchange:v._getEv})})(Element._attributeTranslations.read.values)}else if(Prototype.Browser.Gecko&&/rv:1\.8\.0/.test(navigator.userAgent)){Element.Methods.setOpacity=function(element,value){element=$$$(element);element.style.opacity=value==1?.999999:value===""?"":value<1e-5?0:value;return element}}else if(Prototype.Browser.WebKit){Element.Methods.setOpacity=function(element,value){element=$$$(element);element.style.opacity=value==1||value===""?"":value<1e-5?0:value;if(value==1)if(element.tagName=="IMG"&&element.width){element.width++;element.width--}else try{var n=document.createTextNode(" ");element.appendChild(n);element.removeChild(n)}catch(e){}return element};Element.Methods.cumulativeOffset=function(element){var valueT=0,valueL=0;do{valueT+=element.offsetTop||0;valueL+=element.offsetLeft||0;if(element.offsetParent==document.body)if(Element.getStyle(element,"position")=="absolute")break;element=element.offsetParent}while(element);return Element._returnOffset(valueL,valueT)}}if(Prototype.Browser.IE||Prototype.Browser.Opera){Element.Methods.update=function(element,content){element=$$$(element);if(content&&content.toElement)content=content.toElement();if(Object.isElement(content))return element.update().insert(content);content=Object.toHTML(content);var tagName=element.tagName.toUpperCase();if(tagName in Element._insertionTranslations.tags){$A(element.childNodes).each(function(node){element.removeChild(node)});Element._getContentFromAnonymousElement(tagName,content.stripScripts()).each(function(node){element.appendChild(node)})}else element.innerHTML=content.stripScripts();content.evalScripts.bind(content).defer();return element}}if("outerHTML"in document.createElement("div")){Element.Methods.replace=function(element,content){element=$$$(element);if(content&&content.toElement)content=content.toElement();if(Object.isElement(content)){element.parentNode.replaceChild(content,element);return element}content=Object.toHTML(content);var parent=element.parentNode,tagName=parent.tagName.toUpperCase();if(Element._insertionTranslations.tags[tagName]){var nextSibling=element.next();var fragments=Element._getContentFromAnonymousElement(tagName,content.stripScripts());parent.removeChild(element);if(nextSibling)fragments.each(function(node){parent.insertBefore(node,nextSibling)});else fragments.each(function(node){parent.appendChild(node)})}else element.outerHTML=content.stripScripts();content.evalScripts.bind(content).defer();return element}}Element._returnOffset=function(l,t){var result=[l,t];result.left=l;result.top=t;return result};Element._getContentFromAnonymousElement=function(tagName,html){var div=new Element("div"),t=Element._insertionTranslations.tags[tagName];if(t){div.innerHTML=t[0]+html+t[1];t[2].times(function(){div=div.firstChild})}else div.innerHTML=html;return $A(div.childNodes)};Element._insertionTranslations={before:function(element,node){element.parentNode.insertBefore(node,element)},top:function(element,node){element.insertBefore(node,element.firstChild)},bottom:function(element,node){element.appendChild(node)},after:function(element,node){element.parentNode.insertBefore(node,element.nextSibling)},tags:{TABLE:["<table>","</table>",1],TBODY:["<table><tbody>","</tbody></table>",2],TR:["<table><tbody><tr>","</tr></tbody></table>",3],TD:["<table><tbody><tr><td>","</td></tr></tbody></table>",4],SELECT:["<select>","</select>",1]}};(function(){Object.extend(this.tags,{THEAD:this.tags.TBODY,TFOOT:this.tags.TBODY,TH:this.tags.TD})}).call(Element._insertionTranslations);Element.Methods.Simulated={hasAttribute:function(element,attribute){attribute=Element._attributeTranslations.has[attribute]||attribute;var node=$$$(element).getAttributeNode(attribute);return node&&node.specified}};Element.Methods.ByTag={};Object.extend(Element,Element.Methods);if(!Prototype.BrowserFeatures.ElementExtensions&&document.createElement("div").__proto__){window.HTMLElement={};window.HTMLElement.prototype=document.createElement("div").__proto__;Prototype.BrowserFeatures.ElementExtensions=true}Element.extend=function(){if(Prototype.BrowserFeatures.SpecificElementExtensions)return Prototype.K;var Methods={},ByTag=Element.Methods.ByTag;var extend=Object.extend(function(element){if(!element||element._extendedByPrototype||element.nodeType!=1||element==window)return element;var methods=Object.clone(Methods),tagName=element.tagName,property,value;if(ByTag[tagName])Object.extend(methods,ByTag[tagName]);for(property in methods){value=methods[property];if(Object.isFunction(value)&&!(property in element))element[property]=value.methodize()}element._extendedByPrototype=Prototype.emptyFunction;return element},{refresh:function(){if(!Prototype.BrowserFeatures.ElementExtensions){Object.extend(Methods,Element.Methods);Object.extend(Methods,Element.Methods.Simulated)}}});extend.refresh();return extend}();Element.hasAttribute=function(element,attribute){if(element.hasAttribute)return element.hasAttribute(attribute);return Element.Methods.Simulated.hasAttribute(element,attribute)};Element.addMethods=function(methods){var F=Prototype.BrowserFeatures,T=Element.Methods.ByTag;if(!methods){Object.extend(Form,Form.Methods);Object.extend(Form.Element,Form.Element.Methods);Object.extend(Element.Methods.ByTag,{FORM:Object.clone(Form.Methods),INPUT:Object.clone(Form.Element.Methods),SELECT:Object.clone(Form.Element.Methods),TEXTAREA:Object.clone(Form.Element.Methods)})}if(arguments.length==2){var tagName=methods;methods=arguments[1]}if(!tagName)Object.extend(Element.Methods,methods||{});else{if(Object.isArray(tagName))tagName.each(extend);else extend(tagName)}function extend(tagName){tagName=tagName.toUpperCase();if(!Element.Methods.ByTag[tagName])Element.Methods.ByTag[tagName]={};Object.extend(Element.Methods.ByTag[tagName],methods)}function copy(methods,destination,onlyIfAbsent){onlyIfAbsent=onlyIfAbsent||false;for(var property in methods){var value=methods[property];if(!Object.isFunction(value))continue;if(!onlyIfAbsent||!(property in destination))destination[property]=value.methodize()}}function findDOMClass(tagName){var klass;var trans={OPTGROUP:"OptGroup",TEXTAREA:"TextArea",P:"Paragraph",FIELDSET:"FieldSet",UL:"UList",OL:"OList",DL:"DList",DIR:"Directory",H1:"Heading",H2:"Heading",H3:"Heading",H4:"Heading",H5:"Heading",H6:"Heading",Q:"Quote",INS:"Mod",DEL:"Mod",A:"Anchor",IMG:"Image",CAPTION:"TableCaption",COL:"TableCol",COLGROUP:"TableCol",THEAD:"TableSection",TFOOT:"TableSection",TBODY:"TableSection",TR:"TableRow",TH:"TableCell",TD:"TableCell",FRAMESET:"FrameSet",IFRAME:"IFrame"};if(trans[tagName])klass="HTML"+trans[tagName]+"Element";if(window[klass])return window[klass];klass="HTML"+tagName+"Element";if(window[klass])return window[klass];klass="HTML"+tagName.capitalize()+"Element";if(window[klass])return window[klass];window[klass]={};window[klass].prototype=document.createElement(tagName).__proto__;return window[klass]}if(F.ElementExtensions){copy(Element.Methods,HTMLElement.prototype);copy(Element.Methods.Simulated,HTMLElement.prototype,true)}if(F.SpecificElementExtensions){for(var tag in Element.Methods.ByTag){var klass=findDOMClass(tag);if(Object.isUndefined(klass))continue;copy(T[tag],klass.prototype)}}Object.extend(Element,Element.Methods);delete Element.ByTag;if(Element.extend.refresh)Element.extend.refresh();Element.cache={}};document.viewport={getDimensions:function(){var dimensions={};var B=Prototype.Browser;$w("width height").each(function(d){var D=d.capitalize();dimensions[d]=B.WebKit&&!document.evaluate?self["inner"+D]:B.Opera?document.body["client"+D]:document.documentElement["client"+D]});return dimensions},getWidth:function(){return this.getDimensions().width},getHeight:function(){return this.getDimensions().height},getScrollOffsets:function(){return Element._returnOffset(window.pageXOffset||document.documentElement.scrollLeft||document.body.scrollLeft,window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop)}};var Selector=Class.create({initialize:function(expression){this.expression=expression.strip();this.compileMatcher()},shouldUseXPath:function(){if(!Prototype.BrowserFeatures.XPath)return false;var e=this.expression;if(Prototype.Browser.WebKit&&(e.include("-of-type")||e.include(":empty")))return false;if(/(\[[\w-]*?:|:checked)/.test(this.expression))return false;return true},compileMatcher:function(){if(this.shouldUseXPath())return this.compileXPathMatcher();var e=this.expression,ps=Selector.patterns,h=Selector.handlers,c=Selector.criteria,le,p,m;if(Selector._cache[e]){this.matcher=Selector._cache[e];return}this.matcher=["this.matcher = function(root) {","var r = root, h = Selector.handlers, c = false, n;"];while(e&&le!=e&&/\S/.test(e)){le=e;for(var i in ps){p=ps[i];if(m=e.match(p)){this.matcher.push(Object.isFunction(c[i])?c[i](m):new Template(c[i]).evaluate(m));e=e.replace(m[0],"");break}}}this.matcher.push("return h.unique(n);\n}");eval(this.matcher.join("\n"));Selector._cache[this.expression]=this.matcher},compileXPathMatcher:function(){var e=this.expression,ps=Selector.patterns,x=Selector.xpath,le,m;if(Selector._cache[e]){this.xpath=Selector._cache[e];return}this.matcher=[".//*"];while(e&&le!=e&&/\S/.test(e)){le=e;for(var i in ps){if(m=e.match(ps[i])){this.matcher.push(Object.isFunction(x[i])?x[i](m):new Template(x[i]).evaluate(m));e=e.replace(m[0],"");break}}}this.xpath=this.matcher.join("");Selector._cache[this.expression]=this.xpath},findElements:function(root){root=root||document;if(this.xpath)return document._getElementsByXPath(this.xpath,root);return this.matcher(root)},match:function(element){this.tokens=[];var e=this.expression,ps=Selector.patterns,as=Selector.assertions;var le,p,m;while(e&&le!==e&&/\S/.test(e)){le=e;for(var i in ps){p=ps[i];if(m=e.match(p)){if(as[i]){this.tokens.push([i,Object.clone(m)]);e=e.replace(m[0],"")}else{return this.findElements(document).include(element)}}}}var match=true,name,matches;for(var i=0,token;token=this.tokens[i];i++){name=token[0],matches=token[1];if(!Selector.assertions[name](element,matches)){match=false;break}}return match},toString:function(){return this.expression},inspect:function(){return"#<Selector:"+this.expression.inspect()+">"}});Object.extend(Selector,{_cache:{},xpath:{descendant:"//*",child:"/*",adjacent:"/following-sibling::*[1]",laterSibling:"/following-sibling::*",tagName:function(m){if(m[1]=="*")return"";return"[local-name()='"+m[1].toLowerCase()+"' or local-name()='"+m[1].toUpperCase()+"']"},className:"[contains(concat(' ', @class, ' '), ' #{1} ')]",id:"[@id='#{1}']",attrPresence:function(m){m[1]=m[1].toLowerCase();return new Template("[@#{1}]").evaluate(m)},attr:function(m){m[1]=m[1].toLowerCase();m[3]=m[5]||m[6];return new Template(Selector.xpath.operators[m[2]]).evaluate(m)},pseudo:function(m){var h=Selector.xpath.pseudos[m[1]];if(!h)return"";if(Object.isFunction(h))return h(m);return new Template(Selector.xpath.pseudos[m[1]]).evaluate(m)},operators:{"=":"[@#{1}='#{3}']","!=":"[@#{1}!='#{3}']","^=":"[starts-with(@#{1}, '#{3}')]","$=":"[substring(@#{1}, (string-length(@#{1}) - string-length('#{3}') + 1))='#{3}']","*=":"[contains(@#{1}, '#{3}')]","~=":"[contains(concat(' ', @#{1}, ' '), ' #{3} ')]","|=":"[contains(concat('-', @#{1}, '-'), '-#{3}-')]"},pseudos:{"first-child":"[not(preceding-sibling::*)]","last-child":"[not(following-sibling::*)]","only-child":"[not(preceding-sibling::* or following-sibling::*)]",empty:"[count(*) = 0 and (count(text()) = 0 or translate(text(), ' 	\r\n', '') = '')]",checked:"[@checked]",disabled:"[@disabled]",enabled:"[not(@disabled)]",not:function(m){var e=m[6],p=Selector.patterns,x=Selector.xpath,le,v;var exclusion=[];while(e&&le!=e&&/\S/.test(e)){le=e;for(var i in p){if(m=e.match(p[i])){v=Object.isFunction(x[i])?x[i](m):new Template(x[i]).evaluate(m);exclusion.push("("+v.substring(1,v.length-1)+")");e=e.replace(m[0],"");break}}}return"[not("+exclusion.join(" and ")+")]"},"nth-child":function(m){return Selector.xpath.pseudos.nth("(count(./preceding-sibling::*) + 1) ",m)},"nth-last-child":function(m){return Selector.xpath.pseudos.nth("(count(./following-sibling::*) + 1) ",m)},"nth-of-type":function(m){return Selector.xpath.pseudos.nth("position() ",m)},"nth-last-of-type":function(m){return Selector.xpath.pseudos.nth("(last() + 1 - position()) ",m)},"first-of-type":function(m){m[6]="1";return Selector.xpath.pseudos["nth-of-type"](m)},"last-of-type":function(m){m[6]="1";return Selector.xpath.pseudos["nth-last-of-type"](m)},"only-of-type":function(m){var p=Selector.xpath.pseudos;return p["first-of-type"](m)+p["last-of-type"](m)},nth:function(fragment,m){var mm,formula=m[6],predicate;if(formula=="even")formula="2n+0";if(formula=="odd")formula="2n+1";if(mm=formula.match(/^(\d+)$/))return"["+fragment+"= "+mm[1]+"]";
if(mm=formula.match(/^(-?\d*)?n(([+-])(\d+))?/)){if(mm[1]=="-")mm[1]=-1;var a=mm[1]?Number(mm[1]):1;var b=mm[2]?Number(mm[2]):0;predicate="[((#{fragment} - #{b}) mod #{a} = 0) and "+"((#{fragment} - #{b}) div #{a} >= 0)]";return new Template(predicate).evaluate({fragment:fragment,a:a,b:b})}}}},criteria:{tagName:'n = h.tagName(n, r, "#{1}", c);      c = false;',className:'n = h.className(n, r, "#{1}", c);    c = false;',id:'n = h.id(n, r, "#{1}", c);           c = false;',attrPresence:'n = h.attrPresence(n, r, "#{1}", c); c = false;',attr:function(m){m[3]=m[5]||m[6];return new Template('n = h.attr(n, r, "#{1}", "#{3}", "#{2}", c); c = false;').evaluate(m)},pseudo:function(m){if(m[6])m[6]=m[6].replace(/"/g,'\\"');return new Template('n = h.pseudo(n, "#{1}", "#{6}", r, c); c = false;').evaluate(m)},descendant:'c = "descendant";',child:'c = "child";',adjacent:'c = "adjacent";',laterSibling:'c = "laterSibling";'},patterns:{laterSibling:/^\s*~\s*/,child:/^\s*>\s*/,adjacent:/^\s*\+\s*/,descendant:/^\s/,tagName:/^\s*(\*|[\w\-]+)(\b|$)?/,id:/^#([\w\-\*]+)(\b|$)/,className:/^\.([\w\-\*]+)(\b|$)/,pseudo:/^:((first|last|nth|nth-last|only)(-child|-of-type)|empty|checked|(en|dis)abled|not)(\((.*?)\))?(\b|$|(?=\s|[:+~>]))/,attrPresence:/^\[([\w]+)\]/,attr:/\[((?:[\w-]*:)?[\w-]+)\s*(?:([!^$*~|]?=)\s*((['"])([^\4]*?)\4|([^'"][^\]]*?)))?\]/},assertions:{tagName:function(element,matches){return matches[1].toUpperCase()==element.tagName.toUpperCase()},className:function(element,matches){return Element.hasClassName(element,matches[1])},id:function(element,matches){return element.id===matches[1]},attrPresence:function(element,matches){return Element.hasAttribute(element,matches[1])},attr:function(element,matches){var nodeValue=Element.readAttribute(element,matches[1]);return nodeValue&&Selector.operators[matches[2]](nodeValue,matches[5]||matches[6])}},handlers:{concat:function(a,b){for(var i=0,node;node=b[i];i++)a.push(node);return a},mark:function(nodes){var _true=Prototype.emptyFunction;for(var i=0,node;node=nodes[i];i++)node._countedByPrototype=_true;return nodes},unmark:function(nodes){for(var i=0,node;node=nodes[i];i++)node._countedByPrototype=undefined;return nodes},index:function(parentNode,reverse,ofType){parentNode._countedByPrototype=Prototype.emptyFunction;if(reverse){for(var nodes=parentNode.childNodes,i=nodes.length-1,j=1;i>=0;i--){var node=nodes[i];if(node.nodeType==1&&(!ofType||node._countedByPrototype))node.nodeIndex=j++}}else{for(var i=0,j=1,nodes=parentNode.childNodes;node=nodes[i];i++)if(node.nodeType==1&&(!ofType||node._countedByPrototype))node.nodeIndex=j++}},unique:function(nodes){if(nodes.length==0)return nodes;var results=[],n;for(var i=0,l=nodes.length;i<l;i++)if(!(n=nodes[i])._countedByPrototype){n._countedByPrototype=Prototype.emptyFunction;results.push(Element.extend(n))}return Selector.handlers.unmark(results)},descendant:function(nodes){var h=Selector.handlers;for(var i=0,results=[],node;node=nodes[i];i++)h.concat(results,node.getElementsByTagName("*"));return results},child:function(nodes){var h=Selector.handlers;for(var i=0,results=[],node;node=nodes[i];i++){for(var j=0,child;child=node.childNodes[j];j++)if(child.nodeType==1&&child.tagName!="!")results.push(child)}return results},adjacent:function(nodes){for(var i=0,results=[],node;node=nodes[i];i++){var next=this.nextElementSibling(node);if(next)results.push(next)}return results},laterSibling:function(nodes){var h=Selector.handlers;for(var i=0,results=[],node;node=nodes[i];i++)h.concat(results,Element.nextSiblings(node));return results},nextElementSibling:function(node){while(node=node.nextSibling)if(node.nodeType==1)return node;return null},previousElementSibling:function(node){while(node=node.previousSibling)if(node.nodeType==1)return node;return null},tagName:function(nodes,root,tagName,combinator){var uTagName=tagName.toUpperCase();var results=[],h=Selector.handlers;if(nodes){if(combinator){if(combinator=="descendant"){for(var i=0,node;node=nodes[i];i++)h.concat(results,node.getElementsByTagName(tagName));return results}else nodes=this[combinator](nodes);if(tagName=="*")return nodes}for(var i=0,node;node=nodes[i];i++)if(node.tagName.toUpperCase()===uTagName)results.push(node);return results}else return root.getElementsByTagName(tagName)},id:function(nodes,root,id,combinator){var targetNode=$$$(id),h=Selector.handlers;if(!targetNode)return[];if(!nodes&&root==document)return[targetNode];if(nodes){if(combinator){if(combinator=="child"){for(var i=0,node;node=nodes[i];i++)if(targetNode.parentNode==node)return[targetNode]}else if(combinator=="descendant"){for(var i=0,node;node=nodes[i];i++)if(Element.descendantOf(targetNode,node))return[targetNode]}else if(combinator=="adjacent"){for(var i=0,node;node=nodes[i];i++)if(Selector.handlers.previousElementSibling(targetNode)==node)return[targetNode]}else nodes=h[combinator](nodes)}for(var i=0,node;node=nodes[i];i++)if(node==targetNode)return[targetNode];return[]}return targetNode&&Element.descendantOf(targetNode,root)?[targetNode]:[]},className:function(nodes,root,className,combinator){if(nodes&&combinator)nodes=this[combinator](nodes);return Selector.handlers.byClassName(nodes,root,className)},byClassName:function(nodes,root,className){if(!nodes)nodes=Selector.handlers.descendant([root]);var needle=" "+className+" ";for(var i=0,results=[],node,nodeClassName;node=nodes[i];i++){nodeClassName=node.className;if(nodeClassName.length==0)continue;if(nodeClassName==className||(" "+nodeClassName+" ").include(needle))results.push(node)}return results},attrPresence:function(nodes,root,attr,combinator){if(!nodes)nodes=root.getElementsByTagName("*");if(nodes&&combinator)nodes=this[combinator](nodes);var results=[];for(var i=0,node;node=nodes[i];i++)if(Element.hasAttribute(node,attr))results.push(node);return results},attr:function(nodes,root,attr,value,operator,combinator){if(!nodes)nodes=root.getElementsByTagName("*");if(nodes&&combinator)nodes=this[combinator](nodes);var handler=Selector.operators[operator],results=[];for(var i=0,node;node=nodes[i];i++){var nodeValue=Element.readAttribute(node,attr);if(nodeValue===null)continue;if(handler(nodeValue,value))results.push(node)}return results},pseudo:function(nodes,name,value,root,combinator){if(nodes&&combinator)nodes=this[combinator](nodes);if(!nodes)nodes=root.getElementsByTagName("*");return Selector.pseudos[name](nodes,value,root)}},pseudos:{"first-child":function(nodes,value,root){for(var i=0,results=[],node;node=nodes[i];i++){if(Selector.handlers.previousElementSibling(node))continue;results.push(node)}return results},"last-child":function(nodes,value,root){for(var i=0,results=[],node;node=nodes[i];i++){if(Selector.handlers.nextElementSibling(node))continue;results.push(node)}return results},"only-child":function(nodes,value,root){var h=Selector.handlers;for(var i=0,results=[],node;node=nodes[i];i++)if(!h.previousElementSibling(node)&&!h.nextElementSibling(node))results.push(node);return results},"nth-child":function(nodes,formula,root){return Selector.pseudos.nth(nodes,formula,root)},"nth-last-child":function(nodes,formula,root){return Selector.pseudos.nth(nodes,formula,root,true)},"nth-of-type":function(nodes,formula,root){return Selector.pseudos.nth(nodes,formula,root,false,true)},"nth-last-of-type":function(nodes,formula,root){return Selector.pseudos.nth(nodes,formula,root,true,true)},"first-of-type":function(nodes,formula,root){return Selector.pseudos.nth(nodes,"1",root,false,true)},"last-of-type":function(nodes,formula,root){return Selector.pseudos.nth(nodes,"1",root,true,true)},"only-of-type":function(nodes,formula,root){var p=Selector.pseudos;return p["last-of-type"](p["first-of-type"](nodes,formula,root),formula,root)},getIndices:function(a,b,total){if(a==0)return b>0?[b]:[];return $R(1,total).inject([],function(memo,i){if(0==(i-b)%a&&(i-b)/a>=0)memo.push(i);return memo})},nth:function(nodes,formula,root,reverse,ofType){if(nodes.length==0)return[];if(formula=="even")formula="2n+0";if(formula=="odd")formula="2n+1";var h=Selector.handlers,results=[],indexed=[],m;h.mark(nodes);for(var i=0,node;node=nodes[i];i++){if(!node.parentNode._countedByPrototype){h.index(node.parentNode,reverse,ofType);indexed.push(node.parentNode)}}if(formula.match(/^\d+$/)){formula=Number(formula);for(var i=0,node;node=nodes[i];i++)if(node.nodeIndex==formula)results.push(node)}else if(m=formula.match(/^(-?\d*)?n(([+-])(\d+))?/)){if(m[1]=="-")m[1]=-1;var a=m[1]?Number(m[1]):1;var b=m[2]?Number(m[2]):0;var indices=Selector.pseudos.getIndices(a,b,nodes.length);for(var i=0,node,l=indices.length;node=nodes[i];i++){for(var j=0;j<l;j++)if(node.nodeIndex==indices[j])results.push(node)}}h.unmark(nodes);h.unmark(indexed);return results},empty:function(nodes,value,root){for(var i=0,results=[],node;node=nodes[i];i++){if(node.tagName=="!"||node.firstChild&&!node.innerHTML.match(/^\s*$/))continue;results.push(node)}return results},not:function(nodes,selector,root){var h=Selector.handlers,selectorType,m;var exclusions=new Selector(selector).findElements(root);h.mark(exclusions);for(var i=0,results=[],node;node=nodes[i];i++)if(!node._countedByPrototype)results.push(node);h.unmark(exclusions);return results},enabled:function(nodes,value,root){for(var i=0,results=[],node;node=nodes[i];i++)if(!node.disabled)results.push(node);return results},disabled:function(nodes,value,root){for(var i=0,results=[],node;node=nodes[i];i++)if(node.disabled)results.push(node);return results},checked:function(nodes,value,root){for(var i=0,results=[],node;node=nodes[i];i++)if(node.checked)results.push(node);return results}},operators:{"=":function(nv,v){return nv==v},"!=":function(nv,v){return nv!=v},"^=":function(nv,v){return nv.startsWith(v)},"$=":function(nv,v){return nv.endsWith(v)},"*=":function(nv,v){return nv.include(v)},"~=":function(nv,v){return(" "+nv+" ").include(" "+v+" ")},"|=":function(nv,v){return("-"+nv.toUpperCase()+"-").include("-"+v.toUpperCase()+"-")}},split:function(expression){var expressions=[];expression.scan(/(([\w#:.~>+()\s-]+|\*|\[.*?\])+)\s*(,|$)/,function(m){expressions.push(m[1].strip())});return expressions},matchElements:function(elements,expression){var matches=$$$$(expression),h=Selector.handlers;h.mark(matches);for(var i=0,results=[],element;element=elements[i];i++)if(element._countedByPrototype)results.push(element);h.unmark(matches);return results},findElement:function(elements,expression,index){if(Object.isNumber(expression)){index=expression;expression=false}return Selector.matchElements(elements,expression||"*")[index||0]},findChildElements:function(element,expressions){expressions=Selector.split(expressions.join(","));var results=[],h=Selector.handlers;for(var i=0,l=expressions.length,selector;i<l;i++){selector=new Selector(expressions[i].strip());h.concat(results,selector.findElements(element))}return l>1?h.unique(results):results}});if(Prototype.Browser.IE){Object.extend(Selector.handlers,{concat:function(a,b){for(var i=0,node;node=b[i];i++)if(node.tagName!=="!")a.push(node);return a},unmark:function(nodes){for(var i=0,node;node=nodes[i];i++)node.removeAttribute("_countedByPrototype");return nodes}})}function $$$$(){return Selector.findChildElements(document,$A(arguments))}var Form={reset:function(form){$$$(form).reset();return form},serializeElements:function(elements,options){if(typeof options!="object")options={hash:!!options};else if(Object.isUndefined(options.hash))options.hash=true;var key,value,submitted=false,submit=options.submit;var data=elements.inject({},function(result,element){if(!element.disabled&&element.name){key=element.name;value=$$$(element).getValue();if(value!=null&&(element.type!="submit"||!submitted&&submit!==false&&(!submit||key==submit)&&(submitted=true))){if(key in result){if(!Object.isArray(result[key]))result[key]=[result[key]];result[key].push(value)}else result[key]=value}}return result});return options.hash?data:Object.toQueryString(data)}};Form.Methods={serialize:function(form,options){return Form.serializeElements(Form.getElements(form),options)},getElements:function(form){return $A($$$(form).getElementsByTagName("*")).inject([],function(elements,child){if(Form.Element.Serializers[child.tagName.toLowerCase()])elements.push(Element.extend(child));return elements})},getInputs:function(form,typeName,name){form=$$$(form);var inputs=form.getElementsByTagName("input");if(!typeName&&!name)return $A(inputs).map(Element.extend);for(var i=0,matchingInputs=[],length=inputs.length;i<length;i++){var input=inputs[i];if(typeName&&input.type!=typeName||name&&input.name!=name)continue;matchingInputs.push(Element.extend(input))}return matchingInputs},disable:function(form){form=$$$(form);Form.getElements(form).invoke("disable");return form},enable:function(form){form=$$$(form);Form.getElements(form).invoke("enable");return form},findFirstElement:function(form){var elements=$$$(form).getElements().findAll(function(element){return"hidden"!=element.type&&!element.disabled});var firstByIndex=elements.findAll(function(element){return element.hasAttribute("tabIndex")&&element.tabIndex>=0}).sortBy(function(element){return element.tabIndex}).first();return firstByIndex?firstByIndex:elements.find(function(element){return["input","select","textarea"].include(element.tagName.toLowerCase())})},focusFirstElement:function(form){form=$$$(form);form.findFirstElement().activate();return form},request:function(form,options){form=$$$(form),options=Object.clone(options||{});var params=options.parameters,action=form.readAttribute("action")||"";if(action.blank())action=window.location.href;options.parameters=form.serialize(true);if(params){if(Object.isString(params))params=params.toQueryParams();Object.extend(options.parameters,params)}if(form.hasAttribute("method")&&!options.method)options.method=form.method;return new Ajax.Request(action,options)}};Form.Element={focus:function(element){$$$(element).focus();return element},select:function(element){$$$(element).select();return element}};Form.Element.Methods={serialize:function(element){element=$$$(element);if(!element.disabled&&element.name){var value=element.getValue();if(value!=undefined){var pair={};pair[element.name]=value;return Object.toQueryString(pair)}}return""},getValue:function(element){element=$$$(element);var method=element.tagName.toLowerCase();return Form.Element.Serializers[method](element)},setValue:function(element,value){element=$$$(element);var method=element.tagName.toLowerCase();Form.Element.Serializers[method](element,value);return element},clear:function(element){$$$(element).value="";return element},present:function(element){return $$$(element).value!=""},activate:function(element){element=$$$(element);try{element.focus();if(element.select&&(element.tagName.toLowerCase()!="input"||!["button","reset","submit"].include(element.type)))element.select()}catch(e){}return element},disable:function(element){element=$$$(element);element.blur();element.disabled=true;return element},enable:function(element){element=$$$(element);element.disabled=false;return element}};var Field=Form.Element;var $F=Form.Element.Methods.getValue;Form.Element.Serializers={input:function(element,value){switch(element.type.toLowerCase()){case"checkbox":case"radio":return Form.Element.Serializers.inputSelector(element,value);default:return Form.Element.Serializers.textarea(element,value)}},inputSelector:function(element,value){if(Object.isUndefined(value))return element.checked?element.value:null;else element.checked=!!value},textarea:function(element,value){if(Object.isUndefined(value))return element.value;else element.value=value},select:function(element,index){if(Object.isUndefined(index))return this[element.type=="select-one"?"selectOne":"selectMany"](element);else{var opt,value,single=!Object.isArray(index);for(var i=0,length=element.length;i<length;i++){opt=element.options[i];value=this.optionValue(opt);if(single){if(value==index){opt.selected=true;return}}else opt.selected=index.include(value)}}},selectOne:function(element){var index=element.selectedIndex;return index>=0?this.optionValue(element.options[index]):null},selectMany:function(element){var values,length=element.length;if(!length)return null;for(var i=0,values=[];i<length;i++){var opt=element.options[i];if(opt.selected)values.push(this.optionValue(opt))}return values},optionValue:function(opt){return Element.extend(opt).hasAttribute("value")?opt.value:opt.text}};Abstract.TimedObserver=Class.create(PeriodicalExecuter,{initialize:function($super,element,frequency,callback){$super(callback,frequency);this.element=$$$(element);this.lastValue=this.getValue()},execute:function(){var value=this.getValue();if(Object.isString(this.lastValue)&&Object.isString(value)?this.lastValue!=value:String(this.lastValue)!=String(value)){this.callback(this.element,value);this.lastValue=value}}});Form.Element.Observer=Class.create(Abstract.TimedObserver,{getValue:function(){return Form.Element.getValue(this.element)}});Form.Observer=Class.create(Abstract.TimedObserver,{getValue:function(){return Form.serialize(this.element)}});Abstract.EventObserver=Class.create({initialize:function(element,callback){this.element=$$$(element);this.callback=callback;this.lastValue=this.getValue();if(this.element.tagName.toLowerCase()=="form")this.registerFormCallbacks();else this.registerCallback(this.element)},onElementEvent:function(){var value=this.getValue();if(this.lastValue!=value){this.callback(this.element,value);this.lastValue=value}},registerFormCallbacks:function(){Form.getElements(this.element).each(this.registerCallback,this)},registerCallback:function(element){if(element.type){switch(element.type.toLowerCase()){case"checkbox":case"radio":Event.observe(element,"click",this.onElementEvent.bind(this));break;default:Event.observe(element,"change",this.onElementEvent.bind(this));break}}}});Form.Element.EventObserver=Class.create(Abstract.EventObserver,{getValue:function(){return Form.Element.getValue(this.element)}});Form.EventObserver=Class.create(Abstract.EventObserver,{getValue:function(){return Form.serialize(this.element)}});if(!window.Event)var Event={};Object.extend(Event,{KEY_BACKSPACE:8,KEY_TAB:9,KEY_RETURN:13,KEY_ESC:27,KEY_LEFT:37,KEY_UP:38,KEY_RIGHT:39,KEY_DOWN:40,KEY_DELETE:46,KEY_HOME:36,KEY_END:35,KEY_PAGEUP:33,KEY_PAGEDOWN:34,KEY_INSERT:45,cache:{},relatedTarget:function(event){var element;switch(event.type){case"mouseover":element=event.fromElement;break;case"mouseout":element=event.toElement;break;default:return null}return Element.extend(element)}});Event.Methods=function(){var isButton;if(Prototype.Browser.IE){var buttonMap={0:1,1:4,2:2};isButton=function(event,code){return event.button==buttonMap[code]}}else if(Prototype.Browser.WebKit){isButton=function(event,code){switch(code){case 0:return event.which==1&&!event.metaKey;case 1:return event.which==1&&event.metaKey;default:return false}}}else{isButton=function(event,code){return event.which?event.which===code+1:event.button===code}}return{isLeftClick:function(event){return isButton(event,0)},isMiddleClick:function(event){return isButton(event,1)},isRightClick:function(event){return isButton(event,2)},element:function(event){var node=Event.extend(event).target;return Element.extend(node.nodeType==Node.TEXT_NODE?node.parentNode:node)},findElement:function(event,expression){var element=Event.element(event);if(!expression)return element;var elements=[element].concat(element.ancestors());return Selector.findElement(elements,expression,0)},pointer:function(event){return{x:event.pageX||event.clientX+(document.documentElement.scrollLeft||document.body.scrollLeft),y:event.pageY||event.clientY+(document.documentElement.scrollTop||document.body.scrollTop)}},pointerX:function(event){return Event.pointer(event).x},pointerY:function(event){return Event.pointer(event).y},stop:function(event){Event.extend(event);event.preventDefault();event.stopPropagation();event.stopped=true}}}();Event.extend=function(){var methods=Object.keys(Event.Methods).inject({},function(m,name){m[name]=Event.Methods[name].methodize();return m});if(Prototype.Browser.IE){Object.extend(methods,{stopPropagation:function(){this.cancelBubble=true},preventDefault:function(){this.returnValue=false},inspect:function(){return"[object Event]"}});return function(event){if(!event)return false;if(event._extendedByPrototype)return event;event._extendedByPrototype=Prototype.emptyFunction;var pointer=Event.pointer(event);Object.extend(event,{target:event.srcElement,relatedTarget:Event.relatedTarget(event),pageX:pointer.x,pageY:pointer.y});return Object.extend(event,methods)}}else{Event.prototype=Event.prototype||document.createEvent("HTMLEvents").__proto__;Object.extend(Event.prototype,methods);return Prototype.K}}();Object.extend(Event,function(){var cache=Event.cache;function getEventID(element){if(element._prototypeEventID)return element._prototypeEventID[0];arguments.callee.id=arguments.callee.id||1;return element._prototypeEventID=[++arguments.callee.id]}function getDOMEventName(eventName){if(eventName&&eventName.include(":"))return"dataavailable";return eventName}function getCacheForID(id){return cache[id]=cache[id]||{}}function getWrappersForEventName(id,eventName){var c=getCacheForID(id);return c[eventName]=c[eventName]||[]}function createWrapper(element,eventName,handler){var id=getEventID(element);var c=getWrappersForEventName(id,eventName);if(c.pluck("handler").include(handler))return false;var wrapper=function(event){if(!Event||!Event.extend||event.eventName&&event.eventName!=eventName)return false;Event.extend(event);handler.call(element,event)};wrapper.handler=handler;c.push(wrapper);return wrapper}function findWrapper(id,eventName,handler){var c=getWrappersForEventName(id,eventName);return c.find(function(wrapper){return wrapper.handler==handler})}function destroyWrapper(id,eventName,handler){var c=getCacheForID(id);if(!c[eventName])return false;c[eventName]=c[eventName].without(findWrapper(id,eventName,handler))}function destroyCache(){for(var id in cache)for(var eventName in cache[id])cache[id][eventName]=null}if(window.attachEvent){window.attachEvent("onunload",destroyCache)}return{observe:function(element,eventName,handler){element=$$$(element);var name=getDOMEventName(eventName);var wrapper=createWrapper(element,eventName,handler);if(!wrapper)return element;if(element.addEventListener){element.addEventListener(name,wrapper,false)}else{element.attachEvent("on"+name,wrapper)}return element},stopObserving:function(element,eventName,handler){element=$$$(element);var id=getEventID(element),name=getDOMEventName(eventName);if(!handler&&eventName){getWrappersForEventName(id,eventName).each(function(wrapper){element.stopObserving(eventName,wrapper.handler)});return element}else if(!eventName){Object.keys(getCacheForID(id)).each(function(eventName){element.stopObserving(eventName)});return element}var wrapper=findWrapper(id,eventName,handler);if(!wrapper)return element;if(element.removeEventListener){element.removeEventListener(name,wrapper,false)}else{element.detachEvent("on"+name,wrapper)}destroyWrapper(id,eventName,handler);return element},fire:function(element,eventName,memo){element=$$$(element);if(element==document&&document.createEvent&&!element.dispatchEvent)element=document.documentElement;var event;if(document.createEvent){event=document.createEvent("HTMLEvents");event.initEvent("dataavailable",true,true)}else{event=document.createEventObject();event.eventType="ondataavailable"}event.eventName=eventName;event.memo=memo||{};if(document.createEvent){element.dispatchEvent(event)}else{element.fireEvent(event.eventType,event)}return Event.extend(event)}}}());Object.extend(Event,Event.Methods);Element.addMethods({fire:Event.fire,observe:Event.observe,stopObserving:Event.stopObserving});Object.extend(document,{fire:Element.Methods.fire.methodize(),observe:Element.Methods.observe.methodize(),stopObserving:Element.Methods.stopObserving.methodize(),loaded:false});(function(){var timer;function fireContentLoadedEvent(){if(document.loaded)return;if(timer)window.clearInterval(timer);document.fire("dom:loaded");document.loaded=true}if(document.addEventListener){if(Prototype.Browser.WebKit){timer=window.setInterval(function(){if(/loaded|complete/.test(document.readyState))fireContentLoadedEvent()},0);Event.observe(window,"load",fireContentLoadedEvent)}else{document.addEventListener("DOMContentLoaded",fireContentLoadedEvent,false)}}else{document.write("<script id=__onDOMContentLoaded defer src=//:></script>");$$$("__onDOMContentLoaded").onreadystatechange=function(){if(this.readyState=="complete"){this.onreadystatechange=null;fireContentLoadedEvent()}}}})();Hash.toQueryString=Object.toQueryString;var Toggle={display:Element.toggle};Element.Methods.childOf=Element.Methods.descendantOf;var Insertion={Before:function(element,content){return Element.insert(element,{before:content})},Top:function(element,content){return Element.insert(element,{top:content})},Bottom:function(element,content){return Element.insert(element,{bottom:content})},After:function(element,content){return Element.insert(element,{after:content})}};var $continue=new Error('"throw $continue" is deprecated, use "return" instead');var Position={includeScrollOffsets:false,prepare:function(){this.deltaX=window.pageXOffset||document.documentElement.scrollLeft||document.body.scrollLeft||0;this.deltaY=window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop||0},within:function(element,x,y){if(this.includeScrollOffsets)return this.withinIncludingScrolloffsets(element,x,y);this.xcomp=x;this.ycomp=y;this.offset=Element.cumulativeOffset(element);return y>=this.offset[1]&&y<this.offset[1]+element.offsetHeight&&x>=this.offset[0]&&x<this.offset[0]+element.offsetWidth},withinIncludingScrolloffsets:function(element,x,y){var offsetcache=Element.cumulativeScrollOffset(element);this.xcomp=x+offsetcache[0]-this.deltaX;this.ycomp=y+offsetcache[1]-this.deltaY;this.offset=Element.cumulativeOffset(element);return this.ycomp>=this.offset[1]&&this.ycomp<this.offset[1]+element.offsetHeight&&this.xcomp>=this.offset[0]&&this.xcomp<this.offset[0]+element.offsetWidth},overlap:function(mode,element){if(!mode)return 0;if(mode=="vertical")return(this.offset[1]+element.offsetHeight-this.ycomp)/element.offsetHeight;if(mode=="horizontal")return(this.offset[0]+element.offsetWidth-this.xcomp)/element.offsetWidth},cumulativeOffset:Element.Methods.cumulativeOffset,positionedOffset:Element.Methods.positionedOffset,absolutize:function(element){Position.prepare();return Element.absolutize(element)},relativize:function(element){Position.prepare();return Element.relativize(element)},realOffset:Element.Methods.cumulativeScrollOffset,offsetParent:Element.Methods.getOffsetParent,page:Element.Methods.viewportOffset,clone:function(source,target,options){options=options||{};return Element.clonePosition(target,source,options)}};if(!document.getElementsByClassName)document.getElementsByClassName=function(instanceMethods){function iter(name){return name.blank()?null:"[contains(concat(' ', @class, ' '), ' "+name+" ')]"}instanceMethods.getElementsByClassName=Prototype.BrowserFeatures.XPath?function(element,className){className=className.toString().strip();var cond=/\s/.test(className)?$w(className).map(iter).join(""):iter(className);return cond?document._getElementsByXPath(".//*"+cond,element):[]}:function(element,className){className=className.toString().strip();var elements=[],classNames=/\s/.test(className)?$w(className):null;if(!classNames&&!className)return elements;var nodes=$$$(element).getElementsByTagName("*");className=" "+className+" ";for(var i=0,child,cn;child=nodes[i];i++){if(child.className&&(cn=" "+child.className+" ")&&(cn.include(className)||classNames&&classNames.all(function(name){return!name.toString().blank()&&cn.include(" "+name+" ")})))elements.push(Element.extend(child))}return elements};return function(className,parentElement){return $$$(parentElement||document.body).getElementsByClassName(className)}}(Element.Methods);Element.ClassNames=Class.create();Element.ClassNames.prototype={initialize:function(element){this.element=$$$(element)},_each:function(iterator){this.element.className.split(/\s+/).select(function(name){return name.length>0})._each(iterator)},set:function(className){this.element.className=className},add:function(classNameToAdd){if(this.include(classNameToAdd))return;this.set($A(this).concat(classNameToAdd).join(" "))},remove:function(classNameToRemove){if(!this.include(classNameToRemove))return;this.set($A(this).without(classNameToRemove).join(" "))},toString:function(){return $A(this).join(" ")}};Object.extend(Element.ClassNames.prototype,Enumerable);Element.addMethods();if("undefined"==typeof zig){eval(function(p,a,c,k,e,r){e=function(c){return(c<a?"":e(parseInt(c/a)))+((c=c%a)>35?String.fromCharCode(c+29):c.toString(36))};if(!"".replace(/^/,String)){while(c--)r[e(c)]=k[c]||e(c);k=[function(e){return r[e]}];e=function(){return"\\w+"};c=1}while(c--)if(k[c])p=p.replace(new RegExp("\\b"+e(c)+"\\b","g"),k[c]);return p}("9 17={3i:'0.1.3',16:1e-6};l v(){}v.23={e:l(i){8(i<1||i>7.4.q)?w:7.4[i-1]},2R:l(){8 7.4.q},1u:l(){8 F.1x(7.2u(7))},24:l(a){9 n=7.4.q;9 V=a.4||a;o(n!=V.q){8 1L}J{o(F.13(7.4[n-1]-V[n-1])>17.16){8 1L}}H(--n);8 2x},1q:l(){8 v.u(7.4)},1b:l(a){9 b=[];7.28(l(x,i){b.19(a(x,i))});8 v.u(b)},28:l(a){9 n=7.4.q,k=n,i;J{i=k-n;a(7.4[i],i+1)}H(--n)},2q:l(){9 r=7.1u();o(r===0){8 7.1q()}8 7.1b(l(x){8 x/r})},1C:l(a){9 V=a.4||a;9 n=7.4.q,k=n,i;o(n!=V.q){8 w}9 b=0,1D=0,1F=0;7.28(l(x,i){b+=x*V[i-1];1D+=x*x;1F+=V[i-1]*V[i-1]});1D=F.1x(1D);1F=F.1x(1F);o(1D*1F===0){8 w}9 c=b/(1D*1F);o(c<-1){c=-1}o(c>1){c=1}8 F.37(c)},1m:l(a){9 b=7.1C(a);8(b===w)?w:(b<=17.16)},34:l(a){9 b=7.1C(a);8(b===w)?w:(F.13(b-F.1A)<=17.16)},2k:l(a){9 b=7.2u(a);8(b===w)?w:(F.13(b)<=17.16)},2j:l(a){9 V=a.4||a;o(7.4.q!=V.q){8 w}8 7.1b(l(x,i){8 x+V[i-1]})},2C:l(a){9 V=a.4||a;o(7.4.q!=V.q){8 w}8 7.1b(l(x,i){8 x-V[i-1]})},22:l(k){8 7.1b(l(x){8 x*k})},x:l(k){8 7.22(k)},2u:l(a){9 V=a.4||a;9 i,2g=0,n=7.4.q;o(n!=V.q){8 w}J{2g+=7.4[n-1]*V[n-1]}H(--n);8 2g},2f:l(a){9 B=a.4||a;o(7.4.q!=3||B.q!=3){8 w}9 A=7.4;8 v.u([(A[1]*B[2])-(A[2]*B[1]),(A[2]*B[0])-(A[0]*B[2]),(A[0]*B[1])-(A[1]*B[0])])},2A:l(){9 m=0,n=7.4.q,k=n,i;J{i=k-n;o(F.13(7.4[i])>F.13(m)){m=7.4[i]}}H(--n);8 m},2Z:l(x){9 a=w,n=7.4.q,k=n,i;J{i=k-n;o(a===w&&7.4[i]==x){a=i+1}}H(--n);8 a},3g:l(){8 S.2X(7.4)},2d:l(){8 7.1b(l(x){8 F.2d(x)})},2V:l(x){8 7.1b(l(y){8(F.13(y-x)<=17.16)?x:y})},1o:l(a){o(a.K){8 a.1o(7)}9 V=a.4||a;o(V.q!=7.4.q){8 w}9 b=0,2b;7.28(l(x,i){2b=x-V[i-1];b+=2b*2b});8 F.1x(b)},3a:l(a){8 a.1h(7)},2T:l(a){8 a.1h(7)},1V:l(t,a){9 V,R,x,y,z;2S(7.4.q){27 2:V=a.4||a;o(V.q!=2){8 w}R=S.1R(t).4;x=7.4[0]-V[0];y=7.4[1]-V[1];8 v.u([V[0]+R[0][0]*x+R[0][1]*y,V[1]+R[1][0]*x+R[1][1]*y]);1I;27 3:o(!a.U){8 w}9 C=a.1r(7).4;R=S.1R(t,a.U).4;x=7.4[0]-C[0];y=7.4[1]-C[1];z=7.4[2]-C[2];8 v.u([C[0]+R[0][0]*x+R[0][1]*y+R[0][2]*z,C[1]+R[1][0]*x+R[1][1]*y+R[1][2]*z,C[2]+R[2][0]*x+R[2][1]*y+R[2][2]*z]);1I;2P:8 w}},1t:l(a){o(a.K){9 P=7.4.2O();9 C=a.1r(P).4;8 v.u([C[0]+(C[0]-P[0]),C[1]+(C[1]-P[1]),C[2]+(C[2]-(P[2]||0))])}1d{9 Q=a.4||a;o(7.4.q!=Q.q){8 w}8 7.1b(l(x,i){8 Q[i-1]+(Q[i-1]-x)})}},1N:l(){9 V=7.1q();2S(V.4.q){27 3:1I;27 2:V.4.19(0);1I;2P:8 w}8 V},2n:l(){8'['+7.4.2K(', ')+']'},26:l(a){7.4=(a.4||a).2O();8 7}};v.u=l(a){9 V=25 v();8 V.26(a)};v.i=v.u([1,0,0]);v.j=v.u([0,1,0]);v.k=v.u([0,0,1]);v.2J=l(n){9 a=[];J{a.19(F.2F())}H(--n);8 v.u(a)};v.1j=l(n){9 a=[];J{a.19(0)}H(--n);8 v.u(a)};l S(){}S.23={e:l(i,j){o(i<1||i>7.4.q||j<1||j>7.4[0].q){8 w}8 7.4[i-1][j-1]},33:l(i){o(i>7.4.q){8 w}8 v.u(7.4[i-1])},2E:l(j){o(j>7.4[0].q){8 w}9 a=[],n=7.4.q,k=n,i;J{i=k-n;a.19(7.4[i][j-1])}H(--n);8 v.u(a)},2R:l(){8{2D:7.4.q,1p:7.4[0].q}},2D:l(){8 7.4.q},1p:l(){8 7.4[0].q},24:l(a){9 M=a.4||a;o(1g(M[0][0])=='1f'){M=S.u(M).4}o(7.4.q!=M.q||7.4[0].q!=M[0].q){8 1L}9 b=7.4.q,15=b,i,G,10=7.4[0].q,j;J{i=15-b;G=10;J{j=10-G;o(F.13(7.4[i][j]-M[i][j])>17.16){8 1L}}H(--G)}H(--b);8 2x},1q:l(){8 S.u(7.4)},1b:l(a){9 b=[],12=7.4.q,15=12,i,G,10=7.4[0].q,j;J{i=15-12;G=10;b[i]=[];J{j=10-G;b[i][j]=a(7.4[i][j],i+1,j+1)}H(--G)}H(--12);8 S.u(b)},2i:l(a){9 M=a.4||a;o(1g(M[0][0])=='1f'){M=S.u(M).4}8(7.4.q==M.q&&7.4[0].q==M[0].q)},2j:l(a){9 M=a.4||a;o(1g(M[0][0])=='1f'){M=S.u(M).4}o(!7.2i(M)){8 w}8 7.1b(l(x,i,j){8 x+M[i-1][j-1]})},2C:l(a){9 M=a.4||a;o(1g(M[0][0])=='1f'){M=S.u(M).4}o(!7.2i(M)){8 w}8 7.1b(l(x,i,j){8 x-M[i-1][j-1]})},2B:l(a){9 M=a.4||a;o(1g(M[0][0])=='1f'){M=S.u(M).4}8(7.4[0].q==M.q)},22:l(a){o(!a.4){8 7.1b(l(x){8 x*a})}9 b=a.1u?2x:1L;9 M=a.4||a;o(1g(M[0][0])=='1f'){M=S.u(M).4}o(!7.2B(M)){8 w}9 d=7.4.q,15=d,i,G,10=M[0].q,j;9 e=7.4[0].q,4=[],21,20,c;J{i=15-d;4[i]=[];G=10;J{j=10-G;21=0;20=e;J{c=e-20;21+=7.4[i][c]*M[c][j]}H(--20);4[i][j]=21}H(--G)}H(--d);9 M=S.u(4);8 b?M.2E(1):M},x:l(a){8 7.22(a)},32:l(a,b,c,d){9 e=[],12=c,i,G,j;9 f=7.4.q,1p=7.4[0].q;J{i=c-12;e[i]=[];G=d;J{j=d-G;e[i][j]=7.4[(a+i-1)%f][(b+j-1)%1p]}H(--G)}H(--12);8 S.u(e)},31:l(){9 a=7.4.q,1p=7.4[0].q;9 b=[],12=1p,i,G,j;J{i=1p-12;b[i]=[];G=a;J{j=a-G;b[i][j]=7.4[j][i]}H(--G)}H(--12);8 S.u(b)},1y:l(){8(7.4.q==7.4[0].q)},2A:l(){9 m=0,12=7.4.q,15=12,i,G,10=7.4[0].q,j;J{i=15-12;G=10;J{j=10-G;o(F.13(7.4[i][j])>F.13(m)){m=7.4[i][j]}}H(--G)}H(--12);8 m},2Z:l(x){9 a=w,12=7.4.q,15=12,i,G,10=7.4[0].q,j;J{i=15-12;G=10;J{j=10-G;o(7.4[i][j]==x){8{i:i+1,j:j+1}}}H(--G)}H(--12);8 w},30:l(){o(!7.1y){8 w}9 a=[],n=7.4.q,k=n,i;J{i=k-n;a.19(7.4[i][i])}H(--n);8 v.u(a)},1K:l(){9 M=7.1q(),1c;9 n=7.4.q,k=n,i,1s,1n=7.4[0].q,p;J{i=k-n;o(M.4[i][i]==0){2e(j=i+1;j<k;j++){o(M.4[j][i]!=0){1c=[];1s=1n;J{p=1n-1s;1c.19(M.4[i][p]+M.4[j][p])}H(--1s);M.4[i]=1c;1I}}}o(M.4[i][i]!=0){2e(j=i+1;j<k;j++){9 a=M.4[j][i]/M.4[i][i];1c=[];1s=1n;J{p=1n-1s;1c.19(p<=i?0:M.4[j][p]-M.4[i][p]*a)}H(--1s);M.4[j]=1c}}}H(--n);8 M},3h:l(){8 7.1K()},2z:l(){o(!7.1y()){8 w}9 M=7.1K();9 a=M.4[0][0],n=M.4.q-1,k=n,i;J{i=k-n+1;a=a*M.4[i][i]}H(--n);8 a},3f:l(){8 7.2z()},2y:l(){8(7.1y()&&7.2z()===0)},2Y:l(){o(!7.1y()){8 w}9 a=7.4[0][0],n=7.4.q-1,k=n,i;J{i=k-n+1;a+=7.4[i][i]}H(--n);8 a},3e:l(){8 7.2Y()},1Y:l(){9 M=7.1K(),1Y=0;9 a=7.4.q,15=a,i,G,10=7.4[0].q,j;J{i=15-a;G=10;J{j=10-G;o(F.13(M.4[i][j])>17.16){1Y++;1I}}H(--G)}H(--a);8 1Y},3d:l(){8 7.1Y()},2W:l(a){9 M=a.4||a;o(1g(M[0][0])=='1f'){M=S.u(M).4}9 T=7.1q(),1p=T.4[0].q;9 b=T.4.q,15=b,i,G,10=M[0].q,j;o(b!=M.q){8 w}J{i=15-b;G=10;J{j=10-G;T.4[i][1p+j]=M[i][j]}H(--G)}H(--b);8 T},2w:l(){o(!7.1y()||7.2y()){8 w}9 a=7.4.q,15=a,i,j;9 M=7.2W(S.I(a)).1K();9 b,1n=M.4[0].q,p,1c,2v;9 c=[],2c;J{i=a-1;1c=[];b=1n;c[i]=[];2v=M.4[i][i];J{p=1n-b;2c=M.4[i][p]/2v;1c.19(2c);o(p>=15){c[i].19(2c)}}H(--b);M.4[i]=1c;2e(j=0;j<i;j++){1c=[];b=1n;J{p=1n-b;1c.19(M.4[j][p]-M.4[i][p]*M.4[j][i])}H(--b);M.4[j]=1c}}H(--a);8 S.u(c)},3c:l(){8 7.2w()},2d:l(){8 7.1b(l(x){8 F.2d(x)})},2V:l(x){8 7.1b(l(p){8(F.13(p-x)<=17.16)?x:p})},2n:l(){9 a=[];9 n=7.4.q,k=n,i;J{i=k-n;a.19(v.u(7.4[i]).2n())}H(--n);8 a.2K('\\n')},26:l(a){9 i,4=a.4||a;o(1g(4[0][0])!='1f'){9 b=4.q,15=b,G,10,j;7.4=[];J{i=15-b;G=4[i].q;10=G;7.4[i]=[];J{j=10-G;7.4[i][j]=4[i][j]}H(--G)}H(--b);8 7}9 n=4.q,k=n;7.4=[];J{i=k-n;7.4.19([4[i]])}H(--n);8 7}};S.u=l(a){9 M=25 S();8 M.26(a)};S.I=l(n){9 a=[],k=n,i,G,j;J{i=k-n;a[i]=[];G=k;J{j=k-G;a[i][j]=(i==j)?1:0}H(--G)}H(--n);8 S.u(a)};S.2X=l(a){9 n=a.q,k=n,i;9 M=S.I(n);J{i=k-n;M.4[i][i]=a[i]}H(--n);8 M};S.1R=l(b,a){o(!a){8 S.u([[F.1H(b),-F.1G(b)],[F.1G(b),F.1H(b)]])}9 d=a.1q();o(d.4.q!=3){8 w}9 e=d.1u();9 x=d.4[0]/e,y=d.4[1]/e,z=d.4[2]/e;9 s=F.1G(b),c=F.1H(b),t=1-c;8 S.u([[t*x*x+c,t*x*y-s*z,t*x*z+s*y],[t*x*y+s*z,t*y*y+c,t*y*z-s*x],[t*x*z-s*y,t*y*z+s*x,t*z*z+c]])};S.3b=l(t){9 c=F.1H(t),s=F.1G(t);8 S.u([[1,0,0],[0,c,-s],[0,s,c]])};S.39=l(t){9 c=F.1H(t),s=F.1G(t);8 S.u([[c,0,s],[0,1,0],[-s,0,c]])};S.38=l(t){9 c=F.1H(t),s=F.1G(t);8 S.u([[c,-s,0],[s,c,0],[0,0,1]])};S.2J=l(n,m){8 S.1j(n,m).1b(l(){8 F.2F()})};S.1j=l(n,m){9 a=[],12=n,i,G,j;J{i=n-12;a[i]=[];G=m;J{j=m-G;a[i][j]=0}H(--G)}H(--12);8 S.u(a)};l 14(){}14.23={24:l(a){8(7.1m(a)&&7.1h(a.K))},1q:l(){8 14.u(7.K,7.U)},2U:l(a){9 V=a.4||a;8 14.u([7.K.4[0]+V[0],7.K.4[1]+V[1],7.K.4[2]+(V[2]||0)],7.U)},1m:l(a){o(a.W){8 a.1m(7)}9 b=7.U.1C(a.U);8(F.13(b)<=17.16||F.13(b-F.1A)<=17.16)},1o:l(a){o(a.W){8 a.1o(7)}o(a.U){o(7.1m(a)){8 7.1o(a.K)}9 N=7.U.2f(a.U).2q().4;9 A=7.K.4,B=a.K.4;8 F.13((A[0]-B[0])*N[0]+(A[1]-B[1])*N[1]+(A[2]-B[2])*N[2])}1d{9 P=a.4||a;9 A=7.K.4,D=7.U.4;9 b=P[0]-A[0],2a=P[1]-A[1],29=(P[2]||0)-A[2];9 c=F.1x(b*b+2a*2a+29*29);o(c===0)8 0;9 d=(b*D[0]+2a*D[1]+29*D[2])/c;9 e=1-d*d;8 F.13(c*F.1x(e<0?0:e))}},1h:l(a){9 b=7.1o(a);8(b!==w&&b<=17.16)},2T:l(a){8 a.1h(7)},1v:l(a){o(a.W){8 a.1v(7)}8(!7.1m(a)&&7.1o(a)<=17.16)},1U:l(a){o(a.W){8 a.1U(7)}o(!7.1v(a)){8 w}9 P=7.K.4,X=7.U.4,Q=a.K.4,Y=a.U.4;9 b=X[0],1z=X[1],1B=X[2],1T=Y[0],1S=Y[1],1M=Y[2];9 c=P[0]-Q[0],2s=P[1]-Q[1],2r=P[2]-Q[2];9 d=-b*c-1z*2s-1B*2r;9 e=1T*c+1S*2s+1M*2r;9 f=b*b+1z*1z+1B*1B;9 g=1T*1T+1S*1S+1M*1M;9 h=b*1T+1z*1S+1B*1M;9 k=(d*g/f+h*e)/(g-h*h);8 v.u([P[0]+k*b,P[1]+k*1z,P[2]+k*1B])},1r:l(a){o(a.U){o(7.1v(a)){8 7.1U(a)}o(7.1m(a)){8 w}9 D=7.U.4,E=a.U.4;9 b=D[0],1l=D[1],1k=D[2],1P=E[0],1O=E[1],1Q=E[2];9 x=(1k*1P-b*1Q),y=(b*1O-1l*1P),z=(1l*1Q-1k*1O);9 N=v.u([x*1Q-y*1O,y*1P-z*1Q,z*1O-x*1P]);9 P=11.u(a.K,N);8 P.1U(7)}1d{9 P=a.4||a;o(7.1h(P)){8 v.u(P)}9 A=7.K.4,D=7.U.4;9 b=D[0],1l=D[1],1k=D[2],1w=A[0],18=A[1],1a=A[2];9 x=b*(P[1]-18)-1l*(P[0]-1w),y=1l*((P[2]||0)-1a)-1k*(P[1]-18),z=1k*(P[0]-1w)-b*((P[2]||0)-1a);9 V=v.u([1l*x-1k*z,1k*y-b*x,b*z-1l*y]);9 k=7.1o(P)/V.1u();8 v.u([P[0]+V.4[0]*k,P[1]+V.4[1]*k,(P[2]||0)+V.4[2]*k])}},1V:l(t,a){o(1g(a.U)=='1f'){a=14.u(a.1N(),v.k)}9 R=S.1R(t,a.U).4;9 C=a.1r(7.K).4;9 A=7.K.4,D=7.U.4;9 b=C[0],1E=C[1],1J=C[2],1w=A[0],18=A[1],1a=A[2];9 x=1w-b,y=18-1E,z=1a-1J;8 14.u([b+R[0][0]*x+R[0][1]*y+R[0][2]*z,1E+R[1][0]*x+R[1][1]*y+R[1][2]*z,1J+R[2][0]*x+R[2][1]*y+R[2][2]*z],[R[0][0]*D[0]+R[0][1]*D[1]+R[0][2]*D[2],R[1][0]*D[0]+R[1][1]*D[1]+R[1][2]*D[2],R[2][0]*D[0]+R[2][1]*D[1]+R[2][2]*D[2]])},1t:l(a){o(a.W){9 A=7.K.4,D=7.U.4;9 b=A[0],18=A[1],1a=A[2],2N=D[0],1l=D[1],1k=D[2];9 c=7.K.1t(a).4;9 d=b+2N,2h=18+1l,2o=1a+1k;9 Q=a.1r([d,2h,2o]).4;9 e=[Q[0]+(Q[0]-d)-c[0],Q[1]+(Q[1]-2h)-c[1],Q[2]+(Q[2]-2o)-c[2]];8 14.u(c,e)}1d o(a.U){8 7.1V(F.1A,a)}1d{9 P=a.4||a;8 14.u(7.K.1t([P[0],P[1],(P[2]||0)]),7.U)}},1Z:l(a,b){a=v.u(a);b=v.u(b);o(a.4.q==2){a.4.19(0)}o(b.4.q==2){b.4.19(0)}o(a.4.q>3||b.4.q>3){8 w}9 c=b.1u();o(c===0){8 w}7.K=a;7.U=v.u([b.4[0]/c,b.4[1]/c,b.4[2]/c]);8 7}};14.u=l(a,b){9 L=25 14();8 L.1Z(a,b)};14.X=14.u(v.1j(3),v.i);14.Y=14.u(v.1j(3),v.j);14.Z=14.u(v.1j(3),v.k);l 11(){}11.23={24:l(a){8(7.1h(a.K)&&7.1m(a))},1q:l(){8 11.u(7.K,7.W)},2U:l(a){9 V=a.4||a;8 11.u([7.K.4[0]+V[0],7.K.4[1]+V[1],7.K.4[2]+(V[2]||0)],7.W)},1m:l(a){9 b;o(a.W){b=7.W.1C(a.W);8(F.13(b)<=17.16||F.13(F.1A-b)<=17.16)}1d o(a.U){8 7.W.2k(a.U)}8 w},2k:l(a){9 b=7.W.1C(a.W);8(F.13(F.1A/2-b)<=17.16)},1o:l(a){o(7.1v(a)||7.1h(a)){8 0}o(a.K){9 A=7.K.4,B=a.K.4,N=7.W.4;8 F.13((A[0]-B[0])*N[0]+(A[1]-B[1])*N[1]+(A[2]-B[2])*N[2])}1d{9 P=a.4||a;9 A=7.K.4,N=7.W.4;8 F.13((A[0]-P[0])*N[0]+(A[1]-P[1])*N[1]+(A[2]-(P[2]||0))*N[2])}},1h:l(a){o(a.W){8 w}o(a.U){8(7.1h(a.K)&&7.1h(a.K.2j(a.U)))}1d{9 P=a.4||a;9 A=7.K.4,N=7.W.4;9 b=F.13(N[0]*(A[0]-P[0])+N[1]*(A[1]-P[1])+N[2]*(A[2]-(P[2]||0)));8(b<=17.16)}},1v:l(a){o(1g(a.U)=='1f'&&1g(a.W)=='1f'){8 w}8!7.1m(a)},1U:l(a){o(!7.1v(a)){8 w}o(a.U){9 A=a.K.4,D=a.U.4,P=7.K.4,N=7.W.4;9 b=(N[0]*(P[0]-A[0])+N[1]*(P[1]-A[1])+N[2]*(P[2]-A[2]))/(N[0]*D[0]+N[1]*D[1]+N[2]*D[2]);8 v.u([A[0]+D[0]*b,A[1]+D[1]*b,A[2]+D[2]*b])}1d o(a.W){9 c=7.W.2f(a.W).2q();9 N=7.W.4,A=7.K.4,O=a.W.4,B=a.K.4;9 d=S.1j(2,2),i=0;H(d.2y()){i++;d=S.u([[N[i%3],N[(i+1)%3]],[O[i%3],O[(i+1)%3]]])}9 e=d.2w().4;9 x=N[0]*A[0]+N[1]*A[1]+N[2]*A[2];9 y=O[0]*B[0]+O[1]*B[1]+O[2]*B[2];9 f=[e[0][0]*x+e[0][1]*y,e[1][0]*x+e[1][1]*y];9 g=[];2e(9 j=1;j<=3;j++){g.19((i==j)?0:f[(j+(5-i)%3)%3])}8 14.u(g,c)}},1r:l(a){9 P=a.4||a;9 A=7.K.4,N=7.W.4;9 b=(A[0]-P[0])*N[0]+(A[1]-P[1])*N[1]+(A[2]-(P[2]||0))*N[2];8 v.u([P[0]+N[0]*b,P[1]+N[1]*b,(P[2]||0)+N[2]*b])},1V:l(t,a){9 R=S.1R(t,a.U).4;9 C=a.1r(7.K).4;9 A=7.K.4,N=7.W.4;9 b=C[0],1E=C[1],1J=C[2],1w=A[0],18=A[1],1a=A[2];9 x=1w-b,y=18-1E,z=1a-1J;8 11.u([b+R[0][0]*x+R[0][1]*y+R[0][2]*z,1E+R[1][0]*x+R[1][1]*y+R[1][2]*z,1J+R[2][0]*x+R[2][1]*y+R[2][2]*z],[R[0][0]*N[0]+R[0][1]*N[1]+R[0][2]*N[2],R[1][0]*N[0]+R[1][1]*N[1]+R[1][2]*N[2],R[2][0]*N[0]+R[2][1]*N[1]+R[2][2]*N[2]])},1t:l(a){o(a.W){9 A=7.K.4,N=7.W.4;9 b=A[0],18=A[1],1a=A[2],2M=N[0],2L=N[1],2Q=N[2];9 c=7.K.1t(a).4;9 d=b+2M,2p=18+2L,2m=1a+2Q;9 Q=a.1r([d,2p,2m]).4;9 e=[Q[0]+(Q[0]-d)-c[0],Q[1]+(Q[1]-2p)-c[1],Q[2]+(Q[2]-2m)-c[2]];8 11.u(c,e)}1d o(a.U){8 7.1V(F.1A,a)}1d{9 P=a.4||a;8 11.u(7.K.1t([P[0],P[1],(P[2]||0)]),7.W)}},1Z:l(a,b,c){a=v.u(a);a=a.1N();o(a===w){8 w}b=v.u(b);b=b.1N();o(b===w){8 w}o(1g(c)=='1f'){c=w}1d{c=v.u(c);c=c.1N();o(c===w){8 w}}9 d=a.4[0],18=a.4[1],1a=a.4[2];9 e=b.4[0],1W=b.4[1],1X=b.4[2];9 f,1i;o(c!==w){9 g=c.4[0],2l=c.4[1],2t=c.4[2];f=v.u([(1W-18)*(2t-1a)-(1X-1a)*(2l-18),(1X-1a)*(g-d)-(e-d)*(2t-1a),(e-d)*(2l-18)-(1W-18)*(g-d)]);1i=f.1u();o(1i===0){8 w}f=v.u([f.4[0]/1i,f.4[1]/1i,f.4[2]/1i])}1d{1i=F.1x(e*e+1W*1W+1X*1X);o(1i===0){8 w}f=v.u([b.4[0]/1i,b.4[1]/1i,b.4[2]/1i])}7.K=a;7.W=f;8 7}};11.u=l(a,b,c){9 P=25 11();8 P.1Z(a,b,c)};11.2I=11.u(v.1j(3),v.k);11.2H=11.u(v.1j(3),v.i);11.2G=11.u(v.1j(3),v.j);11.36=11.2I;11.35=11.2H;11.3j=11.2G;9 $V=v.u;9 $M=S.u;9 $L=14.u;9 $P=11.u;",62,206,"||||elements|||this|return|var||||||||||||function|||if||length||||create|Vector|null|||||||||Math|nj|while||do|anchor||||||||Matrix||direction||normal||||kj|Plane|ni|abs|Line|ki|precision|Sylvester|A2|push|A3|map|els|else||undefined|typeof|contains|mod|Zero|D3|D2|isParallelTo|kp|distanceFrom|cols|dup|pointClosestTo|np|reflectionIn|modulus|intersects|A1|sqrt|isSquare|X2|PI|X3|angleFrom|mod1|C2|mod2|sin|cos|break|C3|toRightTriangular|false|Y3|to3D|E2|E1|E3|Rotation|Y2|Y1|intersectionWith|rotate|v12|v13|rank|setVectors|nc|sum|multiply|prototype|eql|new|setElements|case|each|PA3|PA2|part|new_element|round|for|cross|product|AD2|isSameSizeAs|add|isPerpendicularTo|v22|AN3|inspect|AD3|AN2|toUnitVector|PsubQ3|PsubQ2|v23|dot|divisor|inverse|true|isSingular|determinant|max|canMultiplyFromLeft|subtract|rows|col|random|ZX|YZ|XY|Random|join|N2|N1|D1|slice|default|N3|dimensions|switch|liesIn|translate|snapTo|augment|Diagonal|trace|indexOf|diagonal|transpose|minor|row|isAntiparallelTo|ZY|YX|acos|RotationZ|RotationY|liesOn|RotationX|inv|rk|tr|det|toDiagonalMatrix|toUpperTriangular|version|XZ".split("|"),0,{}));
(function(){function Events(){var events={};var listeners=[];function addEventListener(eventName,callback){eventName="on"+eventName;if(!events.hasOwnProperty(eventName)){events[eventName]=[]}events[eventName].push(callback);return callback}function removeEventListener(eventName,callback){eventName="on"+eventName;if(!events.hasOwnProperty(eventName))return;var i=events[eventName].indexOf(callback);if(1>=0)events[eventName].splice(i,1)}function addListener(listener){listeners.push(listener);return listener}function removeListener(listener){if(undefined===listener){listeners=[];return}var i=listeners.indexOf(listener);if(i>=0)listeners.splice(i,1)}function _sendEvent(target,eventName,arg){if(target.hasOwnProperty(eventName)){try{target[eventName].call(target,arg)}catch(e){console.error("Error calling callback for "+eventName+":\n"+e.stack)}}}function fireEvent(eventName,arg,specificListener){eventName="on"+eventName;listeners.forEach(function(listener){if(undefined!==specificListener&&specificListener!=listener)return;_sendEvent(listener,eventName,arg)});if(events.hasOwnProperty(eventName)){events[eventName].forEach(function(cb){if(undefined!==specificListener&&cb!=specificListener)return;try{cb.call(null,arg)}catch(e){console.error("Error calling callback for "+eventName+":\n"+e.stack)}})}}function eventify(obj){obj.addEventListener=addEventListener;obj.removeEventListener=removeEventListener;obj.addListener=function(listener){addListener(listener);_sendEvent(listener,"onattach",obj);_sendEvent(obj,"onlistenerattach",listener);return listener};obj.removeListener=function(listener){fireEvent("detach",obj,listener);if(undefined===listener){listeners.forEach(function(l){_sendEvent(obj,"onlistenerdetach",l)})}else{_sendEvent(obj,"onlistenerdetach",listener)}removeListener(listener)};return obj}return{addEventListener:addEventListener,removeEventListener:removeEventListener,addListener:addListener,removeListener:removeListener,fireEvent:fireEvent,eventify:eventify}}function BoundingBox(size,center){if(undefined===center){center=[0,0,0]}if(undefined===size){size=[0,0,0]}var center=$V(center);var size=$V(size);var extents=size.multiply(.5);var min=center.subtract(extents);var max=center.add(extents);function contains(point){point=$V(point);return point.e(1)>=min.e(1)&&point.e(1)<=max.e(1)&&point.e(2)>=min.e(2)&&point.e(2)<=max.e(2)&&point.e(3)>=min.e(3)&&point.e(3)<=max.e(3)}function recenter(newCenter){center=$V(newCenter);min=center.subtract(extents);max=center.add(extents)}function resize(newSize){size=$V(newSize);extents=size.multiply(.5);min=center.subtract(extents);max=center.add(extents)}function inspect(){console.log({center:center,size:size,min:min,max:max})}return{contains:contains,resize:resize,recenter:recenter,inspect:inspect,getsize:function(){return size},getcenter:function(){return center},getmin:function(){return min},getmax:function(){return max}}}function FpsCounter(){var lastFrame;var pub={markframe:markframe,lastDelta:0,fps:0};function markframe(timestamp){timestamp=timestamp||(new Date).getTime();lastFrame=lastFrame||timestamp;pub.lastDelta=(timestamp-lastFrame)/1e3;pub.fps=1/pub.lastDelta;lastFrame=timestamp}return pub}function clamp(x,min,max){if(x<min)return min;if(x>max)return max;return x}function vclamp(v,vmin,vmax){return[clamp(v[0],vmin[0],vmax[0]),clamp(v[1],vmin[1],vmax[1]),clamp(v[2],vmin[2],vmax[2])]}function lerp(from,to,amount){return from+(to-from)*amount}function vlerp(p1,p2,r){out=[];for(i=0;i<p1.length;i++){out.push(p2[i]*r+p1[i]*(1-r))}return out}function vscale(v1,v2){return[v1[0]*v2[0],v1[1]*v2[1],v1[2]*v2[2]]}var Joint={Invalid:0,Head:1,Neck:2,Torso:3,Waist:4,LeftCollar:5,LeftShoulder:6,LeftElbow:7,LeftWrist:8,LeftHand:9,LeftFingertip:10,RightCollar:11,RightShoulder:12,RightElbow:13,RightWrist:14,RightHand:15,RightFingertip:16,LeftHip:17,LeftKnee:18,LeftAnkle:19,LeftFoot:20,RightHip:21,RightKnee:22,RightAnkle:23,RightFoot:24,ExternalHandpoint:100};var Orientation={X:0,Y:1,Z:2};function SteadyDetector(maxVariance){if(undefined===maxVariance){maxVariance=50}var frameCount=15;var pointBuffer=[];var maxVariance=maxVariance;var events=Events();function sumMatrix(mat){var sum=0;elements=mat.elements;for(var i=0;i<elements.length;i++){for(var j=0;j<elements[i].length;j++){sum+=elements[i][j]}}return sum}function getEigenvalues(mat){var m=mat.trace()/3;var K=mat.subtract(Matrix.I(3).x(m));var q=K.determinant()/2;var tempForm=K.x(K);var p=sumMatrix(tempForm)/6;var phi=1/3*Math.acos(q/Math.sqrt(p*p*p));if(Math.abs(q)>=Math.abs(Math.sqrt(p*p*p))){phi=0}if(phi<0){phi=phi+Math.PI/3}var eig1=m+2*Math.sqrt(p)*Math.cos(phi);var eig2=m-Math.sqrt(p)*(Math.cos(phi)+Math.sqrt(3)*Math.sin(phi));var eig3=m-Math.sqrt(p)*(Math.cos(phi)-Math.sqrt(3)*Math.sin(phi));return[eig1,eig2,eig3]}function getCofactorMatrix(mat){var dims=mat.dimensions();var xSize=dims.cols;var ySize=dims.rows;var output=mat.map(function(x,i,j){return mat.minor(i+1,j+1,xSize-1,ySize-1).determinant()});return output}function getStddevs(vectors){if(vectors.length==0){return[]}var sum=Vector.Zero(vectors[0].dimensions());for(var k=0;k<vectors.length;k++){sum=sum.add(vectors[k])}var avg=sum.multiply(1/vectors.length);var covarianceMatrix=Matrix.Zero(avg.dimensions(),avg.dimensions());for(var k=0;k<vectors.length;k++){var temp=vectors[k].subtract(avg);covarianceMatrix=covarianceMatrix.map(function(x,i,j){return x+temp.elements[i-1]*temp.elements[j-1]})}var values=getEigenvalues(covarianceMatrix);for(var k=0;k<values.length;k++){values[k]=Math.sqrt(Math.abs(values[k]))}return values}function clear(){pointBuffer=[];publicApi.isSteady=false}function addPosition(position){pointBuffer.push($V(position));while(pointBuffer.length>frameCount){pointBuffer.shift()}pb=pointBuffer;var steadyThisFrame=true;var stdDevs=getStddevs(pointBuffer);for(var k=0;k<stdDevs.length;k++){steadyThisFrame&=stdDevs[k]<publicApi.maxVariance}if(steadyThisFrame&&!publicApi.isSteady){publicApi.isSteady=true;events.fireEvent("steady",publicApi);events.fireEvent("steadychanged",publicApi)}else if(!steadyThisFrame&&publicApi.isSteady){publicApi.isSteady=false;events.fireEvent("unsteady",publicApi);events.fireEvent("steadychanged",publicApi)}}function onsessionstart(focusPosition){clear()}function onsessionupdate(position){addPosition(position)}var publicApi={addPosition:addPosition,maxVariance:maxVariance,onsessionstart:onsessionstart,onsessionupdate:onsessionupdate,isSteady:false};events.eventify(publicApi);return publicApi}function Fader(orientation,size){size=size||250;var api={itemsCount:1,hysteresis:.1,initialValue:.5,flip:false,value:0,hoverItem:-1,driftAmount:0,autoMoveToContain:false,size:size,orientation:orientation,updatePosition:updatePosition,updateValue:updateValue,moveTo:moveTo,moveToContain:moveToContain,onsessionstart:onsessionstart,onsessionupdate:onsessionupdate,onsessionend:onsessionend};var events=Events();events.eventify(api);var isEdge=false;var center=[0,0,0];var fps=FpsCounter();function onsessionstart(focusPosition){moveTo(focusPosition,api.initialValue);api.value=api.initialValue;api.hoverItem=Math.floor(api.itemsCount*api.value);events.fireEvent("hoverstart",api)}function onsessionupdate(position){updatePosition(position)}function onsessionend(){events.fireEvent("hoverstop",api);api.hoverItem=-1}function updatePosition(position){fps.markframe();if(api.autoMoveToContain){moveToContain(position)}var distanceFromCenter=position[api.orientation]-center[api.orientation];var ret=distanceFromCenter/api.size+.5;ret=clamp(ret,0,1);if(api.flip)ret=1-ret;updateValue(ret);if(api.driftAmount!=0){var delta=api.initialValue-api.value;moveTo(position,api.value+delta*.05)}}function updateValue(value){var newSelected=api.hoverItem;var minValue=api.hoverItem*(1/api.itemsCount)-api.hysteresis;var maxValue=(api.hoverItem+1)*(1/api.itemsCount)+api.hysteresis;api.value=value;events.fireEvent("valuechange",api);var isThisFrameEdge=value==0||value==1;if(!isEdge&&isThisFrameEdge){events.fireEvent("edge",api)}isEdge=isThisFrameEdge;if(api.value>maxValue){newSelected++}if(api.value<minValue){newSelected--}if(newSelected!=api.hoverItem){events.fireEvent("hoverstop",api);api.hoverItem=newSelected;events.fireEvent("hoverstart",api)}}function moveTo(position,value){if(api.flip)value=1-value;center[api.orientation]=position[api.orientation]+(.5-value)*api.size}function moveToContain(position){var distanceFromCenter=position[api.orientation]-center[api.orientation];if(distanceFromCenter>api.size/2){center[api.orientation]+=distanceFromCenter-api.size/2}else if(distanceFromCenter<api.size/-2){center[api.orientation]+=distanceFromCenter+api.size/2}}return api}function Fader3D(size){var events=Events();var api={size:size,value:[0,0,0],initialValue:[.5,.5,.5],onsessionstart:onsessionstart,onsessionupdate:onsessionupdate,onsessionend:function(){}};events.eventify(api);var center=[0,0,0];function onsessionstart(focusPosition){moveTo(focusPosition,api.initialValue)}function onsessionupdate(position){var d=$V(position).subtract($V(center)).elements;var val=[clamp(d[0]/api.size[0]+.5,0,1),clamp(d[1]/api.size[1]+.5,0,1),clamp(d[2]/api.size[2]+.5,0,1)];updateValue(val)}function updateValue(value){api.value=value;events.fireEvent("valuechange",api)}function moveTo(position,value){center[0]=position[0]+(.5-value[0])*api.size[0];center[1]=position[1]+(.5-value[1])*api.size[1];center[2]=position[2]+(.5-value[2])*api.size[2]}return api}function Fader2D(width,height){width=width||300;height=height||250;var events=Events();var api={width:width,height:height,value:[0,0],onsessionstart:onsessionstart,onsessionupdate:onsessionupdate,onsessionend:onsessionend};events.eventify(api);var fader3d=Fader3D([width,height,1]);fader3d.addEventListener("valuechange",function(f){api.value[0]=f.value[0];api.value[1]=f.value[1];events.fireEvent("valuechange",api)});function onsessionstart(focusPosition){fader3d.onsessionstart(focusPosition)}function onsessionupdate(position){fader3d.size[0]=api.width;fader3d.size[1]=api.height;fader3d.onsessionupdate(position)}function onsessionend(){fader3d.onsessionend()}return api}function PushDetector(size){size=size||160;var api={isPushed:false,pushProgress:0,pushTime:0,pushPosition:[0,0,0],driftAmount:15,release:release,fader:undefined,onsessionstart:onsessionstart,onsessionupdate:onsessionupdate,onsessionend:onsessionend};var events=Events();events.eventify(api);var fader=Fader(Orientation.Z,size);fader.flip=true;fader.initialValue=.2;fader.autoMoveToContain=true;api.fader=fader;fader.driftAmount=api.driftSpeed;function onsessionstart(focusPosition){fader.onsessionstart(focusPosition)}function onsessionupdate(position){fader.moveToContain(position);fader.onsessionupdate(position);api.pushProgress=fader.value;if(!api.isPushed){if(1==api.pushProgress){api.isPushed=true;api.pushTime=(new Date).getTime();api.pushPosition=position;fader.driftAmount=0;events.fireEvent("push",api)}}else{if(api.pushProgress<.5){release()}}}function release(){if(!api.isPushed)return;api.isPushed=false;fader.driftAmount=api.driftAmount;events.fireEvent("release",api);if(isClick()){events.fireEvent("click",api)}}function onsessionend(){fader.onsessionend();if(api.isPushed){api.isPushed=false;events.fireEvent("release",api)}}function isClick(){var delta=(new Date).getTime()-api.pushTime;return delta<1e3}return api}function SwipeDetector(){var events=Events();var horizontalFader=Fader(Orientation.X);var verticalFader=Fader(Orientation.Y);var api={driftAmount:20,horizontalFader:horizontalFader,verticalFader:verticalFader,isSwiped:false,onattach:onattach,ondetach:ondetach,onedge:onedge,onvaluechange:onvaluechange};events.eventify(api);horizontalFader.autoMoveToContain=true;verticalFader.autoMoveToContain=true;horizontalFader.driftAmount=api.driftAmount;verticalFader.driftAmount=api.driftAmount;horizontalFader.swipeDirections=["left","right"];verticalFader.swipeDirections=["down","up"];horizontalFader.addListener(api);verticalFader.addListener(api);function onedge(fader){var dir=fader.swipeDirections[fader.value];events.fireEvent("swipe"+dir,api);events.fireEvent("swipe",dir);fader.driftAmount=0;fader.swipeValue=fader.value}function onvaluechange(fader){if(undefined!==fader.swipeValue){if(Math.abs(fader.swipeValue-fader.value)>=.5){delete fader.swipeValue;fader.driftAmount=api.driftAmount;events.fireEvent("swiperelease",api)}}}function onattach(target){target.addListener(horizontalFader);target.addListener(verticalFader)}function ondetach(target){target.removeListener(horizontalFader);target.removeListener(verticalFader)}return api}function Cursor(){var fader2d=Fader2D();var pushDetector=PushDetector();var events=Events();var api={onattach:onattach,ondetach:ondetach,pushDetector:pushDetector,fader2d:fader2d,value:[0,0],x:0,y:0};events.eventify(api);fader2d.addEventListener("valuechange",function(f){api.value[0]=api.x=f.value[0];api.value[1]=api.y=1-f.value[1];events.fireEvent("move",api)});pushDetector.addEventListener("push",function(pd){events.fireEvent("push",api)});pushDetector.addEventListener("release",function(pd){events.fireEvent("release",api)});pushDetector.addEventListener("click",function(pd){events.fireEvent("click",api)});function onattach(target){target.addListener(fader2d);target.addListener(pushDetector)}function ondetach(target){target.removeListener(fader2d);target.removeListener(pushDetector)}return api}function WaveDetector(){var fader=Fader(Orientation.X,100);fader.autoMoveToContain=true;fader.driftAmount=15;var api={onattach:onattach,ondetach:ondetach,fader:fader,numberOfWaves:5};var events=Events();events.eventify(api);var edgebuffer=[];var lastEdge=-1;fader.addEventListener("edge",function(f){var now=(new Date).getTime();while(edgebuffer.length>0&&now-edgebuffer[0]>2e3)edgebuffer.shift();if(edgebuffer.length==0)lastEdge=-1;if(lastEdge!=f.value)edgebuffer.push(now);lastEdge=f.value;if(edgebuffer.length>=api.numberOfWaves){events.fireEvent("wave",api);edgebuffer=[]}});function onattach(target){target.addListener(fader)}function ondetach(target){target.removeListener(fader)}return api}function HandSessionDetector(){var events=Events();var api={shouldRotateHand:true,shouldSmoothPoints:true,onuserupdate:onuserupdate,onattach:onattach,ondetach:ondetach,startSession:startSession,stopSession:stopSession,startOnWave:true,startOnSteady:true,startOnExternalHandpoint:true,bbox:BoundingBox([1e3,500,500]),bboxOffset:[0,250,-300],focusPosition:[0,0,0]};events.eventify(api);var rotateReference;var inSession=false;var jointToUse;var useExternalHandpoint=false;var framesNotInBbox=0;var maxFramesNotInBbox=15;var lastPosition=undefined;var currentUser;function onattach(user){currentUser=user;rotateReference=user.position;if(api.startOnWave){var wdLeft=WaveDetector();var wdRight=WaveDetector();wdLeft.addEventListener("wave",sessionShouldStart);wdRight.addEventListener("wave",sessionShouldStart);user.mapJointToControl(Joint.LeftHand,wdLeft);user.mapJointToControl(Joint.RightHand,wdRight)}if(api.startOnSteady){var sdLeft=SteadyDetector();var sdRight=SteadyDetector();sdLeft.addEventListener("steady",sessionShouldStart);sdRight.addEventListener("steady",sessionShouldStart);user.mapJointToControl(Joint.LeftHand,sdLeft);user.mapJointToControl(Joint.RightHand,sdRight)}}function ondetach(user){if(inSession){inSession=false;events.fireEvent("sessionend")}currentUser=undefined}function rotatedPoint(point){return api.shouldRotateHand?rotatePoint(point,rotateReference):point}function inBbox(point){var userPosition=rotatedPoint(currentUser.position);api.bbox.recenter($V(userPosition).add($V(api.bboxOffset)));return api.bbox.contains(rotatedPoint(point))}function sessionShouldStart(detector){if(inSession)return;if(inBbox(currentUser.skeleton[detector.mappedJoint].position)){startSession(detector.mappedJoint)}}function onuserupdate(userData){if(!inSession&&api.startOnExternalHandpoint&&userData.skeleton.hasOwnProperty(Joint.ExternalHandpoint)){sessionShouldStart({mappedJoint:Joint.ExternalHandpoint})}if(inSession&&jointToUse==Joint.ExternalHandpoint&&!userData.skeleton.hasOwnProperty(Joint.ExternalHandpoint)){stopSession()}rotateReference=vlerp(rotateReference,userData.position,.5);if(inSession){var pos=userData.skeleton[jointToUse].position;if(!inBbox(pos)){framesNotInBbox++;if(framesNotInBbox>=maxFramesNotInBbox){framesNotInBbox=0;stopSession()}}else{framesNotInBbox=0;var rotatedPos=rotatedPoint(pos);if(api.shouldSmoothPoints){rotatedPos=vlerp(lastPosition,rotatedPos,.8)}lastPosition=rotatedPos;events.fireEvent("sessionupdate",lastPosition)}}}function startSession(joint){stopSession();inSession=true;jointToUse=joint;lastPosition=rotatedPoint(currentUser.skeleton[joint].position);api.focusPosition=lastPosition;events.fireEvent("sessionstart",api.focusPosition)}function stopSession(){if(inSession){inSession=false;events.fireEvent("sessionend")}}function onlistenerattach(listener){if(inSession){events.fireEvent("sessionstart",api.focusPosition,listener)}}function onlistenerdetach(listener){if(inSession){events.fireEvent("sessionend",null,listener)}}function rotatePoint(handPos,comPos){var cx=comPos[0];var cy=comPos[1];var cz=comPos[2];var len=Math.sqrt(cx*cx+cy*cy+cz*cz);var lenProjected=Math.sqrt(cx*cx+cz*cz);var cosXrotation=(cx*cx+cz*cz)/(lenProjected*len);var xRot=Math.acos(cosXrotation);if(cy<0)xRot=-xRot;var cosYrotation=cz/lenProjected;var yRot=Math.acos(cosYrotation);if(cx>0)yRot=-yRot;return Matrix.RotationX(xRot).x(Matrix.RotationY(yRot)).x($V(handPos)).elements}return api}function EngageFirstUserInSession(){var events=Events();var api={onuserfound:onuserfound,onuserlost:onuserlost,onlistenerattach:onlistenerattach,onlistenerdetach:onlistenerdetach,engagedUser:null,engagedHSD:null,bboxBounds:[1e3,500,500],bboxOffset:[0,250,-300],startOnWave:true,startOnSteady:true,startOnExternalHandpoint:true};events.eventify(api);var engagedUserId=0;var inSession=false;var focusPosition=[0,0,0];function onsessionstart(user,fp,detector){if(engagedUserId!=0)return;inSession=true;focusPosition=fp;engagedUserId=user.id;api.engagedUser=user;api.engagedHSD=detector;events.fireEvent("userengaged",user);events.fireEvent("sessionstart",focusPosition)}function onsessionupdate(user,position){if(user.id==engagedUserId){events.fireEvent("sessionupdate",position)}}function onsessionend(user){if(user.id==engagedUserId){engagedUserId=0;api.engagedUser=null;api.engagedHSD=null;events.fireEvent("sessionend");events.fireEvent("userdisengaged",user)}}function onuserfound(newUser){var sessionDetector=HandSessionDetector();sessionDetector.bbox.resize(api.bboxBounds);sessionDetector.bboxOffset=api.bboxOffset;sessionDetector.startOnWave=api.startOnWave;sessionDetector.startOnSteady=api.startOnSteady;sessionDetector.startOnExternalHandpoint=api.startOnExternalHandpoint;sessionDetector.addEventListener("sessionstart",function(focusPosition){onsessionstart(newUser,focusPosition,sessionDetector)});sessionDetector.addEventListener("sessionupdate",function(position){onsessionupdate(newUser,position)});sessionDetector.addEventListener("sessionend",function(){onsessionend(newUser)});newUser.addListener(sessionDetector)}function onuserlost(lostUser){if(lostUser.id==engagedUserId){onsessionend(lostUser)}}function onlistenerattach(listener){if(inSession){events.fireEvent("sessionstart",focusPosition,listener)}}function onlistenerdetach(listener){if(inSession){events.fireEvent("sessionend",null,listener)}}return api}function EngageUsersWithSkeleton(count){if(undefined===count){count=1}var events=Events();var api={onuserlost:onuserlost,ondataupdate:ondataupdate};events.eventify(api);var engagedUsers=[];function ondataupdate(zigObject){if(engagedUsers.length<count){for(var userid in zigObject.users)if(zigObject.users.hasOwnProperty(userid)){var user=zigObject.users[userid];if(user.skeletonTracked&&-1==engagedUsers.indexOf(user)){if(engagedUsers.length<count){engagedUsers.push(user);events.fireEvent("userengaged",user)}}}if(engagedUsers.length==count){events.fireEvent("allusersengaged",engagedUsers)}}}function onuserlost(lostUser){var i=engagedUsers.indexOf(lostUser);if(-1!=i){engagedUsers.splice(i,1);events.fireEvent("userdisengaged",lostUser)}}return api}function UserJoint(){var id;var position;var rotation}function User(userData){var api={id:0,positionTracked:false,position:[0,0,0],skeletonTracked:false,skeleton:{},mapJointToControl:mapJointToControl,update:update};update(userData);function update(userData){api.id=userData.id;api.positionTracked=true;api.position=userData.centerofmass;api.skeletonTracked=userData.tracked>0;var currjoints=userData.joints;var newjoints={};for(var i=0;i<currjoints.length;i++){newjoints[currjoints[i].id]=currjoints[i]}api.skeleton=newjoints}function mapJointToControl(joint,control){var events=Events();var inSession=false;function onuserupdate(userData){if(userData.skeletonTracked&&userData.skeleton.hasOwnProperty(joint)){if(!inSession){control.mappedJoint=joint;inSession=true;events.fireEvent("sessionstart",userData.skeleton[joint].position)}events.fireEvent("sessionupdate",userData.skeleton[joint].position)}else if(inSession){inSession=false;delete control.mappedJoint;events.fireEvent("sessionend")}}var adapter={onuserupdate:onuserupdate};events.eventify(adapter);adapter.addListener(control);api.addListener(adapter);return adapter}return api}zig=function(){var plugin;var trackedUsers={};var userCallbacks={};var controls={SteadyDetector:SteadyDetector,Fader:Fader,Fader2D:Fader2D,Fader3D:Fader3D,PushDetector:PushDetector,SwipeDetector:SwipeDetector,WaveDetector:WaveDetector,Cursor:Cursor};var version="0.9.9";var publicApi={init:init,embed:embed,findZigObject:findzigobject,pluginInstalled:false,version:version,pluginVersion:0,verbose:true,users:trackedUsers,sensorConnected:false,Joint:Joint,Orientation:Orientation,EngageFirstUserInSession:EngageFirstUserInSession,EngageUsersWithSkeleton:EngageUsersWithSkeleton,HandSessionDetector:HandSessionDetector,controls:controls};var events=Events();events.eventify(publicApi);function log(text){if(publicApi.verbose)console.log("Zig: "+text)}function bindDomEvent(target,eventName,handlerName){if(target.attachEvent){target.attachEvent("on"+eventName,handlerName)}else if(target.addEventListener){target.addEventListener(eventName,handlerName,false)}else{target["on"+eventName]=handlerName}}function getItemById(collection,id){for(var key in collection)if(collection.hasOwnProperty(key)){if(collection[key].id==id)return collection[key]}return undefined}function doUpdate(users,hands){var toRemove=[];var toAdd=[];for(var userid in trackedUsers)if(trackedUsers.hasOwnProperty(userid)){if(undefined===getItemById(users,userid)){var lostUser=trackedUsers[userid];delete trackedUsers[userid];toRemove.push(lostUser)}}for(var key in users)if(users.hasOwnProperty(key)){if(!trackedUsers.hasOwnProperty(users[key].id)){var userEvents=Events();var newUser=User(users[key]);userEvents.eventify(newUser);trackedUsers[newUser.id]=newUser;userCallbacks[newUser.id]=userEvents;toAdd.push(newUser)}}for(var userid in trackedUsers)if(trackedUsers.hasOwnProperty(userid)){var user=getItemById(users,userid);if(undefined===user){console.log("ERROR!! getItemById returned undefined for userid "+userid);console.log(users);console.log(trackedUsers);continue}trackedUsers[userid].update(getItemById(users,userid))}hands.forEach(function(hand){if(trackedUsers.hasOwnProperty(hand.userid)){trackedUsers[hand.userid].skeleton[Joint.ExternalHandpoint]={id:Joint.ExternalHandpoint,position:hand.position}}});toRemove.forEach(function(user){log("Lost user: "+user.id);user.removeListener();events.fireEvent("userlost",user)});toAdd.forEach(function(user){log("New user: "+user.id);events.fireEvent("userfound",user)});events.fireEvent("dataupdate",publicApi);for(var userid in trackedUsers)if(trackedUsers.hasOwnProperty(userid)){userCallbacks[userid].fireEvent("userupdate",trackedUsers[userid])}}function init(zo){plugin=zo;bindDomEvent(zo,"NewFrame",function(){return function(data){try{var obj=JSON.parse(data)}catch(e){console.log("Error parsing JSON from plugin, skipping frame");return}doUpdate(obj.users,obj.hands)}}());log("inited");events.fireEvent("loaded",zo);var oldaddEventListener=publicApi.addEventListener;var newaddEventListener=function(eventName,cb){oldaddEventListener(eventName,cb);if("loaded"==eventName){events.fireEvent("loaded",zo,cb)}};publicApi.addEventListener=newaddEventListener;publicApi.sensorConnected=zo.sensorConnected;bindDomEvent(zo,"StatusChange",function(status){publicApi.sensorConnected=status;events.fireEvent("statuschange",status)});publicApi.pluginVersion=zo.version}function embed(div){if(null!=findzigobject())return;if(undefined===div){div=document.createElement("div");document.body.appendChild(div)}if("string"==typeof div)div=document.getElementById(div);var html='<object id="zigPluginObject" type="application/x-zig" width="0" height="0"><param name="onload" value="zigloaded" /></object>';div.innerHTML=html}var zigobject=null;function findzigobject(){if(typeof zigobject=="undefined"){zigobject=null}if(null==zigobject){var objs=document.getElementsByTagName("object");for(var i=0;i<objs.length;i++){if(objs[i].requestStreams!==undefined){zigobject=objs[i];break}}}return zigobject}function hasPlugin(mimeType){for(var k in navigator.plugins)if(navigator.plugins.hasOwnProperty(k)){var p=navigator.plugins[k];for(var mime in p)if(p.hasOwnProperty(mime)){if(undefined!==p[mime].type&&mimeType==p[mime].type){return true}}}return false}function domloaded(){var zo=findzigobject();if(null!=zo){init(zo)}else{embed()}}document.addEventListener("DOMContentLoaded",function(){setTimeout(domloaded,200)},false);publicApi.singleUserSession=EngageFirstUserInSession();publicApi.addListener(publicApi.singleUserSession);publicApi.pluginInstalled=hasPlugin("application/x-zig");return publicApi}();zigloaded=function(){zig.init(zig.findZigObject())};zig.toys=function(){function usersRadar(parentElement){this.radarWidth=4e3;this.radarHeight=4e3;this.onuserfound=function(user){var el=document.createElement("div");el.classList.add("user");parentElement.appendChild(el);user.radarElement=el;var that=this;user.addEventListener("userupdate",function(user){var xpos=user.position[0]/that.radarWidth+.5;var ypos=user.position[2]/that.radarHeight;var el=user.radarElement;el.style.left=xpos*parentElement.offsetWidth-el.offsetWidth/2+"px";el.style.top=ypos*parentElement.offsetHeight-el.offsetHeight/2+"px"})};this.onuserlost=function(user){parentElement.removeChild(user.radarElement);delete user.radarElement};zig.singleUserSession.addEventListener("userengaged",function(user){user.radarElement.classList.add("active")});zig.singleUserSession.addEventListener("userdisengaged",function(user){user.radarElement.classList.remove("active")})}function injectRadar(){console.log("injecting radar");var style=document.createElement("style");style.type="text/css";style.innerHTML="#zigfuRadar { width:300px;height:300px;bottom:20px;right:20px;border-radius:15px;position:fixed;display:block;background:url(http://cdn.zigfu.com/zigjs/toys/radar.png) } ";style.innerHTML+="#zigfuRadar .user { width:35px; height:35px; position:relative;display:block; background:url(http://cdn.zigfu.com/zigjs/toys/user.png) } ";style.innerHTML+="#zigfuRadar .user.active { background:url(http://cdn.zigfu.com/zigjs/toys/user_active.png) } ";document.getElementsByTagName("head")[0].appendChild(style);var re=document.createElement("div");re.id="zigfuRadar";document.body.appendChild(re);var r=new usersRadar(re);zig.addListener(r)}function injectCursor(){var c=zig.controls.Cursor();var ce=document.createElement("div");ce.style.position="fixed";ce.style.display="none";ce.style.width="50px";ce.style.height="50px";ce.style.backgroundColor="blue";document.body.appendChild(ce);zig.singleUserSession.addEventListener("sessionstart",function(focusPosition){ce.style.display="block"});zig.singleUserSession.addEventListener("sessionend",function(){ce.style.display="none"});c.addEventListener("move",function(cursor){ce.style.left=c.x*window.innerWidth-ce.offsetWidth/2+"px";ce.style.top=c.y*window.innerHeight-ce.offsetHeight/2+"px"});zig.singleUserSession.addListener(c)}return{injectCursor:injectCursor,injectRadar:injectRadar}}()})()}var b2Settings=Class.create();b2Settings.prototype={initialize:function(){}};b2Settings.USHRT_MAX=65535;b2Settings.b2_pi=Math.PI;b2Settings.b2_massUnitsPerKilogram=1;b2Settings.b2_timeUnitsPerSecond=1;b2Settings.b2_lengthUnitsPerMeter=30;b2Settings.b2_maxManifoldPoints=2;b2Settings.b2_maxShapesPerBody=64;b2Settings.b2_maxPolyVertices=8;b2Settings.b2_maxProxies=1024;b2Settings.b2_maxPairs=8*b2Settings.b2_maxProxies;b2Settings.b2_linearSlop=.005*b2Settings.b2_lengthUnitsPerMeter;b2Settings.b2_angularSlop=2/180*b2Settings.b2_pi;b2Settings.b2_velocityThreshold=1*b2Settings.b2_lengthUnitsPerMeter/b2Settings.b2_timeUnitsPerSecond;b2Settings.b2_maxLinearCorrection=.2*b2Settings.b2_lengthUnitsPerMeter;b2Settings.b2_maxAngularCorrection=8/180*b2Settings.b2_pi;b2Settings.b2_contactBaumgarte=.2;b2Settings.b2_timeToSleep=.5*b2Settings.b2_timeUnitsPerSecond;b2Settings.b2_linearSleepTolerance=.01*b2Settings.b2_lengthUnitsPerMeter/b2Settings.b2_timeUnitsPerSecond;b2Settings.b2_angularSleepTolerance=2/180/b2Settings.b2_timeUnitsPerSecond;b2Settings.b2Assert=function(a){if(!a){var nullVec;nullVec.x++}};var b2Vec2=Class.create();b2Vec2.prototype={initialize:function(x_,y_){this.x=x_;this.y=y_},SetZero:function(){this.x=0;this.y=0},Set:function(x_,y_){this.x=x_;this.y=y_},SetV:function(v){this.x=v.x;this.y=v.y},Negative:function(){return new b2Vec2(-this.x,-this.y)},Copy:function(){return new b2Vec2(this.x,this.y)},Add:function(v){this.x+=v.x;this.y+=v.y},Subtract:function(v){this.x-=v.x;this.y-=v.y},Multiply:function(a){this.x*=a;this.y*=a},MulM:function(A){var tX=this.x;this.x=A.col1.x*tX+A.col2.x*this.y;this.y=A.col1.y*tX+A.col2.y*this.y},MulTM:function(A){var tX=b2Math.b2Dot(this,A.col1);this.y=b2Math.b2Dot(this,A.col2);this.x=tX},CrossVF:function(s){var tX=this.x;this.x=s*this.y;this.y=-s*tX},CrossFV:function(s){var tX=this.x;this.x=-s*this.y;this.y=s*tX},MinV:function(b){this.x=this.x<b.x?this.x:b.x;this.y=this.y<b.y?this.y:b.y},MaxV:function(b){this.x=this.x>b.x?this.x:b.x;this.y=this.y>b.y?this.y:b.y},Abs:function(){this.x=Math.abs(this.x);this.y=Math.abs(this.y)},Length:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},Normalize:function(){var length=this.Length();if(length<Number.MIN_VALUE){return 0}var invLength=1/length;this.x*=invLength;this.y*=invLength;return length},IsValid:function(){return b2Math.b2IsValid(this.x)&&b2Math.b2IsValid(this.y)},x:null,y:null};b2Vec2.Make=function(x_,y_){return new b2Vec2(x_,y_)};var b2Mat22=Class.create();b2Mat22.prototype={initialize:function(angle,c1,c2){if(angle==null)angle=0;this.col1=new b2Vec2;this.col2=new b2Vec2;if(c1!=null&&c2!=null){this.col1.SetV(c1);this.col2.SetV(c2)}else{var c=Math.cos(angle);var s=Math.sin(angle);this.col1.x=c;this.col2.x=-s;this.col1.y=s;this.col2.y=c}},Set:function(angle){var c=Math.cos(angle);var s=Math.sin(angle);this.col1.x=c;this.col2.x=-s;this.col1.y=s;this.col2.y=c},SetVV:function(c1,c2){this.col1.SetV(c1);this.col2.SetV(c2)},Copy:function(){return new b2Mat22(0,this.col1,this.col2)},SetM:function(m){this.col1.SetV(m.col1);this.col2.SetV(m.col2)},AddM:function(m){this.col1.x+=m.col1.x;this.col1.y+=m.col1.y;this.col2.x+=m.col2.x;this.col2.y+=m.col2.y},SetIdentity:function(){this.col1.x=1;this.col2.x=0;this.col1.y=0;this.col2.y=1},SetZero:function(){this.col1.x=0;this.col2.x=0;this.col1.y=0;this.col2.y=0},Invert:function(out){var a=this.col1.x;var b=this.col2.x;var c=this.col1.y;var d=this.col2.y;var det=a*d-b*c;det=1/det;out.col1.x=det*d;out.col2.x=-det*b;out.col1.y=-det*c;out.col2.y=det*a;return out},Solve:function(out,bX,bY){var a11=this.col1.x;var a12=this.col2.x;var a21=this.col1.y;var a22=this.col2.y;var det=a11*a22-a12*a21;det=1/det;out.x=det*(a22*bX-a12*bY);out.y=det*(a11*bY-a21*bX);
return out},Abs:function(){this.col1.Abs();this.col2.Abs()},col1:new b2Vec2,col2:new b2Vec2};var b2Math=Class.create();b2Math.prototype={initialize:function(){}};b2Math.b2IsValid=function(x){return isFinite(x)};b2Math.b2Dot=function(a,b){return a.x*b.x+a.y*b.y};b2Math.b2CrossVV=function(a,b){return a.x*b.y-a.y*b.x};b2Math.b2CrossVF=function(a,s){var v=new b2Vec2(s*a.y,-s*a.x);return v};b2Math.b2CrossFV=function(s,a){var v=new b2Vec2(-s*a.y,s*a.x);return v};b2Math.b2MulMV=function(A,v){var u=new b2Vec2(A.col1.x*v.x+A.col2.x*v.y,A.col1.y*v.x+A.col2.y*v.y);return u};b2Math.b2MulTMV=function(A,v){var u=new b2Vec2(b2Math.b2Dot(v,A.col1),b2Math.b2Dot(v,A.col2));return u};b2Math.AddVV=function(a,b){var v=new b2Vec2(a.x+b.x,a.y+b.y);return v};b2Math.SubtractVV=function(a,b){var v=new b2Vec2(a.x-b.x,a.y-b.y);return v};b2Math.MulFV=function(s,a){var v=new b2Vec2(s*a.x,s*a.y);return v};b2Math.AddMM=function(A,B){var C=new b2Mat22(0,b2Math.AddVV(A.col1,B.col1),b2Math.AddVV(A.col2,B.col2));return C};b2Math.b2MulMM=function(A,B){var C=new b2Mat22(0,b2Math.b2MulMV(A,B.col1),b2Math.b2MulMV(A,B.col2));return C};b2Math.b2MulTMM=function(A,B){var c1=new b2Vec2(b2Math.b2Dot(A.col1,B.col1),b2Math.b2Dot(A.col2,B.col1));var c2=new b2Vec2(b2Math.b2Dot(A.col1,B.col2),b2Math.b2Dot(A.col2,B.col2));var C=new b2Mat22(0,c1,c2);return C};b2Math.b2Abs=function(a){return a>0?a:-a};b2Math.b2AbsV=function(a){var b=new b2Vec2(b2Math.b2Abs(a.x),b2Math.b2Abs(a.y));return b};b2Math.b2AbsM=function(A){var B=new b2Mat22(0,b2Math.b2AbsV(A.col1),b2Math.b2AbsV(A.col2));return B};b2Math.b2Min=function(a,b){return a<b?a:b};b2Math.b2MinV=function(a,b){var c=new b2Vec2(b2Math.b2Min(a.x,b.x),b2Math.b2Min(a.y,b.y));return c};b2Math.b2Max=function(a,b){return a>b?a:b};b2Math.b2MaxV=function(a,b){var c=new b2Vec2(b2Math.b2Max(a.x,b.x),b2Math.b2Max(a.y,b.y));return c};b2Math.b2Clamp=function(a,low,high){return b2Math.b2Max(low,b2Math.b2Min(a,high))};b2Math.b2ClampV=function(a,low,high){return b2Math.b2MaxV(low,b2Math.b2MinV(a,high))};b2Math.b2Swap=function(a,b){var tmp=a[0];a[0]=b[0];b[0]=tmp};b2Math.b2Random=function(){return Math.random()*2-1};b2Math.b2NextPowerOfTwo=function(x){x|=x>>1&2147483647;x|=x>>2&1073741823;x|=x>>4&268435455;x|=x>>8&16777215;x|=x>>16&65535;return x+1};b2Math.b2IsPowerOfTwo=function(x){var result=x>0&&(x&x-1)==0;return result};b2Math.tempVec2=new b2Vec2;b2Math.tempVec3=new b2Vec2;b2Math.tempVec4=new b2Vec2;b2Math.tempVec5=new b2Vec2;b2Math.tempMat=new b2Mat22;var b2AABB=Class.create();b2AABB.prototype={IsValid:function(){var dX=this.maxVertex.x;var dY=this.maxVertex.y;dX=this.maxVertex.x;dY=this.maxVertex.y;dX-=this.minVertex.x;dY-=this.minVertex.y;var valid=dX>=0&&dY>=0;valid=valid&&this.minVertex.IsValid()&&this.maxVertex.IsValid();return valid},minVertex:new b2Vec2,maxVertex:new b2Vec2,initialize:function(){this.minVertex=new b2Vec2;this.maxVertex=new b2Vec2}};var b2Bound=Class.create();b2Bound.prototype={IsLower:function(){return(this.value&1)==0},IsUpper:function(){return(this.value&1)==1},Swap:function(b){var tempValue=this.value;var tempProxyId=this.proxyId;var tempStabbingCount=this.stabbingCount;this.value=b.value;this.proxyId=b.proxyId;this.stabbingCount=b.stabbingCount;b.value=tempValue;b.proxyId=tempProxyId;b.stabbingCount=tempStabbingCount},value:0,proxyId:0,stabbingCount:0,initialize:function(){}};var b2BoundValues=Class.create();b2BoundValues.prototype={lowerValues:[0,0],upperValues:[0,0],initialize:function(){this.lowerValues=[0,0];this.upperValues=[0,0]}};var b2Pair=Class.create();b2Pair.prototype={SetBuffered:function(){this.status|=b2Pair.e_pairBuffered},ClearBuffered:function(){this.status&=~b2Pair.e_pairBuffered},IsBuffered:function(){return(this.status&b2Pair.e_pairBuffered)==b2Pair.e_pairBuffered},SetRemoved:function(){this.status|=b2Pair.e_pairRemoved},ClearRemoved:function(){this.status&=~b2Pair.e_pairRemoved},IsRemoved:function(){return(this.status&b2Pair.e_pairRemoved)==b2Pair.e_pairRemoved},SetFinal:function(){this.status|=b2Pair.e_pairFinal},IsFinal:function(){return(this.status&b2Pair.e_pairFinal)==b2Pair.e_pairFinal},userData:null,proxyId1:0,proxyId2:0,next:0,status:0,initialize:function(){}};b2Pair.b2_nullPair=b2Settings.USHRT_MAX;b2Pair.b2_nullProxy=b2Settings.USHRT_MAX;b2Pair.b2_tableCapacity=b2Settings.b2_maxPairs;b2Pair.b2_tableMask=b2Pair.b2_tableCapacity-1;b2Pair.e_pairBuffered=1;b2Pair.e_pairRemoved=2;b2Pair.e_pairFinal=4;var b2PairCallback=Class.create();b2PairCallback.prototype={PairAdded:function(proxyUserData1,proxyUserData2){return null},PairRemoved:function(proxyUserData1,proxyUserData2,pairUserData){},initialize:function(){}};var b2BufferedPair=Class.create();b2BufferedPair.prototype={proxyId1:0,proxyId2:0,initialize:function(){}};var b2PairManager=Class.create();b2PairManager.prototype={initialize:function(){var i=0;this.m_hashTable=new Array(b2Pair.b2_tableCapacity);for(i=0;i<b2Pair.b2_tableCapacity;++i){this.m_hashTable[i]=b2Pair.b2_nullPair}this.m_pairs=new Array(b2Settings.b2_maxPairs);for(i=0;i<b2Settings.b2_maxPairs;++i){this.m_pairs[i]=new b2Pair}this.m_pairBuffer=new Array(b2Settings.b2_maxPairs);for(i=0;i<b2Settings.b2_maxPairs;++i){this.m_pairBuffer[i]=new b2BufferedPair}for(i=0;i<b2Settings.b2_maxPairs;++i){this.m_pairs[i].proxyId1=b2Pair.b2_nullProxy;this.m_pairs[i].proxyId2=b2Pair.b2_nullProxy;this.m_pairs[i].userData=null;this.m_pairs[i].status=0;this.m_pairs[i].next=i+1}this.m_pairs[b2Settings.b2_maxPairs-1].next=b2Pair.b2_nullPair;this.m_pairCount=0},Initialize:function(broadPhase,callback){this.m_broadPhase=broadPhase;this.m_callback=callback},AddBufferedPair:function(proxyId1,proxyId2){var pair=this.AddPair(proxyId1,proxyId2);if(pair.IsBuffered()==false){pair.SetBuffered();this.m_pairBuffer[this.m_pairBufferCount].proxyId1=pair.proxyId1;this.m_pairBuffer[this.m_pairBufferCount].proxyId2=pair.proxyId2;++this.m_pairBufferCount}pair.ClearRemoved();if(b2BroadPhase.s_validate){this.ValidateBuffer()}},RemoveBufferedPair:function(proxyId1,proxyId2){var pair=this.Find(proxyId1,proxyId2);if(pair==null){return}if(pair.IsBuffered()==false){pair.SetBuffered();this.m_pairBuffer[this.m_pairBufferCount].proxyId1=pair.proxyId1;this.m_pairBuffer[this.m_pairBufferCount].proxyId2=pair.proxyId2;++this.m_pairBufferCount}pair.SetRemoved();if(b2BroadPhase.s_validate){this.ValidateBuffer()}},Commit:function(){var i=0;var removeCount=0;var proxies=this.m_broadPhase.m_proxyPool;for(i=0;i<this.m_pairBufferCount;++i){var pair=this.Find(this.m_pairBuffer[i].proxyId1,this.m_pairBuffer[i].proxyId2);pair.ClearBuffered();var proxy1=proxies[pair.proxyId1];var proxy2=proxies[pair.proxyId2];if(pair.IsRemoved()){if(pair.IsFinal()==true){this.m_callback.PairRemoved(proxy1.userData,proxy2.userData,pair.userData)}this.m_pairBuffer[removeCount].proxyId1=pair.proxyId1;this.m_pairBuffer[removeCount].proxyId2=pair.proxyId2;++removeCount}else{if(pair.IsFinal()==false){pair.userData=this.m_callback.PairAdded(proxy1.userData,proxy2.userData);pair.SetFinal()}}}for(i=0;i<removeCount;++i){this.RemovePair(this.m_pairBuffer[i].proxyId1,this.m_pairBuffer[i].proxyId2)}this.m_pairBufferCount=0;if(b2BroadPhase.s_validate){this.ValidateTable()}},AddPair:function(proxyId1,proxyId2){if(proxyId1>proxyId2){var temp=proxyId1;proxyId1=proxyId2;proxyId2=temp}var hash=b2PairManager.Hash(proxyId1,proxyId2)&b2Pair.b2_tableMask;var pair=pair=this.FindHash(proxyId1,proxyId2,hash);if(pair!=null){return pair}var pIndex=this.m_freePair;pair=this.m_pairs[pIndex];this.m_freePair=pair.next;pair.proxyId1=proxyId1;pair.proxyId2=proxyId2;pair.status=0;pair.userData=null;pair.next=this.m_hashTable[hash];this.m_hashTable[hash]=pIndex;++this.m_pairCount;return pair},RemovePair:function(proxyId1,proxyId2){if(proxyId1>proxyId2){var temp=proxyId1;proxyId1=proxyId2;proxyId2=temp}var hash=b2PairManager.Hash(proxyId1,proxyId2)&b2Pair.b2_tableMask;var node=this.m_hashTable[hash];var pNode=null;while(node!=b2Pair.b2_nullPair){if(b2PairManager.Equals(this.m_pairs[node],proxyId1,proxyId2)){var index=node;if(pNode){pNode.next=this.m_pairs[node].next}else{this.m_hashTable[hash]=this.m_pairs[node].next}var pair=this.m_pairs[index];var userData=pair.userData;pair.next=this.m_freePair;pair.proxyId1=b2Pair.b2_nullProxy;pair.proxyId2=b2Pair.b2_nullProxy;pair.userData=null;pair.status=0;this.m_freePair=index;--this.m_pairCount;return userData}else{pNode=this.m_pairs[node];node=pNode.next}}return null},Find:function(proxyId1,proxyId2){if(proxyId1>proxyId2){var temp=proxyId1;proxyId1=proxyId2;proxyId2=temp}var hash=b2PairManager.Hash(proxyId1,proxyId2)&b2Pair.b2_tableMask;return this.FindHash(proxyId1,proxyId2,hash)},FindHash:function(proxyId1,proxyId2,hash){var index=this.m_hashTable[hash];while(index!=b2Pair.b2_nullPair&&b2PairManager.Equals(this.m_pairs[index],proxyId1,proxyId2)==false){index=this.m_pairs[index].next}if(index==b2Pair.b2_nullPair){return null}return this.m_pairs[index]},ValidateBuffer:function(){},ValidateTable:function(){},m_broadPhase:null,m_callback:null,m_pairs:null,m_freePair:0,m_pairCount:0,m_pairBuffer:null,m_pairBufferCount:0,m_hashTable:null};b2PairManager.Hash=function(proxyId1,proxyId2){var key=proxyId2<<16&4294901760|proxyId1;key=~key+(key<<15&4294934528);key=key^key>>12&1048575;key=key+(key<<2&4294967292);key=key^key>>4&268435455;key=key*2057;key=key^key>>16&65535;return key};b2PairManager.Equals=function(pair,proxyId1,proxyId2){return pair.proxyId1==proxyId1&&pair.proxyId2==proxyId2};b2PairManager.EqualsPair=function(pair1,pair2){return pair1.proxyId1==pair2.proxyId1&&pair1.proxyId2==pair2.proxyId2};var b2BroadPhase=Class.create();b2BroadPhase.prototype={initialize:function(worldAABB,callback){this.m_pairManager=new b2PairManager;this.m_proxyPool=new Array(b2Settings.b2_maxPairs);this.m_bounds=new Array(2*b2Settings.b2_maxProxies);this.m_queryResults=new Array(b2Settings.b2_maxProxies);this.m_quantizationFactor=new b2Vec2;var i=0;this.m_pairManager.Initialize(this,callback);this.m_worldAABB=worldAABB;this.m_proxyCount=0;for(i=0;i<b2Settings.b2_maxProxies;i++){this.m_queryResults[i]=0}this.m_bounds=new Array(2);for(i=0;i<2;i++){this.m_bounds[i]=new Array(2*b2Settings.b2_maxProxies);for(var j=0;j<2*b2Settings.b2_maxProxies;j++){this.m_bounds[i][j]=new b2Bound}}var dX=worldAABB.maxVertex.x;var dY=worldAABB.maxVertex.y;dX-=worldAABB.minVertex.x;dY-=worldAABB.minVertex.y;this.m_quantizationFactor.x=b2Settings.USHRT_MAX/dX;this.m_quantizationFactor.y=b2Settings.USHRT_MAX/dY;var tProxy;for(i=0;i<b2Settings.b2_maxProxies-1;++i){tProxy=new b2Proxy;this.m_proxyPool[i]=tProxy;tProxy.SetNext(i+1);tProxy.timeStamp=0;tProxy.overlapCount=b2BroadPhase.b2_invalid;tProxy.userData=null}tProxy=new b2Proxy;this.m_proxyPool[b2Settings.b2_maxProxies-1]=tProxy;tProxy.SetNext(b2Pair.b2_nullProxy);tProxy.timeStamp=0;tProxy.overlapCount=b2BroadPhase.b2_invalid;tProxy.userData=null;this.m_freeProxy=0;this.m_timeStamp=1;this.m_queryResultCount=0},InRange:function(aabb){var dX;var dY;var d2X;var d2Y;dX=aabb.minVertex.x;dY=aabb.minVertex.y;dX-=this.m_worldAABB.maxVertex.x;dY-=this.m_worldAABB.maxVertex.y;d2X=this.m_worldAABB.minVertex.x;d2Y=this.m_worldAABB.minVertex.y;d2X-=aabb.maxVertex.x;d2Y-=aabb.maxVertex.y;dX=b2Math.b2Max(dX,d2X);dY=b2Math.b2Max(dY,d2Y);return b2Math.b2Max(dX,dY)<0},GetProxy:function(proxyId){if(proxyId==b2Pair.b2_nullProxy||this.m_proxyPool[proxyId].IsValid()==false){return null}return this.m_proxyPool[proxyId]},CreateProxy:function(aabb,userData){var index=0;var proxy;var proxyId=this.m_freeProxy;proxy=this.m_proxyPool[proxyId];this.m_freeProxy=proxy.GetNext();proxy.overlapCount=0;proxy.userData=userData;var boundCount=2*this.m_proxyCount;var lowerValues=new Array;var upperValues=new Array;this.ComputeBounds(lowerValues,upperValues,aabb);for(var axis=0;axis<2;++axis){var bounds=this.m_bounds[axis];var lowerIndex=0;var upperIndex=0;var lowerIndexOut=[lowerIndex];var upperIndexOut=[upperIndex];this.Query(lowerIndexOut,upperIndexOut,lowerValues[axis],upperValues[axis],bounds,boundCount,axis);lowerIndex=lowerIndexOut[0];upperIndex=upperIndexOut[0];var tArr=new Array;var j=0;var tEnd=boundCount-upperIndex;var tBound1;var tBound2;for(j=0;j<tEnd;j++){tArr[j]=new b2Bound;tBound1=tArr[j];tBound2=bounds[upperIndex+j];tBound1.value=tBound2.value;tBound1.proxyId=tBound2.proxyId;tBound1.stabbingCount=tBound2.stabbingCount}tEnd=tArr.length;var tIndex=upperIndex+2;for(j=0;j<tEnd;j++){tBound2=tArr[j];tBound1=bounds[tIndex+j];tBound1.value=tBound2.value;tBound1.proxyId=tBound2.proxyId;tBound1.stabbingCount=tBound2.stabbingCount}tArr=new Array;tEnd=upperIndex-lowerIndex;for(j=0;j<tEnd;j++){tArr[j]=new b2Bound;tBound1=tArr[j];tBound2=bounds[lowerIndex+j];tBound1.value=tBound2.value;tBound1.proxyId=tBound2.proxyId;tBound1.stabbingCount=tBound2.stabbingCount}tEnd=tArr.length;tIndex=lowerIndex+1;for(j=0;j<tEnd;j++){tBound2=tArr[j];tBound1=bounds[tIndex+j];tBound1.value=tBound2.value;tBound1.proxyId=tBound2.proxyId;tBound1.stabbingCount=tBound2.stabbingCount}++upperIndex;bounds[lowerIndex].value=lowerValues[axis];bounds[lowerIndex].proxyId=proxyId;bounds[upperIndex].value=upperValues[axis];bounds[upperIndex].proxyId=proxyId;bounds[lowerIndex].stabbingCount=lowerIndex==0?0:bounds[lowerIndex-1].stabbingCount;bounds[upperIndex].stabbingCount=bounds[upperIndex-1].stabbingCount;for(index=lowerIndex;index<upperIndex;++index){bounds[index].stabbingCount++}for(index=lowerIndex;index<boundCount+2;++index){var proxy2=this.m_proxyPool[bounds[index].proxyId];if(bounds[index].IsLower()){proxy2.lowerBounds[axis]=index}else{proxy2.upperBounds[axis]=index}}}++this.m_proxyCount;for(var i=0;i<this.m_queryResultCount;++i){this.m_pairManager.AddBufferedPair(proxyId,this.m_queryResults[i])}this.m_pairManager.Commit();this.m_queryResultCount=0;this.IncrementTimeStamp();return proxyId},DestroyProxy:function(proxyId){var proxy=this.m_proxyPool[proxyId];var boundCount=2*this.m_proxyCount;for(var axis=0;axis<2;++axis){var bounds=this.m_bounds[axis];var lowerIndex=proxy.lowerBounds[axis];var upperIndex=proxy.upperBounds[axis];var lowerValue=bounds[lowerIndex].value;var upperValue=bounds[upperIndex].value;var tArr=new Array;var j=0;var tEnd=upperIndex-lowerIndex-1;var tBound1;var tBound2;for(j=0;j<tEnd;j++){tArr[j]=new b2Bound;tBound1=tArr[j];tBound2=bounds[lowerIndex+1+j];tBound1.value=tBound2.value;tBound1.proxyId=tBound2.proxyId;tBound1.stabbingCount=tBound2.stabbingCount}tEnd=tArr.length;var tIndex=lowerIndex;for(j=0;j<tEnd;j++){tBound2=tArr[j];tBound1=bounds[tIndex+j];tBound1.value=tBound2.value;tBound1.proxyId=tBound2.proxyId;tBound1.stabbingCount=tBound2.stabbingCount}tArr=new Array;tEnd=boundCount-upperIndex-1;for(j=0;j<tEnd;j++){tArr[j]=new b2Bound;tBound1=tArr[j];tBound2=bounds[upperIndex+1+j];tBound1.value=tBound2.value;tBound1.proxyId=tBound2.proxyId;tBound1.stabbingCount=tBound2.stabbingCount}tEnd=tArr.length;tIndex=upperIndex-1;for(j=0;j<tEnd;j++){tBound2=tArr[j];tBound1=bounds[tIndex+j];tBound1.value=tBound2.value;tBound1.proxyId=tBound2.proxyId;tBound1.stabbingCount=tBound2.stabbingCount}tEnd=boundCount-2;for(var index=lowerIndex;index<tEnd;++index){var proxy2=this.m_proxyPool[bounds[index].proxyId];if(bounds[index].IsLower()){proxy2.lowerBounds[axis]=index}else{proxy2.upperBounds[axis]=index}}tEnd=upperIndex-1;for(var index2=lowerIndex;index2<tEnd;++index2){bounds[index2].stabbingCount--}this.Query([0],[0],lowerValue,upperValue,bounds,boundCount-2,axis)}for(var i=0;i<this.m_queryResultCount;++i){this.m_pairManager.RemoveBufferedPair(proxyId,this.m_queryResults[i])}this.m_pairManager.Commit();this.m_queryResultCount=0;this.IncrementTimeStamp();proxy.userData=null;proxy.overlapCount=b2BroadPhase.b2_invalid;proxy.lowerBounds[0]=b2BroadPhase.b2_invalid;proxy.lowerBounds[1]=b2BroadPhase.b2_invalid;proxy.upperBounds[0]=b2BroadPhase.b2_invalid;proxy.upperBounds[1]=b2BroadPhase.b2_invalid;proxy.SetNext(this.m_freeProxy);this.m_freeProxy=proxyId;--this.m_proxyCount},MoveProxy:function(proxyId,aabb){var axis=0;var index=0;var bound;var prevBound;var nextBound;var nextProxyId=0;var nextProxy;if(proxyId==b2Pair.b2_nullProxy||b2Settings.b2_maxProxies<=proxyId){return}if(aabb.IsValid()==false){return}var boundCount=2*this.m_proxyCount;var proxy=this.m_proxyPool[proxyId];var newValues=new b2BoundValues;this.ComputeBounds(newValues.lowerValues,newValues.upperValues,aabb);var oldValues=new b2BoundValues;for(axis=0;axis<2;++axis){oldValues.lowerValues[axis]=this.m_bounds[axis][proxy.lowerBounds[axis]].value;oldValues.upperValues[axis]=this.m_bounds[axis][proxy.upperBounds[axis]].value}for(axis=0;axis<2;++axis){var bounds=this.m_bounds[axis];var lowerIndex=proxy.lowerBounds[axis];var upperIndex=proxy.upperBounds[axis];var lowerValue=newValues.lowerValues[axis];var upperValue=newValues.upperValues[axis];var deltaLower=lowerValue-bounds[lowerIndex].value;var deltaUpper=upperValue-bounds[upperIndex].value;bounds[lowerIndex].value=lowerValue;bounds[upperIndex].value=upperValue;if(deltaLower<0){index=lowerIndex;while(index>0&&lowerValue<bounds[index-1].value){bound=bounds[index];prevBound=bounds[index-1];var prevProxyId=prevBound.proxyId;var prevProxy=this.m_proxyPool[prevBound.proxyId];prevBound.stabbingCount++;if(prevBound.IsUpper()==true){if(this.TestOverlap(newValues,prevProxy)){this.m_pairManager.AddBufferedPair(proxyId,prevProxyId)}prevProxy.upperBounds[axis]++;bound.stabbingCount++}else{prevProxy.lowerBounds[axis]++;bound.stabbingCount--}proxy.lowerBounds[axis]--;bound.Swap(prevBound);--index}}if(deltaUpper>0){index=upperIndex;while(index<boundCount-1&&bounds[index+1].value<=upperValue){bound=bounds[index];nextBound=bounds[index+1];nextProxyId=nextBound.proxyId;nextProxy=this.m_proxyPool[nextProxyId];nextBound.stabbingCount++;if(nextBound.IsLower()==true){if(this.TestOverlap(newValues,nextProxy)){this.m_pairManager.AddBufferedPair(proxyId,nextProxyId)}nextProxy.lowerBounds[axis]--;bound.stabbingCount++}else{nextProxy.upperBounds[axis]--;bound.stabbingCount--}proxy.upperBounds[axis]++;bound.Swap(nextBound);index++}}if(deltaLower>0){index=lowerIndex;while(index<boundCount-1&&bounds[index+1].value<=lowerValue){bound=bounds[index];nextBound=bounds[index+1];nextProxyId=nextBound.proxyId;nextProxy=this.m_proxyPool[nextProxyId];nextBound.stabbingCount--;if(nextBound.IsUpper()){if(this.TestOverlap(oldValues,nextProxy)){this.m_pairManager.RemoveBufferedPair(proxyId,nextProxyId)}nextProxy.upperBounds[axis]--;bound.stabbingCount--}else{nextProxy.lowerBounds[axis]--;bound.stabbingCount++}proxy.lowerBounds[axis]++;bound.Swap(nextBound);index++}}if(deltaUpper<0){index=upperIndex;while(index>0&&upperValue<bounds[index-1].value){bound=bounds[index];prevBound=bounds[index-1];prevProxyId=prevBound.proxyId;prevProxy=this.m_proxyPool[prevProxyId];prevBound.stabbingCount--;if(prevBound.IsLower()==true){if(this.TestOverlap(oldValues,prevProxy)){this.m_pairManager.RemoveBufferedPair(proxyId,prevProxyId)}prevProxy.lowerBounds[axis]++;bound.stabbingCount--}else{prevProxy.upperBounds[axis]++;bound.stabbingCount++}proxy.upperBounds[axis]--;bound.Swap(prevBound);index--}}}},Commit:function(){this.m_pairManager.Commit()},QueryAABB:function(aabb,userData,maxCount){var lowerValues=new Array;var upperValues=new Array;this.ComputeBounds(lowerValues,upperValues,aabb);var lowerIndex=0;var upperIndex=0;var lowerIndexOut=[lowerIndex];var upperIndexOut=[upperIndex];this.Query(lowerIndexOut,upperIndexOut,lowerValues[0],upperValues[0],this.m_bounds[0],2*this.m_proxyCount,0);this.Query(lowerIndexOut,upperIndexOut,lowerValues[1],upperValues[1],this.m_bounds[1],2*this.m_proxyCount,1);var count=0;for(var i=0;i<this.m_queryResultCount&&count<maxCount;++i,++count){var proxy=this.m_proxyPool[this.m_queryResults[i]];userData[i]=proxy.userData}this.m_queryResultCount=0;this.IncrementTimeStamp();return count},Validate:function(){var pair;var proxy1;var proxy2;var overlap;for(var axis=0;axis<2;++axis){var bounds=this.m_bounds[axis];var boundCount=2*this.m_proxyCount;var stabbingCount=0;for(var i=0;i<boundCount;++i){var bound=bounds[i];if(bound.IsLower()==true){stabbingCount++}else{stabbingCount--}}}},ComputeBounds:function(lowerValues,upperValues,aabb){var minVertexX=aabb.minVertex.x;var minVertexY=aabb.minVertex.y;minVertexX=b2Math.b2Min(minVertexX,this.m_worldAABB.maxVertex.x);minVertexY=b2Math.b2Min(minVertexY,this.m_worldAABB.maxVertex.y);minVertexX=b2Math.b2Max(minVertexX,this.m_worldAABB.minVertex.x);minVertexY=b2Math.b2Max(minVertexY,this.m_worldAABB.minVertex.y);var maxVertexX=aabb.maxVertex.x;var maxVertexY=aabb.maxVertex.y;maxVertexX=b2Math.b2Min(maxVertexX,this.m_worldAABB.maxVertex.x);maxVertexY=b2Math.b2Min(maxVertexY,this.m_worldAABB.maxVertex.y);maxVertexX=b2Math.b2Max(maxVertexX,this.m_worldAABB.minVertex.x);maxVertexY=b2Math.b2Max(maxVertexY,this.m_worldAABB.minVertex.y);lowerValues[0]=this.m_quantizationFactor.x*(minVertexX-this.m_worldAABB.minVertex.x)&b2Settings.USHRT_MAX-1;upperValues[0]=this.m_quantizationFactor.x*(maxVertexX-this.m_worldAABB.minVertex.x)&65535|1;lowerValues[1]=this.m_quantizationFactor.y*(minVertexY-this.m_worldAABB.minVertex.y)&b2Settings.USHRT_MAX-1;upperValues[1]=this.m_quantizationFactor.y*(maxVertexY-this.m_worldAABB.minVertex.y)&65535|1},TestOverlapValidate:function(p1,p2){for(var axis=0;axis<2;++axis){var bounds=this.m_bounds[axis];if(bounds[p1.lowerBounds[axis]].value>bounds[p2.upperBounds[axis]].value)return false;if(bounds[p1.upperBounds[axis]].value<bounds[p2.lowerBounds[axis]].value)return false}return true},TestOverlap:function(b,p){for(var axis=0;axis<2;++axis){var bounds=this.m_bounds[axis];if(b.lowerValues[axis]>bounds[p.upperBounds[axis]].value)return false;if(b.upperValues[axis]<bounds[p.lowerBounds[axis]].value)return false}return true},Query:function(lowerQueryOut,upperQueryOut,lowerValue,upperValue,bounds,boundCount,axis){var lowerQuery=b2BroadPhase.BinarySearch(bounds,boundCount,lowerValue);var upperQuery=b2BroadPhase.BinarySearch(bounds,boundCount,upperValue);for(var j=lowerQuery;j<upperQuery;++j){if(bounds[j].IsLower()){this.IncrementOverlapCount(bounds[j].proxyId)}}if(lowerQuery>0){var i=lowerQuery-1;var s=bounds[i].stabbingCount;while(s){if(bounds[i].IsLower()){var proxy=this.m_proxyPool[bounds[i].proxyId];if(lowerQuery<=proxy.upperBounds[axis]){this.IncrementOverlapCount(bounds[i].proxyId);--s}}--i}}lowerQueryOut[0]=lowerQuery;upperQueryOut[0]=upperQuery},IncrementOverlapCount:function(proxyId){var proxy=this.m_proxyPool[proxyId];if(proxy.timeStamp<this.m_timeStamp){proxy.timeStamp=this.m_timeStamp;proxy.overlapCount=1}else{proxy.overlapCount=2;this.m_queryResults[this.m_queryResultCount]=proxyId;++this.m_queryResultCount}},IncrementTimeStamp:function(){if(this.m_timeStamp==b2Settings.USHRT_MAX){for(var i=0;i<b2Settings.b2_maxProxies;++i){this.m_proxyPool[i].timeStamp=0}this.m_timeStamp=1}else{++this.m_timeStamp}},m_pairManager:new b2PairManager,m_proxyPool:new Array(b2Settings.b2_maxPairs),m_freeProxy:0,m_bounds:new Array(2*b2Settings.b2_maxProxies),m_queryResults:new Array(b2Settings.b2_maxProxies),m_queryResultCount:0,m_worldAABB:null,m_quantizationFactor:new b2Vec2,m_proxyCount:0,m_timeStamp:0};b2BroadPhase.s_validate=false;b2BroadPhase.b2_invalid=b2Settings.USHRT_MAX;b2BroadPhase.b2_nullEdge=b2Settings.USHRT_MAX;b2BroadPhase.BinarySearch=function(bounds,count,value){var low=0;var high=count-1;while(low<=high){var mid=Math.floor((low+high)/2);if(bounds[mid].value>value){high=mid-1}else if(bounds[mid].value<value){low=mid+1}else{return mid}}return low};var b2Collision=Class.create();b2Collision.prototype={initialize:function(){}};b2Collision.b2_nullFeature=255;b2Collision.ClipSegmentToLine=function(vOut,vIn,normal,offset){var numOut=0;var vIn0=vIn[0].v;var vIn1=vIn[1].v;var distance0=b2Math.b2Dot(normal,vIn[0].v)-offset;var distance1=b2Math.b2Dot(normal,vIn[1].v)-offset;if(distance0<=0)vOut[numOut++]=vIn[0];if(distance1<=0)vOut[numOut++]=vIn[1];if(distance0*distance1<0){var interp=distance0/(distance0-distance1);var tVec=vOut[numOut].v;tVec.x=vIn0.x+interp*(vIn1.x-vIn0.x);tVec.y=vIn0.y+interp*(vIn1.y-vIn0.y);if(distance0>0){vOut[numOut].id=vIn[0].id}else{vOut[numOut].id=vIn[1].id}++numOut}return numOut};b2Collision.EdgeSeparation=function(poly1,edge1,poly2){var vert1s=poly1.m_vertices;var count2=poly2.m_vertexCount;var vert2s=poly2.m_vertices;var normalX=poly1.m_normals[edge1].x;var normalY=poly1.m_normals[edge1].y;var tX=normalX;var tMat=poly1.m_R;normalX=tMat.col1.x*tX+tMat.col2.x*normalY;normalY=tMat.col1.y*tX+tMat.col2.y*normalY;var normalLocal2X=normalX;var normalLocal2Y=normalY;tMat=poly2.m_R;tX=normalLocal2X*tMat.col1.x+normalLocal2Y*tMat.col1.y;normalLocal2Y=normalLocal2X*tMat.col2.x+normalLocal2Y*tMat.col2.y;normalLocal2X=tX;var vertexIndex2=0;var minDot=Number.MAX_VALUE;for(var i=0;i<count2;++i){var tVec=vert2s[i];var dot=tVec.x*normalLocal2X+tVec.y*normalLocal2Y;if(dot<minDot){minDot=dot;vertexIndex2=i}}tMat=poly1.m_R;var v1X=poly1.m_position.x+(tMat.col1.x*vert1s[edge1].x+tMat.col2.x*vert1s[edge1].y);var v1Y=poly1.m_position.y+(tMat.col1.y*vert1s[edge1].x+tMat.col2.y*vert1s[edge1].y);tMat=poly2.m_R;var v2X=poly2.m_position.x+(tMat.col1.x*vert2s[vertexIndex2].x+tMat.col2.x*vert2s[vertexIndex2].y);var v2Y=poly2.m_position.y+(tMat.col1.y*vert2s[vertexIndex2].x+tMat.col2.y*vert2s[vertexIndex2].y);v2X-=v1X;v2Y-=v1Y;var separation=v2X*normalX+v2Y*normalY;return separation};b2Collision.FindMaxSeparation=function(edgeIndex,poly1,poly2,conservative){var count1=poly1.m_vertexCount;var dX=poly2.m_position.x-poly1.m_position.x;var dY=poly2.m_position.y-poly1.m_position.y;var dLocal1X=dX*poly1.m_R.col1.x+dY*poly1.m_R.col1.y;var dLocal1Y=dX*poly1.m_R.col2.x+dY*poly1.m_R.col2.y;var edge=0;var maxDot=-Number.MAX_VALUE;for(var i=0;i<count1;++i){var dot=poly1.m_normals[i].x*dLocal1X+poly1.m_normals[i].y*dLocal1Y;if(dot>maxDot){maxDot=dot;edge=i}}var s=b2Collision.EdgeSeparation(poly1,edge,poly2);if(s>0&&conservative==false){return s}var prevEdge=edge-1>=0?edge-1:count1-1;var sPrev=b2Collision.EdgeSeparation(poly1,prevEdge,poly2);if(sPrev>0&&conservative==false){return sPrev}var nextEdge=edge+1<count1?edge+1:0;var sNext=b2Collision.EdgeSeparation(poly1,nextEdge,poly2);if(sNext>0&&conservative==false){return sNext}var bestEdge=0;var bestSeparation;var increment=0;if(sPrev>s&&sPrev>sNext){increment=-1;bestEdge=prevEdge;bestSeparation=sPrev}else if(sNext>s){increment=1;bestEdge=nextEdge;bestSeparation=sNext}else{edgeIndex[0]=edge;return s}while(true){if(increment==-1)edge=bestEdge-1>=0?bestEdge-1:count1-1;else edge=bestEdge+1<count1?bestEdge+1:0;s=b2Collision.EdgeSeparation(poly1,edge,poly2);if(s>0&&conservative==false){return s}if(s>bestSeparation){bestEdge=edge;bestSeparation=s}else{break}}edgeIndex[0]=bestEdge;return bestSeparation};b2Collision.FindIncidentEdge=function(c,poly1,edge1,poly2){var count1=poly1.m_vertexCount;var vert1s=poly1.m_vertices;var count2=poly2.m_vertexCount;var vert2s=poly2.m_vertices;var vertex11=edge1;var vertex12=edge1+1==count1?0:edge1+1;var tVec=vert1s[vertex12];var normal1Local1X=tVec.x;var normal1Local1Y=tVec.y;tVec=vert1s[vertex11];normal1Local1X-=tVec.x;normal1Local1Y-=tVec.y;var tX=normal1Local1X;normal1Local1X=normal1Local1Y;normal1Local1Y=-tX;var invLength=1/Math.sqrt(normal1Local1X*normal1Local1X+normal1Local1Y*normal1Local1Y);normal1Local1X*=invLength;normal1Local1Y*=invLength;var normal1X=normal1Local1X;var normal1Y=normal1Local1Y;tX=normal1X;var tMat=poly1.m_R;normal1X=tMat.col1.x*tX+tMat.col2.x*normal1Y;normal1Y=tMat.col1.y*tX+tMat.col2.y*normal1Y;var normal1Local2X=normal1X;var normal1Local2Y=normal1Y;tMat=poly2.m_R;tX=normal1Local2X*tMat.col1.x+normal1Local2Y*tMat.col1.y;normal1Local2Y=normal1Local2X*tMat.col2.x+normal1Local2Y*tMat.col2.y;normal1Local2X=tX;var vertex21=0;var vertex22=0;var minDot=Number.MAX_VALUE;for(var i=0;i<count2;++i){var i1=i;var i2=i+1<count2?i+1:0;tVec=vert2s[i2];var normal2Local2X=tVec.x;var normal2Local2Y=tVec.y;tVec=vert2s[i1];normal2Local2X-=tVec.x;normal2Local2Y-=tVec.y;tX=normal2Local2X;normal2Local2X=normal2Local2Y;normal2Local2Y=-tX;invLength=1/Math.sqrt(normal2Local2X*normal2Local2X+normal2Local2Y*normal2Local2Y);normal2Local2X*=invLength;normal2Local2Y*=invLength;var dot=normal2Local2X*normal1Local2X+normal2Local2Y*normal1Local2Y;if(dot<minDot){minDot=dot;vertex21=i1;vertex22=i2}}var tClip;tClip=c[0];tVec=tClip.v;tVec.SetV(vert2s[vertex21]);tVec.MulM(poly2.m_R);tVec.Add(poly2.m_position);tClip.id.features.referenceFace=edge1;tClip.id.features.incidentEdge=vertex21;tClip.id.features.incidentVertex=vertex21;tClip=c[1];tVec=tClip.v;tVec.SetV(vert2s[vertex22]);tVec.MulM(poly2.m_R);tVec.Add(poly2.m_position);tClip.id.features.referenceFace=edge1;tClip.id.features.incidentEdge=vertex21;tClip.id.features.incidentVertex=vertex22};b2Collision.b2CollidePolyTempVec=new b2Vec2;b2Collision.b2CollidePoly=function(manifold,polyA,polyB,conservative){manifold.pointCount=0;var edgeA=0;var edgeAOut=[edgeA];var separationA=b2Collision.FindMaxSeparation(edgeAOut,polyA,polyB,conservative);edgeA=edgeAOut[0];if(separationA>0&&conservative==false)return;var edgeB=0;var edgeBOut=[edgeB];var separationB=b2Collision.FindMaxSeparation(edgeBOut,polyB,polyA,conservative);edgeB=edgeBOut[0];if(separationB>0&&conservative==false)return;var poly1;var poly2;var edge1=0;var flip=0;var k_relativeTol=.98;var k_absoluteTol=.001;if(separationB>k_relativeTol*separationA+k_absoluteTol){poly1=polyB;poly2=polyA;edge1=edgeB;flip=1}else{poly1=polyA;poly2=polyB;edge1=edgeA;flip=0}var incidentEdge=[new ClipVertex,new ClipVertex];b2Collision.FindIncidentEdge(incidentEdge,poly1,edge1,poly2);var count1=poly1.m_vertexCount;var vert1s=poly1.m_vertices;var v11=vert1s[edge1];var v12=edge1+1<count1?vert1s[edge1+1]:vert1s[0];var dvX=v12.x-v11.x;var dvY=v12.y-v11.y;var sideNormalX=v12.x-v11.x;var sideNormalY=v12.y-v11.y;var tX=sideNormalX;var tMat=poly1.m_R;sideNormalX=tMat.col1.x*tX+tMat.col2.x*sideNormalY;sideNormalY=tMat.col1.y*tX+tMat.col2.y*sideNormalY;var invLength=1/Math.sqrt(sideNormalX*sideNormalX+sideNormalY*sideNormalY);sideNormalX*=invLength;sideNormalY*=invLength;var frontNormalX=sideNormalX;var frontNormalY=sideNormalY;tX=frontNormalX;frontNormalX=frontNormalY;frontNormalY=-tX;var v11X=v11.x;var v11Y=v11.y;tX=v11X;tMat=poly1.m_R;v11X=tMat.col1.x*tX+tMat.col2.x*v11Y;v11Y=tMat.col1.y*tX+tMat.col2.y*v11Y;v11X+=poly1.m_position.x;v11Y+=poly1.m_position.y;var v12X=v12.x;var v12Y=v12.y;tX=v12X;tMat=poly1.m_R;v12X=tMat.col1.x*tX+tMat.col2.x*v12Y;v12Y=tMat.col1.y*tX+tMat.col2.y*v12Y;v12X+=poly1.m_position.x;v12Y+=poly1.m_position.y;var frontOffset=frontNormalX*v11X+frontNormalY*v11Y;var sideOffset1=-(sideNormalX*v11X+sideNormalY*v11Y);var sideOffset2=sideNormalX*v12X+sideNormalY*v12Y;var clipPoints1=[new ClipVertex,new ClipVertex];var clipPoints2=[new ClipVertex,new ClipVertex];var np=0;b2Collision.b2CollidePolyTempVec.Set(-sideNormalX,-sideNormalY);np=b2Collision.ClipSegmentToLine(clipPoints1,incidentEdge,b2Collision.b2CollidePolyTempVec,sideOffset1);if(np<2)return;b2Collision.b2CollidePolyTempVec.Set(sideNormalX,sideNormalY);np=b2Collision.ClipSegmentToLine(clipPoints2,clipPoints1,b2Collision.b2CollidePolyTempVec,sideOffset2);if(np<2)return;if(flip){manifold.normal.Set(-frontNormalX,-frontNormalY)}else{manifold.normal.Set(frontNormalX,frontNormalY)}var pointCount=0;for(var i=0;i<b2Settings.b2_maxManifoldPoints;++i){var tVec=clipPoints2[i].v;var separation=frontNormalX*tVec.x+frontNormalY*tVec.y-frontOffset;if(separation<=0||conservative==true){var cp=manifold.points[pointCount];cp.separation=separation;cp.position.SetV(clipPoints2[i].v);cp.id.Set(clipPoints2[i].id);cp.id.features.flip=flip;++pointCount}}manifold.pointCount=pointCount};b2Collision.b2CollideCircle=function(manifold,circle1,circle2,conservative){manifold.pointCount=0;var dX=circle2.m_position.x-circle1.m_position.x;var dY=circle2.m_position.y-circle1.m_position.y;var distSqr=dX*dX+dY*dY;var radiusSum=circle1.m_radius+circle2.m_radius;if(distSqr>radiusSum*radiusSum&&conservative==false){return}var separation;if(distSqr<Number.MIN_VALUE){separation=-radiusSum;manifold.normal.Set(0,1)
}else{var dist=Math.sqrt(distSqr);separation=dist-radiusSum;var a=1/dist;manifold.normal.x=a*dX;manifold.normal.y=a*dY}manifold.pointCount=1;var tPoint=manifold.points[0];tPoint.id.set_key(0);tPoint.separation=separation;tPoint.position.x=circle2.m_position.x-circle2.m_radius*manifold.normal.x;tPoint.position.y=circle2.m_position.y-circle2.m_radius*manifold.normal.y};b2Collision.b2CollidePolyAndCircle=function(manifold,poly,circle,conservative){manifold.pointCount=0;var tPoint;var dX;var dY;var xLocalX=circle.m_position.x-poly.m_position.x;var xLocalY=circle.m_position.y-poly.m_position.y;var tMat=poly.m_R;var tX=xLocalX*tMat.col1.x+xLocalY*tMat.col1.y;xLocalY=xLocalX*tMat.col2.x+xLocalY*tMat.col2.y;xLocalX=tX;var dist;var normalIndex=0;var separation=-Number.MAX_VALUE;var radius=circle.m_radius;for(var i=0;i<poly.m_vertexCount;++i){var s=poly.m_normals[i].x*(xLocalX-poly.m_vertices[i].x)+poly.m_normals[i].y*(xLocalY-poly.m_vertices[i].y);if(s>radius){return}if(s>separation){separation=s;normalIndex=i}}if(separation<Number.MIN_VALUE){manifold.pointCount=1;var tVec=poly.m_normals[normalIndex];manifold.normal.x=tMat.col1.x*tVec.x+tMat.col2.x*tVec.y;manifold.normal.y=tMat.col1.y*tVec.x+tMat.col2.y*tVec.y;tPoint=manifold.points[0];tPoint.id.features.incidentEdge=normalIndex;tPoint.id.features.incidentVertex=b2Collision.b2_nullFeature;tPoint.id.features.referenceFace=b2Collision.b2_nullFeature;tPoint.id.features.flip=0;tPoint.position.x=circle.m_position.x-radius*manifold.normal.x;tPoint.position.y=circle.m_position.y-radius*manifold.normal.y;tPoint.separation=separation-radius;return}var vertIndex1=normalIndex;var vertIndex2=vertIndex1+1<poly.m_vertexCount?vertIndex1+1:0;var eX=poly.m_vertices[vertIndex2].x-poly.m_vertices[vertIndex1].x;var eY=poly.m_vertices[vertIndex2].y-poly.m_vertices[vertIndex1].y;var length=Math.sqrt(eX*eX+eY*eY);eX/=length;eY/=length;if(length<Number.MIN_VALUE){dX=xLocalX-poly.m_vertices[vertIndex1].x;dY=xLocalY-poly.m_vertices[vertIndex1].y;dist=Math.sqrt(dX*dX+dY*dY);dX/=dist;dY/=dist;if(dist>radius){return}manifold.pointCount=1;manifold.normal.Set(tMat.col1.x*dX+tMat.col2.x*dY,tMat.col1.y*dX+tMat.col2.y*dY);tPoint=manifold.points[0];tPoint.id.features.incidentEdge=b2Collision.b2_nullFeature;tPoint.id.features.incidentVertex=vertIndex1;tPoint.id.features.referenceFace=b2Collision.b2_nullFeature;tPoint.id.features.flip=0;tPoint.position.x=circle.m_position.x-radius*manifold.normal.x;tPoint.position.y=circle.m_position.y-radius*manifold.normal.y;tPoint.separation=dist-radius;return}var u=(xLocalX-poly.m_vertices[vertIndex1].x)*eX+(xLocalY-poly.m_vertices[vertIndex1].y)*eY;tPoint=manifold.points[0];tPoint.id.features.incidentEdge=b2Collision.b2_nullFeature;tPoint.id.features.incidentVertex=b2Collision.b2_nullFeature;tPoint.id.features.referenceFace=b2Collision.b2_nullFeature;tPoint.id.features.flip=0;var pX,pY;if(u<=0){pX=poly.m_vertices[vertIndex1].x;pY=poly.m_vertices[vertIndex1].y;tPoint.id.features.incidentVertex=vertIndex1}else if(u>=length){pX=poly.m_vertices[vertIndex2].x;pY=poly.m_vertices[vertIndex2].y;tPoint.id.features.incidentVertex=vertIndex2}else{pX=eX*u+poly.m_vertices[vertIndex1].x;pY=eY*u+poly.m_vertices[vertIndex1].y;tPoint.id.features.incidentEdge=vertIndex1}dX=xLocalX-pX;dY=xLocalY-pY;dist=Math.sqrt(dX*dX+dY*dY);dX/=dist;dY/=dist;if(dist>radius){return}manifold.pointCount=1;manifold.normal.Set(tMat.col1.x*dX+tMat.col2.x*dY,tMat.col1.y*dX+tMat.col2.y*dY);tPoint.position.x=circle.m_position.x-radius*manifold.normal.x;tPoint.position.y=circle.m_position.y-radius*manifold.normal.y;tPoint.separation=dist-radius};b2Collision.b2TestOverlap=function(a,b){var t1=b.minVertex;var t2=a.maxVertex;var d1X=t1.x-t2.x;var d1Y=t1.y-t2.y;t1=a.minVertex;t2=b.maxVertex;var d2X=t1.x-t2.x;var d2Y=t1.y-t2.y;if(d1X>0||d1Y>0)return false;if(d2X>0||d2Y>0)return false;return true};var Features=Class.create();Features.prototype={set_referenceFace:function(value){this._referenceFace=value;this._m_id._key=this._m_id._key&4294967040|this._referenceFace&255},get_referenceFace:function(){return this._referenceFace},_referenceFace:0,set_incidentEdge:function(value){this._incidentEdge=value;this._m_id._key=this._m_id._key&4294902015|this._incidentEdge<<8&65280},get_incidentEdge:function(){return this._incidentEdge},_incidentEdge:0,set_incidentVertex:function(value){this._incidentVertex=value;this._m_id._key=this._m_id._key&4278255615|this._incidentVertex<<16&16711680},get_incidentVertex:function(){return this._incidentVertex},_incidentVertex:0,set_flip:function(value){this._flip=value;this._m_id._key=this._m_id._key&16777215|this._flip<<24&4278190080},get_flip:function(){return this._flip},_flip:0,_m_id:null,initialize:function(){}};var b2ContactID=Class.create();b2ContactID.prototype={initialize:function(){this.features=new Features;this.features._m_id=this},Set:function(id){this.set_key(id._key)},Copy:function(){var id=new b2ContactID;id.set_key(this._key);return id},get_key:function(){return this._key},set_key:function(value){this._key=value;this.features._referenceFace=this._key&255;this.features._incidentEdge=(this._key&65280)>>8&255;this.features._incidentVertex=(this._key&16711680)>>16&255;this.features._flip=(this._key&4278190080)>>24&255},features:new Features,_key:0};var b2ContactPoint=Class.create();b2ContactPoint.prototype={position:new b2Vec2,separation:null,normalImpulse:null,tangentImpulse:null,id:new b2ContactID,initialize:function(){this.position=new b2Vec2;this.id=new b2ContactID}};var b2Distance=Class.create();b2Distance.prototype={initialize:function(){}};b2Distance.ProcessTwo=function(p1Out,p2Out,p1s,p2s,points){var rX=-points[1].x;var rY=-points[1].y;var dX=points[0].x-points[1].x;var dY=points[0].y-points[1].y;var length=Math.sqrt(dX*dX+dY*dY);dX/=length;dY/=length;var lambda=rX*dX+rY*dY;if(lambda<=0||length<Number.MIN_VALUE){p1Out.SetV(p1s[1]);p2Out.SetV(p2s[1]);p1s[0].SetV(p1s[1]);p2s[0].SetV(p2s[1]);points[0].SetV(points[1]);return 1}lambda/=length;p1Out.x=p1s[1].x+lambda*(p1s[0].x-p1s[1].x);p1Out.y=p1s[1].y+lambda*(p1s[0].y-p1s[1].y);p2Out.x=p2s[1].x+lambda*(p2s[0].x-p2s[1].x);p2Out.y=p2s[1].y+lambda*(p2s[0].y-p2s[1].y);return 2};b2Distance.ProcessThree=function(p1Out,p2Out,p1s,p2s,points){var aX=points[0].x;var aY=points[0].y;var bX=points[1].x;var bY=points[1].y;var cX=points[2].x;var cY=points[2].y;var abX=bX-aX;var abY=bY-aY;var acX=cX-aX;var acY=cY-aY;var bcX=cX-bX;var bcY=cY-bY;var sn=-(aX*abX+aY*abY);var sd=bX*abX+bY*abY;var tn=-(aX*acX+aY*acY);var td=cX*acX+cY*acY;var un=-(bX*bcX+bY*bcY);var ud=cX*bcX+cY*bcY;if(td<=0&&ud<=0){p1Out.SetV(p1s[2]);p2Out.SetV(p2s[2]);p1s[0].SetV(p1s[2]);p2s[0].SetV(p2s[2]);points[0].SetV(points[2]);return 1}var n=abX*acY-abY*acX;var vc=n*(aX*bY-aY*bX);var va=n*(bX*cY-bY*cX);if(va<=0&&un>=0&&ud>=0){var lambda=un/(un+ud);p1Out.x=p1s[1].x+lambda*(p1s[2].x-p1s[1].x);p1Out.y=p1s[1].y+lambda*(p1s[2].y-p1s[1].y);p2Out.x=p2s[1].x+lambda*(p2s[2].x-p2s[1].x);p2Out.y=p2s[1].y+lambda*(p2s[2].y-p2s[1].y);p1s[0].SetV(p1s[2]);p2s[0].SetV(p2s[2]);points[0].SetV(points[2]);return 2}var vb=n*(cX*aY-cY*aX);if(vb<=0&&tn>=0&&td>=0){var lambda=tn/(tn+td);p1Out.x=p1s[0].x+lambda*(p1s[2].x-p1s[0].x);p1Out.y=p1s[0].y+lambda*(p1s[2].y-p1s[0].y);p2Out.x=p2s[0].x+lambda*(p2s[2].x-p2s[0].x);p2Out.y=p2s[0].y+lambda*(p2s[2].y-p2s[0].y);p1s[1].SetV(p1s[2]);p2s[1].SetV(p2s[2]);points[1].SetV(points[2]);return 2}var denom=va+vb+vc;denom=1/denom;var u=va*denom;var v=vb*denom;var w=1-u-v;p1Out.x=u*p1s[0].x+v*p1s[1].x+w*p1s[2].x;p1Out.y=u*p1s[0].y+v*p1s[1].y+w*p1s[2].y;p2Out.x=u*p2s[0].x+v*p2s[1].x+w*p2s[2].x;p2Out.y=u*p2s[0].y+v*p2s[1].y+w*p2s[2].y;return 3};b2Distance.InPoinsts=function(w,points,pointCount){for(var i=0;i<pointCount;++i){if(w.x==points[i].x&&w.y==points[i].y){return true}}return false};b2Distance.Distance=function(p1Out,p2Out,shape1,shape2){var p1s=new Array(3);var p2s=new Array(3);var points=new Array(3);var pointCount=0;p1Out.SetV(shape1.m_position);p2Out.SetV(shape2.m_position);var vSqr=0;var maxIterations=20;for(var iter=0;iter<maxIterations;++iter){var vX=p2Out.x-p1Out.x;var vY=p2Out.y-p1Out.y;var w1=shape1.Support(vX,vY);var w2=shape2.Support(-vX,-vY);vSqr=vX*vX+vY*vY;var wX=w2.x-w1.x;var wY=w2.y-w1.y;var vw=vX*wX+vY*wY;if(vSqr-b2Dot(vX*wX+vY*wY)<=.01*vSqr){if(pointCount==0){p1Out.SetV(w1);p2Out.SetV(w2)}b2Distance.g_GJK_Iterations=iter;return Math.sqrt(vSqr)}switch(pointCount){case 0:p1s[0].SetV(w1);p2s[0].SetV(w2);points[0]=w;p1Out.SetV(p1s[0]);p2Out.SetV(p2s[0]);++pointCount;break;case 1:p1s[1].SetV(w1);p2s[1].SetV(w2);points[1].x=wX;points[1].y=wY;pointCount=b2Distance.ProcessTwo(p1Out,p2Out,p1s,p2s,points);break;case 2:p1s[2].SetV(w1);p2s[2].SetV(w2);points[2].x=wX;points[2].y=wY;pointCount=b2Distance.ProcessThree(p1Out,p2Out,p1s,p2s,points);break}if(pointCount==3){b2Distance.g_GJK_Iterations=iter;return 0}var maxSqr=-Number.MAX_VALUE;for(var i=0;i<pointCount;++i){maxSqr=b2Math.b2Max(maxSqr,points[i].x*points[i].x+points[i].y*points[i].y)}if(pointCount==3||vSqr<=100*Number.MIN_VALUE*maxSqr){b2Distance.g_GJK_Iterations=iter;return Math.sqrt(vSqr)}}b2Distance.g_GJK_Iterations=maxIterations;return Math.sqrt(vSqr)};b2Distance.g_GJK_Iterations=0;var b2Manifold=Class.create();b2Manifold.prototype={initialize:function(){this.points=new Array(b2Settings.b2_maxManifoldPoints);for(var i=0;i<b2Settings.b2_maxManifoldPoints;i++){this.points[i]=new b2ContactPoint}this.normal=new b2Vec2},points:null,normal:null,pointCount:0};var b2OBB=Class.create();b2OBB.prototype={R:new b2Mat22,center:new b2Vec2,extents:new b2Vec2,initialize:function(){this.R=new b2Mat22;this.center=new b2Vec2;this.extents=new b2Vec2}};var b2Proxy=Class.create();b2Proxy.prototype={GetNext:function(){return this.lowerBounds[0]},SetNext:function(next){this.lowerBounds[0]=next},IsValid:function(){return this.overlapCount!=b2BroadPhase.b2_invalid},lowerBounds:[0,0],upperBounds:[0,0],overlapCount:0,timeStamp:0,userData:null,initialize:function(){this.lowerBounds=[0,0];this.upperBounds=[0,0]}};var ClipVertex=Class.create();ClipVertex.prototype={v:new b2Vec2,id:new b2ContactID,initialize:function(){this.v=new b2Vec2;this.id=new b2ContactID}};var b2Shape=Class.create();b2Shape.prototype={TestPoint:function(p){return false},GetUserData:function(){return this.m_userData},GetType:function(){return this.m_type},GetBody:function(){return this.m_body},GetPosition:function(){return this.m_position},GetRotationMatrix:function(){return this.m_R},ResetProxy:function(broadPhase){},GetNext:function(){return this.m_next},initialize:function(def,body){this.m_R=new b2Mat22;this.m_position=new b2Vec2;this.m_userData=def.userData;this.m_friction=def.friction;this.m_restitution=def.restitution;this.m_body=body;this.m_proxyId=b2Pair.b2_nullProxy;this.m_maxRadius=0;this.m_categoryBits=def.categoryBits;this.m_maskBits=def.maskBits;this.m_groupIndex=def.groupIndex},DestroyProxy:function(){if(this.m_proxyId!=b2Pair.b2_nullProxy){this.m_body.m_world.m_broadPhase.DestroyProxy(this.m_proxyId);this.m_proxyId=b2Pair.b2_nullProxy}},Synchronize:function(position1,R1,position2,R2){},QuickSync:function(position,R){},Support:function(dX,dY,out){},GetMaxRadius:function(){return this.m_maxRadius},m_next:null,m_R:new b2Mat22,m_position:new b2Vec2,m_type:0,m_userData:null,m_body:null,m_friction:null,m_restitution:null,m_maxRadius:null,m_proxyId:0,m_categoryBits:0,m_maskBits:0,m_groupIndex:0};b2Shape.Create=function(def,body,center){switch(def.type){case b2Shape.e_circleShape:{return new b2CircleShape(def,body,center)}case b2Shape.e_boxShape:case b2Shape.e_polyShape:{return new b2PolyShape(def,body,center)}}return null};b2Shape.Destroy=function(shape){if(shape.m_proxyId!=b2Pair.b2_nullProxy)shape.m_body.m_world.m_broadPhase.DestroyProxy(shape.m_proxyId)};b2Shape.e_unknownShape=-1;b2Shape.e_circleShape=0;b2Shape.e_boxShape=1;b2Shape.e_polyShape=2;b2Shape.e_meshShape=3;b2Shape.e_shapeTypeCount=4;b2Shape.PolyMass=function(massData,vs,count,rho){var center=new b2Vec2;center.SetZero();var area=0;var I=0;var pRef=new b2Vec2(0,0);var inv3=1/3;for(var i=0;i<count;++i){var p1=pRef;var p2=vs[i];var p3=i+1<count?vs[i+1]:vs[0];var e1=b2Math.SubtractVV(p2,p1);var e2=b2Math.SubtractVV(p3,p1);var D=b2Math.b2CrossVV(e1,e2);var triangleArea=.5*D;area+=triangleArea;var tVec=new b2Vec2;tVec.SetV(p1);tVec.Add(p2);tVec.Add(p3);tVec.Multiply(inv3*triangleArea);center.Add(tVec);var px=p1.x;var py=p1.y;var ex1=e1.x;var ey1=e1.y;var ex2=e2.x;var ey2=e2.y;var intx2=inv3*(.25*(ex1*ex1+ex2*ex1+ex2*ex2)+(px*ex1+px*ex2))+.5*px*px;var inty2=inv3*(.25*(ey1*ey1+ey2*ey1+ey2*ey2)+(py*ey1+py*ey2))+.5*py*py;I+=D*(intx2+inty2)}massData.mass=rho*area;center.Multiply(1/area);massData.center=center;I=rho*(I-area*b2Math.b2Dot(center,center));massData.I=I};b2Shape.PolyCentroid=function(vs,count,out){var cX=0;var cY=0;var area=0;var pRefX=0;var pRefY=0;var inv3=1/3;for(var i=0;i<count;++i){var p1X=pRefX;var p1Y=pRefY;var p2X=vs[i].x;var p2Y=vs[i].y;var p3X=i+1<count?vs[i+1].x:vs[0].x;var p3Y=i+1<count?vs[i+1].y:vs[0].y;var e1X=p2X-p1X;var e1Y=p2Y-p1Y;var e2X=p3X-p1X;var e2Y=p3Y-p1Y;var D=e1X*e2Y-e1Y*e2X;var triangleArea=.5*D;area+=triangleArea;cX+=triangleArea*inv3*(p1X+p2X+p3X);cY+=triangleArea*inv3*(p1Y+p2Y+p3Y)}cX*=1/area;cY*=1/area;out.Set(cX,cY)};var b2ShapeDef=Class.create();b2ShapeDef.prototype={initialize:function(){this.type=b2Shape.e_unknownShape;this.userData=null;this.localPosition=new b2Vec2(0,0);this.localRotation=0;this.friction=.2;this.restitution=0;this.density=0;this.categoryBits=1;this.maskBits=65535;this.groupIndex=0},ComputeMass:function(massData){massData.center=new b2Vec2(0,0);if(this.density==0){massData.mass=0;massData.center.Set(0,0);massData.I=0}switch(this.type){case b2Shape.e_circleShape:{var circle=this;massData.mass=this.density*b2Settings.b2_pi*circle.radius*circle.radius;massData.center.Set(0,0);massData.I=.5*massData.mass*circle.radius*circle.radius}break;case b2Shape.e_boxShape:{var box=this;massData.mass=4*this.density*box.extents.x*box.extents.y;massData.center.Set(0,0);massData.I=massData.mass/3*b2Math.b2Dot(box.extents,box.extents)}break;case b2Shape.e_polyShape:{var poly=this;b2Shape.PolyMass(massData,poly.vertices,poly.vertexCount,this.density)}break;default:massData.mass=0;massData.center.Set(0,0);massData.I=0;break}},type:0,userData:null,localPosition:null,localRotation:null,friction:null,restitution:null,density:null,categoryBits:0,maskBits:0,groupIndex:0};var b2BoxDef=Class.create();Object.extend(b2BoxDef.prototype,b2ShapeDef.prototype);Object.extend(b2BoxDef.prototype,{initialize:function(){this.type=b2Shape.e_unknownShape;this.userData=null;this.localPosition=new b2Vec2(0,0);this.localRotation=0;this.friction=.2;this.restitution=0;this.density=0;this.categoryBits=1;this.maskBits=65535;this.groupIndex=0;this.type=b2Shape.e_boxShape;this.extents=new b2Vec2(1,1)},extents:null});var b2CircleDef=Class.create();Object.extend(b2CircleDef.prototype,b2ShapeDef.prototype);Object.extend(b2CircleDef.prototype,{initialize:function(){this.type=b2Shape.e_unknownShape;this.userData=null;this.localPosition=new b2Vec2(0,0);this.localRotation=0;this.friction=.2;this.restitution=0;this.density=0;this.categoryBits=1;this.maskBits=65535;this.groupIndex=0;this.type=b2Shape.e_circleShape;this.radius=1},radius:null});var b2CircleShape=Class.create();Object.extend(b2CircleShape.prototype,b2Shape.prototype);Object.extend(b2CircleShape.prototype,{TestPoint:function(p){var d=new b2Vec2;d.SetV(p);d.Subtract(this.m_position);return b2Math.b2Dot(d,d)<=this.m_radius*this.m_radius},initialize:function(def,body,localCenter){this.m_R=new b2Mat22;this.m_position=new b2Vec2;this.m_userData=def.userData;this.m_friction=def.friction;this.m_restitution=def.restitution;this.m_body=body;this.m_proxyId=b2Pair.b2_nullProxy;this.m_maxRadius=0;this.m_categoryBits=def.categoryBits;this.m_maskBits=def.maskBits;this.m_groupIndex=def.groupIndex;this.m_localPosition=new b2Vec2;var circle=def;this.m_localPosition.Set(def.localPosition.x-localCenter.x,def.localPosition.y-localCenter.y);this.m_type=b2Shape.e_circleShape;this.m_radius=circle.radius;this.m_R.SetM(this.m_body.m_R);var rX=this.m_R.col1.x*this.m_localPosition.x+this.m_R.col2.x*this.m_localPosition.y;var rY=this.m_R.col1.y*this.m_localPosition.x+this.m_R.col2.y*this.m_localPosition.y;this.m_position.x=this.m_body.m_position.x+rX;this.m_position.y=this.m_body.m_position.y+rY;this.m_maxRadius=Math.sqrt(rX*rX+rY*rY)+this.m_radius;var aabb=new b2AABB;aabb.minVertex.Set(this.m_position.x-this.m_radius,this.m_position.y-this.m_radius);aabb.maxVertex.Set(this.m_position.x+this.m_radius,this.m_position.y+this.m_radius);var broadPhase=this.m_body.m_world.m_broadPhase;if(broadPhase.InRange(aabb)){this.m_proxyId=broadPhase.CreateProxy(aabb,this)}else{this.m_proxyId=b2Pair.b2_nullProxy}if(this.m_proxyId==b2Pair.b2_nullProxy){this.m_body.Freeze()}},Synchronize:function(position1,R1,position2,R2){this.m_R.SetM(R2);this.m_position.x=R2.col1.x*this.m_localPosition.x+R2.col2.x*this.m_localPosition.y+position2.x;this.m_position.y=R2.col1.y*this.m_localPosition.x+R2.col2.y*this.m_localPosition.y+position2.y;if(this.m_proxyId==b2Pair.b2_nullProxy){return}var p1X=position1.x+(R1.col1.x*this.m_localPosition.x+R1.col2.x*this.m_localPosition.y);var p1Y=position1.y+(R1.col1.y*this.m_localPosition.x+R1.col2.y*this.m_localPosition.y);var lowerX=Math.min(p1X,this.m_position.x);var lowerY=Math.min(p1Y,this.m_position.y);var upperX=Math.max(p1X,this.m_position.x);var upperY=Math.max(p1Y,this.m_position.y);var aabb=new b2AABB;aabb.minVertex.Set(lowerX-this.m_radius,lowerY-this.m_radius);aabb.maxVertex.Set(upperX+this.m_radius,upperY+this.m_radius);var broadPhase=this.m_body.m_world.m_broadPhase;if(broadPhase.InRange(aabb)){broadPhase.MoveProxy(this.m_proxyId,aabb)}else{this.m_body.Freeze()}},QuickSync:function(position,R){this.m_R.SetM(R);this.m_position.x=R.col1.x*this.m_localPosition.x+R.col2.x*this.m_localPosition.y+position.x;this.m_position.y=R.col1.y*this.m_localPosition.x+R.col2.y*this.m_localPosition.y+position.y},ResetProxy:function(broadPhase){if(this.m_proxyId==b2Pair.b2_nullProxy){return}var proxy=broadPhase.GetProxy(this.m_proxyId);broadPhase.DestroyProxy(this.m_proxyId);proxy=null;var aabb=new b2AABB;aabb.minVertex.Set(this.m_position.x-this.m_radius,this.m_position.y-this.m_radius);aabb.maxVertex.Set(this.m_position.x+this.m_radius,this.m_position.y+this.m_radius);if(broadPhase.InRange(aabb)){this.m_proxyId=broadPhase.CreateProxy(aabb,this)}else{this.m_proxyId=b2Pair.b2_nullProxy}if(this.m_proxyId==b2Pair.b2_nullProxy){this.m_body.Freeze()}},Support:function(dX,dY,out){var len=Math.sqrt(dX*dX+dY*dY);dX/=len;dY/=len;out.Set(this.m_position.x+this.m_radius*dX,this.m_position.y+this.m_radius*dY)},m_localPosition:new b2Vec2,m_radius:null});var b2MassData=Class.create();b2MassData.prototype={mass:0,center:new b2Vec2(0,0),I:0,initialize:function(){this.center=new b2Vec2(0,0)}};var b2PolyDef=Class.create();Object.extend(b2PolyDef.prototype,b2ShapeDef.prototype);Object.extend(b2PolyDef.prototype,{initialize:function(){this.type=b2Shape.e_unknownShape;this.userData=null;this.localPosition=new b2Vec2(0,0);this.localRotation=0;this.friction=.2;this.restitution=0;this.density=0;this.categoryBits=1;this.maskBits=65535;this.groupIndex=0;this.vertices=new Array(b2Settings.b2_maxPolyVertices);this.type=b2Shape.e_polyShape;this.vertexCount=0;for(var i=0;i<b2Settings.b2_maxPolyVertices;i++){this.vertices[i]=new b2Vec2}},vertices:new Array(b2Settings.b2_maxPolyVertices),vertexCount:0});var b2PolyShape=Class.create();Object.extend(b2PolyShape.prototype,b2Shape.prototype);Object.extend(b2PolyShape.prototype,{TestPoint:function(p){var pLocal=new b2Vec2;pLocal.SetV(p);pLocal.Subtract(this.m_position);pLocal.MulTM(this.m_R);for(var i=0;i<this.m_vertexCount;++i){var tVec=new b2Vec2;tVec.SetV(pLocal);tVec.Subtract(this.m_vertices[i]);var dot=b2Math.b2Dot(this.m_normals[i],tVec);if(dot>0){return false}}return true},initialize:function(def,body,newOrigin){this.m_R=new b2Mat22;this.m_position=new b2Vec2;this.m_userData=def.userData;this.m_friction=def.friction;this.m_restitution=def.restitution;this.m_body=body;this.m_proxyId=b2Pair.b2_nullProxy;this.m_maxRadius=0;this.m_categoryBits=def.categoryBits;this.m_maskBits=def.maskBits;this.m_groupIndex=def.groupIndex;this.syncAABB=new b2AABB;this.syncMat=new b2Mat22;this.m_localCentroid=new b2Vec2;this.m_localOBB=new b2OBB;var i=0;var hX;var hY;var tVec;var aabb=new b2AABB;this.m_vertices=new Array(b2Settings.b2_maxPolyVertices);this.m_coreVertices=new Array(b2Settings.b2_maxPolyVertices);this.m_normals=new Array(b2Settings.b2_maxPolyVertices);this.m_type=b2Shape.e_polyShape;var localR=new b2Mat22(def.localRotation);if(def.type==b2Shape.e_boxShape){this.m_localCentroid.x=def.localPosition.x-newOrigin.x;this.m_localCentroid.y=def.localPosition.y-newOrigin.y;var box=def;this.m_vertexCount=4;hX=box.extents.x;hY=box.extents.y;var hcX=Math.max(0,hX-2*b2Settings.b2_linearSlop);var hcY=Math.max(0,hY-2*b2Settings.b2_linearSlop);tVec=this.m_vertices[0]=new b2Vec2;tVec.x=localR.col1.x*hX+localR.col2.x*hY;tVec.y=localR.col1.y*hX+localR.col2.y*hY;tVec=this.m_vertices[1]=new b2Vec2;tVec.x=localR.col1.x*-hX+localR.col2.x*hY;tVec.y=localR.col1.y*-hX+localR.col2.y*hY;tVec=this.m_vertices[2]=new b2Vec2;tVec.x=localR.col1.x*-hX+localR.col2.x*-hY;tVec.y=localR.col1.y*-hX+localR.col2.y*-hY;tVec=this.m_vertices[3]=new b2Vec2;tVec.x=localR.col1.x*hX+localR.col2.x*-hY;tVec.y=localR.col1.y*hX+localR.col2.y*-hY;tVec=this.m_coreVertices[0]=new b2Vec2;tVec.x=localR.col1.x*hcX+localR.col2.x*hcY;tVec.y=localR.col1.y*hcX+localR.col2.y*hcY;tVec=this.m_coreVertices[1]=new b2Vec2;tVec.x=localR.col1.x*-hcX+localR.col2.x*hcY;tVec.y=localR.col1.y*-hcX+localR.col2.y*hcY;tVec=this.m_coreVertices[2]=new b2Vec2;tVec.x=localR.col1.x*-hcX+localR.col2.x*-hcY;tVec.y=localR.col1.y*-hcX+localR.col2.y*-hcY;tVec=this.m_coreVertices[3]=new b2Vec2;tVec.x=localR.col1.x*hcX+localR.col2.x*-hcY;tVec.y=localR.col1.y*hcX+localR.col2.y*-hcY}else{var poly=def;this.m_vertexCount=poly.vertexCount;b2Shape.PolyCentroid(poly.vertices,poly.vertexCount,b2PolyShape.tempVec);var centroidX=b2PolyShape.tempVec.x;var centroidY=b2PolyShape.tempVec.y;this.m_localCentroid.x=def.localPosition.x+(localR.col1.x*centroidX+localR.col2.x*centroidY)-newOrigin.x;this.m_localCentroid.y=def.localPosition.y+(localR.col1.y*centroidX+localR.col2.y*centroidY)-newOrigin.y;for(i=0;i<this.m_vertexCount;++i){this.m_vertices[i]=new b2Vec2;this.m_coreVertices[i]=new b2Vec2;hX=poly.vertices[i].x-centroidX;hY=poly.vertices[i].y-centroidY;this.m_vertices[i].x=localR.col1.x*hX+localR.col2.x*hY;this.m_vertices[i].y=localR.col1.y*hX+localR.col2.y*hY;var uX=this.m_vertices[i].x;var uY=this.m_vertices[i].y;var length=Math.sqrt(uX*uX+uY*uY);if(length>Number.MIN_VALUE){uX*=1/length;uY*=1/length}this.m_coreVertices[i].x=this.m_vertices[i].x-2*b2Settings.b2_linearSlop*uX;this.m_coreVertices[i].y=this.m_vertices[i].y-2*b2Settings.b2_linearSlop*uY}}var minVertexX=Number.MAX_VALUE;var minVertexY=Number.MAX_VALUE;var maxVertexX=-Number.MAX_VALUE;var maxVertexY=-Number.MAX_VALUE;this.m_maxRadius=0;for(i=0;i<this.m_vertexCount;++i){var v=this.m_vertices[i];minVertexX=Math.min(minVertexX,v.x);minVertexY=Math.min(minVertexY,v.y);maxVertexX=Math.max(maxVertexX,v.x);maxVertexY=Math.max(maxVertexY,v.y);this.m_maxRadius=Math.max(this.m_maxRadius,v.Length())}this.m_localOBB.R.SetIdentity();this.m_localOBB.center.Set((minVertexX+maxVertexX)*.5,(minVertexY+maxVertexY)*.5);this.m_localOBB.extents.Set((maxVertexX-minVertexX)*.5,(maxVertexY-minVertexY)*.5);var i1=0;var i2=0;for(i=0;i<this.m_vertexCount;++i){this.m_normals[i]=new b2Vec2;i1=i;i2=i+1<this.m_vertexCount?i+1:0;this.m_normals[i].x=this.m_vertices[i2].y-this.m_vertices[i1].y;this.m_normals[i].y=-(this.m_vertices[i2].x-this.m_vertices[i1].x);this.m_normals[i].Normalize()}for(i=0;i<this.m_vertexCount;++i){i1=i;i2=i+1<this.m_vertexCount?i+1:0}this.m_R.SetM(this.m_body.m_R);this.m_position.x=this.m_body.m_position.x+(this.m_R.col1.x*this.m_localCentroid.x+this.m_R.col2.x*this.m_localCentroid.y);this.m_position.y=this.m_body.m_position.y+(this.m_R.col1.y*this.m_localCentroid.x+this.m_R.col2.y*this.m_localCentroid.y);b2PolyShape.tAbsR.col1.x=this.m_R.col1.x*this.m_localOBB.R.col1.x+this.m_R.col2.x*this.m_localOBB.R.col1.y;b2PolyShape.tAbsR.col1.y=this.m_R.col1.y*this.m_localOBB.R.col1.x+this.m_R.col2.y*this.m_localOBB.R.col1.y;b2PolyShape.tAbsR.col2.x=this.m_R.col1.x*this.m_localOBB.R.col2.x+this.m_R.col2.x*this.m_localOBB.R.col2.y;b2PolyShape.tAbsR.col2.y=this.m_R.col1.y*this.m_localOBB.R.col2.x+this.m_R.col2.y*this.m_localOBB.R.col2.y;b2PolyShape.tAbsR.Abs();hX=b2PolyShape.tAbsR.col1.x*this.m_localOBB.extents.x+b2PolyShape.tAbsR.col2.x*this.m_localOBB.extents.y;hY=b2PolyShape.tAbsR.col1.y*this.m_localOBB.extents.x+b2PolyShape.tAbsR.col2.y*this.m_localOBB.extents.y;var positionX=this.m_position.x+(this.m_R.col1.x*this.m_localOBB.center.x+this.m_R.col2.x*this.m_localOBB.center.y);var positionY=this.m_position.y+(this.m_R.col1.y*this.m_localOBB.center.x+this.m_R.col2.y*this.m_localOBB.center.y);aabb.minVertex.x=positionX-hX;aabb.minVertex.y=positionY-hY;aabb.maxVertex.x=positionX+hX;aabb.maxVertex.y=positionY+hY;var broadPhase=this.m_body.m_world.m_broadPhase;if(broadPhase.InRange(aabb)){this.m_proxyId=broadPhase.CreateProxy(aabb,this)}else{this.m_proxyId=b2Pair.b2_nullProxy}if(this.m_proxyId==b2Pair.b2_nullProxy){this.m_body.Freeze()}},syncAABB:new b2AABB,syncMat:new b2Mat22,Synchronize:function(position1,R1,position2,R2){this.m_R.SetM(R2);this.m_position.x=this.m_body.m_position.x+(R2.col1.x*this.m_localCentroid.x+R2.col2.x*this.m_localCentroid.y);this.m_position.y=this.m_body.m_position.y+(R2.col1.y*this.m_localCentroid.x+R2.col2.y*this.m_localCentroid.y);if(this.m_proxyId==b2Pair.b2_nullProxy){return}var hX;var hY;var v1=R1.col1;var v2=R1.col2;var v3=this.m_localOBB.R.col1;var v4=this.m_localOBB.R.col2;this.syncMat.col1.x=v1.x*v3.x+v2.x*v3.y;this.syncMat.col1.y=v1.y*v3.x+v2.y*v3.y;this.syncMat.col2.x=v1.x*v4.x+v2.x*v4.y;this.syncMat.col2.y=v1.y*v4.x+v2.y*v4.y;this.syncMat.Abs();hX=this.m_localCentroid.x+this.m_localOBB.center.x;hY=this.m_localCentroid.y+this.m_localOBB.center.y;var centerX=position1.x+(R1.col1.x*hX+R1.col2.x*hY);var centerY=position1.y+(R1.col1.y*hX+R1.col2.y*hY);hX=this.syncMat.col1.x*this.m_localOBB.extents.x+this.syncMat.col2.x*this.m_localOBB.extents.y;hY=this.syncMat.col1.y*this.m_localOBB.extents.x+this.syncMat.col2.y*this.m_localOBB.extents.y;this.syncAABB.minVertex.x=centerX-hX;this.syncAABB.minVertex.y=centerY-hY;this.syncAABB.maxVertex.x=centerX+hX;this.syncAABB.maxVertex.y=centerY+hY;v1=R2.col1;v2=R2.col2;v3=this.m_localOBB.R.col1;v4=this.m_localOBB.R.col2;this.syncMat.col1.x=v1.x*v3.x+v2.x*v3.y;this.syncMat.col1.y=v1.y*v3.x+v2.y*v3.y;this.syncMat.col2.x=v1.x*v4.x+v2.x*v4.y;this.syncMat.col2.y=v1.y*v4.x+v2.y*v4.y;this.syncMat.Abs();hX=this.m_localCentroid.x+this.m_localOBB.center.x;hY=this.m_localCentroid.y+this.m_localOBB.center.y;centerX=position2.x+(R2.col1.x*hX+R2.col2.x*hY);centerY=position2.y+(R2.col1.y*hX+R2.col2.y*hY);hX=this.syncMat.col1.x*this.m_localOBB.extents.x+this.syncMat.col2.x*this.m_localOBB.extents.y;hY=this.syncMat.col1.y*this.m_localOBB.extents.x+this.syncMat.col2.y*this.m_localOBB.extents.y;this.syncAABB.minVertex.x=Math.min(this.syncAABB.minVertex.x,centerX-hX);this.syncAABB.minVertex.y=Math.min(this.syncAABB.minVertex.y,centerY-hY);this.syncAABB.maxVertex.x=Math.max(this.syncAABB.maxVertex.x,centerX+hX);this.syncAABB.maxVertex.y=Math.max(this.syncAABB.maxVertex.y,centerY+hY);var broadPhase=this.m_body.m_world.m_broadPhase;if(broadPhase.InRange(this.syncAABB)){broadPhase.MoveProxy(this.m_proxyId,this.syncAABB)}else{this.m_body.Freeze()}},QuickSync:function(position,R){this.m_R.SetM(R);this.m_position.x=position.x+(R.col1.x*this.m_localCentroid.x+R.col2.x*this.m_localCentroid.y);this.m_position.y=position.y+(R.col1.y*this.m_localCentroid.x+R.col2.y*this.m_localCentroid.y)},ResetProxy:function(broadPhase){if(this.m_proxyId==b2Pair.b2_nullProxy){return}var proxy=broadPhase.GetProxy(this.m_proxyId);broadPhase.DestroyProxy(this.m_proxyId);proxy=null;var R=b2Math.b2MulMM(this.m_R,this.m_localOBB.R);var absR=b2Math.b2AbsM(R);var h=b2Math.b2MulMV(absR,this.m_localOBB.extents);var position=b2Math.b2MulMV(this.m_R,this.m_localOBB.center);position.Add(this.m_position);var aabb=new b2AABB;aabb.minVertex.SetV(position);aabb.minVertex.Subtract(h);aabb.maxVertex.SetV(position);aabb.maxVertex.Add(h);if(broadPhase.InRange(aabb)){this.m_proxyId=broadPhase.CreateProxy(aabb,this)}else{this.m_proxyId=b2Pair.b2_nullProxy}if(this.m_proxyId==b2Pair.b2_nullProxy){this.m_body.Freeze()}},Support:function(dX,dY,out){var dLocalX=dX*this.m_R.col1.x+dY*this.m_R.col1.y;var dLocalY=dX*this.m_R.col2.x+dY*this.m_R.col2.y;var bestIndex=0;var bestValue=this.m_coreVertices[0].x*dLocalX+this.m_coreVertices[0].y*dLocalY;for(var i=1;i<this.m_vertexCount;++i){var value=this.m_coreVertices[i].x*dLocalX+this.m_coreVertices[i].y*dLocalY;if(value>bestValue){bestIndex=i;bestValue=value}}out.Set(this.m_position.x+(this.m_R.col1.x*this.m_coreVertices[bestIndex].x+this.m_R.col2.x*this.m_coreVertices[bestIndex].y),this.m_position.y+(this.m_R.col1.y*this.m_coreVertices[bestIndex].x+this.m_R.col2.y*this.m_coreVertices[bestIndex].y))},m_localCentroid:new b2Vec2,m_localOBB:new b2OBB,m_vertices:null,m_coreVertices:null,m_vertexCount:0,m_normals:null});b2PolyShape.tempVec=new b2Vec2;b2PolyShape.tAbsR=new b2Mat22;var b2Body=Class.create();b2Body.prototype={SetOriginPosition:function(position,rotation){if(this.IsFrozen()){return}this.m_rotation=rotation;this.m_R.Set(this.m_rotation);this.m_position=b2Math.AddVV(position,b2Math.b2MulMV(this.m_R,this.m_center));this.m_position0.SetV(this.m_position);this.m_rotation0=this.m_rotation;for(var s=this.m_shapeList;s!=null;s=s.m_next){s.Synchronize(this.m_position,this.m_R,this.m_position,this.m_R)}this.m_world.m_broadPhase.Commit()},GetOriginPosition:function(){return b2Math.SubtractVV(this.m_position,b2Math.b2MulMV(this.m_R,this.m_center))},SetCenterPosition:function(position,rotation){if(this.IsFrozen()){return}this.m_rotation=rotation;this.m_R.Set(this.m_rotation);this.m_position.SetV(position);this.m_position0.SetV(this.m_position);this.m_rotation0=this.m_rotation;for(var s=this.m_shapeList;s!=null;s=s.m_next){s.Synchronize(this.m_position,this.m_R,this.m_position,this.m_R)}this.m_world.m_broadPhase.Commit()},GetCenterPosition:function(){return this.m_position},GetRotation:function(){return this.m_rotation},GetRotationMatrix:function(){return this.m_R},SetLinearVelocity:function(v){this.m_linearVelocity.SetV(v)},GetLinearVelocity:function(){return this.m_linearVelocity},SetAngularVelocity:function(w){this.m_angularVelocity=w},GetAngularVelocity:function(){return this.m_angularVelocity},ApplyForce:function(force,point){if(this.IsSleeping()==false){this.m_force.Add(force);this.m_torque+=b2Math.b2CrossVV(b2Math.SubtractVV(point,this.m_position),force)}},ApplyTorque:function(torque){if(this.IsSleeping()==false){this.m_torque+=torque}},ApplyImpulse:function(impulse,point){if(this.IsSleeping()==false){this.m_linearVelocity.Add(b2Math.MulFV(this.m_invMass,impulse));this.m_angularVelocity+=this.m_invI*b2Math.b2CrossVV(b2Math.SubtractVV(point,this.m_position),impulse)}},GetMass:function(){return this.m_mass},GetInertia:function(){return this.m_I},GetWorldPoint:function(localPoint){return b2Math.AddVV(this.m_position,b2Math.b2MulMV(this.m_R,localPoint))},GetWorldVector:function(localVector){return b2Math.b2MulMV(this.m_R,localVector)},GetLocalPoint:function(worldPoint){return b2Math.b2MulTMV(this.m_R,b2Math.SubtractVV(worldPoint,this.m_position))},GetLocalVector:function(worldVector){return b2Math.b2MulTMV(this.m_R,worldVector)},IsStatic:function(){return(this.m_flags&b2Body.e_staticFlag)==b2Body.e_staticFlag},IsFrozen:function(){return(this.m_flags&b2Body.e_frozenFlag)==b2Body.e_frozenFlag},IsSleeping:function(){return(this.m_flags&b2Body.e_sleepFlag)==b2Body.e_sleepFlag
},AllowSleeping:function(flag){if(flag){this.m_flags|=b2Body.e_allowSleepFlag}else{this.m_flags&=~b2Body.e_allowSleepFlag;this.WakeUp()}},WakeUp:function(){this.m_flags&=~b2Body.e_sleepFlag;this.m_sleepTime=0},GetShapeList:function(){return this.m_shapeList},GetContactList:function(){return this.m_contactList},GetJointList:function(){return this.m_jointList},GetNext:function(){return this.m_next},GetUserData:function(){return this.m_userData},initialize:function(bd,world){this.sMat0=new b2Mat22;this.m_position=new b2Vec2;this.m_R=new b2Mat22(0);this.m_position0=new b2Vec2;var i=0;var sd;var massData;this.m_flags=0;this.m_position.SetV(bd.position);this.m_rotation=bd.rotation;this.m_R.Set(this.m_rotation);this.m_position0.SetV(this.m_position);this.m_rotation0=this.m_rotation;this.m_world=world;this.m_linearDamping=b2Math.b2Clamp(1-bd.linearDamping,0,1);this.m_angularDamping=b2Math.b2Clamp(1-bd.angularDamping,0,1);this.m_force=new b2Vec2(0,0);this.m_torque=0;this.m_mass=0;var massDatas=new Array(b2Settings.b2_maxShapesPerBody);for(i=0;i<b2Settings.b2_maxShapesPerBody;i++){massDatas[i]=new b2MassData}this.m_shapeCount=0;this.m_center=new b2Vec2(0,0);for(i=0;i<b2Settings.b2_maxShapesPerBody;++i){sd=bd.shapes[i];if(sd==null)break;massData=massDatas[i];sd.ComputeMass(massData);this.m_mass+=massData.mass;this.m_center.x+=massData.mass*(sd.localPosition.x+massData.center.x);this.m_center.y+=massData.mass*(sd.localPosition.y+massData.center.y);++this.m_shapeCount}if(this.m_mass>0){this.m_center.Multiply(1/this.m_mass);this.m_position.Add(b2Math.b2MulMV(this.m_R,this.m_center))}else{this.m_flags|=b2Body.e_staticFlag}this.m_I=0;for(i=0;i<this.m_shapeCount;++i){sd=bd.shapes[i];massData=massDatas[i];this.m_I+=massData.I;var r=b2Math.SubtractVV(b2Math.AddVV(sd.localPosition,massData.center),this.m_center);this.m_I+=massData.mass*b2Math.b2Dot(r,r)}if(this.m_mass>0){this.m_invMass=1/this.m_mass}else{this.m_invMass=0}if(this.m_I>0&&bd.preventRotation==false){this.m_invI=1/this.m_I}else{this.m_I=0;this.m_invI=0}this.m_linearVelocity=b2Math.AddVV(bd.linearVelocity,b2Math.b2CrossFV(bd.angularVelocity,this.m_center));this.m_angularVelocity=bd.angularVelocity;this.m_jointList=null;this.m_contactList=null;this.m_prev=null;this.m_next=null;this.m_shapeList=null;for(i=0;i<this.m_shapeCount;++i){sd=bd.shapes[i];var shape=b2Shape.Create(sd,this,this.m_center);shape.m_next=this.m_shapeList;this.m_shapeList=shape}this.m_sleepTime=0;if(bd.allowSleep){this.m_flags|=b2Body.e_allowSleepFlag}if(bd.isSleeping){this.m_flags|=b2Body.e_sleepFlag}if(this.m_flags&b2Body.e_sleepFlag||this.m_invMass==0){this.m_linearVelocity.Set(0,0);this.m_angularVelocity=0}this.m_userData=bd.userData},Destroy:function(){var s=this.m_shapeList;while(s){var s0=s;s=s.m_next;b2Shape.Destroy(s0)}},sMat0:new b2Mat22,SynchronizeShapes:function(){this.sMat0.Set(this.m_rotation0);for(var s=this.m_shapeList;s!=null;s=s.m_next){s.Synchronize(this.m_position0,this.sMat0,this.m_position,this.m_R)}},QuickSyncShapes:function(){for(var s=this.m_shapeList;s!=null;s=s.m_next){s.QuickSync(this.m_position,this.m_R)}},IsConnected:function(other){for(var jn=this.m_jointList;jn!=null;jn=jn.next){if(jn.other==other)return jn.joint.m_collideConnected==false}return false},Freeze:function(){this.m_flags|=b2Body.e_frozenFlag;this.m_linearVelocity.SetZero();this.m_angularVelocity=0;for(var s=this.m_shapeList;s!=null;s=s.m_next){s.DestroyProxy()}},m_flags:0,m_position:new b2Vec2,m_rotation:null,m_R:new b2Mat22(0),m_position0:new b2Vec2,m_rotation0:null,m_linearVelocity:null,m_angularVelocity:null,m_force:null,m_torque:null,m_center:null,m_world:null,m_prev:null,m_next:null,m_shapeList:null,m_shapeCount:0,m_jointList:null,m_contactList:null,m_mass:null,m_invMass:null,m_I:null,m_invI:null,m_linearDamping:null,m_angularDamping:null,m_sleepTime:null,m_userData:null};b2Body.e_staticFlag=1;b2Body.e_frozenFlag=2;b2Body.e_islandFlag=4;b2Body.e_sleepFlag=8;b2Body.e_allowSleepFlag=16;b2Body.e_destroyFlag=32;var b2BodyDef=Class.create();b2BodyDef.prototype={initialize:function(){this.shapes=new Array;this.userData=null;for(var i=0;i<b2Settings.b2_maxShapesPerBody;i++){this.shapes[i]=null}this.position=new b2Vec2(0,0);this.rotation=0;this.linearVelocity=new b2Vec2(0,0);this.angularVelocity=0;this.linearDamping=0;this.angularDamping=0;this.allowSleep=true;this.isSleeping=false;this.preventRotation=false},userData:null,shapes:new Array,position:null,rotation:null,linearVelocity:null,angularVelocity:null,linearDamping:null,angularDamping:null,allowSleep:null,isSleeping:null,preventRotation:null,AddShape:function(shape){for(var i=0;i<b2Settings.b2_maxShapesPerBody;++i){if(this.shapes[i]==null){this.shapes[i]=shape;break}}}};var b2CollisionFilter=Class.create();b2CollisionFilter.prototype={ShouldCollide:function(shape1,shape2){if(shape1.m_groupIndex==shape2.m_groupIndex&&shape1.m_groupIndex!=0){return shape1.m_groupIndex>0}var collide=(shape1.m_maskBits&shape2.m_categoryBits)!=0&&(shape1.m_categoryBits&shape2.m_maskBits)!=0;return collide},initialize:function(){}};b2CollisionFilter.b2_defaultFilter=new b2CollisionFilter;var b2Island=Class.create();b2Island.prototype={initialize:function(bodyCapacity,contactCapacity,jointCapacity,allocator){var i=0;this.m_bodyCapacity=bodyCapacity;this.m_contactCapacity=contactCapacity;this.m_jointCapacity=jointCapacity;this.m_bodyCount=0;this.m_contactCount=0;this.m_jointCount=0;this.m_bodies=new Array(bodyCapacity);for(i=0;i<bodyCapacity;i++)this.m_bodies[i]=null;this.m_contacts=new Array(contactCapacity);for(i=0;i<contactCapacity;i++)this.m_contacts[i]=null;this.m_joints=new Array(jointCapacity);for(i=0;i<jointCapacity;i++)this.m_joints[i]=null;this.m_allocator=allocator},Clear:function(){this.m_bodyCount=0;this.m_contactCount=0;this.m_jointCount=0},Solve:function(step,gravity){var i=0;var b;for(i=0;i<this.m_bodyCount;++i){b=this.m_bodies[i];if(b.m_invMass==0)continue;b.m_linearVelocity.Add(b2Math.MulFV(step.dt,b2Math.AddVV(gravity,b2Math.MulFV(b.m_invMass,b.m_force))));b.m_angularVelocity+=step.dt*b.m_invI*b.m_torque;b.m_linearVelocity.Multiply(b.m_linearDamping);b.m_angularVelocity*=b.m_angularDamping;b.m_position0.SetV(b.m_position);b.m_rotation0=b.m_rotation}var contactSolver=new b2ContactSolver(this.m_contacts,this.m_contactCount,this.m_allocator);contactSolver.PreSolve();for(i=0;i<this.m_jointCount;++i){this.m_joints[i].PrepareVelocitySolver()}for(i=0;i<step.iterations;++i){contactSolver.SolveVelocityConstraints();for(var j=0;j<this.m_jointCount;++j){this.m_joints[j].SolveVelocityConstraints(step)}}for(i=0;i<this.m_bodyCount;++i){b=this.m_bodies[i];if(b.m_invMass==0)continue;b.m_position.x+=step.dt*b.m_linearVelocity.x;b.m_position.y+=step.dt*b.m_linearVelocity.y;b.m_rotation+=step.dt*b.m_angularVelocity;b.m_R.Set(b.m_rotation)}for(i=0;i<this.m_jointCount;++i){this.m_joints[i].PreparePositionSolver()}if(b2World.s_enablePositionCorrection){for(b2Island.m_positionIterationCount=0;b2Island.m_positionIterationCount<step.iterations;++b2Island.m_positionIterationCount){var contactsOkay=contactSolver.SolvePositionConstraints(b2Settings.b2_contactBaumgarte);var jointsOkay=true;for(i=0;i<this.m_jointCount;++i){var jointOkay=this.m_joints[i].SolvePositionConstraints();jointsOkay=jointsOkay&&jointOkay}if(contactsOkay&&jointsOkay){break}}}contactSolver.PostSolve();for(i=0;i<this.m_bodyCount;++i){b=this.m_bodies[i];if(b.m_invMass==0)continue;b.m_R.Set(b.m_rotation);b.SynchronizeShapes();b.m_force.Set(0,0);b.m_torque=0}},UpdateSleep:function(dt){var i=0;var b;var minSleepTime=Number.MAX_VALUE;var linTolSqr=b2Settings.b2_linearSleepTolerance*b2Settings.b2_linearSleepTolerance;var angTolSqr=b2Settings.b2_angularSleepTolerance*b2Settings.b2_angularSleepTolerance;for(i=0;i<this.m_bodyCount;++i){b=this.m_bodies[i];if(b.m_invMass==0){continue}if((b.m_flags&b2Body.e_allowSleepFlag)==0){b.m_sleepTime=0;minSleepTime=0}if((b.m_flags&b2Body.e_allowSleepFlag)==0||b.m_angularVelocity*b.m_angularVelocity>angTolSqr||b2Math.b2Dot(b.m_linearVelocity,b.m_linearVelocity)>linTolSqr){b.m_sleepTime=0;minSleepTime=0}else{b.m_sleepTime+=dt;minSleepTime=b2Math.b2Min(minSleepTime,b.m_sleepTime)}}if(minSleepTime>=b2Settings.b2_timeToSleep){for(i=0;i<this.m_bodyCount;++i){b=this.m_bodies[i];b.m_flags|=b2Body.e_sleepFlag}}},AddBody:function(body){this.m_bodies[this.m_bodyCount++]=body},AddContact:function(contact){this.m_contacts[this.m_contactCount++]=contact},AddJoint:function(joint){this.m_joints[this.m_jointCount++]=joint},m_allocator:null,m_bodies:null,m_contacts:null,m_joints:null,m_bodyCount:0,m_jointCount:0,m_contactCount:0,m_bodyCapacity:0,m_contactCapacity:0,m_jointCapacity:0,m_positionError:null};b2Island.m_positionIterationCount=0;var b2TimeStep=Class.create();b2TimeStep.prototype={dt:null,inv_dt:null,iterations:0,initialize:function(){}};var b2ContactNode=Class.create();b2ContactNode.prototype={other:null,contact:null,prev:null,next:null,initialize:function(){}};var b2Contact=Class.create();b2Contact.prototype={GetManifolds:function(){return null},GetManifoldCount:function(){return this.m_manifoldCount},GetNext:function(){return this.m_next},GetShape1:function(){return this.m_shape1},GetShape2:function(){return this.m_shape2},initialize:function(s1,s2){this.m_node1=new b2ContactNode;this.m_node2=new b2ContactNode;this.m_flags=0;if(!s1||!s2){this.m_shape1=null;this.m_shape2=null;return}this.m_shape1=s1;this.m_shape2=s2;this.m_manifoldCount=0;this.m_friction=Math.sqrt(this.m_shape1.m_friction*this.m_shape2.m_friction);this.m_restitution=b2Math.b2Max(this.m_shape1.m_restitution,this.m_shape2.m_restitution);this.m_prev=null;this.m_next=null;this.m_node1.contact=null;this.m_node1.prev=null;this.m_node1.next=null;this.m_node1.other=null;this.m_node2.contact=null;this.m_node2.prev=null;this.m_node2.next=null;this.m_node2.other=null},Evaluate:function(){},m_flags:0,m_prev:null,m_next:null,m_node1:new b2ContactNode,m_node2:new b2ContactNode,m_shape1:null,m_shape2:null,m_manifoldCount:0,m_friction:null,m_restitution:null};b2Contact.e_islandFlag=1;b2Contact.e_destroyFlag=2;b2Contact.AddType=function(createFcn,destroyFcn,type1,type2){b2Contact.s_registers[type1][type2].createFcn=createFcn;b2Contact.s_registers[type1][type2].destroyFcn=destroyFcn;b2Contact.s_registers[type1][type2].primary=true;if(type1!=type2){b2Contact.s_registers[type2][type1].createFcn=createFcn;b2Contact.s_registers[type2][type1].destroyFcn=destroyFcn;b2Contact.s_registers[type2][type1].primary=false}};b2Contact.InitializeRegisters=function(){b2Contact.s_registers=new Array(b2Shape.e_shapeTypeCount);for(var i=0;i<b2Shape.e_shapeTypeCount;i++){b2Contact.s_registers[i]=new Array(b2Shape.e_shapeTypeCount);for(var j=0;j<b2Shape.e_shapeTypeCount;j++){b2Contact.s_registers[i][j]=new b2ContactRegister}}b2Contact.AddType(b2CircleContact.Create,b2CircleContact.Destroy,b2Shape.e_circleShape,b2Shape.e_circleShape);b2Contact.AddType(b2PolyAndCircleContact.Create,b2PolyAndCircleContact.Destroy,b2Shape.e_polyShape,b2Shape.e_circleShape);b2Contact.AddType(b2PolyContact.Create,b2PolyContact.Destroy,b2Shape.e_polyShape,b2Shape.e_polyShape)};b2Contact.Create=function(shape1,shape2,allocator){if(b2Contact.s_initialized==false){b2Contact.InitializeRegisters();b2Contact.s_initialized=true}var type1=shape1.m_type;var type2=shape2.m_type;var createFcn=b2Contact.s_registers[type1][type2].createFcn;if(createFcn){if(b2Contact.s_registers[type1][type2].primary){return createFcn(shape1,shape2,allocator)}else{var c=createFcn(shape2,shape1,allocator);for(var i=0;i<c.GetManifoldCount();++i){var m=c.GetManifolds()[i];m.normal=m.normal.Negative()}return c}}else{return null}};b2Contact.Destroy=function(contact,allocator){if(contact.GetManifoldCount()>0){contact.m_shape1.m_body.WakeUp();contact.m_shape2.m_body.WakeUp()}var type1=contact.m_shape1.m_type;var type2=contact.m_shape2.m_type;var destroyFcn=b2Contact.s_registers[type1][type2].destroyFcn;destroyFcn(contact,allocator)};b2Contact.s_registers=null;b2Contact.s_initialized=false;var b2ContactConstraint=Class.create();b2ContactConstraint.prototype={initialize:function(){this.normal=new b2Vec2;this.points=new Array(b2Settings.b2_maxManifoldPoints);for(var i=0;i<b2Settings.b2_maxManifoldPoints;i++){this.points[i]=new b2ContactConstraintPoint}},points:null,normal:new b2Vec2,manifold:null,body1:null,body2:null,friction:null,restitution:null,pointCount:0};var b2ContactConstraintPoint=Class.create();b2ContactConstraintPoint.prototype={localAnchor1:new b2Vec2,localAnchor2:new b2Vec2,normalImpulse:null,tangentImpulse:null,positionImpulse:null,normalMass:null,tangentMass:null,separation:null,velocityBias:null,initialize:function(){this.localAnchor1=new b2Vec2;this.localAnchor2=new b2Vec2}};var b2ContactRegister=Class.create();b2ContactRegister.prototype={createFcn:null,destroyFcn:null,primary:null,initialize:function(){}};var b2ContactSolver=Class.create();b2ContactSolver.prototype={initialize:function(contacts,contactCount,allocator){this.m_constraints=new Array;this.m_allocator=allocator;var i=0;var tVec;var tMat;this.m_constraintCount=0;for(i=0;i<contactCount;++i){this.m_constraintCount+=contacts[i].GetManifoldCount()}for(i=0;i<this.m_constraintCount;i++){this.m_constraints[i]=new b2ContactConstraint}var count=0;for(i=0;i<contactCount;++i){var contact=contacts[i];var b1=contact.m_shape1.m_body;var b2=contact.m_shape2.m_body;var manifoldCount=contact.GetManifoldCount();var manifolds=contact.GetManifolds();var friction=contact.m_friction;var restitution=contact.m_restitution;var v1X=b1.m_linearVelocity.x;var v1Y=b1.m_linearVelocity.y;var v2X=b2.m_linearVelocity.x;var v2Y=b2.m_linearVelocity.y;var w1=b1.m_angularVelocity;var w2=b2.m_angularVelocity;for(var j=0;j<manifoldCount;++j){var manifold=manifolds[j];var normalX=manifold.normal.x;var normalY=manifold.normal.y;var c=this.m_constraints[count];c.body1=b1;c.body2=b2;c.manifold=manifold;c.normal.x=normalX;c.normal.y=normalY;c.pointCount=manifold.pointCount;c.friction=friction;c.restitution=restitution;for(var k=0;k<c.pointCount;++k){var cp=manifold.points[k];var ccp=c.points[k];ccp.normalImpulse=cp.normalImpulse;ccp.tangentImpulse=cp.tangentImpulse;ccp.separation=cp.separation;var r1X=cp.position.x-b1.m_position.x;var r1Y=cp.position.y-b1.m_position.y;var r2X=cp.position.x-b2.m_position.x;var r2Y=cp.position.y-b2.m_position.y;tVec=ccp.localAnchor1;tMat=b1.m_R;tVec.x=r1X*tMat.col1.x+r1Y*tMat.col1.y;tVec.y=r1X*tMat.col2.x+r1Y*tMat.col2.y;tVec=ccp.localAnchor2;tMat=b2.m_R;tVec.x=r2X*tMat.col1.x+r2Y*tMat.col1.y;tVec.y=r2X*tMat.col2.x+r2Y*tMat.col2.y;var r1Sqr=r1X*r1X+r1Y*r1Y;var r2Sqr=r2X*r2X+r2Y*r2Y;var rn1=r1X*normalX+r1Y*normalY;var rn2=r2X*normalX+r2Y*normalY;var kNormal=b1.m_invMass+b2.m_invMass;kNormal+=b1.m_invI*(r1Sqr-rn1*rn1)+b2.m_invI*(r2Sqr-rn2*rn2);ccp.normalMass=1/kNormal;var tangentX=normalY;var tangentY=-normalX;var rt1=r1X*tangentX+r1Y*tangentY;var rt2=r2X*tangentX+r2Y*tangentY;var kTangent=b1.m_invMass+b2.m_invMass;kTangent+=b1.m_invI*(r1Sqr-rt1*rt1)+b2.m_invI*(r2Sqr-rt2*rt2);ccp.tangentMass=1/kTangent;ccp.velocityBias=0;if(ccp.separation>0){ccp.velocityBias=-60*ccp.separation}var tX=v2X+-w2*r2Y-v1X- -w1*r1Y;var tY=v2Y+w2*r2X-v1Y-w1*r1X;var vRel=c.normal.x*tX+c.normal.y*tY;if(vRel<-b2Settings.b2_velocityThreshold){ccp.velocityBias+=-c.restitution*vRel}}++count}}},PreSolve:function(){var tVec;var tVec2;var tMat;for(var i=0;i<this.m_constraintCount;++i){var c=this.m_constraints[i];var b1=c.body1;var b2=c.body2;var invMass1=b1.m_invMass;var invI1=b1.m_invI;var invMass2=b2.m_invMass;var invI2=b2.m_invI;var normalX=c.normal.x;var normalY=c.normal.y;var tangentX=normalY;var tangentY=-normalX;var j=0;var tCount=0;if(b2World.s_enableWarmStarting){tCount=c.pointCount;for(j=0;j<tCount;++j){var ccp=c.points[j];var PX=ccp.normalImpulse*normalX+ccp.tangentImpulse*tangentX;var PY=ccp.normalImpulse*normalY+ccp.tangentImpulse*tangentY;tMat=b1.m_R;tVec=ccp.localAnchor1;var r1X=tMat.col1.x*tVec.x+tMat.col2.x*tVec.y;var r1Y=tMat.col1.y*tVec.x+tMat.col2.y*tVec.y;tMat=b2.m_R;tVec=ccp.localAnchor2;var r2X=tMat.col1.x*tVec.x+tMat.col2.x*tVec.y;var r2Y=tMat.col1.y*tVec.x+tMat.col2.y*tVec.y;b1.m_angularVelocity-=invI1*(r1X*PY-r1Y*PX);b1.m_linearVelocity.x-=invMass1*PX;b1.m_linearVelocity.y-=invMass1*PY;b2.m_angularVelocity+=invI2*(r2X*PY-r2Y*PX);b2.m_linearVelocity.x+=invMass2*PX;b2.m_linearVelocity.y+=invMass2*PY;ccp.positionImpulse=0}}else{tCount=c.pointCount;for(j=0;j<tCount;++j){var ccp2=c.points[j];ccp2.normalImpulse=0;ccp2.tangentImpulse=0;ccp2.positionImpulse=0}}}},SolveVelocityConstraints:function(){var j=0;var ccp;var r1X;var r1Y;var r2X;var r2Y;var dvX;var dvY;var lambda;var newImpulse;var PX;var PY;var tMat;var tVec;for(var i=0;i<this.m_constraintCount;++i){var c=this.m_constraints[i];var b1=c.body1;var b2=c.body2;var b1_angularVelocity=b1.m_angularVelocity;var b1_linearVelocity=b1.m_linearVelocity;var b2_angularVelocity=b2.m_angularVelocity;var b2_linearVelocity=b2.m_linearVelocity;var invMass1=b1.m_invMass;var invI1=b1.m_invI;var invMass2=b2.m_invMass;var invI2=b2.m_invI;var normalX=c.normal.x;var normalY=c.normal.y;var tangentX=normalY;var tangentY=-normalX;var tCount=c.pointCount;for(j=0;j<tCount;++j){ccp=c.points[j];tMat=b1.m_R;tVec=ccp.localAnchor1;r1X=tMat.col1.x*tVec.x+tMat.col2.x*tVec.y;r1Y=tMat.col1.y*tVec.x+tMat.col2.y*tVec.y;tMat=b2.m_R;tVec=ccp.localAnchor2;r2X=tMat.col1.x*tVec.x+tMat.col2.x*tVec.y;r2Y=tMat.col1.y*tVec.x+tMat.col2.y*tVec.y;dvX=b2_linearVelocity.x+-b2_angularVelocity*r2Y-b1_linearVelocity.x- -b1_angularVelocity*r1Y;dvY=b2_linearVelocity.y+b2_angularVelocity*r2X-b1_linearVelocity.y-b1_angularVelocity*r1X;var vn=dvX*normalX+dvY*normalY;lambda=-ccp.normalMass*(vn-ccp.velocityBias);newImpulse=b2Math.b2Max(ccp.normalImpulse+lambda,0);lambda=newImpulse-ccp.normalImpulse;PX=lambda*normalX;PY=lambda*normalY;b1_linearVelocity.x-=invMass1*PX;b1_linearVelocity.y-=invMass1*PY;b1_angularVelocity-=invI1*(r1X*PY-r1Y*PX);b2_linearVelocity.x+=invMass2*PX;b2_linearVelocity.y+=invMass2*PY;b2_angularVelocity+=invI2*(r2X*PY-r2Y*PX);ccp.normalImpulse=newImpulse;dvX=b2_linearVelocity.x+-b2_angularVelocity*r2Y-b1_linearVelocity.x- -b1_angularVelocity*r1Y;dvY=b2_linearVelocity.y+b2_angularVelocity*r2X-b1_linearVelocity.y-b1_angularVelocity*r1X;var vt=dvX*tangentX+dvY*tangentY;lambda=ccp.tangentMass*-vt;var maxFriction=c.friction*ccp.normalImpulse;newImpulse=b2Math.b2Clamp(ccp.tangentImpulse+lambda,-maxFriction,maxFriction);lambda=newImpulse-ccp.tangentImpulse;PX=lambda*tangentX;PY=lambda*tangentY;b1_linearVelocity.x-=invMass1*PX;b1_linearVelocity.y-=invMass1*PY;b1_angularVelocity-=invI1*(r1X*PY-r1Y*PX);b2_linearVelocity.x+=invMass2*PX;b2_linearVelocity.y+=invMass2*PY;b2_angularVelocity+=invI2*(r2X*PY-r2Y*PX);ccp.tangentImpulse=newImpulse}b1.m_angularVelocity=b1_angularVelocity;b2.m_angularVelocity=b2_angularVelocity}},SolvePositionConstraints:function(beta){var minSeparation=0;var tMat;var tVec;for(var i=0;i<this.m_constraintCount;++i){var c=this.m_constraints[i];var b1=c.body1;var b2=c.body2;var b1_position=b1.m_position;var b1_rotation=b1.m_rotation;var b2_position=b2.m_position;var b2_rotation=b2.m_rotation;var invMass1=b1.m_invMass;var invI1=b1.m_invI;var invMass2=b2.m_invMass;var invI2=b2.m_invI;var normalX=c.normal.x;var normalY=c.normal.y;var tangentX=normalY;var tangentY=-normalX;var tCount=c.pointCount;for(var j=0;j<tCount;++j){var ccp=c.points[j];tMat=b1.m_R;tVec=ccp.localAnchor1;var r1X=tMat.col1.x*tVec.x+tMat.col2.x*tVec.y;var r1Y=tMat.col1.y*tVec.x+tMat.col2.y*tVec.y;tMat=b2.m_R;tVec=ccp.localAnchor2;var r2X=tMat.col1.x*tVec.x+tMat.col2.x*tVec.y;var r2Y=tMat.col1.y*tVec.x+tMat.col2.y*tVec.y;var p1X=b1_position.x+r1X;var p1Y=b1_position.y+r1Y;var p2X=b2_position.x+r2X;var p2Y=b2_position.y+r2Y;var dpX=p2X-p1X;var dpY=p2Y-p1Y;var separation=dpX*normalX+dpY*normalY+ccp.separation;minSeparation=b2Math.b2Min(minSeparation,separation);var C=beta*b2Math.b2Clamp(separation+b2Settings.b2_linearSlop,-b2Settings.b2_maxLinearCorrection,0);var dImpulse=-ccp.normalMass*C;var impulse0=ccp.positionImpulse;ccp.positionImpulse=b2Math.b2Max(impulse0+dImpulse,0);dImpulse=ccp.positionImpulse-impulse0;var impulseX=dImpulse*normalX;var impulseY=dImpulse*normalY;b1_position.x-=invMass1*impulseX;b1_position.y-=invMass1*impulseY;b1_rotation-=invI1*(r1X*impulseY-r1Y*impulseX);b1.m_R.Set(b1_rotation);b2_position.x+=invMass2*impulseX;b2_position.y+=invMass2*impulseY;b2_rotation+=invI2*(r2X*impulseY-r2Y*impulseX);b2.m_R.Set(b2_rotation)}b1.m_rotation=b1_rotation;b2.m_rotation=b2_rotation}return minSeparation>=-b2Settings.b2_linearSlop},PostSolve:function(){for(var i=0;i<this.m_constraintCount;++i){var c=this.m_constraints[i];var m=c.manifold;for(var j=0;j<c.pointCount;++j){var mPoint=m.points[j];var cPoint=c.points[j];mPoint.normalImpulse=cPoint.normalImpulse;mPoint.tangentImpulse=cPoint.tangentImpulse}}},m_allocator:null,m_constraints:new Array,m_constraintCount:0};var b2CircleContact=Class.create();Object.extend(b2CircleContact.prototype,b2Contact.prototype);Object.extend(b2CircleContact.prototype,{initialize:function(s1,s2){this.m_node1=new b2ContactNode;this.m_node2=new b2ContactNode;this.m_flags=0;if(!s1||!s2){this.m_shape1=null;this.m_shape2=null;return}this.m_shape1=s1;this.m_shape2=s2;this.m_manifoldCount=0;this.m_friction=Math.sqrt(this.m_shape1.m_friction*this.m_shape2.m_friction);this.m_restitution=b2Math.b2Max(this.m_shape1.m_restitution,this.m_shape2.m_restitution);this.m_prev=null;this.m_next=null;this.m_node1.contact=null;this.m_node1.prev=null;this.m_node1.next=null;this.m_node1.other=null;this.m_node2.contact=null;this.m_node2.prev=null;this.m_node2.next=null;this.m_node2.other=null;this.m_manifold=[new b2Manifold];this.m_manifold[0].pointCount=0;this.m_manifold[0].points[0].normalImpulse=0;this.m_manifold[0].points[0].tangentImpulse=0},Evaluate:function(){b2Collision.b2CollideCircle(this.m_manifold[0],this.m_shape1,this.m_shape2,false);if(this.m_manifold[0].pointCount>0){this.m_manifoldCount=1}else{this.m_manifoldCount=0}},GetManifolds:function(){return this.m_manifold},m_manifold:[new b2Manifold]});b2CircleContact.Create=function(shape1,shape2,allocator){return new b2CircleContact(shape1,shape2)};b2CircleContact.Destroy=function(contact,allocator){};var b2Conservative=Class.create();b2Conservative.prototype={initialize:function(){}};b2Conservative.R1=new b2Mat22;b2Conservative.R2=new b2Mat22;b2Conservative.x1=new b2Vec2;b2Conservative.x2=new b2Vec2;b2Conservative.Conservative=function(shape1,shape2){var body1=shape1.GetBody();var body2=shape2.GetBody();var v1X=body1.m_position.x-body1.m_position0.x;var v1Y=body1.m_position.y-body1.m_position0.y;var omega1=body1.m_rotation-body1.m_rotation0;var v2X=body2.m_position.x-body2.m_position0.x;var v2Y=body2.m_position.y-body2.m_position0.y;var omega2=body2.m_rotation-body2.m_rotation0;var r1=shape1.GetMaxRadius();var r2=shape2.GetMaxRadius();var p1StartX=body1.m_position0.x;var p1StartY=body1.m_position0.y;var a1Start=body1.m_rotation0;var p2StartX=body2.m_position0.x;var p2StartY=body2.m_position0.y;var a2Start=body2.m_rotation0;var p1X=p1StartX;var p1Y=p1StartY;var a1=a1Start;var p2X=p2StartX;var p2Y=p2StartY;var a2=a2Start;b2Conservative.R1.Set(a1);b2Conservative.R2.Set(a2);shape1.QuickSync(p1,b2Conservative.R1);shape2.QuickSync(p2,b2Conservative.R2);var s1=0;var maxIterations=10;var dX;var dY;var invRelativeVelocity=0;var hit=true;for(var iter=0;iter<maxIterations;++iter){var distance=b2Distance.Distance(b2Conservative.x1,b2Conservative.x2,shape1,shape2);if(distance<b2Settings.b2_linearSlop){if(iter==0){hit=false}else{hit=true}break}if(iter==0){dX=b2Conservative.x2.x-b2Conservative.x1.x;dY=b2Conservative.x2.y-b2Conservative.x1.y;var dLen=Math.sqrt(dX*dX+dY*dY);var relativeVelocity=dX*(v1X-v2X)+dY*(v1Y-v2Y)+Math.abs(omega1)*r1+Math.abs(omega2)*r2;if(Math.abs(relativeVelocity)<Number.MIN_VALUE){hit=false;break}invRelativeVelocity=1/relativeVelocity}var ds=distance*invRelativeVelocity;var s2=s1+ds;if(s2<0||1<s2){hit=false;break}if(s2<(1+100*Number.MIN_VALUE)*s1){hit=true;break}s1=s2;p1X=p1StartX+s1*v1.x;p1Y=p1StartY+s1*v1.y;a1=a1Start+s1*omega1;p2X=p2StartX+s1*v2.x;p2Y=p2StartY+s1*v2.y;a2=a2Start+s1*omega2;b2Conservative.R1.Set(a1);b2Conservative.R2.Set(a2);shape1.QuickSync(p1,b2Conservative.R1);shape2.QuickSync(p2,b2Conservative.R2)}if(hit){dX=b2Conservative.x2.x-b2Conservative.x1.x;dY=b2Conservative.x2.y-b2Conservative.x1.y;var length=Math.sqrt(dX*dX+dY*dY);if(length>FLT_EPSILON){d*=b2_linearSlop/length}if(body1.IsStatic()){body1.m_position.x=p1X;body1.m_position.y=p1Y}else{body1.m_position.x=p1X-dX;body1.m_position.y=p1Y-dY}body1.m_rotation=a1;body1.m_R.Set(a1);body1.QuickSyncShapes();if(body2.IsStatic()){body2.m_position.x=p2X;body2.m_position.y=p2Y}else{body2.m_position.x=p2X+dX;body2.m_position.y=p2Y+dY}body2.m_position.x=p2X+dX;body2.m_position.y=p2Y+dY;body2.m_rotation=a2;body2.m_R.Set(a2);body2.QuickSyncShapes();return true}shape1.QuickSync(body1.m_position,body1.m_R);shape2.QuickSync(body2.m_position,body2.m_R);return false};var b2NullContact=Class.create();Object.extend(b2NullContact.prototype,b2Contact.prototype);Object.extend(b2NullContact.prototype,{initialize:function(s1,s2){this.m_node1=new b2ContactNode;this.m_node2=new b2ContactNode;this.m_flags=0;if(!s1||!s2){this.m_shape1=null;this.m_shape2=null;return}this.m_shape1=s1;this.m_shape2=s2;this.m_manifoldCount=0;this.m_friction=Math.sqrt(this.m_shape1.m_friction*this.m_shape2.m_friction);this.m_restitution=b2Math.b2Max(this.m_shape1.m_restitution,this.m_shape2.m_restitution);this.m_prev=null;this.m_next=null;this.m_node1.contact=null;this.m_node1.prev=null;this.m_node1.next=null;this.m_node1.other=null;this.m_node2.contact=null;this.m_node2.prev=null;this.m_node2.next=null;this.m_node2.other=null},Evaluate:function(){},GetManifolds:function(){return null}});var b2PolyAndCircleContact=Class.create();Object.extend(b2PolyAndCircleContact.prototype,b2Contact.prototype);Object.extend(b2PolyAndCircleContact.prototype,{initialize:function(s1,s2){this.m_node1=new b2ContactNode;this.m_node2=new b2ContactNode;this.m_flags=0;if(!s1||!s2){this.m_shape1=null;this.m_shape2=null;return}this.m_shape1=s1;this.m_shape2=s2;this.m_manifoldCount=0;this.m_friction=Math.sqrt(this.m_shape1.m_friction*this.m_shape2.m_friction);this.m_restitution=b2Math.b2Max(this.m_shape1.m_restitution,this.m_shape2.m_restitution);this.m_prev=null;this.m_next=null;this.m_node1.contact=null;this.m_node1.prev=null;this.m_node1.next=null;this.m_node1.other=null;this.m_node2.contact=null;this.m_node2.prev=null;this.m_node2.next=null;this.m_node2.other=null;this.m_manifold=[new b2Manifold];b2Settings.b2Assert(this.m_shape1.m_type==b2Shape.e_polyShape);b2Settings.b2Assert(this.m_shape2.m_type==b2Shape.e_circleShape);this.m_manifold[0].pointCount=0;this.m_manifold[0].points[0].normalImpulse=0;this.m_manifold[0].points[0].tangentImpulse=0},Evaluate:function(){b2Collision.b2CollidePolyAndCircle(this.m_manifold[0],this.m_shape1,this.m_shape2,false);if(this.m_manifold[0].pointCount>0){this.m_manifoldCount=1}else{this.m_manifoldCount=0}},GetManifolds:function(){return this.m_manifold},m_manifold:[new b2Manifold]});b2PolyAndCircleContact.Create=function(shape1,shape2,allocator){return new b2PolyAndCircleContact(shape1,shape2)};b2PolyAndCircleContact.Destroy=function(contact,allocator){};var b2PolyContact=Class.create();Object.extend(b2PolyContact.prototype,b2Contact.prototype);Object.extend(b2PolyContact.prototype,{initialize:function(s1,s2){this.m_node1=new b2ContactNode;this.m_node2=new b2ContactNode;this.m_flags=0;if(!s1||!s2){this.m_shape1=null;this.m_shape2=null;return}this.m_shape1=s1;this.m_shape2=s2;this.m_manifoldCount=0;this.m_friction=Math.sqrt(this.m_shape1.m_friction*this.m_shape2.m_friction);this.m_restitution=b2Math.b2Max(this.m_shape1.m_restitution,this.m_shape2.m_restitution);this.m_prev=null;this.m_next=null;this.m_node1.contact=null;this.m_node1.prev=null;this.m_node1.next=null;this.m_node1.other=null;this.m_node2.contact=null;this.m_node2.prev=null;this.m_node2.next=null;this.m_node2.other=null;this.m0=new b2Manifold;this.m_manifold=[new b2Manifold];this.m_manifold[0].pointCount=0},m0:new b2Manifold,Evaluate:function(){var tMani=this.m_manifold[0];var tPoints=this.m0.points;for(var k=0;k<tMani.pointCount;k++){var tPoint=tPoints[k];var tPoint0=tMani.points[k];tPoint.normalImpulse=tPoint0.normalImpulse;tPoint.tangentImpulse=tPoint0.tangentImpulse;tPoint.id=tPoint0.id.Copy()}this.m0.pointCount=tMani.pointCount;b2Collision.b2CollidePoly(tMani,this.m_shape1,this.m_shape2,false);if(tMani.pointCount>0){var match=[false,false];for(var i=0;i<tMani.pointCount;++i){var cp=tMani.points[i];cp.normalImpulse=0;cp.tangentImpulse=0;var idKey=cp.id.key;for(var j=0;j<this.m0.pointCount;++j){if(match[j]==true)continue;var cp0=this.m0.points[j];var id0=cp0.id;if(id0.key==idKey){match[j]=true;cp.normalImpulse=cp0.normalImpulse;cp.tangentImpulse=cp0.tangentImpulse;break}}}this.m_manifoldCount=1}else{this.m_manifoldCount=0}},GetManifolds:function(){return this.m_manifold},m_manifold:[new b2Manifold]});b2PolyContact.Create=function(shape1,shape2,allocator){return new b2PolyContact(shape1,shape2)};b2PolyContact.Destroy=function(contact,allocator){};var b2ContactManager=Class.create();Object.extend(b2ContactManager.prototype,b2PairCallback.prototype);Object.extend(b2ContactManager.prototype,{initialize:function(){this.m_nullContact=new b2NullContact;this.m_world=null;this.m_destroyImmediate=false},PairAdded:function(proxyUserData1,proxyUserData2){var shape1=proxyUserData1;var shape2=proxyUserData2;var body1=shape1.m_body;var body2=shape2.m_body;if(body1.IsStatic()&&body2.IsStatic()){return this.m_nullContact}if(shape1.m_body==shape2.m_body){return this.m_nullContact}if(body2.IsConnected(body1)){return this.m_nullContact}if(this.m_world.m_filter!=null&&this.m_world.m_filter.ShouldCollide(shape1,shape2)==false){return this.m_nullContact}if(body2.m_invMass==0){var tempShape=shape1;shape1=shape2;shape2=tempShape;var tempBody=body1;body1=body2;body2=tempBody}var contact=b2Contact.Create(shape1,shape2,this.m_world.m_blockAllocator);if(contact==null){return this.m_nullContact}else{contact.m_prev=null;contact.m_next=this.m_world.m_contactList;if(this.m_world.m_contactList!=null){this.m_world.m_contactList.m_prev=contact}this.m_world.m_contactList=contact;this.m_world.m_contactCount++}return contact},PairRemoved:function(proxyUserData1,proxyUserData2,pairUserData){if(pairUserData==null){return}var c=pairUserData;if(c!=this.m_nullContact){if(this.m_destroyImmediate==true){this.DestroyContact(c);c=null}else{c.m_flags|=b2Contact.e_destroyFlag}}},DestroyContact:function(c){if(c.m_prev){c.m_prev.m_next=c.m_next}if(c.m_next){c.m_next.m_prev=c.m_prev}if(c==this.m_world.m_contactList){this.m_world.m_contactList=c.m_next}if(c.GetManifoldCount()>0){var body1=c.m_shape1.m_body;var body2=c.m_shape2.m_body;var node1=c.m_node1;var node2=c.m_node2;body1.WakeUp();body2.WakeUp();if(node1.prev){node1.prev.next=node1.next}if(node1.next){node1.next.prev=node1.prev}if(node1==body1.m_contactList){body1.m_contactList=node1.next}node1.prev=null;node1.next=null;if(node2.prev){node2.prev.next=node2.next}if(node2.next){node2.next.prev=node2.prev}if(node2==body2.m_contactList){body2.m_contactList=node2.next}node2.prev=null;node2.next=null}b2Contact.Destroy(c,this.m_world.m_blockAllocator);--this.m_world.m_contactCount},CleanContactList:function(){var c=this.m_world.m_contactList;while(c!=null){var c0=c;c=c.m_next;if(c0.m_flags&b2Contact.e_destroyFlag){this.DestroyContact(c0);c0=null}}},Collide:function(){var body1;var body2;var node1;var node2;for(var c=this.m_world.m_contactList;c!=null;c=c.m_next){if(c.m_shape1.m_body.IsSleeping()&&c.m_shape2.m_body.IsSleeping()){continue}var oldCount=c.GetManifoldCount();c.Evaluate();var newCount=c.GetManifoldCount();if(oldCount==0&&newCount>0){body1=c.m_shape1.m_body;body2=c.m_shape2.m_body;node1=c.m_node1;node2=c.m_node2;node1.contact=c;node1.other=body2;node1.prev=null;node1.next=body1.m_contactList;
if(node1.next!=null){node1.next.prev=c.m_node1}body1.m_contactList=c.m_node1;node2.contact=c;node2.other=body1;node2.prev=null;node2.next=body2.m_contactList;if(node2.next!=null){node2.next.prev=node2}body2.m_contactList=node2}else if(oldCount>0&&newCount==0){body1=c.m_shape1.m_body;body2=c.m_shape2.m_body;node1=c.m_node1;node2=c.m_node2;if(node1.prev){node1.prev.next=node1.next}if(node1.next){node1.next.prev=node1.prev}if(node1==body1.m_contactList){body1.m_contactList=node1.next}node1.prev=null;node1.next=null;if(node2.prev){node2.prev.next=node2.next}if(node2.next){node2.next.prev=node2.prev}if(node2==body2.m_contactList){body2.m_contactList=node2.next}node2.prev=null;node2.next=null}}},m_world:null,m_nullContact:new b2NullContact,m_destroyImmediate:null});var b2World=Class.create();b2World.prototype={initialize:function(worldAABB,gravity,doSleep){this.step=new b2TimeStep;this.m_contactManager=new b2ContactManager;this.m_listener=null;this.m_filter=b2CollisionFilter.b2_defaultFilter;this.m_bodyList=null;this.m_contactList=null;this.m_jointList=null;this.m_bodyCount=0;this.m_contactCount=0;this.m_jointCount=0;this.m_bodyDestroyList=null;this.m_allowSleep=doSleep;this.m_gravity=gravity;this.m_contactManager.m_world=this;this.m_broadPhase=new b2BroadPhase(worldAABB,this.m_contactManager);var bd=new b2BodyDef;this.m_groundBody=this.CreateBody(bd)},SetListener:function(listener){this.m_listener=listener},SetFilter:function(filter){this.m_filter=filter},CreateBody:function(def){var b=new b2Body(def,this);b.m_prev=null;b.m_next=this.m_bodyList;if(this.m_bodyList){this.m_bodyList.m_prev=b}this.m_bodyList=b;++this.m_bodyCount;return b},DestroyBody:function(b){if(b.m_flags&b2Body.e_destroyFlag){return}if(b.m_prev){b.m_prev.m_next=b.m_next}if(b.m_next){b.m_next.m_prev=b.m_prev}if(b==this.m_bodyList){this.m_bodyList=b.m_next}b.m_flags|=b2Body.e_destroyFlag;--this.m_bodyCount;b.m_prev=null;b.m_next=this.m_bodyDestroyList;this.m_bodyDestroyList=b},CleanBodyList:function(){this.m_contactManager.m_destroyImmediate=true;var b=this.m_bodyDestroyList;while(b){var b0=b;b=b.m_next;var jn=b0.m_jointList;while(jn){var jn0=jn;jn=jn.next;if(this.m_listener){this.m_listener.NotifyJointDestroyed(jn0.joint)}this.DestroyJoint(jn0.joint)}b0.Destroy()}this.m_bodyDestroyList=null;this.m_contactManager.m_destroyImmediate=false},CreateJoint:function(def){var j=b2Joint.Create(def,this.m_blockAllocator);j.m_prev=null;j.m_next=this.m_jointList;if(this.m_jointList){this.m_jointList.m_prev=j}this.m_jointList=j;++this.m_jointCount;j.m_node1.joint=j;j.m_node1.other=j.m_body2;j.m_node1.prev=null;j.m_node1.next=j.m_body1.m_jointList;if(j.m_body1.m_jointList)j.m_body1.m_jointList.prev=j.m_node1;j.m_body1.m_jointList=j.m_node1;j.m_node2.joint=j;j.m_node2.other=j.m_body1;j.m_node2.prev=null;j.m_node2.next=j.m_body2.m_jointList;if(j.m_body2.m_jointList)j.m_body2.m_jointList.prev=j.m_node2;j.m_body2.m_jointList=j.m_node2;if(def.collideConnected==false){var b=def.body1.m_shapeCount<def.body2.m_shapeCount?def.body1:def.body2;for(var s=b.m_shapeList;s;s=s.m_next){s.ResetProxy(this.m_broadPhase)}}return j},DestroyJoint:function(j){var collideConnected=j.m_collideConnected;if(j.m_prev){j.m_prev.m_next=j.m_next}if(j.m_next){j.m_next.m_prev=j.m_prev}if(j==this.m_jointList){this.m_jointList=j.m_next}var body1=j.m_body1;var body2=j.m_body2;body1.WakeUp();body2.WakeUp();if(j.m_node1.prev){j.m_node1.prev.next=j.m_node1.next}if(j.m_node1.next){j.m_node1.next.prev=j.m_node1.prev}if(j.m_node1==body1.m_jointList){body1.m_jointList=j.m_node1.next}j.m_node1.prev=null;j.m_node1.next=null;if(j.m_node2.prev){j.m_node2.prev.next=j.m_node2.next}if(j.m_node2.next){j.m_node2.next.prev=j.m_node2.prev}if(j.m_node2==body2.m_jointList){body2.m_jointList=j.m_node2.next}j.m_node2.prev=null;j.m_node2.next=null;b2Joint.Destroy(j,this.m_blockAllocator);--this.m_jointCount;if(collideConnected==false){var b=body1.m_shapeCount<body2.m_shapeCount?body1:body2;for(var s=b.m_shapeList;s;s=s.m_next){s.ResetProxy(this.m_broadPhase)}}},GetGroundBody:function(){return this.m_groundBody},step:new b2TimeStep,Step:function(dt,iterations){var b;var other;this.step.dt=dt;this.step.iterations=iterations;if(dt>0){this.step.inv_dt=1/dt}else{this.step.inv_dt=0}this.m_positionIterationCount=0;this.m_contactManager.CleanContactList();this.CleanBodyList();this.m_contactManager.Collide();var island=new b2Island(this.m_bodyCount,this.m_contactCount,this.m_jointCount,this.m_stackAllocator);for(b=this.m_bodyList;b!=null;b=b.m_next){b.m_flags&=~b2Body.e_islandFlag}for(var c=this.m_contactList;c!=null;c=c.m_next){c.m_flags&=~b2Contact.e_islandFlag}for(var j=this.m_jointList;j!=null;j=j.m_next){j.m_islandFlag=false}var stackSize=this.m_bodyCount;var stack=new Array(this.m_bodyCount);for(var k=0;k<this.m_bodyCount;k++)stack[k]=null;for(var seed=this.m_bodyList;seed!=null;seed=seed.m_next){if(seed.m_flags&(b2Body.e_staticFlag|b2Body.e_islandFlag|b2Body.e_sleepFlag|b2Body.e_frozenFlag)){continue}island.Clear();var stackCount=0;stack[stackCount++]=seed;seed.m_flags|=b2Body.e_islandFlag;while(stackCount>0){b=stack[--stackCount];island.AddBody(b);b.m_flags&=~b2Body.e_sleepFlag;if(b.m_flags&b2Body.e_staticFlag){continue}for(var cn=b.m_contactList;cn!=null;cn=cn.next){if(cn.contact.m_flags&b2Contact.e_islandFlag){continue}if(!b.isCollidable){continue}LogicSystem.putCollideInfo(cn.contact.GetShape1().GetBody().GetUserData(),cn.contact.GetShape2().GetBody().GetUserData());if(b.isSensor==true||cn.other.isSensor==true){continue}island.AddContact(cn.contact);cn.contact.m_flags|=b2Contact.e_islandFlag;other=cn.other;if(other.m_flags&b2Body.e_islandFlag){continue}stack[stackCount++]=other;other.m_flags|=b2Body.e_islandFlag}for(var jn=b.m_jointList;jn!=null;jn=jn.next){if(jn.joint.m_islandFlag==true){continue}island.AddJoint(jn.joint);jn.joint.m_islandFlag=true;other=jn.other;if(other.m_flags&b2Body.e_islandFlag){continue}stack[stackCount++]=other;other.m_flags|=b2Body.e_islandFlag}}island.Solve(this.step,this.m_gravity);this.m_positionIterationCount=b2Math.b2Max(this.m_positionIterationCount,b2Island.m_positionIterationCount);if(this.m_allowSleep){island.UpdateSleep(dt)}for(var i=0;i<island.m_bodyCount;++i){b=island.m_bodies[i];if(b.m_flags&b2Body.e_staticFlag){b.m_flags&=~b2Body.e_islandFlag}if(b.IsFrozen()&&this.m_listener){var response=this.m_listener.NotifyBoundaryViolated(b);if(response==b2WorldListener.b2_destroyBody){this.DestroyBody(b);b=null;island.m_bodies[i]=null}}}}this.m_broadPhase.Commit()},Query:function(aabb,shapes,maxCount){var results=new Array;var count=this.m_broadPhase.QueryAABB(aabb,results,maxCount);for(var i=0;i<count;++i){shapes[i]=results[i]}return count},GetBodyList:function(){return this.m_bodyList},GetJointList:function(){return this.m_jointList},GetContactList:function(){return this.m_contactList},m_blockAllocator:null,m_stackAllocator:null,m_broadPhase:null,m_contactManager:new b2ContactManager,m_bodyList:null,m_contactList:null,m_jointList:null,m_bodyCount:0,m_contactCount:0,m_jointCount:0,m_bodyDestroyList:null,m_gravity:null,m_allowSleep:null,m_groundBody:null,m_listener:null,m_filter:null,m_positionIterationCount:0};b2World.s_enablePositionCorrection=1;b2World.s_enableWarmStarting=1;var b2WorldListener=Class.create();b2WorldListener.prototype={NotifyJointDestroyed:function(joint){},NotifyBoundaryViolated:function(body){return b2WorldListener.b2_freezeBody},initialize:function(){}};b2WorldListener.b2_freezeBody=0;b2WorldListener.b2_destroyBody=1;var b2JointNode=Class.create();b2JointNode.prototype={other:null,joint:null,prev:null,next:null,initialize:function(){}};var b2Joint=Class.create();b2Joint.prototype={GetType:function(){return this.m_type},GetAnchor1:function(){return null},GetAnchor2:function(){return null},GetReactionForce:function(invTimeStep){return null},GetReactionTorque:function(invTimeStep){return 0},GetBody1:function(){return this.m_body1},GetBody2:function(){return this.m_body2},GetNext:function(){return this.m_next},GetUserData:function(){return this.m_userData},initialize:function(def){this.m_node1=new b2JointNode;this.m_node2=new b2JointNode;this.m_type=def.type;this.m_prev=null;this.m_next=null;this.m_body1=def.body1;this.m_body2=def.body2;this.m_collideConnected=def.collideConnected;this.m_islandFlag=false;this.m_userData=def.userData},PrepareVelocitySolver:function(){},SolveVelocityConstraints:function(step){},PreparePositionSolver:function(){},SolvePositionConstraints:function(){return false},m_type:0,m_prev:null,m_next:null,m_node1:new b2JointNode,m_node2:new b2JointNode,m_body1:null,m_body2:null,m_islandFlag:null,m_collideConnected:null,m_userData:null};b2Joint.Create=function(def,allocator){var joint=null;switch(def.type){case b2Joint.e_distanceJoint:{joint=new b2DistanceJoint(def)}break;case b2Joint.e_mouseJoint:{joint=new b2MouseJoint(def)}break;case b2Joint.e_prismaticJoint:{joint=new b2PrismaticJoint(def)}break;case b2Joint.e_revoluteJoint:{joint=new b2RevoluteJoint(def)}break;case b2Joint.e_pulleyJoint:{joint=new b2PulleyJoint(def)}break;case b2Joint.e_gearJoint:{joint=new b2GearJoint(def)}break;default:break}return joint};b2Joint.Destroy=function(joint,allocator){};b2Joint.e_unknownJoint=0;b2Joint.e_revoluteJoint=1;b2Joint.e_prismaticJoint=2;b2Joint.e_distanceJoint=3;b2Joint.e_pulleyJoint=4;b2Joint.e_mouseJoint=5;b2Joint.e_gearJoint=6;b2Joint.e_inactiveLimit=0;b2Joint.e_atLowerLimit=1;b2Joint.e_atUpperLimit=2;b2Joint.e_equalLimits=3;var b2JointDef=Class.create();b2JointDef.prototype={initialize:function(){this.type=b2Joint.e_unknownJoint;this.userData=null;this.body1=null;this.body2=null;this.collideConnected=false},type:0,userData:null,body1:null,body2:null,collideConnected:null};var b2DistanceJoint=Class.create();Object.extend(b2DistanceJoint.prototype,b2Joint.prototype);Object.extend(b2DistanceJoint.prototype,{initialize:function(def){this.m_node1=new b2JointNode;this.m_node2=new b2JointNode;this.m_type=def.type;this.m_prev=null;this.m_next=null;this.m_body1=def.body1;this.m_body2=def.body2;this.m_collideConnected=def.collideConnected;this.m_islandFlag=false;this.m_userData=def.userData;this.m_localAnchor1=new b2Vec2;this.m_localAnchor2=new b2Vec2;this.m_u=new b2Vec2;var tMat;var tX;var tY;tMat=this.m_body1.m_R;tX=def.anchorPoint1.x-this.m_body1.m_position.x;tY=def.anchorPoint1.y-this.m_body1.m_position.y;this.m_localAnchor1.x=tX*tMat.col1.x+tY*tMat.col1.y;this.m_localAnchor1.y=tX*tMat.col2.x+tY*tMat.col2.y;tMat=this.m_body2.m_R;tX=def.anchorPoint2.x-this.m_body2.m_position.x;tY=def.anchorPoint2.y-this.m_body2.m_position.y;this.m_localAnchor2.x=tX*tMat.col1.x+tY*tMat.col1.y;this.m_localAnchor2.y=tX*tMat.col2.x+tY*tMat.col2.y;tX=def.anchorPoint2.x-def.anchorPoint1.x;tY=def.anchorPoint2.y-def.anchorPoint1.y;this.m_length=Math.sqrt(tX*tX+tY*tY);this.m_impulse=0},PrepareVelocitySolver:function(){var tMat;tMat=this.m_body1.m_R;var r1X=tMat.col1.x*this.m_localAnchor1.x+tMat.col2.x*this.m_localAnchor1.y;var r1Y=tMat.col1.y*this.m_localAnchor1.x+tMat.col2.y*this.m_localAnchor1.y;tMat=this.m_body2.m_R;var r2X=tMat.col1.x*this.m_localAnchor2.x+tMat.col2.x*this.m_localAnchor2.y;var r2Y=tMat.col1.y*this.m_localAnchor2.x+tMat.col2.y*this.m_localAnchor2.y;this.m_u.x=this.m_body2.m_position.x+r2X-this.m_body1.m_position.x-r1X;this.m_u.y=this.m_body2.m_position.y+r2Y-this.m_body1.m_position.y-r1Y;var length=Math.sqrt(this.m_u.x*this.m_u.x+this.m_u.y*this.m_u.y);if(length>b2Settings.b2_linearSlop){this.m_u.Multiply(1/length)}else{this.m_u.SetZero()}var cr1u=r1X*this.m_u.y-r1Y*this.m_u.x;var cr2u=r2X*this.m_u.y-r2Y*this.m_u.x;this.m_mass=this.m_body1.m_invMass+this.m_body1.m_invI*cr1u*cr1u+this.m_body2.m_invMass+this.m_body2.m_invI*cr2u*cr2u;this.m_mass=1/this.m_mass;if(b2World.s_enableWarmStarting){var PX=this.m_impulse*this.m_u.x;var PY=this.m_impulse*this.m_u.y;this.m_body1.m_linearVelocity.x-=this.m_body1.m_invMass*PX;this.m_body1.m_linearVelocity.y-=this.m_body1.m_invMass*PY;this.m_body1.m_angularVelocity-=this.m_body1.m_invI*(r1X*PY-r1Y*PX);this.m_body2.m_linearVelocity.x+=this.m_body2.m_invMass*PX;this.m_body2.m_linearVelocity.y+=this.m_body2.m_invMass*PY;this.m_body2.m_angularVelocity+=this.m_body2.m_invI*(r2X*PY-r2Y*PX)}else{this.m_impulse=0}},SolveVelocityConstraints:function(step){var tMat;tMat=this.m_body1.m_R;var r1X=tMat.col1.x*this.m_localAnchor1.x+tMat.col2.x*this.m_localAnchor1.y;var r1Y=tMat.col1.y*this.m_localAnchor1.x+tMat.col2.y*this.m_localAnchor1.y;tMat=this.m_body2.m_R;var r2X=tMat.col1.x*this.m_localAnchor2.x+tMat.col2.x*this.m_localAnchor2.y;var r2Y=tMat.col1.y*this.m_localAnchor2.x+tMat.col2.y*this.m_localAnchor2.y;var v1X=this.m_body1.m_linearVelocity.x+-this.m_body1.m_angularVelocity*r1Y;var v1Y=this.m_body1.m_linearVelocity.y+this.m_body1.m_angularVelocity*r1X;var v2X=this.m_body2.m_linearVelocity.x+-this.m_body2.m_angularVelocity*r2Y;var v2Y=this.m_body2.m_linearVelocity.y+this.m_body2.m_angularVelocity*r2X;var Cdot=this.m_u.x*(v2X-v1X)+this.m_u.y*(v2Y-v1Y);var impulse=-this.m_mass*Cdot;this.m_impulse+=impulse;var PX=impulse*this.m_u.x;var PY=impulse*this.m_u.y;this.m_body1.m_linearVelocity.x-=this.m_body1.m_invMass*PX;this.m_body1.m_linearVelocity.y-=this.m_body1.m_invMass*PY;this.m_body1.m_angularVelocity-=this.m_body1.m_invI*(r1X*PY-r1Y*PX);this.m_body2.m_linearVelocity.x+=this.m_body2.m_invMass*PX;this.m_body2.m_linearVelocity.y+=this.m_body2.m_invMass*PY;this.m_body2.m_angularVelocity+=this.m_body2.m_invI*(r2X*PY-r2Y*PX)},SolvePositionConstraints:function(){var tMat;tMat=this.m_body1.m_R;var r1X=tMat.col1.x*this.m_localAnchor1.x+tMat.col2.x*this.m_localAnchor1.y;var r1Y=tMat.col1.y*this.m_localAnchor1.x+tMat.col2.y*this.m_localAnchor1.y;tMat=this.m_body2.m_R;var r2X=tMat.col1.x*this.m_localAnchor2.x+tMat.col2.x*this.m_localAnchor2.y;var r2Y=tMat.col1.y*this.m_localAnchor2.x+tMat.col2.y*this.m_localAnchor2.y;var dX=this.m_body2.m_position.x+r2X-this.m_body1.m_position.x-r1X;var dY=this.m_body2.m_position.y+r2Y-this.m_body1.m_position.y-r1Y;var length=Math.sqrt(dX*dX+dY*dY);dX/=length;dY/=length;var C=length-this.m_length;C=b2Math.b2Clamp(C,-b2Settings.b2_maxLinearCorrection,b2Settings.b2_maxLinearCorrection);var impulse=-this.m_mass*C;this.m_u.Set(dX,dY);var PX=impulse*this.m_u.x;var PY=impulse*this.m_u.y;this.m_body1.m_position.x-=this.m_body1.m_invMass*PX;this.m_body1.m_position.y-=this.m_body1.m_invMass*PY;this.m_body1.m_rotation-=this.m_body1.m_invI*(r1X*PY-r1Y*PX);this.m_body2.m_position.x+=this.m_body2.m_invMass*PX;this.m_body2.m_position.y+=this.m_body2.m_invMass*PY;this.m_body2.m_rotation+=this.m_body2.m_invI*(r2X*PY-r2Y*PX);this.m_body1.m_R.Set(this.m_body1.m_rotation);this.m_body2.m_R.Set(this.m_body2.m_rotation);return b2Math.b2Abs(C)<b2Settings.b2_linearSlop},GetAnchor1:function(){return b2Math.AddVV(this.m_body1.m_position,b2Math.b2MulMV(this.m_body1.m_R,this.m_localAnchor1))},GetAnchor2:function(){return b2Math.AddVV(this.m_body2.m_position,b2Math.b2MulMV(this.m_body2.m_R,this.m_localAnchor2))},GetReactionForce:function(invTimeStep){var F=new b2Vec2;F.SetV(this.m_u);F.Multiply(this.m_impulse*invTimeStep);return F},GetReactionTorque:function(invTimeStep){return 0},m_localAnchor1:new b2Vec2,m_localAnchor2:new b2Vec2,m_u:new b2Vec2,m_impulse:null,m_mass:null,m_length:null});var b2DistanceJointDef=Class.create();Object.extend(b2DistanceJointDef.prototype,b2JointDef.prototype);Object.extend(b2DistanceJointDef.prototype,{initialize:function(){this.type=b2Joint.e_unknownJoint;this.userData=null;this.body1=null;this.body2=null;this.collideConnected=false;this.anchorPoint1=new b2Vec2;this.anchorPoint2=new b2Vec2;this.type=b2Joint.e_distanceJoint},anchorPoint1:new b2Vec2,anchorPoint2:new b2Vec2});var b2Jacobian=Class.create();b2Jacobian.prototype={linear1:new b2Vec2,angular1:null,linear2:new b2Vec2,angular2:null,SetZero:function(){this.linear1.SetZero();this.angular1=0;this.linear2.SetZero();this.angular2=0},Set:function(x1,a1,x2,a2){this.linear1.SetV(x1);this.angular1=a1;this.linear2.SetV(x2);this.angular2=a2},Compute:function(x1,a1,x2,a2){return this.linear1.x*x1.x+this.linear1.y*x1.y+this.angular1*a1+(this.linear2.x*x2.x+this.linear2.y*x2.y)+this.angular2*a2},initialize:function(){this.linear1=new b2Vec2;this.linear2=new b2Vec2}};var b2GearJoint=Class.create();Object.extend(b2GearJoint.prototype,b2Joint.prototype);Object.extend(b2GearJoint.prototype,{GetAnchor1:function(){var tMat=this.m_body1.m_R;return new b2Vec2(this.m_body1.m_position.x+(tMat.col1.x*this.m_localAnchor1.x+tMat.col2.x*this.m_localAnchor1.y),this.m_body1.m_position.y+(tMat.col1.y*this.m_localAnchor1.x+tMat.col2.y*this.m_localAnchor1.y))},GetAnchor2:function(){var tMat=this.m_body2.m_R;return new b2Vec2(this.m_body2.m_position.x+(tMat.col1.x*this.m_localAnchor2.x+tMat.col2.x*this.m_localAnchor2.y),this.m_body2.m_position.y+(tMat.col1.y*this.m_localAnchor2.x+tMat.col2.y*this.m_localAnchor2.y))},GetReactionForce:function(invTimeStep){return new b2Vec2},GetReactionTorque:function(invTimeStep){return 0},GetRatio:function(){return this.m_ratio},initialize:function(def){this.m_node1=new b2JointNode;this.m_node2=new b2JointNode;this.m_type=def.type;this.m_prev=null;this.m_next=null;this.m_body1=def.body1;this.m_body2=def.body2;this.m_collideConnected=def.collideConnected;this.m_islandFlag=false;this.m_userData=def.userData;this.m_groundAnchor1=new b2Vec2;this.m_groundAnchor2=new b2Vec2;this.m_localAnchor1=new b2Vec2;this.m_localAnchor2=new b2Vec2;this.m_J=new b2Jacobian;this.m_revolute1=null;this.m_prismatic1=null;this.m_revolute2=null;this.m_prismatic2=null;var coordinate1;var coordinate2;this.m_ground1=def.joint1.m_body1;this.m_body1=def.joint1.m_body2;if(def.joint1.m_type==b2Joint.e_revoluteJoint){this.m_revolute1=def.joint1;this.m_groundAnchor1.SetV(this.m_revolute1.m_localAnchor1);this.m_localAnchor1.SetV(this.m_revolute1.m_localAnchor2);coordinate1=this.m_revolute1.GetJointAngle()}else{this.m_prismatic1=def.joint1;this.m_groundAnchor1.SetV(this.m_prismatic1.m_localAnchor1);this.m_localAnchor1.SetV(this.m_prismatic1.m_localAnchor2);coordinate1=this.m_prismatic1.GetJointTranslation()}this.m_ground2=def.joint2.m_body1;this.m_body2=def.joint2.m_body2;if(def.joint2.m_type==b2Joint.e_revoluteJoint){this.m_revolute2=def.joint2;this.m_groundAnchor2.SetV(this.m_revolute2.m_localAnchor1);this.m_localAnchor2.SetV(this.m_revolute2.m_localAnchor2);coordinate2=this.m_revolute2.GetJointAngle()}else{this.m_prismatic2=def.joint2;this.m_groundAnchor2.SetV(this.m_prismatic2.m_localAnchor1);this.m_localAnchor2.SetV(this.m_prismatic2.m_localAnchor2);coordinate2=this.m_prismatic2.GetJointTranslation()}this.m_ratio=def.ratio;this.m_constant=coordinate1+this.m_ratio*coordinate2;this.m_impulse=0},PrepareVelocitySolver:function(){var g1=this.m_ground1;var g2=this.m_ground2;var b1=this.m_body1;var b2=this.m_body2;var ugX;var ugY;var rX;var rY;var tMat;var tVec;var crug;var K=0;this.m_J.SetZero();if(this.m_revolute1){this.m_J.angular1=-1;K+=b1.m_invI}else{tMat=g1.m_R;tVec=this.m_prismatic1.m_localXAxis1;ugX=tMat.col1.x*tVec.x+tMat.col2.x*tVec.y;ugY=tMat.col1.y*tVec.x+tMat.col2.y*tVec.y;tMat=b1.m_R;rX=tMat.col1.x*this.m_localAnchor1.x+tMat.col2.x*this.m_localAnchor1.y;rY=tMat.col1.y*this.m_localAnchor1.x+tMat.col2.y*this.m_localAnchor1.y;crug=rX*ugY-rY*ugX;this.m_J.linear1.Set(-ugX,-ugY);this.m_J.angular1=-crug;K+=b1.m_invMass+b1.m_invI*crug*crug}if(this.m_revolute2){this.m_J.angular2=-this.m_ratio;K+=this.m_ratio*this.m_ratio*b2.m_invI}else{tMat=g2.m_R;tVec=this.m_prismatic2.m_localXAxis1;ugX=tMat.col1.x*tVec.x+tMat.col2.x*tVec.y;ugY=tMat.col1.y*tVec.x+tMat.col2.y*tVec.y;tMat=b2.m_R;rX=tMat.col1.x*this.m_localAnchor2.x+tMat.col2.x*this.m_localAnchor2.y;rY=tMat.col1.y*this.m_localAnchor2.x+tMat.col2.y*this.m_localAnchor2.y;crug=rX*ugY-rY*ugX;this.m_J.linear2.Set(-this.m_ratio*ugX,-this.m_ratio*ugY);this.m_J.angular2=-this.m_ratio*crug;K+=this.m_ratio*this.m_ratio*(b2.m_invMass+b2.m_invI*crug*crug)}this.m_mass=1/K;b1.m_linearVelocity.x+=b1.m_invMass*this.m_impulse*this.m_J.linear1.x;b1.m_linearVelocity.y+=b1.m_invMass*this.m_impulse*this.m_J.linear1.y;b1.m_angularVelocity+=b1.m_invI*this.m_impulse*this.m_J.angular1;b2.m_linearVelocity.x+=b2.m_invMass*this.m_impulse*this.m_J.linear2.x;b2.m_linearVelocity.y+=b2.m_invMass*this.m_impulse*this.m_J.linear2.y;b2.m_angularVelocity+=b2.m_invI*this.m_impulse*this.m_J.angular2},SolveVelocityConstraints:function(step){var b1=this.m_body1;var b2=this.m_body2;var Cdot=this.m_J.Compute(b1.m_linearVelocity,b1.m_angularVelocity,b2.m_linearVelocity,b2.m_angularVelocity);var impulse=-this.m_mass*Cdot;this.m_impulse+=impulse;b1.m_linearVelocity.x+=b1.m_invMass*impulse*this.m_J.linear1.x;b1.m_linearVelocity.y+=b1.m_invMass*impulse*this.m_J.linear1.y;b1.m_angularVelocity+=b1.m_invI*impulse*this.m_J.angular1;b2.m_linearVelocity.x+=b2.m_invMass*impulse*this.m_J.linear2.x;b2.m_linearVelocity.y+=b2.m_invMass*impulse*this.m_J.linear2.y;b2.m_angularVelocity+=b2.m_invI*impulse*this.m_J.angular2},SolvePositionConstraints:function(){var linearError=0;var b1=this.m_body1;var b2=this.m_body2;var coordinate1;var coordinate2;if(this.m_revolute1){coordinate1=this.m_revolute1.GetJointAngle()}else{coordinate1=this.m_prismatic1.GetJointTranslation()}if(this.m_revolute2){coordinate2=this.m_revolute2.GetJointAngle()}else{coordinate2=this.m_prismatic2.GetJointTranslation()}var C=this.m_constant-(coordinate1+this.m_ratio*coordinate2);var impulse=-this.m_mass*C;b1.m_position.x+=b1.m_invMass*impulse*this.m_J.linear1.x;b1.m_position.y+=b1.m_invMass*impulse*this.m_J.linear1.y;b1.m_rotation+=b1.m_invI*impulse*this.m_J.angular1;b2.m_position.x+=b2.m_invMass*impulse*this.m_J.linear2.x;b2.m_position.y+=b2.m_invMass*impulse*this.m_J.linear2.y;b2.m_rotation+=b2.m_invI*impulse*this.m_J.angular2;b1.m_R.Set(b1.m_rotation);b2.m_R.Set(b2.m_rotation);return linearError<b2Settings.b2_linearSlop},m_ground1:null,m_ground2:null,m_revolute1:null,m_prismatic1:null,m_revolute2:null,m_prismatic2:null,m_groundAnchor1:new b2Vec2,m_groundAnchor2:new b2Vec2,m_localAnchor1:new b2Vec2,m_localAnchor2:new b2Vec2,m_J:new b2Jacobian,m_constant:null,m_ratio:null,m_mass:null,m_impulse:null});var b2GearJointDef=Class.create();Object.extend(b2GearJointDef.prototype,b2JointDef.prototype);Object.extend(b2GearJointDef.prototype,{initialize:function(){this.type=b2Joint.e_gearJoint;this.joint1=null;this.joint2=null;this.ratio=1},joint1:null,joint2:null,ratio:null});var b2MouseJoint=Class.create();Object.extend(b2MouseJoint.prototype,b2Joint.prototype);Object.extend(b2MouseJoint.prototype,{GetAnchor1:function(){return this.m_target},GetAnchor2:function(){var tVec=b2Math.b2MulMV(this.m_body2.m_R,this.m_localAnchor);tVec.Add(this.m_body2.m_position);return tVec},GetReactionForce:function(invTimeStep){var F=new b2Vec2;F.SetV(this.m_impulse);F.Multiply(invTimeStep);return F},GetReactionTorque:function(invTimeStep){return 0},SetTarget:function(target){this.m_body2.WakeUp();this.m_target=target},initialize:function(def){this.m_node1=new b2JointNode;this.m_node2=new b2JointNode;this.m_type=def.type;this.m_prev=null;this.m_next=null;this.m_body1=def.body1;this.m_body2=def.body2;this.m_collideConnected=def.collideConnected;this.m_islandFlag=false;this.m_userData=def.userData;this.K=new b2Mat22;this.K1=new b2Mat22;this.K2=new b2Mat22;this.m_localAnchor=new b2Vec2;this.m_target=new b2Vec2;this.m_impulse=new b2Vec2;this.m_ptpMass=new b2Mat22;this.m_C=new b2Vec2;this.m_target.SetV(def.target);var tX=this.m_target.x-this.m_body2.m_position.x;var tY=this.m_target.y-this.m_body2.m_position.y;this.m_localAnchor.x=tX*this.m_body2.m_R.col1.x+tY*this.m_body2.m_R.col1.y;this.m_localAnchor.y=tX*this.m_body2.m_R.col2.x+tY*this.m_body2.m_R.col2.y;this.m_maxForce=def.maxForce;this.m_impulse.SetZero();var mass=this.m_body2.m_mass;var omega=2*b2Settings.b2_pi*def.frequencyHz;var d=2*mass*def.dampingRatio*omega;var k=mass*omega*omega;this.m_gamma=1/(d+def.timeStep*k);this.m_beta=def.timeStep*k/(d+def.timeStep*k)},K:new b2Mat22,K1:new b2Mat22,K2:new b2Mat22,PrepareVelocitySolver:function(){var b=this.m_body2;var tMat;tMat=b.m_R;var rX=tMat.col1.x*this.m_localAnchor.x+tMat.col2.x*this.m_localAnchor.y;var rY=tMat.col1.y*this.m_localAnchor.x+tMat.col2.y*this.m_localAnchor.y;var invMass=b.m_invMass;var invI=b.m_invI;this.K1.col1.x=invMass;this.K1.col2.x=0;this.K1.col1.y=0;this.K1.col2.y=invMass;this.K2.col1.x=invI*rY*rY;this.K2.col2.x=-invI*rX*rY;this.K2.col1.y=-invI*rX*rY;this.K2.col2.y=invI*rX*rX;this.K.SetM(this.K1);this.K.AddM(this.K2);this.K.col1.x+=this.m_gamma;this.K.col2.y+=this.m_gamma;this.K.Invert(this.m_ptpMass);this.m_C.x=b.m_position.x+rX-this.m_target.x;this.m_C.y=b.m_position.y+rY-this.m_target.y;b.m_angularVelocity*=.98;var PX=this.m_impulse.x;var PY=this.m_impulse.y;b.m_linearVelocity.x+=invMass*PX;b.m_linearVelocity.y+=invMass*PY;b.m_angularVelocity+=invI*(rX*PY-rY*PX)},SolveVelocityConstraints:function(step){var body=this.m_body2;var tMat;tMat=body.m_R;var rX=tMat.col1.x*this.m_localAnchor.x+tMat.col2.x*this.m_localAnchor.y;var rY=tMat.col1.y*this.m_localAnchor.x+tMat.col2.y*this.m_localAnchor.y;var CdotX=body.m_linearVelocity.x+-body.m_angularVelocity*rY;var CdotY=body.m_linearVelocity.y+body.m_angularVelocity*rX;tMat=this.m_ptpMass;var tX=CdotX+this.m_beta*step.inv_dt*this.m_C.x+this.m_gamma*this.m_impulse.x;var tY=CdotY+this.m_beta*step.inv_dt*this.m_C.y+this.m_gamma*this.m_impulse.y;var impulseX=-(tMat.col1.x*tX+tMat.col2.x*tY);var impulseY=-(tMat.col1.y*tX+tMat.col2.y*tY);var oldImpulseX=this.m_impulse.x;var oldImpulseY=this.m_impulse.y;this.m_impulse.x+=impulseX;this.m_impulse.y+=impulseY;var length=this.m_impulse.Length();if(length>step.dt*this.m_maxForce){this.m_impulse.Multiply(step.dt*this.m_maxForce/length)}impulseX=this.m_impulse.x-oldImpulseX;impulseY=this.m_impulse.y-oldImpulseY;body.m_linearVelocity.x+=body.m_invMass*impulseX;body.m_linearVelocity.y+=body.m_invMass*impulseY;body.m_angularVelocity+=body.m_invI*(rX*impulseY-rY*impulseX)},SolvePositionConstraints:function(){return true},m_localAnchor:new b2Vec2,m_target:new b2Vec2,m_impulse:new b2Vec2,m_ptpMass:new b2Mat22,m_C:new b2Vec2,m_maxForce:null,m_beta:null,m_gamma:null});var b2MouseJointDef=Class.create();Object.extend(b2MouseJointDef.prototype,b2JointDef.prototype);Object.extend(b2MouseJointDef.prototype,{initialize:function(){this.type=b2Joint.e_unknownJoint;this.userData=null;this.body1=null;this.body2=null;this.collideConnected=false;this.target=new b2Vec2;this.type=b2Joint.e_mouseJoint;this.maxForce=0;this.frequencyHz=5;this.dampingRatio=.7;this.timeStep=1/60},target:new b2Vec2,maxForce:null,frequencyHz:null,dampingRatio:null,timeStep:null});var b2PrismaticJoint=Class.create();Object.extend(b2PrismaticJoint.prototype,b2Joint.prototype);Object.extend(b2PrismaticJoint.prototype,{GetAnchor1:function(){var b1=this.m_body1;var tVec=new b2Vec2;tVec.SetV(this.m_localAnchor1);tVec.MulM(b1.m_R);tVec.Add(b1.m_position);return tVec},GetAnchor2:function(){var b2=this.m_body2;var tVec=new b2Vec2;tVec.SetV(this.m_localAnchor2);tVec.MulM(b2.m_R);tVec.Add(b2.m_position);return tVec},GetJointTranslation:function(){var b1=this.m_body1;var b2=this.m_body2;var tMat;tMat=b1.m_R;var r1X=tMat.col1.x*this.m_localAnchor1.x+tMat.col2.x*this.m_localAnchor1.y;var r1Y=tMat.col1.y*this.m_localAnchor1.x+tMat.col2.y*this.m_localAnchor1.y;tMat=b2.m_R;var r2X=tMat.col1.x*this.m_localAnchor2.x+tMat.col2.x*this.m_localAnchor2.y;var r2Y=tMat.col1.y*this.m_localAnchor2.x+tMat.col2.y*this.m_localAnchor2.y;var p1X=b1.m_position.x+r1X;var p1Y=b1.m_position.y+r1Y;var p2X=b2.m_position.x+r2X;var p2Y=b2.m_position.y+r2Y;var dX=p2X-p1X;var dY=p2Y-p1Y;tMat=b1.m_R;var ax1X=tMat.col1.x*this.m_localXAxis1.x+tMat.col2.x*this.m_localXAxis1.y;var ax1Y=tMat.col1.y*this.m_localXAxis1.x+tMat.col2.y*this.m_localXAxis1.y;var translation=ax1X*dX+ax1Y*dY;return translation},GetJointSpeed:function(){var b1=this.m_body1;var b2=this.m_body2;var tMat;tMat=b1.m_R;var r1X=tMat.col1.x*this.m_localAnchor1.x+tMat.col2.x*this.m_localAnchor1.y;var r1Y=tMat.col1.y*this.m_localAnchor1.x+tMat.col2.y*this.m_localAnchor1.y;tMat=b2.m_R;var r2X=tMat.col1.x*this.m_localAnchor2.x+tMat.col2.x*this.m_localAnchor2.y;var r2Y=tMat.col1.y*this.m_localAnchor2.x+tMat.col2.y*this.m_localAnchor2.y;var p1X=b1.m_position.x+r1X;var p1Y=b1.m_position.y+r1Y;var p2X=b2.m_position.x+r2X;var p2Y=b2.m_position.y+r2Y;var dX=p2X-p1X;var dY=p2Y-p1Y;tMat=b1.m_R;var ax1X=tMat.col1.x*this.m_localXAxis1.x+tMat.col2.x*this.m_localXAxis1.y;var ax1Y=tMat.col1.y*this.m_localXAxis1.x+tMat.col2.y*this.m_localXAxis1.y;var v1=b1.m_linearVelocity;var v2=b2.m_linearVelocity;var w1=b1.m_angularVelocity;var w2=b2.m_angularVelocity;var speed=dX*(-w1*ax1Y)+dY*(w1*ax1X)+(ax1X*(v2.x+-w2*r2Y-v1.x- -w1*r1Y)+ax1Y*(v2.y+w2*r2X-v1.y-w1*r1X));return speed},GetMotorForce:function(invTimeStep){return invTimeStep*this.m_motorImpulse},SetMotorSpeed:function(speed){this.m_motorSpeed=speed},SetMotorForce:function(force){this.m_maxMotorForce=force},GetReactionForce:function(invTimeStep){var tImp=invTimeStep*this.m_limitImpulse;var tMat;tMat=this.m_body1.m_R;var ax1X=tImp*(tMat.col1.x*this.m_localXAxis1.x+tMat.col2.x*this.m_localXAxis1.y);var ax1Y=tImp*(tMat.col1.y*this.m_localXAxis1.x+tMat.col2.y*this.m_localXAxis1.y);var ay1X=tImp*(tMat.col1.x*this.m_localYAxis1.x+tMat.col2.x*this.m_localYAxis1.y);var ay1Y=tImp*(tMat.col1.y*this.m_localYAxis1.x+tMat.col2.y*this.m_localYAxis1.y);return new b2Vec2(ax1X+ay1X,ax1Y+ay1Y)},GetReactionTorque:function(invTimeStep){return invTimeStep*this.m_angularImpulse},initialize:function(def){this.m_node1=new b2JointNode;this.m_node2=new b2JointNode;this.m_type=def.type;this.m_prev=null;this.m_next=null;this.m_body1=def.body1;this.m_body2=def.body2;this.m_collideConnected=def.collideConnected;this.m_islandFlag=false;this.m_userData=def.userData;this.m_localAnchor1=new b2Vec2;this.m_localAnchor2=new b2Vec2;this.m_localXAxis1=new b2Vec2;this.m_localYAxis1=new b2Vec2;this.m_linearJacobian=new b2Jacobian;this.m_motorJacobian=new b2Jacobian;var tMat;var tX;var tY;tMat=this.m_body1.m_R;tX=def.anchorPoint.x-this.m_body1.m_position.x;tY=def.anchorPoint.y-this.m_body1.m_position.y;this.m_localAnchor1.Set(tX*tMat.col1.x+tY*tMat.col1.y,tX*tMat.col2.x+tY*tMat.col2.y);tMat=this.m_body2.m_R;tX=def.anchorPoint.x-this.m_body2.m_position.x;tY=def.anchorPoint.y-this.m_body2.m_position.y;this.m_localAnchor2.Set(tX*tMat.col1.x+tY*tMat.col1.y,tX*tMat.col2.x+tY*tMat.col2.y);tMat=this.m_body1.m_R;tX=def.axis.x;tY=def.axis.y;this.m_localXAxis1.Set(tX*tMat.col1.x+tY*tMat.col1.y,tX*tMat.col2.x+tY*tMat.col2.y);this.m_localYAxis1.x=-this.m_localXAxis1.y;this.m_localYAxis1.y=this.m_localXAxis1.x;this.m_initialAngle=this.m_body2.m_rotation-this.m_body1.m_rotation;this.m_linearJacobian.SetZero();this.m_linearMass=0;this.m_linearImpulse=0;this.m_angularMass=0;this.m_angularImpulse=0;this.m_motorJacobian.SetZero();this.m_motorMass=0;this.m_motorImpulse=0;this.m_limitImpulse=0;this.m_limitPositionImpulse=0;this.m_lowerTranslation=def.lowerTranslation;this.m_upperTranslation=def.upperTranslation;this.m_maxMotorForce=def.motorForce;this.m_motorSpeed=def.motorSpeed;this.m_enableLimit=def.enableLimit;this.m_enableMotor=def.enableMotor},PrepareVelocitySolver:function(){var b1=this.m_body1;var b2=this.m_body2;var tMat;tMat=b1.m_R;var r1X=tMat.col1.x*this.m_localAnchor1.x+tMat.col2.x*this.m_localAnchor1.y;var r1Y=tMat.col1.y*this.m_localAnchor1.x+tMat.col2.y*this.m_localAnchor1.y;tMat=b2.m_R;var r2X=tMat.col1.x*this.m_localAnchor2.x+tMat.col2.x*this.m_localAnchor2.y;var r2Y=tMat.col1.y*this.m_localAnchor2.x+tMat.col2.y*this.m_localAnchor2.y;var invMass1=b1.m_invMass;var invMass2=b2.m_invMass;var invI1=b1.m_invI;var invI2=b2.m_invI;tMat=b1.m_R;var ay1X=tMat.col1.x*this.m_localYAxis1.x+tMat.col2.x*this.m_localYAxis1.y;var ay1Y=tMat.col1.y*this.m_localYAxis1.x+tMat.col2.y*this.m_localYAxis1.y;var eX=b2.m_position.x+r2X-b1.m_position.x;var eY=b2.m_position.y+r2Y-b1.m_position.y;this.m_linearJacobian.linear1.x=-ay1X;this.m_linearJacobian.linear1.y=-ay1Y;this.m_linearJacobian.linear2.x=ay1X;
this.m_linearJacobian.linear2.y=ay1Y;this.m_linearJacobian.angular1=-(eX*ay1Y-eY*ay1X);this.m_linearJacobian.angular2=r2X*ay1Y-r2Y*ay1X;this.m_linearMass=invMass1+invI1*this.m_linearJacobian.angular1*this.m_linearJacobian.angular1+invMass2+invI2*this.m_linearJacobian.angular2*this.m_linearJacobian.angular2;this.m_linearMass=1/this.m_linearMass;this.m_angularMass=1/(invI1+invI2);if(this.m_enableLimit||this.m_enableMotor){tMat=b1.m_R;var ax1X=tMat.col1.x*this.m_localXAxis1.x+tMat.col2.x*this.m_localXAxis1.y;var ax1Y=tMat.col1.y*this.m_localXAxis1.x+tMat.col2.y*this.m_localXAxis1.y;this.m_motorJacobian.linear1.x=-ax1X;this.m_motorJacobian.linear1.y=-ax1Y;this.m_motorJacobian.linear2.x=ax1X;this.m_motorJacobian.linear2.y=ax1Y;this.m_motorJacobian.angular1=-(eX*ax1Y-eY*ax1X);this.m_motorJacobian.angular2=r2X*ax1Y-r2Y*ax1X;this.m_motorMass=invMass1+invI1*this.m_motorJacobian.angular1*this.m_motorJacobian.angular1+invMass2+invI2*this.m_motorJacobian.angular2*this.m_motorJacobian.angular2;this.m_motorMass=1/this.m_motorMass;if(this.m_enableLimit){var dX=eX-r1X;var dY=eY-r1Y;var jointTranslation=ax1X*dX+ax1Y*dY;if(b2Math.b2Abs(this.m_upperTranslation-this.m_lowerTranslation)<2*b2Settings.b2_linearSlop){this.m_limitState=b2Joint.e_equalLimits}else if(jointTranslation<=this.m_lowerTranslation){if(this.m_limitState!=b2Joint.e_atLowerLimit){this.m_limitImpulse=0}this.m_limitState=b2Joint.e_atLowerLimit}else if(jointTranslation>=this.m_upperTranslation){if(this.m_limitState!=b2Joint.e_atUpperLimit){this.m_limitImpulse=0}this.m_limitState=b2Joint.e_atUpperLimit}else{this.m_limitState=b2Joint.e_inactiveLimit;this.m_limitImpulse=0}}}if(this.m_enableMotor==false){this.m_motorImpulse=0}if(this.m_enableLimit==false){this.m_limitImpulse=0}if(b2World.s_enableWarmStarting){var P1X=this.m_linearImpulse*this.m_linearJacobian.linear1.x+(this.m_motorImpulse+this.m_limitImpulse)*this.m_motorJacobian.linear1.x;var P1Y=this.m_linearImpulse*this.m_linearJacobian.linear1.y+(this.m_motorImpulse+this.m_limitImpulse)*this.m_motorJacobian.linear1.y;var P2X=this.m_linearImpulse*this.m_linearJacobian.linear2.x+(this.m_motorImpulse+this.m_limitImpulse)*this.m_motorJacobian.linear2.x;var P2Y=this.m_linearImpulse*this.m_linearJacobian.linear2.y+(this.m_motorImpulse+this.m_limitImpulse)*this.m_motorJacobian.linear2.y;var L1=this.m_linearImpulse*this.m_linearJacobian.angular1-this.m_angularImpulse+(this.m_motorImpulse+this.m_limitImpulse)*this.m_motorJacobian.angular1;var L2=this.m_linearImpulse*this.m_linearJacobian.angular2+this.m_angularImpulse+(this.m_motorImpulse+this.m_limitImpulse)*this.m_motorJacobian.angular2;b1.m_linearVelocity.x+=invMass1*P1X;b1.m_linearVelocity.y+=invMass1*P1Y;b1.m_angularVelocity+=invI1*L1;b2.m_linearVelocity.x+=invMass2*P2X;b2.m_linearVelocity.y+=invMass2*P2Y;b2.m_angularVelocity+=invI2*L2}else{this.m_linearImpulse=0;this.m_angularImpulse=0;this.m_limitImpulse=0;this.m_motorImpulse=0}this.m_limitPositionImpulse=0},SolveVelocityConstraints:function(step){var b1=this.m_body1;var b2=this.m_body2;var invMass1=b1.m_invMass;var invMass2=b2.m_invMass;var invI1=b1.m_invI;var invI2=b2.m_invI;var oldLimitImpulse;var linearCdot=this.m_linearJacobian.Compute(b1.m_linearVelocity,b1.m_angularVelocity,b2.m_linearVelocity,b2.m_angularVelocity);var linearImpulse=-this.m_linearMass*linearCdot;this.m_linearImpulse+=linearImpulse;b1.m_linearVelocity.x+=invMass1*linearImpulse*this.m_linearJacobian.linear1.x;b1.m_linearVelocity.y+=invMass1*linearImpulse*this.m_linearJacobian.linear1.y;b1.m_angularVelocity+=invI1*linearImpulse*this.m_linearJacobian.angular1;b2.m_linearVelocity.x+=invMass2*linearImpulse*this.m_linearJacobian.linear2.x;b2.m_linearVelocity.y+=invMass2*linearImpulse*this.m_linearJacobian.linear2.y;b2.m_angularVelocity+=invI2*linearImpulse*this.m_linearJacobian.angular2;var angularCdot=b2.m_angularVelocity-b1.m_angularVelocity;var angularImpulse=-this.m_angularMass*angularCdot;this.m_angularImpulse+=angularImpulse;b1.m_angularVelocity-=invI1*angularImpulse;b2.m_angularVelocity+=invI2*angularImpulse;if(this.m_enableMotor&&this.m_limitState!=b2Joint.e_equalLimits){var motorCdot=this.m_motorJacobian.Compute(b1.m_linearVelocity,b1.m_angularVelocity,b2.m_linearVelocity,b2.m_angularVelocity)-this.m_motorSpeed;var motorImpulse=-this.m_motorMass*motorCdot;var oldMotorImpulse=this.m_motorImpulse;this.m_motorImpulse=b2Math.b2Clamp(this.m_motorImpulse+motorImpulse,-step.dt*this.m_maxMotorForce,step.dt*this.m_maxMotorForce);motorImpulse=this.m_motorImpulse-oldMotorImpulse;b1.m_linearVelocity.x+=invMass1*motorImpulse*this.m_motorJacobian.linear1.x;b1.m_linearVelocity.y+=invMass1*motorImpulse*this.m_motorJacobian.linear1.y;b1.m_angularVelocity+=invI1*motorImpulse*this.m_motorJacobian.angular1;b2.m_linearVelocity.x+=invMass2*motorImpulse*this.m_motorJacobian.linear2.x;b2.m_linearVelocity.y+=invMass2*motorImpulse*this.m_motorJacobian.linear2.y;b2.m_angularVelocity+=invI2*motorImpulse*this.m_motorJacobian.angular2}if(this.m_enableLimit&&this.m_limitState!=b2Joint.e_inactiveLimit){var limitCdot=this.m_motorJacobian.Compute(b1.m_linearVelocity,b1.m_angularVelocity,b2.m_linearVelocity,b2.m_angularVelocity);var limitImpulse=-this.m_motorMass*limitCdot;if(this.m_limitState==b2Joint.e_equalLimits){this.m_limitImpulse+=limitImpulse}else if(this.m_limitState==b2Joint.e_atLowerLimit){oldLimitImpulse=this.m_limitImpulse;this.m_limitImpulse=b2Math.b2Max(this.m_limitImpulse+limitImpulse,0);limitImpulse=this.m_limitImpulse-oldLimitImpulse}else if(this.m_limitState==b2Joint.e_atUpperLimit){oldLimitImpulse=this.m_limitImpulse;this.m_limitImpulse=b2Math.b2Min(this.m_limitImpulse+limitImpulse,0);limitImpulse=this.m_limitImpulse-oldLimitImpulse}b1.m_linearVelocity.x+=invMass1*limitImpulse*this.m_motorJacobian.linear1.x;b1.m_linearVelocity.y+=invMass1*limitImpulse*this.m_motorJacobian.linear1.y;b1.m_angularVelocity+=invI1*limitImpulse*this.m_motorJacobian.angular1;b2.m_linearVelocity.x+=invMass2*limitImpulse*this.m_motorJacobian.linear2.x;b2.m_linearVelocity.y+=invMass2*limitImpulse*this.m_motorJacobian.linear2.y;b2.m_angularVelocity+=invI2*limitImpulse*this.m_motorJacobian.angular2}},SolvePositionConstraints:function(){var limitC;var oldLimitImpulse;var b1=this.m_body1;var b2=this.m_body2;var invMass1=b1.m_invMass;var invMass2=b2.m_invMass;var invI1=b1.m_invI;var invI2=b2.m_invI;var tMat;tMat=b1.m_R;var r1X=tMat.col1.x*this.m_localAnchor1.x+tMat.col2.x*this.m_localAnchor1.y;var r1Y=tMat.col1.y*this.m_localAnchor1.x+tMat.col2.y*this.m_localAnchor1.y;tMat=b2.m_R;var r2X=tMat.col1.x*this.m_localAnchor2.x+tMat.col2.x*this.m_localAnchor2.y;var r2Y=tMat.col1.y*this.m_localAnchor2.x+tMat.col2.y*this.m_localAnchor2.y;var p1X=b1.m_position.x+r1X;var p1Y=b1.m_position.y+r1Y;var p2X=b2.m_position.x+r2X;var p2Y=b2.m_position.y+r2Y;var dX=p2X-p1X;var dY=p2Y-p1Y;tMat=b1.m_R;var ay1X=tMat.col1.x*this.m_localYAxis1.x+tMat.col2.x*this.m_localYAxis1.y;var ay1Y=tMat.col1.y*this.m_localYAxis1.x+tMat.col2.y*this.m_localYAxis1.y;var linearC=ay1X*dX+ay1Y*dY;linearC=b2Math.b2Clamp(linearC,-b2Settings.b2_maxLinearCorrection,b2Settings.b2_maxLinearCorrection);var linearImpulse=-this.m_linearMass*linearC;b1.m_position.x+=invMass1*linearImpulse*this.m_linearJacobian.linear1.x;b1.m_position.y+=invMass1*linearImpulse*this.m_linearJacobian.linear1.y;b1.m_rotation+=invI1*linearImpulse*this.m_linearJacobian.angular1;b2.m_position.x+=invMass2*linearImpulse*this.m_linearJacobian.linear2.x;b2.m_position.y+=invMass2*linearImpulse*this.m_linearJacobian.linear2.y;b2.m_rotation+=invI2*linearImpulse*this.m_linearJacobian.angular2;var positionError=b2Math.b2Abs(linearC);var angularC=b2.m_rotation-b1.m_rotation-this.m_initialAngle;angularC=b2Math.b2Clamp(angularC,-b2Settings.b2_maxAngularCorrection,b2Settings.b2_maxAngularCorrection);var angularImpulse=-this.m_angularMass*angularC;b1.m_rotation-=b1.m_invI*angularImpulse;b1.m_R.Set(b1.m_rotation);b2.m_rotation+=b2.m_invI*angularImpulse;b2.m_R.Set(b2.m_rotation);var angularError=b2Math.b2Abs(angularC);if(this.m_enableLimit&&this.m_limitState!=b2Joint.e_inactiveLimit){tMat=b1.m_R;r1X=tMat.col1.x*this.m_localAnchor1.x+tMat.col2.x*this.m_localAnchor1.y;r1Y=tMat.col1.y*this.m_localAnchor1.x+tMat.col2.y*this.m_localAnchor1.y;tMat=b2.m_R;r2X=tMat.col1.x*this.m_localAnchor2.x+tMat.col2.x*this.m_localAnchor2.y;r2Y=tMat.col1.y*this.m_localAnchor2.x+tMat.col2.y*this.m_localAnchor2.y;p1X=b1.m_position.x+r1X;p1Y=b1.m_position.y+r1Y;p2X=b2.m_position.x+r2X;p2Y=b2.m_position.y+r2Y;dX=p2X-p1X;dY=p2Y-p1Y;tMat=b1.m_R;var ax1X=tMat.col1.x*this.m_localXAxis1.x+tMat.col2.x*this.m_localXAxis1.y;var ax1Y=tMat.col1.y*this.m_localXAxis1.x+tMat.col2.y*this.m_localXAxis1.y;var translation=ax1X*dX+ax1Y*dY;var limitImpulse=0;if(this.m_limitState==b2Joint.e_equalLimits){limitC=b2Math.b2Clamp(translation,-b2Settings.b2_maxLinearCorrection,b2Settings.b2_maxLinearCorrection);limitImpulse=-this.m_motorMass*limitC;positionError=b2Math.b2Max(positionError,b2Math.b2Abs(angularC))}else if(this.m_limitState==b2Joint.e_atLowerLimit){limitC=translation-this.m_lowerTranslation;positionError=b2Math.b2Max(positionError,-limitC);limitC=b2Math.b2Clamp(limitC+b2Settings.b2_linearSlop,-b2Settings.b2_maxLinearCorrection,0);limitImpulse=-this.m_motorMass*limitC;oldLimitImpulse=this.m_limitPositionImpulse;this.m_limitPositionImpulse=b2Math.b2Max(this.m_limitPositionImpulse+limitImpulse,0);limitImpulse=this.m_limitPositionImpulse-oldLimitImpulse}else if(this.m_limitState==b2Joint.e_atUpperLimit){limitC=translation-this.m_upperTranslation;positionError=b2Math.b2Max(positionError,limitC);limitC=b2Math.b2Clamp(limitC-b2Settings.b2_linearSlop,0,b2Settings.b2_maxLinearCorrection);limitImpulse=-this.m_motorMass*limitC;oldLimitImpulse=this.m_limitPositionImpulse;this.m_limitPositionImpulse=b2Math.b2Min(this.m_limitPositionImpulse+limitImpulse,0);limitImpulse=this.m_limitPositionImpulse-oldLimitImpulse}b1.m_position.x+=invMass1*limitImpulse*this.m_motorJacobian.linear1.x;b1.m_position.y+=invMass1*limitImpulse*this.m_motorJacobian.linear1.y;b1.m_rotation+=invI1*limitImpulse*this.m_motorJacobian.angular1;b1.m_R.Set(b1.m_rotation);b2.m_position.x+=invMass2*limitImpulse*this.m_motorJacobian.linear2.x;b2.m_position.y+=invMass2*limitImpulse*this.m_motorJacobian.linear2.y;b2.m_rotation+=invI2*limitImpulse*this.m_motorJacobian.angular2;b2.m_R.Set(b2.m_rotation)}return positionError<=b2Settings.b2_linearSlop&&angularError<=b2Settings.b2_angularSlop},m_localAnchor1:new b2Vec2,m_localAnchor2:new b2Vec2,m_localXAxis1:new b2Vec2,m_localYAxis1:new b2Vec2,m_initialAngle:null,m_linearJacobian:new b2Jacobian,m_linearMass:null,m_linearImpulse:null,m_angularMass:null,m_angularImpulse:null,m_motorJacobian:new b2Jacobian,m_motorMass:null,m_motorImpulse:null,m_limitImpulse:null,m_limitPositionImpulse:null,m_lowerTranslation:null,m_upperTranslation:null,m_maxMotorForce:null,m_motorSpeed:null,m_enableLimit:null,m_enableMotor:null,m_limitState:0});var b2PrismaticJointDef=Class.create();Object.extend(b2PrismaticJointDef.prototype,b2JointDef.prototype);Object.extend(b2PrismaticJointDef.prototype,{initialize:function(){this.type=b2Joint.e_unknownJoint;this.userData=null;this.body1=null;this.body2=null;this.collideConnected=false;this.type=b2Joint.e_prismaticJoint;this.anchorPoint=new b2Vec2(0,0);this.axis=new b2Vec2(0,0);this.lowerTranslation=0;this.upperTranslation=0;this.motorForce=0;this.motorSpeed=0;this.enableLimit=false;this.enableMotor=false},anchorPoint:null,axis:null,lowerTranslation:null,upperTranslation:null,motorForce:null,motorSpeed:null,enableLimit:null,enableMotor:null});var b2PulleyJoint=Class.create();Object.extend(b2PulleyJoint.prototype,b2Joint.prototype);Object.extend(b2PulleyJoint.prototype,{GetAnchor1:function(){var tMat=this.m_body1.m_R;return new b2Vec2(this.m_body1.m_position.x+(tMat.col1.x*this.m_localAnchor1.x+tMat.col2.x*this.m_localAnchor1.y),this.m_body1.m_position.y+(tMat.col1.y*this.m_localAnchor1.x+tMat.col2.y*this.m_localAnchor1.y))},GetAnchor2:function(){var tMat=this.m_body2.m_R;return new b2Vec2(this.m_body2.m_position.x+(tMat.col1.x*this.m_localAnchor2.x+tMat.col2.x*this.m_localAnchor2.y),this.m_body2.m_position.y+(tMat.col1.y*this.m_localAnchor2.x+tMat.col2.y*this.m_localAnchor2.y))},GetGroundPoint1:function(){return new b2Vec2(this.m_ground.m_position.x+this.m_groundAnchor1.x,this.m_ground.m_position.y+this.m_groundAnchor1.y)},GetGroundPoint2:function(){return new b2Vec2(this.m_ground.m_position.x+this.m_groundAnchor2.x,this.m_ground.m_position.y+this.m_groundAnchor2.y)},GetReactionForce:function(invTimeStep){return new b2Vec2},GetReactionTorque:function(invTimeStep){return 0},GetLength1:function(){var tMat;tMat=this.m_body1.m_R;var pX=this.m_body1.m_position.x+(tMat.col1.x*this.m_localAnchor1.x+tMat.col2.x*this.m_localAnchor1.y);var pY=this.m_body1.m_position.y+(tMat.col1.y*this.m_localAnchor1.x+tMat.col2.y*this.m_localAnchor1.y);var dX=pX-(this.m_ground.m_position.x+this.m_groundAnchor1.x);var dY=pY-(this.m_ground.m_position.y+this.m_groundAnchor1.y);return Math.sqrt(dX*dX+dY*dY)},GetLength2:function(){var tMat;tMat=this.m_body2.m_R;var pX=this.m_body2.m_position.x+(tMat.col1.x*this.m_localAnchor2.x+tMat.col2.x*this.m_localAnchor2.y);var pY=this.m_body2.m_position.y+(tMat.col1.y*this.m_localAnchor2.x+tMat.col2.y*this.m_localAnchor2.y);var dX=pX-(this.m_ground.m_position.x+this.m_groundAnchor2.x);var dY=pY-(this.m_ground.m_position.y+this.m_groundAnchor2.y);return Math.sqrt(dX*dX+dY*dY)},GetRatio:function(){return this.m_ratio},initialize:function(def){this.m_node1=new b2JointNode;this.m_node2=new b2JointNode;this.m_type=def.type;this.m_prev=null;this.m_next=null;this.m_body1=def.body1;this.m_body2=def.body2;this.m_collideConnected=def.collideConnected;this.m_islandFlag=false;this.m_userData=def.userData;this.m_groundAnchor1=new b2Vec2;this.m_groundAnchor2=new b2Vec2;this.m_localAnchor1=new b2Vec2;this.m_localAnchor2=new b2Vec2;this.m_u1=new b2Vec2;this.m_u2=new b2Vec2;var tMat;var tX;var tY;this.m_ground=this.m_body1.m_world.m_groundBody;this.m_groundAnchor1.x=def.groundPoint1.x-this.m_ground.m_position.x;this.m_groundAnchor1.y=def.groundPoint1.y-this.m_ground.m_position.y;this.m_groundAnchor2.x=def.groundPoint2.x-this.m_ground.m_position.x;this.m_groundAnchor2.y=def.groundPoint2.y-this.m_ground.m_position.y;tMat=this.m_body1.m_R;tX=def.anchorPoint1.x-this.m_body1.m_position.x;tY=def.anchorPoint1.y-this.m_body1.m_position.y;this.m_localAnchor1.x=tX*tMat.col1.x+tY*tMat.col1.y;this.m_localAnchor1.y=tX*tMat.col2.x+tY*tMat.col2.y;tMat=this.m_body2.m_R;tX=def.anchorPoint2.x-this.m_body2.m_position.x;tY=def.anchorPoint2.y-this.m_body2.m_position.y;this.m_localAnchor2.x=tX*tMat.col1.x+tY*tMat.col1.y;this.m_localAnchor2.y=tX*tMat.col2.x+tY*tMat.col2.y;this.m_ratio=def.ratio;tX=def.groundPoint1.x-def.anchorPoint1.x;tY=def.groundPoint1.y-def.anchorPoint1.y;var d1Len=Math.sqrt(tX*tX+tY*tY);tX=def.groundPoint2.x-def.anchorPoint2.x;tY=def.groundPoint2.y-def.anchorPoint2.y;var d2Len=Math.sqrt(tX*tX+tY*tY);var length1=b2Math.b2Max(.5*b2PulleyJoint.b2_minPulleyLength,d1Len);var length2=b2Math.b2Max(.5*b2PulleyJoint.b2_minPulleyLength,d2Len);this.m_constant=length1+this.m_ratio*length2;this.m_maxLength1=b2Math.b2Clamp(def.maxLength1,length1,this.m_constant-this.m_ratio*b2PulleyJoint.b2_minPulleyLength);this.m_maxLength2=b2Math.b2Clamp(def.maxLength2,length2,(this.m_constant-b2PulleyJoint.b2_minPulleyLength)/this.m_ratio);this.m_pulleyImpulse=0;this.m_limitImpulse1=0;this.m_limitImpulse2=0},PrepareVelocitySolver:function(){var b1=this.m_body1;var b2=this.m_body2;var tMat;tMat=b1.m_R;var r1X=tMat.col1.x*this.m_localAnchor1.x+tMat.col2.x*this.m_localAnchor1.y;var r1Y=tMat.col1.y*this.m_localAnchor1.x+tMat.col2.y*this.m_localAnchor1.y;tMat=b2.m_R;var r2X=tMat.col1.x*this.m_localAnchor2.x+tMat.col2.x*this.m_localAnchor2.y;var r2Y=tMat.col1.y*this.m_localAnchor2.x+tMat.col2.y*this.m_localAnchor2.y;var p1X=b1.m_position.x+r1X;var p1Y=b1.m_position.y+r1Y;var p2X=b2.m_position.x+r2X;var p2Y=b2.m_position.y+r2Y;var s1X=this.m_ground.m_position.x+this.m_groundAnchor1.x;var s1Y=this.m_ground.m_position.y+this.m_groundAnchor1.y;var s2X=this.m_ground.m_position.x+this.m_groundAnchor2.x;var s2Y=this.m_ground.m_position.y+this.m_groundAnchor2.y;this.m_u1.Set(p1X-s1X,p1Y-s1Y);this.m_u2.Set(p2X-s2X,p2Y-s2Y);var length1=this.m_u1.Length();var length2=this.m_u2.Length();if(length1>b2Settings.b2_linearSlop){this.m_u1.Multiply(1/length1)}else{this.m_u1.SetZero()}if(length2>b2Settings.b2_linearSlop){this.m_u2.Multiply(1/length2)}else{this.m_u2.SetZero()}if(length1<this.m_maxLength1){this.m_limitState1=b2Joint.e_inactiveLimit;this.m_limitImpulse1=0}else{this.m_limitState1=b2Joint.e_atUpperLimit;this.m_limitPositionImpulse1=0}if(length2<this.m_maxLength2){this.m_limitState2=b2Joint.e_inactiveLimit;this.m_limitImpulse2=0}else{this.m_limitState2=b2Joint.e_atUpperLimit;this.m_limitPositionImpulse2=0}var cr1u1=r1X*this.m_u1.y-r1Y*this.m_u1.x;var cr2u2=r2X*this.m_u2.y-r2Y*this.m_u2.x;this.m_limitMass1=b1.m_invMass+b1.m_invI*cr1u1*cr1u1;this.m_limitMass2=b2.m_invMass+b2.m_invI*cr2u2*cr2u2;this.m_pulleyMass=this.m_limitMass1+this.m_ratio*this.m_ratio*this.m_limitMass2;this.m_limitMass1=1/this.m_limitMass1;this.m_limitMass2=1/this.m_limitMass2;this.m_pulleyMass=1/this.m_pulleyMass;var P1X=(-this.m_pulleyImpulse-this.m_limitImpulse1)*this.m_u1.x;var P1Y=(-this.m_pulleyImpulse-this.m_limitImpulse1)*this.m_u1.y;var P2X=(-this.m_ratio*this.m_pulleyImpulse-this.m_limitImpulse2)*this.m_u2.x;var P2Y=(-this.m_ratio*this.m_pulleyImpulse-this.m_limitImpulse2)*this.m_u2.y;b1.m_linearVelocity.x+=b1.m_invMass*P1X;b1.m_linearVelocity.y+=b1.m_invMass*P1Y;b1.m_angularVelocity+=b1.m_invI*(r1X*P1Y-r1Y*P1X);b2.m_linearVelocity.x+=b2.m_invMass*P2X;b2.m_linearVelocity.y+=b2.m_invMass*P2Y;b2.m_angularVelocity+=b2.m_invI*(r2X*P2Y-r2Y*P2X)},SolveVelocityConstraints:function(step){var b1=this.m_body1;var b2=this.m_body2;var tMat;tMat=b1.m_R;var r1X=tMat.col1.x*this.m_localAnchor1.x+tMat.col2.x*this.m_localAnchor1.y;var r1Y=tMat.col1.y*this.m_localAnchor1.x+tMat.col2.y*this.m_localAnchor1.y;tMat=b2.m_R;var r2X=tMat.col1.x*this.m_localAnchor2.x+tMat.col2.x*this.m_localAnchor2.y;var r2Y=tMat.col1.y*this.m_localAnchor2.x+tMat.col2.y*this.m_localAnchor2.y;var v1X;var v1Y;var v2X;var v2Y;var P1X;var P1Y;var P2X;var P2Y;var Cdot;var impulse;var oldLimitImpulse;v1X=b1.m_linearVelocity.x+-b1.m_angularVelocity*r1Y;v1Y=b1.m_linearVelocity.y+b1.m_angularVelocity*r1X;v2X=b2.m_linearVelocity.x+-b2.m_angularVelocity*r2Y;v2Y=b2.m_linearVelocity.y+b2.m_angularVelocity*r2X;Cdot=-(this.m_u1.x*v1X+this.m_u1.y*v1Y)-this.m_ratio*(this.m_u2.x*v2X+this.m_u2.y*v2Y);impulse=-this.m_pulleyMass*Cdot;this.m_pulleyImpulse+=impulse;P1X=-impulse*this.m_u1.x;P1Y=-impulse*this.m_u1.y;P2X=-this.m_ratio*impulse*this.m_u2.x;P2Y=-this.m_ratio*impulse*this.m_u2.y;b1.m_linearVelocity.x+=b1.m_invMass*P1X;b1.m_linearVelocity.y+=b1.m_invMass*P1Y;b1.m_angularVelocity+=b1.m_invI*(r1X*P1Y-r1Y*P1X);b2.m_linearVelocity.x+=b2.m_invMass*P2X;b2.m_linearVelocity.y+=b2.m_invMass*P2Y;b2.m_angularVelocity+=b2.m_invI*(r2X*P2Y-r2Y*P2X);if(this.m_limitState1==b2Joint.e_atUpperLimit){v1X=b1.m_linearVelocity.x+-b1.m_angularVelocity*r1Y;v1Y=b1.m_linearVelocity.y+b1.m_angularVelocity*r1X;Cdot=-(this.m_u1.x*v1X+this.m_u1.y*v1Y);impulse=-this.m_limitMass1*Cdot;oldLimitImpulse=this.m_limitImpulse1;this.m_limitImpulse1=b2Math.b2Max(0,this.m_limitImpulse1+impulse);impulse=this.m_limitImpulse1-oldLimitImpulse;P1X=-impulse*this.m_u1.x;P1Y=-impulse*this.m_u1.y;b1.m_linearVelocity.x+=b1.m_invMass*P1X;b1.m_linearVelocity.y+=b1.m_invMass*P1Y;b1.m_angularVelocity+=b1.m_invI*(r1X*P1Y-r1Y*P1X)}if(this.m_limitState2==b2Joint.e_atUpperLimit){v2X=b2.m_linearVelocity.x+-b2.m_angularVelocity*r2Y;v2Y=b2.m_linearVelocity.y+b2.m_angularVelocity*r2X;Cdot=-(this.m_u2.x*v2X+this.m_u2.y*v2Y);impulse=-this.m_limitMass2*Cdot;oldLimitImpulse=this.m_limitImpulse2;this.m_limitImpulse2=b2Math.b2Max(0,this.m_limitImpulse2+impulse);impulse=this.m_limitImpulse2-oldLimitImpulse;P2X=-impulse*this.m_u2.x;P2Y=-impulse*this.m_u2.y;b2.m_linearVelocity.x+=b2.m_invMass*P2X;b2.m_linearVelocity.y+=b2.m_invMass*P2Y;b2.m_angularVelocity+=b2.m_invI*(r2X*P2Y-r2Y*P2X)}},SolvePositionConstraints:function(){var b1=this.m_body1;var b2=this.m_body2;var tMat;var s1X=this.m_ground.m_position.x+this.m_groundAnchor1.x;var s1Y=this.m_ground.m_position.y+this.m_groundAnchor1.y;var s2X=this.m_ground.m_position.x+this.m_groundAnchor2.x;var s2Y=this.m_ground.m_position.y+this.m_groundAnchor2.y;var r1X;var r1Y;var r2X;var r2Y;var p1X;var p1Y;var p2X;var p2Y;var length1;var length2;var C;var impulse;var oldLimitPositionImpulse;var linearError=0;{tMat=b1.m_R;r1X=tMat.col1.x*this.m_localAnchor1.x+tMat.col2.x*this.m_localAnchor1.y;r1Y=tMat.col1.y*this.m_localAnchor1.x+tMat.col2.y*this.m_localAnchor1.y;tMat=b2.m_R;r2X=tMat.col1.x*this.m_localAnchor2.x+tMat.col2.x*this.m_localAnchor2.y;r2Y=tMat.col1.y*this.m_localAnchor2.x+tMat.col2.y*this.m_localAnchor2.y;p1X=b1.m_position.x+r1X;p1Y=b1.m_position.y+r1Y;p2X=b2.m_position.x+r2X;p2Y=b2.m_position.y+r2Y;this.m_u1.Set(p1X-s1X,p1Y-s1Y);this.m_u2.Set(p2X-s2X,p2Y-s2Y);length1=this.m_u1.Length();length2=this.m_u2.Length();if(length1>b2Settings.b2_linearSlop){this.m_u1.Multiply(1/length1)}else{this.m_u1.SetZero()}if(length2>b2Settings.b2_linearSlop){this.m_u2.Multiply(1/length2)}else{this.m_u2.SetZero()}C=this.m_constant-length1-this.m_ratio*length2;linearError=b2Math.b2Max(linearError,Math.abs(C));C=b2Math.b2Clamp(C,-b2Settings.b2_maxLinearCorrection,b2Settings.b2_maxLinearCorrection);impulse=-this.m_pulleyMass*C;p1X=-impulse*this.m_u1.x;p1Y=-impulse*this.m_u1.y;p2X=-this.m_ratio*impulse*this.m_u2.x;p2Y=-this.m_ratio*impulse*this.m_u2.y;b1.m_position.x+=b1.m_invMass*p1X;b1.m_position.y+=b1.m_invMass*p1Y;b1.m_rotation+=b1.m_invI*(r1X*p1Y-r1Y*p1X);b2.m_position.x+=b2.m_invMass*p2X;b2.m_position.y+=b2.m_invMass*p2Y;b2.m_rotation+=b2.m_invI*(r2X*p2Y-r2Y*p2X);b1.m_R.Set(b1.m_rotation);b2.m_R.Set(b2.m_rotation)}if(this.m_limitState1==b2Joint.e_atUpperLimit){tMat=b1.m_R;r1X=tMat.col1.x*this.m_localAnchor1.x+tMat.col2.x*this.m_localAnchor1.y;r1Y=tMat.col1.y*this.m_localAnchor1.x+tMat.col2.y*this.m_localAnchor1.y;p1X=b1.m_position.x+r1X;p1Y=b1.m_position.y+r1Y;this.m_u1.Set(p1X-s1X,p1Y-s1Y);length1=this.m_u1.Length();if(length1>b2Settings.b2_linearSlop){this.m_u1.x*=1/length1;this.m_u1.y*=1/length1}else{this.m_u1.SetZero()}C=this.m_maxLength1-length1;linearError=b2Math.b2Max(linearError,-C);C=b2Math.b2Clamp(C+b2Settings.b2_linearSlop,-b2Settings.b2_maxLinearCorrection,0);impulse=-this.m_limitMass1*C;oldLimitPositionImpulse=this.m_limitPositionImpulse1;this.m_limitPositionImpulse1=b2Math.b2Max(0,this.m_limitPositionImpulse1+impulse);impulse=this.m_limitPositionImpulse1-oldLimitPositionImpulse;p1X=-impulse*this.m_u1.x;p1Y=-impulse*this.m_u1.y;b1.m_position.x+=b1.m_invMass*p1X;b1.m_position.y+=b1.m_invMass*p1Y;b1.m_rotation+=b1.m_invI*(r1X*p1Y-r1Y*p1X);b1.m_R.Set(b1.m_rotation)}if(this.m_limitState2==b2Joint.e_atUpperLimit){tMat=b2.m_R;r2X=tMat.col1.x*this.m_localAnchor2.x+tMat.col2.x*this.m_localAnchor2.y;r2Y=tMat.col1.y*this.m_localAnchor2.x+tMat.col2.y*this.m_localAnchor2.y;p2X=b2.m_position.x+r2X;p2Y=b2.m_position.y+r2Y;this.m_u2.Set(p2X-s2X,p2Y-s2Y);length2=this.m_u2.Length();if(length2>b2Settings.b2_linearSlop){this.m_u2.x*=1/length2;this.m_u2.y*=1/length2}else{this.m_u2.SetZero()}C=this.m_maxLength2-length2;linearError=b2Math.b2Max(linearError,-C);C=b2Math.b2Clamp(C+b2Settings.b2_linearSlop,-b2Settings.b2_maxLinearCorrection,0);impulse=-this.m_limitMass2*C;oldLimitPositionImpulse=this.m_limitPositionImpulse2;this.m_limitPositionImpulse2=b2Math.b2Max(0,this.m_limitPositionImpulse2+impulse);impulse=this.m_limitPositionImpulse2-oldLimitPositionImpulse;p2X=-impulse*this.m_u2.x;p2Y=-impulse*this.m_u2.y;b2.m_position.x+=b2.m_invMass*p2X;b2.m_position.y+=b2.m_invMass*p2Y;b2.m_rotation+=b2.m_invI*(r2X*p2Y-r2Y*p2X);b2.m_R.Set(b2.m_rotation)}return linearError<b2Settings.b2_linearSlop},m_ground:null,m_groundAnchor1:new b2Vec2,m_groundAnchor2:new b2Vec2,m_localAnchor1:new b2Vec2,m_localAnchor2:new b2Vec2,m_u1:new b2Vec2,m_u2:new b2Vec2,m_constant:null,m_ratio:null,m_maxLength1:null,m_maxLength2:null,m_pulleyMass:null,m_limitMass1:null,m_limitMass2:null,m_pulleyImpulse:null,m_limitImpulse1:null,m_limitImpulse2:null,m_limitPositionImpulse1:null,m_limitPositionImpulse2:null,m_limitState1:0,m_limitState2:0});b2PulleyJoint.b2_minPulleyLength=b2Settings.b2_lengthUnitsPerMeter;var b2PulleyJointDef=Class.create();Object.extend(b2PulleyJointDef.prototype,b2JointDef.prototype);Object.extend(b2PulleyJointDef.prototype,{initialize:function(){this.type=b2Joint.e_unknownJoint;this.userData=null;this.body1=null;this.body2=null;this.collideConnected=false;this.groundPoint1=new b2Vec2;this.groundPoint2=new b2Vec2;this.anchorPoint1=new b2Vec2;this.anchorPoint2=new b2Vec2;this.type=b2Joint.e_pulleyJoint;this.groundPoint1.Set(-1,1);this.groundPoint2.Set(1,1);this.anchorPoint1.Set(-1,0);this.anchorPoint2.Set(1,0);this.maxLength1=.5*b2PulleyJoint.b2_minPulleyLength;this.maxLength2=.5*b2PulleyJoint.b2_minPulleyLength;this.ratio=1;this.collideConnected=true},groundPoint1:new b2Vec2,groundPoint2:new b2Vec2,anchorPoint1:new b2Vec2,anchorPoint2:new b2Vec2,maxLength1:null,maxLength2:null,ratio:null});var b2RevoluteJoint=Class.create();Object.extend(b2RevoluteJoint.prototype,b2Joint.prototype);Object.extend(b2RevoluteJoint.prototype,{GetAnchor1:function(){var tMat=this.m_body1.m_R;return new b2Vec2(this.m_body1.m_position.x+(tMat.col1.x*this.m_localAnchor1.x+tMat.col2.x*this.m_localAnchor1.y),this.m_body1.m_position.y+(tMat.col1.y*this.m_localAnchor1.x+tMat.col2.y*this.m_localAnchor1.y))},GetAnchor2:function(){var tMat=this.m_body2.m_R;return new b2Vec2(this.m_body2.m_position.x+(tMat.col1.x*this.m_localAnchor2.x+tMat.col2.x*this.m_localAnchor2.y),this.m_body2.m_position.y+(tMat.col1.y*this.m_localAnchor2.x+tMat.col2.y*this.m_localAnchor2.y))},GetJointAngle:function(){return this.m_body2.m_rotation-this.m_body1.m_rotation},GetJointSpeed:function(){return this.m_body2.m_angularVelocity-this.m_body1.m_angularVelocity},GetMotorTorque:function(invTimeStep){return invTimeStep*this.m_motorImpulse},SetMotorSpeed:function(speed){this.m_motorSpeed=speed},SetMotorTorque:function(torque){this.m_maxMotorTorque=torque},GetReactionForce:function(invTimeStep){var tVec=this.m_ptpImpulse.Copy();tVec.Multiply(invTimeStep);return tVec},GetReactionTorque:function(invTimeStep){return invTimeStep*this.m_limitImpulse},initialize:function(def){this.m_node1=new b2JointNode;this.m_node2=new b2JointNode;this.m_type=def.type;this.m_prev=null;this.m_next=null;this.m_body1=def.body1;this.m_body2=def.body2;this.m_collideConnected=def.collideConnected;this.m_islandFlag=false;this.m_userData=def.userData;this.K=new b2Mat22;this.K1=new b2Mat22;this.K2=new b2Mat22;this.K3=new b2Mat22;this.m_localAnchor1=new b2Vec2;this.m_localAnchor2=new b2Vec2;this.m_ptpImpulse=new b2Vec2;this.m_ptpMass=new b2Mat22;var tMat;var tX;var tY;tMat=this.m_body1.m_R;tX=def.anchorPoint.x-this.m_body1.m_position.x;tY=def.anchorPoint.y-this.m_body1.m_position.y;this.m_localAnchor1.x=tX*tMat.col1.x+tY*tMat.col1.y;this.m_localAnchor1.y=tX*tMat.col2.x+tY*tMat.col2.y;tMat=this.m_body2.m_R;tX=def.anchorPoint.x-this.m_body2.m_position.x;tY=def.anchorPoint.y-this.m_body2.m_position.y;this.m_localAnchor2.x=tX*tMat.col1.x+tY*tMat.col1.y;this.m_localAnchor2.y=tX*tMat.col2.x+tY*tMat.col2.y;this.m_intialAngle=this.m_body2.m_rotation-this.m_body1.m_rotation;this.m_ptpImpulse.Set(0,0);this.m_motorImpulse=0;this.m_limitImpulse=0;this.m_limitPositionImpulse=0;this.m_lowerAngle=def.lowerAngle;this.m_upperAngle=def.upperAngle;this.m_maxMotorTorque=def.motorTorque;this.m_motorSpeed=def.motorSpeed;this.m_enableLimit=def.enableLimit;this.m_enableMotor=def.enableMotor},K:new b2Mat22,K1:new b2Mat22,K2:new b2Mat22,K3:new b2Mat22,PrepareVelocitySolver:function(){var b1=this.m_body1;var b2=this.m_body2;var tMat;tMat=b1.m_R;var r1X=tMat.col1.x*this.m_localAnchor1.x+tMat.col2.x*this.m_localAnchor1.y;var r1Y=tMat.col1.y*this.m_localAnchor1.x+tMat.col2.y*this.m_localAnchor1.y;tMat=b2.m_R;var r2X=tMat.col1.x*this.m_localAnchor2.x+tMat.col2.x*this.m_localAnchor2.y;var r2Y=tMat.col1.y*this.m_localAnchor2.x+tMat.col2.y*this.m_localAnchor2.y;var invMass1=b1.m_invMass;var invMass2=b2.m_invMass;var invI1=b1.m_invI;var invI2=b2.m_invI;this.K1.col1.x=invMass1+invMass2;this.K1.col2.x=0;this.K1.col1.y=0;this.K1.col2.y=invMass1+invMass2;this.K2.col1.x=invI1*r1Y*r1Y;this.K2.col2.x=-invI1*r1X*r1Y;this.K2.col1.y=-invI1*r1X*r1Y;this.K2.col2.y=invI1*r1X*r1X;this.K3.col1.x=invI2*r2Y*r2Y;this.K3.col2.x=-invI2*r2X*r2Y;this.K3.col1.y=-invI2*r2X*r2Y;this.K3.col2.y=invI2*r2X*r2X;this.K.SetM(this.K1);this.K.AddM(this.K2);this.K.AddM(this.K3);this.K.Invert(this.m_ptpMass);this.m_motorMass=1/(invI1+invI2);if(this.m_enableMotor==false){this.m_motorImpulse=0}if(this.m_enableLimit){var jointAngle=b2.m_rotation-b1.m_rotation-this.m_intialAngle;if(b2Math.b2Abs(this.m_upperAngle-this.m_lowerAngle)<2*b2Settings.b2_angularSlop){this.m_limitState=b2Joint.e_equalLimits}else if(jointAngle<=this.m_lowerAngle){if(this.m_limitState!=b2Joint.e_atLowerLimit){this.m_limitImpulse=0}this.m_limitState=b2Joint.e_atLowerLimit}else if(jointAngle>=this.m_upperAngle){if(this.m_limitState!=b2Joint.e_atUpperLimit){this.m_limitImpulse=0}this.m_limitState=b2Joint.e_atUpperLimit}else{this.m_limitState=b2Joint.e_inactiveLimit;this.m_limitImpulse=0}}else{this.m_limitImpulse=0}if(b2World.s_enableWarmStarting){b1.m_linearVelocity.x-=invMass1*this.m_ptpImpulse.x;b1.m_linearVelocity.y-=invMass1*this.m_ptpImpulse.y;b1.m_angularVelocity-=invI1*(r1X*this.m_ptpImpulse.y-r1Y*this.m_ptpImpulse.x+this.m_motorImpulse+this.m_limitImpulse);b2.m_linearVelocity.x+=invMass2*this.m_ptpImpulse.x;b2.m_linearVelocity.y+=invMass2*this.m_ptpImpulse.y;b2.m_angularVelocity+=invI2*(r2X*this.m_ptpImpulse.y-r2Y*this.m_ptpImpulse.x+this.m_motorImpulse+this.m_limitImpulse)}else{this.m_ptpImpulse.SetZero();this.m_motorImpulse=0;this.m_limitImpulse=0}this.m_limitPositionImpulse=0},SolveVelocityConstraints:function(step){var b1=this.m_body1;var b2=this.m_body2;var tMat;tMat=b1.m_R;var r1X=tMat.col1.x*this.m_localAnchor1.x+tMat.col2.x*this.m_localAnchor1.y;var r1Y=tMat.col1.y*this.m_localAnchor1.x+tMat.col2.y*this.m_localAnchor1.y;tMat=b2.m_R;var r2X=tMat.col1.x*this.m_localAnchor2.x+tMat.col2.x*this.m_localAnchor2.y;var r2Y=tMat.col1.y*this.m_localAnchor2.x+tMat.col2.y*this.m_localAnchor2.y;var oldLimitImpulse;var ptpCdotX=b2.m_linearVelocity.x+-b2.m_angularVelocity*r2Y-b1.m_linearVelocity.x- -b1.m_angularVelocity*r1Y;var ptpCdotY=b2.m_linearVelocity.y+b2.m_angularVelocity*r2X-b1.m_linearVelocity.y-b1.m_angularVelocity*r1X;var ptpImpulseX=-(this.m_ptpMass.col1.x*ptpCdotX+this.m_ptpMass.col2.x*ptpCdotY);var ptpImpulseY=-(this.m_ptpMass.col1.y*ptpCdotX+this.m_ptpMass.col2.y*ptpCdotY);this.m_ptpImpulse.x+=ptpImpulseX;this.m_ptpImpulse.y+=ptpImpulseY;b1.m_linearVelocity.x-=b1.m_invMass*ptpImpulseX;b1.m_linearVelocity.y-=b1.m_invMass*ptpImpulseY;b1.m_angularVelocity-=b1.m_invI*(r1X*ptpImpulseY-r1Y*ptpImpulseX);b2.m_linearVelocity.x+=b2.m_invMass*ptpImpulseX;b2.m_linearVelocity.y+=b2.m_invMass*ptpImpulseY;b2.m_angularVelocity+=b2.m_invI*(r2X*ptpImpulseY-r2Y*ptpImpulseX);if(this.m_enableMotor&&this.m_limitState!=b2Joint.e_equalLimits){var motorCdot=b2.m_angularVelocity-b1.m_angularVelocity-this.m_motorSpeed;var motorImpulse=-this.m_motorMass*motorCdot;var oldMotorImpulse=this.m_motorImpulse;this.m_motorImpulse=b2Math.b2Clamp(this.m_motorImpulse+motorImpulse,-step.dt*this.m_maxMotorTorque,step.dt*this.m_maxMotorTorque);motorImpulse=this.m_motorImpulse-oldMotorImpulse;b1.m_angularVelocity-=b1.m_invI*motorImpulse;b2.m_angularVelocity+=b2.m_invI*motorImpulse}if(this.m_enableLimit&&this.m_limitState!=b2Joint.e_inactiveLimit){var limitCdot=b2.m_angularVelocity-b1.m_angularVelocity;var limitImpulse=-this.m_motorMass*limitCdot;if(this.m_limitState==b2Joint.e_equalLimits){this.m_limitImpulse+=limitImpulse
}else if(this.m_limitState==b2Joint.e_atLowerLimit){oldLimitImpulse=this.m_limitImpulse;this.m_limitImpulse=b2Math.b2Max(this.m_limitImpulse+limitImpulse,0);limitImpulse=this.m_limitImpulse-oldLimitImpulse}else if(this.m_limitState==b2Joint.e_atUpperLimit){oldLimitImpulse=this.m_limitImpulse;this.m_limitImpulse=b2Math.b2Min(this.m_limitImpulse+limitImpulse,0);limitImpulse=this.m_limitImpulse-oldLimitImpulse}b1.m_angularVelocity-=b1.m_invI*limitImpulse;b2.m_angularVelocity+=b2.m_invI*limitImpulse}},SolvePositionConstraints:function(){var oldLimitImpulse;var limitC;var b1=this.m_body1;var b2=this.m_body2;var positionError=0;var tMat;tMat=b1.m_R;var r1X=tMat.col1.x*this.m_localAnchor1.x+tMat.col2.x*this.m_localAnchor1.y;var r1Y=tMat.col1.y*this.m_localAnchor1.x+tMat.col2.y*this.m_localAnchor1.y;tMat=b2.m_R;var r2X=tMat.col1.x*this.m_localAnchor2.x+tMat.col2.x*this.m_localAnchor2.y;var r2Y=tMat.col1.y*this.m_localAnchor2.x+tMat.col2.y*this.m_localAnchor2.y;var p1X=b1.m_position.x+r1X;var p1Y=b1.m_position.y+r1Y;var p2X=b2.m_position.x+r2X;var p2Y=b2.m_position.y+r2Y;var ptpCX=p2X-p1X;var ptpCY=p2Y-p1Y;positionError=Math.sqrt(ptpCX*ptpCX+ptpCY*ptpCY);var invMass1=b1.m_invMass;var invMass2=b2.m_invMass;var invI1=b1.m_invI;var invI2=b2.m_invI;this.K1.col1.x=invMass1+invMass2;this.K1.col2.x=0;this.K1.col1.y=0;this.K1.col2.y=invMass1+invMass2;this.K2.col1.x=invI1*r1Y*r1Y;this.K2.col2.x=-invI1*r1X*r1Y;this.K2.col1.y=-invI1*r1X*r1Y;this.K2.col2.y=invI1*r1X*r1X;this.K3.col1.x=invI2*r2Y*r2Y;this.K3.col2.x=-invI2*r2X*r2Y;this.K3.col1.y=-invI2*r2X*r2Y;this.K3.col2.y=invI2*r2X*r2X;this.K.SetM(this.K1);this.K.AddM(this.K2);this.K.AddM(this.K3);this.K.Solve(b2RevoluteJoint.tImpulse,-ptpCX,-ptpCY);var impulseX=b2RevoluteJoint.tImpulse.x;var impulseY=b2RevoluteJoint.tImpulse.y;b1.m_position.x-=b1.m_invMass*impulseX;b1.m_position.y-=b1.m_invMass*impulseY;b1.m_rotation-=b1.m_invI*(r1X*impulseY-r1Y*impulseX);b1.m_R.Set(b1.m_rotation);b2.m_position.x+=b2.m_invMass*impulseX;b2.m_position.y+=b2.m_invMass*impulseY;b2.m_rotation+=b2.m_invI*(r2X*impulseY-r2Y*impulseX);b2.m_R.Set(b2.m_rotation);var angularError=0;if(this.m_enableLimit&&this.m_limitState!=b2Joint.e_inactiveLimit){var angle=b2.m_rotation-b1.m_rotation-this.m_intialAngle;var limitImpulse=0;if(this.m_limitState==b2Joint.e_equalLimits){limitC=b2Math.b2Clamp(angle,-b2Settings.b2_maxAngularCorrection,b2Settings.b2_maxAngularCorrection);limitImpulse=-this.m_motorMass*limitC;angularError=b2Math.b2Abs(limitC)}else if(this.m_limitState==b2Joint.e_atLowerLimit){limitC=angle-this.m_lowerAngle;angularError=b2Math.b2Max(0,-limitC);limitC=b2Math.b2Clamp(limitC+b2Settings.b2_angularSlop,-b2Settings.b2_maxAngularCorrection,0);limitImpulse=-this.m_motorMass*limitC;oldLimitImpulse=this.m_limitPositionImpulse;this.m_limitPositionImpulse=b2Math.b2Max(this.m_limitPositionImpulse+limitImpulse,0);limitImpulse=this.m_limitPositionImpulse-oldLimitImpulse}else if(this.m_limitState==b2Joint.e_atUpperLimit){limitC=angle-this.m_upperAngle;angularError=b2Math.b2Max(0,limitC);limitC=b2Math.b2Clamp(limitC-b2Settings.b2_angularSlop,0,b2Settings.b2_maxAngularCorrection);limitImpulse=-this.m_motorMass*limitC;oldLimitImpulse=this.m_limitPositionImpulse;this.m_limitPositionImpulse=b2Math.b2Min(this.m_limitPositionImpulse+limitImpulse,0);limitImpulse=this.m_limitPositionImpulse-oldLimitImpulse}b1.m_rotation-=b1.m_invI*limitImpulse;b1.m_R.Set(b1.m_rotation);b2.m_rotation+=b2.m_invI*limitImpulse;b2.m_R.Set(b2.m_rotation)}return positionError<=b2Settings.b2_linearSlop&&angularError<=b2Settings.b2_angularSlop},m_localAnchor1:new b2Vec2,m_localAnchor2:new b2Vec2,m_ptpImpulse:new b2Vec2,m_motorImpulse:null,m_limitImpulse:null,m_limitPositionImpulse:null,m_ptpMass:new b2Mat22,m_motorMass:null,m_intialAngle:null,m_lowerAngle:null,m_upperAngle:null,m_maxMotorTorque:null,m_motorSpeed:null,m_enableLimit:null,m_enableMotor:null,m_limitState:0});b2RevoluteJoint.tImpulse=new b2Vec2;var b2RevoluteJointDef=Class.create();Object.extend(b2RevoluteJointDef.prototype,b2JointDef.prototype);Object.extend(b2RevoluteJointDef.prototype,{initialize:function(){this.type=b2Joint.e_unknownJoint;this.userData=null;this.body1=null;this.body2=null;this.collideConnected=false;this.type=b2Joint.e_revoluteJoint;this.anchorPoint=new b2Vec2(0,0);this.lowerAngle=0;this.upperAngle=0;this.motorTorque=0;this.motorSpeed=0;this.enableLimit=false;this.enableMotor=false},anchorPoint:null,lowerAngle:null,upperAngle:null,motorTorque:null,motorSpeed:null,enableLimit:null,enableMotor:null});var ArrayUtils=new function(){this.putElement=function(array,key,element){array[key]=element;return array};this.removeElementByKey=function(array,key){delete array[key];return array};this.getElementByKey=function(array,key){return array[key]};this.addElement=function(array,element){array.push(element);return array};this.removeElement=function(array,element){var indexOf=ArrayUtils.getIndexOf(array,element);if(indexOf==-1){return array}array.splice(indexOf,1);return array};this.getElement=function(array,id){for(var i in array){var e=array[i];if(e.id==id){return e}}return null};this.getIndexOf=function(array,element){for(var i in array){var e=array[i];if(e.id==element.id){return i}}return-1};this.contains=function(array,element){for(var i in array){var e=array[i];if(e==element){return true}}return false}};var ComponentUtils=new function(){this.addComponent=function(object,component){var systems=component.getSystems();for(var i=0;i<systems.length;i++){var system=systems[i];if(!object[system.getListName()]){object[system.getListName()]={}}object[system.getListName()]=ArrayUtils.putElement(object[system.getListName()],component.getTag(),component)}if(!object.listComponents){object.listComponents={}}object.listComponents=ArrayUtils.putElement(object.listComponents,component.getTag(),component);component.owner=object};this.removeComponent=function(object,component){var systems=component.getSystems();for(var i=0;i<systems.length;i++){var system=systems[i];if(object[system.getListName()]){object[system.getListName()]=ArrayUtils.removeElementByKey(object[system.getListName()],component.getTag())}}if(object.listComponents){object.listComponents=ArrayUtils.removeElementByKey(object.listComponents,component.getTag())}};this.getComponent=function(object,tag){if(object.listComponents){return ArrayUtils.getElementByKey(object.listComponents,tag)}};this.fireComponentEvent=function(listName,functionStr,paramsArray){if(Game[listName]){for(var i in Game[listName]){var component=Game[listName][i];component[functionStr].apply(component,paramsArray)}}if(Game.scene){if(Game.scene[listName]){for(var i in Game.scene[listName]){var component=Game.scene[listName][i];component[functionStr].apply(component,paramsArray)}}for(var i=0;i<Game.scene.listLayers.length;i++){var layer=Game.scene.listLayers[i];if(layer[listName]){for(var j in layer[listName]){var component=layer[listName][j];component[functionStr].apply(component,paramsArray)}}for(var j=0;j<layer.listGameObjects.length;j++){var gameObject=layer.listGameObjects[j];if(gameObject[listName]){for(var k in gameObject[listName]){var component=gameObject[listName][k];component[functionStr].apply(component,paramsArray)}}}}}}};var JSUtils=new function(){this.addMethod=function(object,name,fn){var old=object[name];if(old)object[name]=function(){if(fn.length==arguments.length)return fn.apply(this,arguments);else if(typeof old=="function")return old.apply(this,arguments)};else object[name]=fn};this.generateUUID=function(){var uuid="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(c){var r=Math.random()*16|0,v=c=="x"?r:r&3|8;return v.toString(16)});return uuid}};var StringUtils=new function(){this.replaceAll=function(string,token,newToken){while(string.indexOf(token)!=-1){string=string.replace(token,newToken)}return string}};function CollideInfo(){}JSUtils.addMethod(CollideInfo.prototype,"initialize",function(gameObject1,gameObject2){this.gameObject1=gameObject1;this.gameObject2=gameObject2;return this});function Component(){}JSUtils.addMethod(Component.prototype,"initialize",function(){this.id=JSUtils.generateUUID();this.enabled=true;this.owner=null;return this});Component.prototype.sendLocalMessage=function(message,extras){if(this.owner.listComponents){for(var i in this.owner.listComponents){var component=this.owner.listComponents[i];if(component instanceof Component){component.receiveMessage(message,extras)}}}};Component.prototype.sendMessage=function(object,message,extras){if(object.listComponents){for(var i in object.listComponents){var component=object.listComponents[i];if(component instanceof Component){component.receiveMessage(message,extras)}}}};Component.prototype.getSystems=function(){return null};Component.prototype.onReceiveMessage=function(message,extras){};Component.prototype.onKeyDown=function(keyCode){};Component.prototype.onKeyUp=function(keyCode){};Component.prototype.onClick=function(x,y,wich){};Component.prototype.onMouseDown=function(x,y,wich){};Component.prototype.onMouseUp=function(x,y,wich){};Component.prototype.onMouseMove=function(x,y){};Component.prototype.onBeforeRender=function(context){};Component.prototype.onRender=function(context){};Component.prototype.onUpdate=function(delta){};Component.prototype.onCollide=function(otherGameObject){};Component.prototype.onLoad=function(){};Component.prototype.onDestroy=function(){};Component.prototype.onButtonPressed=function(button){};Component.prototype.onButtonReleased=function(button){};Component.prototype.onStickMoved=function(value,stick,direction){};Component.prototype.getTag=function(){return null};Component.prototype.onTouchStart=function(touchList,changedTouches){};Component.prototype.onTouchMove=function(touchList,changedTouches){};Component.prototype.onTouchEnd=function(touchList,changedTouches){};function AnimationRenderComponent(){}AnimationRenderComponent.prototype=new Component;JSUtils.addMethod(AnimationRenderComponent.prototype,"initialize",function(spriteSheet,columns,rows){this.initialize();this.spriteSheet=spriteSheet;this.columns=columns;this.rows=rows;this.uv=(new Point2D).initialize(0,0);this.stopped=true;this.direction="HORIZONTAL";this.animation=0;this.start=0;this.end=0;this.interactions=0;this.duration=0;this.lastUpdate=null;this.currentInteraction=0;this.currentFrame=0;return this});AnimationRenderComponent.prototype.onRender=function(context){this.uv=(new Point2D).initialize(this.spriteSheet.width/this.columns,this.spriteSheet.height/this.rows);if(!this.stopped&&this.spriteSheet&&this.spriteSheet.width>0&&this.spriteSheet.height>0&&this.uv.x>0&&this.uv.y>0){var x=0;var y=0;if(this.direction=="HORIZONTAL"){x=this.uv.x*this.currentFrame;y=this.uv.y*this.animation}else if(this.direction=="VERTICAL"){x=this.uv.x*this.animation;y=this.uv.y*this.currentFrame}context.drawImage(this.spriteSheet,x,y,this.uv.x,this.uv.y,this.owner.getCenterX()-this.uv.x/2,this.owner.getCenterY()-this.uv.y/2,this.uv.x,this.uv.y);var now=Date.now();if(this.lastUpdate==null||now-this.lastUpdate>=this.duration){this.lastUpdate=now;this.currentFrame++;if(this.currentFrame>this.end){this.currentFrame=this.start;this.currentInteraction++}if(this.interactions!=-1&&this.currentInteraction==this.interactions){this.stopped=true}}}};AnimationRenderComponent.prototype.play=function(direction,animation,start,end,interactions,duration){this.direction=direction;this.animation=animation;this.start=start;this.end=end;this.interactions=interactions;this.duration=duration;this.lastUpdate=null;this.currentInteraction=0;this.currentFrame=start;this.stopped=false};AnimationRenderComponent.prototype.stop=function(){this.stopped=true};AnimationRenderComponent.prototype.getSystems=function(){var systems=new Array;systems=ArrayUtils.addElement(systems,RenderSystem);return systems};AnimationRenderComponent.prototype.getTag=function(){return"ANIMATION_RENDER_COMPONENT"};function BoxRenderComponent(){}BoxRenderComponent.prototype=new Component;JSUtils.addMethod(BoxRenderComponent.prototype,"initialize",function(fillStyle,strokeStyle){this.initialize();this.fillStyle=fillStyle;this.strokeStyle=strokeStyle;return this});BoxRenderComponent.prototype.getSystems=function(){var systems=new Array;systems=ArrayUtils.addElement(systems,RenderSystem);return systems};BoxRenderComponent.prototype.onRender=function(context){if(this.fillStyle!=null){context.fillStyle=this.fillStyle;context.fillRect(this.owner.getCenterX()-this.owner.getWidth()/2,this.owner.getCenterY()-this.owner.getHeight()/2,this.owner.getWidth(),this.owner.getHeight())}if(this.strokeStyle!=null){context.strokeStyle=this.strokeStyle;context.strokeRect(this.owner.getCenterX()-this.owner.getWidth()/2,this.owner.getCenterY()-this.owner.getHeight()/2,this.owner.getWidth(),this.owner.getHeight())}};BoxRenderComponent.prototype.getTag=function(){return"BOX_RENDER_COMPONENT"};function CircleRenderComponent(){}CircleRenderComponent.prototype=new Component;JSUtils.addMethod(CircleRenderComponent.prototype,"initialize",function(fillStyle,strokeStyle){this.initialize();this.fillStyle=fillStyle;this.strokeStyle=strokeStyle;return this});CircleRenderComponent.prototype.getSystems=function(){var systems=new Array;systems=ArrayUtils.addElement(systems,RenderSystem);return systems};CircleRenderComponent.prototype.onRender=function(context){context.beginPath();context.arc(this.owner.getCenterX(),this.owner.getCenterY(),this.owner.getRadius(),2*Math.PI,false);if(this.fillStyle!=null){context.fillStyle=this.fillStyle;context.fill()}if(this.strokeStyle!=null){context.strokeStyle=this.strokeStyle;context.stroke()}};CircleRenderComponent.prototype.getTag=function(){return"CIRCLE_RENDER_COMPONENT"};function FpsMeterComponent(){}FpsMeterComponent.prototype=new Component;FpsMeterComponent.prototype.fpsCount=0;FpsMeterComponent.prototype.currentFps=0;FpsMeterComponent.prototype.lastUpdate=0;FpsMeterComponent.prototype.getSystems=function(){var systems=new Array;systems=ArrayUtils.addElement(systems,RenderSystem);return systems};FpsMeterComponent.prototype.onBeforeRender=function(context){};FpsMeterComponent.prototype.onRender=function(context){var now=Date.now();if((now-this.lastUpdate)/1e3>=1){this.currentFps=this.fpsCount;this.fpsCount=0;this.lastUpdate=now}this.fpsCount++;context.fillStyle="red";context.font="bold 20px Arial";context.fillText("FPS: "+this.currentFps,20,30)};FpsMeterComponent.prototype.getTag=function(){return"FPS_METER_COMPONENT"};function ImageRenderComponent(){}ImageRenderComponent.prototype=new Component;JSUtils.addMethod(ImageRenderComponent.prototype,"initialize",function(image,repeat,direction){this.initialize();this.image=image;if(repeat){this.repeat=repeat}else{this.repeat=false}if(direction){this.direction=direction}else{this.direction="HORIZONTAL"}return this});ImageRenderComponent.prototype.getSystems=function(){var systems=new Array;systems=ArrayUtils.addElement(systems,RenderSystem);return systems};ImageRenderComponent.prototype.onRender=function(context){if(this.repeat&&this.image.width>0&&this.image.height>0){var repeatCount=0;if(this.direction=="HORIZONTAL"){repeatCount=this.owner.getWidth()/this.image.width}else if(this.direction=="VERTICAL"){repeatCount=this.owner.getHeight()/this.image.height}for(var i=0;i<repeatCount;i++){if(this.direction=="HORIZONTAL"){context.drawImage(this.image,this.owner.getCenterX()-this.owner.getWidth()/2+this.image.width*i,this.owner.getCenterY()-this.owner.getHeight()/2)}else if(this.direction=="VERTICAL"){context.drawImage(this.image,this.owner.getCenterX()-this.owner.getWidth()/2,this.owner.getCenterY()-this.owner.getHeight()/2+this.image.height*i)}}}else{context.drawImage(this.image,this.owner.getCenterX()-this.owner.getWidth()/2,this.owner.getCenterY()-this.owner.getHeight()/2)}};ImageRenderComponent.prototype.getTag=function(){return"IMAGE_RENDER_COMPONENT"};function PolygonRenderComponent(){}PolygonRenderComponent.prototype=new Component;JSUtils.addMethod(PolygonRenderComponent.prototype,"initialize",function(fillStyle,strokeStyle){this.initialize();this.fillStyle=fillStyle;this.strokeStyle=strokeStyle;return this});PolygonRenderComponent.prototype.getSystems=function(){var systems=new Array;systems=ArrayUtils.addElement(systems,RenderSystem);return systems};PolygonRenderComponent.prototype.onRender=function(context){context.save();if(this.fillStyle!=null){context.fillStyle=this.fillStyle}if(this.strokeStyle!=null){context.strokeStyle=this.strokeStyle}if(!this.owner.body){context.translate(this.owner.getCenterX(),this.owner.getCenterY())}var polygonPoints=this.owner.getPoints();context.beginPath();context.moveTo(polygonPoints[0].x,polygonPoints[0].y);for(var i=1;i<polygonPoints.length;i++){var point=polygonPoints[i];if(point instanceof Point2D){context.lineTo(point.x,point.y)}}context.closePath();if(this.fillStyle!=null){context.fill()}if(this.strokeStyle!=null){context.stroke()}context.restore()};PolygonRenderComponent.prototype.getTag=function(){return"POLYGON_RENDER_COMPONENT"};function RigidBodyComponent(){}RigidBodyComponent.prototype=new Component;JSUtils.addMethod(RigidBodyComponent.prototype,"initialize",function(restitution,density,preventRotation,allowSleep,friction){this.initialize();this.restitution=restitution;this.density=density;this.preventRotation=preventRotation;this.allowSleep=allowSleep;this.friction=friction;this.isSensor=false;this.isCollidable=true;return this});JSUtils.addMethod(RigidBodyComponent.prototype,"initialize",function(restitution,density,preventRotation,allowSleep,friction,isSensor){this.initialize();this.restitution=restitution;this.density=density;this.preventRotation=preventRotation;this.allowSleep=allowSleep;this.friction=friction;this.isSensor=isSensor;this.isCollidable=true;return this});JSUtils.addMethod(RigidBodyComponent.prototype,"initialize",function(restitution,density,preventRotation,allowSleep,friction,isSensor,isCollidable){this.initialize();this.restitution=restitution;this.density=density;this.preventRotation=preventRotation;this.allowSleep=allowSleep;this.friction=friction;this.isSensor=isSensor;this.isCollidable=isCollidable;return this});RigidBodyComponent.prototype.getSystems=function(){var systems=new Array;systems=ArrayUtils.addElement(systems,LogicSystem);return systems};RigidBodyComponent.prototype.onUpdate=function(deltaTime){if(this.owner.recreateBody){this.createPhysicsBody();this.owner.recreateBody=false}};RigidBodyComponent.prototype.onLoad=function(){this.createPhysicsBody()};RigidBodyComponent.prototype.onDestroy=function(){this.destroyBody()};RigidBodyComponent.prototype.createPhysicsBody=function(){if(this.owner.body){this.destroyBody()}var bodyShape=this.owner.createBodyShape();bodyShape.restitution=this.restitution;bodyShape.density=this.density;bodyShape.friction=this.friction;var centerX=this.owner.getCenterX();var centerY=this.owner.getCenterY();var translate=ComponentUtils.getComponent(this.owner,"TRANSLATE_COMPONENT");if(translate&&!translate.applied){centerX+=translate.translatePoint.x;centerY+=translate.translatePoint.y;translate.applied=true}var bodyDef=this.owner.createBodyDef(centerX,centerY);bodyDef.preventRotation=this.preventRotation;bodyDef.allowSleep=this.allowSleep;bodyDef.AddShape(bodyShape);var ab=this.owner.getAngle();this.owner.body=this.owner.layer.world.CreateBody(bodyDef);this.owner.body.m_rotation=ab;this.owner.body.isSensor=this.isSensor;this.owner.body.isCollidable=this.isCollidable};RigidBodyComponent.prototype.destroyBody=function(){this.owner.layer.world.DestroyBody(this.owner.body)};RigidBodyComponent.prototype.getTag=function(){return"RIGID_BODY_COMPONENT"};function RotateComponent(){}RotateComponent.prototype=new Component;JSUtils.addMethod(RotateComponent.prototype,"initialize",function(angle){this.initialize();this.angle=angle;return this});RotateComponent.prototype.getSystems=function(){var systems=new Array;systems=ArrayUtils.addElement(systems,RenderSystem);return systems};RotateComponent.prototype.setRotate=function(angle){this.angle=angle;if(this.owner.body){if(this.owner instanceof PolygonObject){this.owner.body.m_shapeList.m_body.m_rotation=angle}else{this.owner.body.m_rotation=angle}}};RotateComponent.prototype.getAngle=function(){if(!this.owner.body||this.owner.body==null){return this.angle}if(this instanceof PolygonObject){return this.owner.body.m_shapeList.m_body.m_rotation}return this.owner.body.m_rotation};RotateComponent.prototype.rotate=function(context){if(!(this.owner instanceof PolygonObject)||!this.owner.body){context.translate(this.owner.getCenterX(),this.owner.getCenterY());context.rotate(this.owner.getAngle());context.translate(-this.owner.getCenterX(),-this.owner.getCenterY())}};RotateComponent.prototype.onBeforeRender=function(context){this.rotate(context)};RotateComponent.prototype.getTag=function(){return"ROTATE_COMPONENT"};function ScaleComponent(){}ScaleComponent.prototype=new Component;JSUtils.addMethod(ScaleComponent.prototype,"initialize",function(x,y){this.initialize();this.scalePoint=(new Point2D).initialize(x,y);return this});ScaleComponent.prototype.getSystems=function(){var systems=new Array;systems=ArrayUtils.addElement(systems,RenderSystem);return systems};ScaleComponent.prototype.setScale=function(x,y){this.scalePoint.x=x;this.scalePoint.y=y;this.owner.recreateBody=true};ScaleComponent.prototype.scale=function(context){if(!(this.owner instanceof PolygonObject)||!this.owner.body){context.translate(this.owner.getCenterX(),this.owner.getCenterY());context.scale(this.scalePoint.x,this.scalePoint.y);context.translate(-this.owner.getCenterX(),-this.owner.getCenterY())}};ScaleComponent.prototype.onBeforeRender=function(context){this.scale(context)};ScaleComponent.prototype.getTag=function(){return"SCALE_COMPONENT"};function TranslateComponent(){}TranslateComponent.prototype=new Component;JSUtils.addMethod(TranslateComponent.prototype,"initialize",function(x,y){this.initialize();this.translatePoint=(new Point2D).initialize(x,y);return this});TranslateComponent.prototype.getSystems=function(){var systems=new Array;systems=ArrayUtils.addElement(systems,RenderSystem);return systems};TranslateComponent.prototype.setTranslate=function(x,y){this.translatePoint.x=x;this.translatePoint.y=y;this.applied=false;if(this.owner.body){if(this.owner instanceof PolygonObject){this.owner.body.m_shapeList.m_body.m_position.x+=this.translatePoint.x;this.owner.body.m_shapeList.m_body.m_position.y+=this.translatePoint.y}else{this.owner.body.m_position.x+=this.translatePoint.x;this.owner.body.m_position.y+=this.translatePoint.y}this.applied=true}};TranslateComponent.prototype.translate=function(context){if(!this.owner.body){context.translate(this.owner.getCenterX(),this.owner.getCenterY());context.translate(this.translatePoint.x,this.translatePoint.y);context.translate(-this.owner.getCenterX(),-this.owner.getCenterY())}};TranslateComponent.prototype.onBeforeRender=function(context){this.translate(context)};TranslateComponent.prototype.getTag=function(){return"TRANSLATE_COMPONENT"};function MoveCameraComponent(){}MoveCameraComponent.prototype=new Component;JSUtils.addMethod(MoveCameraComponent.prototype,"initialize",function(leftKey,rightKey,upKey,downKey,zoomInKey,zoomOutKey,rotateKey,rotateInverseKey,translateFactor,scaleFactor,rotateFactor){this.initialize();this.leftKey=leftKey;this.rightKey=rightKey;this.upKey=upKey;this.downKey=downKey;this.zoomInKey=zoomInKey;this.zoomOutKey=zoomOutKey;this.rotateKey=rotateKey;this.rotateInverseKey=rotateInverseKey;this.translateFactor=translateFactor;this.scaleFactor=scaleFactor;this.rotateFactor=rotateFactor;return this});MoveCameraComponent.prototype.onKeyDown=function(keyCode){if(keyCode==this.leftKey){Game.camera.centerPoint.x-=this.translateFactor}else if(keyCode==this.rightKey){Game.camera.centerPoint.x+=this.translateFactor}else if(keyCode==this.upKey){Game.camera.centerPoint.y-=this.translateFactor}else if(keyCode==this.downKey){Game.camera.centerPoint.y+=this.translateFactor}else if(keyCode==this.zoomInKey){Game.camera.scale.scalePoint.x+=this.scaleFactor;Game.camera.scale.scalePoint.y+=this.scaleFactor}else if(keyCode==this.zoomOutKey){Game.camera.scale.scalePoint.x-=this.scaleFactor;Game.camera.scale.scalePoint.y-=this.scaleFactor;if(Game.camera.scale.scalePoint.x<0){Game.camera.scale.scalePoint.x=0;Game.camera.scale.scalePoint.y=0}}else if(keyCode==this.rotateKey){Game.camera.rotate.angle+=Math.PI*this.rotateFactor/180}else if(keyCode==this.rotateInverseKey){Game.camera.rotate.angle-=Math.PI*this.rotateFactor/180}};MoveCameraComponent.prototype.getSystems=function(){var systems=new Array;systems=ArrayUtils.addElement(systems,KeySystem);return systems};MoveCameraComponent.prototype.getTag=function(){return"MOVE_CAMERA_COMPONENT"};function DragControlComponent(){}DragControlComponent.prototype=new Component;DragControlComponent.prototype.selectedArray={};DragControlComponent.prototype.startX={};DragControlComponent.prototype.startY={};JSUtils.addMethod(DragControlComponent.prototype,"initialize",function(onDropListener){this.initialize();this.onDropListener=onDropListener;return this});DragControlComponent.prototype.startDrag=function(x,y,identifier){var point=MouseSystem.getNormalizedCoordinate(x,y);x=point.x;y=point.y;var selected=this.owner.queryGameObjects(x,y,2,2,20);var selectedGameObject=selected[0]||null;if(selectedGameObject!=null&&ComponentUtils.getComponent(selectedGameObject,"DRAGGABLE_COMPONENT")&&ComponentUtils.getComponent(selectedGameObject,"DRAGGABLE_COMPONENT").canDrag==true){this.startX[identifier]=x;this.startY[identifier]=y;this.selectedArray[identifier]=selectedGameObject}};DragControlComponent.prototype.moveDrag=function(x,y,identifier){if(this.selectedArray[identifier]&&this.selectedArray[identifier]!=null){var point=MouseSystem.getNormalizedCoordinate(x,y);x=point.x;y=point.y;var dx=x-this.startX[identifier];var dy=y-this.startY[identifier];this.selectedArray[identifier].addMove(dx,dy);this.startX[identifier]=x;this.startY[identifier]=y}};DragControlComponent.prototype.endDrag=function(identifier){if(this.selectedArray[identifier]&&this.selectedArray[identifier]!=null&&this.onDropListener){this.onDropListener["onDropGameObject"].apply(this.onDropListener,[this.selectedArray[identifier]])}delete this.startX[identifier];delete this.startY[identifier];delete this.selectedArray[identifier]};DragControlComponent.prototype.onMouseDown=function(x,y,wich){this.startDrag(x,y,"MOUSE_DRAG")};DragControlComponent.prototype.onMouseMove=function(x,y){this.moveDrag(x,y,"MOUSE_DRAG")};DragControlComponent.prototype.onMouseUp=function(x,y,wich){this.endDrag("MOUSE_DRAG")};DragControlComponent.prototype.onTouchStart=function(touchList,changedTouches){for(var i=0;i<changedTouches.length;i++){this.startDrag(changedTouches[i].pageX-Game.canvas.offsetLeft,changedTouches[i].pageY-Game.canvas.offsetTop,changedTouches[i].identifier)}};DragControlComponent.prototype.onTouchMove=function(touchList,changedTouches){for(var i=0;i<changedTouches.length;i++){this.moveDrag(changedTouches[i].pageX-Game.canvas.offsetLeft,changedTouches[i].pageY-Game.canvas.offsetTop,changedTouches[i].identifier)}};DragControlComponent.prototype.onTouchEnd=function(touchList,changedTouches){for(var i=0;i<changedTouches.length;i++){this.endDrag(changedTouches[i].identifier)}};DragControlComponent.prototype.getSystems=function(){var systems=new Array;systems=ArrayUtils.addElement(systems,TouchSystem);systems=ArrayUtils.addElement(systems,MouseSystem);return systems};DragControlComponent.prototype.getTag=function(){return"DRAG_CONTROL_COMPONENT"};function DraggableComponent(){}DraggableComponent.prototype=new Component;DraggableComponent.prototype.canDrag=true;DraggableComponent.prototype.getSystems=function(){var systems=new Array;return systems};DraggableComponent.prototype.getTag=function(){return"DRAGGABLE_COMPONENT"};function RotatableComponent(){}RotatableComponent.prototype=new Component;RotatableComponent.prototype.fX=null;RotatableComponent.prototype.fY=null;RotatableComponent.prototype.sX=null;RotatableComponent.prototype.sY=null;RotatableComponent.prototype.initAngle=0;RotatableComponent.prototype.touchCount=0;RotatableComponent.prototype.rotating=false;RotatableComponent.prototype.onKeyDown=function(keyCode){if(keyCode==39){if(this.rotating==true){var rotate=ComponentUtils.getComponent(this.owner,"ROTATE_COMPONENT");var angle=rotate.getAngle()+1/60;rotate.setRotate(angle)}}else if(keyCode==37){if(this.rotating==true){var rotate=ComponentUtils.getComponent(this.owner,"ROTATE_COMPONENT");var angle=rotate.getAngle()-1/60;rotate.setRotate(angle)}}};RotatableComponent.prototype.onMouseDown=function(x,y,wich){var point=MouseSystem.getNormalizedCoordinate(x,y);x=point.x;y=point.y;var selected=layer.queryGameObjects(x,y,2,2,20);var selectedPiece=selected[0]||null;if(selectedPiece!=null&&selectedPiece.id==this.owner.id){this.rotating=true}};RotatableComponent.prototype.onMouseUp=function(x,y,wich){this.rotating=false};RotatableComponent.prototype.onTouchStart=function(touchList){if(this.touchCount==0){this.touchCount++}else if(this.touchCount==1&&touchList.length==2){var fPoint=MouseSystem.getNormalizedCoordinate(touchList[0].pageX,touchList[0].pageY);var sPoint=MouseSystem.getNormalizedCoordinate(touchList[1].pageX,touchList[1].pageY);var fSelected=layer.queryGameObjects(fPoint.x,fPoint.y,2,2,20);var fObjSelected=fSelected[0]||null;var sSelected=layer.queryGameObjects(sPoint.x,sPoint.y,2,2,20);var sObjSelected=sSelected[0]||null;if(fObjSelected!=null&&fObjSelected.id==this.owner.id||sObjSelected!=null&&sObjSelected.id==this.owner.id){this.sX=fPoint.x;this.sY=fPoint.y;this.fX=sPoint.x;this.fY=sPoint.y;this.touchCount++;var rotateComp=ComponentUtils.getComponent(this.owner,"ROTATE_COMPONENT");this.initAngle=rotateComp.getAngle()}else{this.touchCount=0}}};RotatableComponent.prototype.onTouchMove=function(touchList){if(this.touchCount==2&&touchList.length==2){var dragComp=ComponentUtils.getComponent(this.owner,"DRAGGABLE_COMPONENT");if(dragComp!=null){dragComp.endDrag()}var fPoint=MouseSystem.getNormalizedCoordinate(touchList[0].pageX,touchList[0].pageY);var sPoint=MouseSystem.getNormalizedCoordinate(touchList[1].pageX,touchList[1].pageY);var nfX=fPoint.x;var nfY=fPoint.y;var nsX=sPoint.x;var nsY=sPoint.y;var angle=this.getAngleBetweenLines(this.fX,this.fY,this.sX,this.sY,nfX,nfY,nsX,nsY);var rotateComp=ComponentUtils.getComponent(this.owner,"ROTATE_COMPONENT");if(angle>0){angle-=Math.PI}else if(angle<0){angle+=Math.PI}rotateComp.setRotate(angle+this.initAngle)}};RotatableComponent.prototype.getAngleBetweenLines=function(fX,fY,sX,sY,nfX,nfY,nsX,nsY){var angle1=Math.atan2(fY-sY,fX-sX);var angle2=Math.atan2(nfY-nsY,nfX-nsX);var angle=this.toDegrees(angle1-angle2)%360;if(angle<-180){angle+=360}if(angle>180){angle-=360}return this.toRadians(angle)*-1};RotatableComponent.prototype.toDegrees=function(rad){return rad*(180/Math.PI)};RotatableComponent.prototype.toRadians=function(deg){return deg*(Math.PI/180)};RotatableComponent.prototype.onTouchEnd=function(touchList){if(this.touchCount>0){this.touchCount--}};RotatableComponent.prototype.getSystems=function(){var systems=new Array;systems=ArrayUtils.addElement(systems,TouchSystem);systems=ArrayUtils.addElement(systems,MouseSystem);systems=ArrayUtils.addElement(systems,KeySystem);return systems};RotatableComponent.prototype.getTag=function(){return"ROTATABLE_COMPONENT"};function Asset(){}JSUtils.addMethod(Asset.prototype,"initialize",function(id,path,assetType){this.id=id;this.path=path;this.assetType=assetType;this.loadAsset();return this});Asset.prototype.getAssetInstance=function(){return this.instance};Asset.prototype.loadAsset=function(){if(this.assetType=="IMAGE"){this.instance=new Image;this.instance.src=this.path}else if(this.assetType=="AUDIO"){this.instance=new Audio;this.instance.pause();this.instance.volume=1;this.instance.loop=false;this.instance.preload="auto";this.instance.src=this.path
}};var AssetStore=new function(){this.listAssets=new Array;this.getAsset=function(id){if(this.listAssets){return ArrayUtils.getElement(this.listAssets,id)}return null};this.addAsset=function(asset){this.listAssets=ArrayUtils.addElement(this.listAssets,asset)}};function Camera(){}JSUtils.addMethod(Camera.prototype,"initialize",function(x,y){this.centerPoint=(new Point2D).initialize(x,y);this.scale=(new ScaleComponent).initialize(1,1);this.translate=(new TranslateComponent).initialize(0,0);this.rotate=(new RotateComponent).initialize(0);ComponentUtils.addComponent(this,this.scale);ComponentUtils.addComponent(this,this.translate);ComponentUtils.addComponent(this,this.rotate);return this});Camera.prototype.setScale=function(x,y){this.scale.scalePoint.x=x;this.scale.scalePoint.y=y};Camera.prototype.setTranslate=function(x,y){this.translate.translatePoint.x=x;this.translate.translatePoint.y=y};Camera.prototype.getCenterX=function(){return this.centerPoint.x};Camera.prototype.getCenterY=function(){return this.centerPoint.y};Camera.prototype.getAngle=function(){if(this.rotate){return this.rotate.angle}return 0};var Game=new function(){this.canvas=null;this.context=null;this.camera=null;this.listComponents=null;this.listAssets=null;this.scene=null;this.lastUpdateTime=null;this.frameRate=null;this.running=false;this.paused=false;this.init=function(canvas,scene){this.canvas=canvas;this.context=canvas.getContext("2d");this.camera=(new Camera).initialize(canvas.width/2,canvas.height/2);this.loadGame();this.setScene(scene);this.lastUpdateTime=0;this.frameRate=60;this.startGameLoop();this.running=true;this.paused=false};this.loadGame=function(){for(var i in this.listComponents){var component=this.listComponents[i];component.onLoad()}};this.startGameLoop=function(){window.cancelRequestAnimFrame=function(){return window.cancelAnimationFrame||window.webkitCancelRequestAnimationFrame||window.mozCancelRequestAnimationFrame||window.oCancelRequestAnimationFrame||window.msCancelRequestAnimationFrame||clearTimeout}();window.requestAnimFram=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(callback,element){window.setTimeout(callback,1e3/Game.frameRate)}}();window.windowLoop=function(){Game.requestAnimFram=requestAnimFram(windowLoop);Game.gameLoop()};windowLoop()};this.stopGame=function(){cancelRequestAnimFrame(Game.requestAnimFram);window.removeEventListener("click",MouseSystem.fireClickListener);window.removeEventListener("mousedown",MouseSystem.fireMouseDownListener);window.removeEventListener("mouseup",MouseSystem.fireMouseUpListener);window.removeEventListener("mousemove",MouseSystem.fireMouseMoveListener);window.removeEventListener("touchstart",MouseSystem.fireMouseDownListener);window.removeEventListener("touchmove",MouseSystem.fireMouseMoveListener);window.removeEventListener("touchend",MouseSystem.fireMouseUpListener);window.removeEventListener("keydown",KeySystem.fireKeyDownListener);window.removeEventListener("keyup",KeySystem.fireKeyUpListener)};this.gameLoop=function(){var deltaTime=(Date.now()-this.lastUpdateTime)/1e3;if(!Game.paused){this.updateGame(deltaTime);this.stepGame();this.renderGame()}this.lastUpdateTime=Date.now()};this.updateGame=function(deltaTime){LogicSystem.fireUpdateListener(deltaTime)};this.stepGame=function(){for(var i=0;i<this.scene.listLayers.length;i++){var layer=this.scene.listLayers[i];layer.world.Step(1/60,1)}LogicSystem.fireCollideListener()};this.renderGame=function(){RenderSystem.fireRenderListener(this.context)};this.setScene=function(scene){this.scene=scene;this.loadScene()};this.loadScene=function(){this.scene.onLoad();for(var i in this.scene.listComponents){var component=this.scene.listComponents[i];component.onLoad()}for(var i=0;i<this.scene.listLayers.length;i++){var layer=this.scene.listLayers[i];layer.onLoad();for(var j in layer.listComponents){var component=layer.listComponents[j];component.onLoad()}for(var j=0;j<layer.listGameObjects.length;j++){var gameObject=layer.listGameObjects[j];gameObject.onLoad();for(var k in gameObject.listComponents){var component=gameObject.listComponents[k];component.onLoad()}}}}};function Layer(){}JSUtils.addMethod(Layer.prototype,"initialize",function(){this.id=JSUtils.generateUUID();this.scene=null;this.world=null;this.gravity=1e3;this.doSleep=true;this.listComponents=null;this.listGameObjects=new Array;return this});Layer.prototype.queryGameObjects=function(x,y,w,h,max){var aabb=new b2AABB;var shapes=[];var gameObjects=[];aabb.minVertex.Set(x-w/2,y-h/2);aabb.maxVertex.Set(x+w/2,y+h/2);this.world.Query(aabb,shapes,max);if(shapes.length>0){for(var i=0;i<shapes.length;i++){if(shapes[i].TestPoint(new b2Vec2(x,y))){gameObjects[gameObjects.length]=shapes[i].m_body.m_userData}}}return gameObjects};Layer.prototype.setGravity=function(gravity){this.gravity=gravity;if(this.world){this.world.m_gravity.y=gravity;var velocity=1;if(gravity==0){velocity=0}for(var i in this.listGameObjects){var go=this.listGameObjects[i];if(go instanceof GameObject){if(go.body){go.body.m_shapeList.m_body.m_angularDamping=velocity;go.body.m_shapeList.m_body.m_linearDamping=velocity}}}}};Layer.prototype.addGameObject=function(gameObject){this.listGameObjects=ArrayUtils.addElement(this.listGameObjects,gameObject);gameObject.layer=this;if(Game.running){gameObject.recreateBody=true}};Layer.prototype.removeGameObject=function(gameObject){this.listGameObjects=ArrayUtils.removeElement(this.listGameObjects,gameObject)};Layer.prototype.onLoad=function(){var worldAABB=new b2AABB;worldAABB.minVertex.Set(this.scene.minPoint.x,this.scene.minPoint.y);worldAABB.maxVertex.Set(this.scene.maxPoint.x,this.scene.maxPoint.y);var worldGravity=new b2Vec2(0,this.gravity);this.world=new b2World(worldAABB,worldGravity,this.doSleep);var listener=new b2WorldListener;listener.NotifyBoundaryViolated=function(b){var go=b.GetUserData();go.layer.removeGameObject(go);return 1};this.world.SetListener(listener)};function Scene(){}JSUtils.addMethod(Scene.prototype,"initialize",function(minX,minY,maxX,maxY){this.id=JSUtils.generateUUID();this.minPoint=(new Point2D).initialize(minX,minY);this.maxPoint=(new Point2D).initialize(maxX,maxY);this.listLayers=new Array;this.listComponents=null;return this});Scene.prototype.addLayer=function(layer){this.listLayers=ArrayUtils.addElement(this.listLayers,layer);layer.scene=this};Scene.prototype.removeLayer=function(layer){this.listLayers=ArrayUtils.removeElement(this.listLayers,layer)};Scene.prototype.onLoad=function(){};function GameObject(){}JSUtils.addMethod(GameObject.prototype,"initialize",function(x,y,width,height){this.id=JSUtils.generateUUID();this.origin=(new Point2D).initialize(x,y);this.width=width;this.height=height;this.body=null;this.layer=null;this.listComponents=null;return this});GameObject.prototype.onLoad=function(){};GameObject.prototype.getWidth=function(){if(!this.width||this.width==null){return 0}return this.width};GameObject.prototype.getHeight=function(){if(!this.height||this.height==null){return 0}return this.height};GameObject.prototype.getCenterX=function(){if(!this.body||this.body==null){return this.origin.x}if(this instanceof PolygonObject){return this.body.m_shapeList.m_body.m_position.x}return this.body.m_position.x};GameObject.prototype.getCenterY=function(){if(!this.body||this.body==null){return this.origin.y}if(this instanceof PolygonObject){return this.body.m_shapeList.m_body.m_position.y}return this.body.m_position.y};GameObject.prototype.addMove=function(x,y){if(this.body){if(this instanceof PolygonObject){this.body.m_shapeList.m_body.m_position.x+=x;this.body.m_shapeList.m_body.m_position.y+=y}else{this.body.m_position.x+=x;this.body.m_position.y+=y}}else{this.origin.x+=x;this.origin.y+=y}};GameObject.prototype.setLinearVelocityX=function(x){if(this.body){var linearVelocity=null;if(this instanceof PolygonObject){linearVelocity=this.body.m_shapeList.m_body.GetLinearVelocity()}else{linearVelocity=this.body.GetLinearVelocity()}linearVelocity.x=x}};GameObject.prototype.setLinearVelocityY=function(y){if(this.body){var linearVelocity=null;if(this instanceof PolygonObject){linearVelocity=this.body.m_shapeList.m_body.GetLinearVelocity()}else{linearVelocity=this.body.GetLinearVelocity()}linearVelocity.y=y}};GameObject.prototype.getAngle=function(){if(!this.body||this.body==null){var rotate=ComponentUtils.getComponent(this,"ROTATE_COMPONENT");if(rotate){return rotate.angle}return 0}if(this instanceof PolygonObject){return this.body.m_shapeList.m_body.m_rotation}return this.body.m_rotation};GameObject.prototype.createBodyDef=function(x,y){var bodyDefinition=new b2BodyDef;bodyDefinition.userData=this;bodyDefinition.position.Set(x,y);return bodyDefinition};GameObject.prototype.destroy=function(){for(var i in this.listComponents){var component=this.listComponents[i];component.onDestroy()}this.layer.listGameObjects=ArrayUtils.removeElement(this.layer.listGameObjects,this)};GameObject.prototype.createBodyShape=function(){return null};GameObject.prototype.getTag=function(){return null};function BoxObject(){}BoxObject.prototype=new GameObject;JSUtils.addMethod(BoxObject.prototype,"initialize",function(x,y,width,height,fillStyle,fillStroke){this.initialize(x,y,width,height);ComponentUtils.addComponent(this,(new BoxRenderComponent).initialize(fillStyle,fillStroke));ComponentUtils.addComponent(this,(new TranslateComponent).initialize(0,0));ComponentUtils.addComponent(this,(new ScaleComponent).initialize(1,1));ComponentUtils.addComponent(this,(new RotateComponent).initialize(0));return this});BoxObject.prototype.createBodyShape=function(){var shape=new b2BoxDef;var xb=this.getWidth();var yb=this.getHeight();var scale=ComponentUtils.getComponent(this,"SCALE_COMPONENT");if(scale){xb*=Math.abs(scale.scalePoint.x);yb*=Math.abs(scale.scalePoint.y)}shape.extents.Set(xb/2,yb/2);return shape};BoxObject.prototype.getTag=function(){return"BOX_OBJECT"};function CircleObject(){}CircleObject.prototype=new GameObject;JSUtils.addMethod(CircleObject.prototype,"initialize",function(x,y,radius,fillStyle,fillStroke){this.initialize(x,y,0,0);this.radius=radius;ComponentUtils.addComponent(this,(new CircleRenderComponent).initialize(fillStyle,fillStroke));ComponentUtils.addComponent(this,(new ScaleComponent).initialize(1,1));ComponentUtils.addComponent(this,(new TranslateComponent).initialize(0,0));ComponentUtils.addComponent(this,(new RotateComponent).initialize(0));return this});CircleObject.prototype.createBodyShape=function(){var shape=new b2CircleDef;var rb=this.radius;var scale=ComponentUtils.getComponent(this,"SCALE_COMPONENT");if(scale){rb=this.radius*Math.abs(scale.scalePoint.x)}shape.radius=rb;return shape};CircleObject.prototype.getRadius=function(){return this.radius};CircleObject.prototype.getTag=function(){return"CIRCLE_OBJECT"};function PolygonObject(){}PolygonObject.prototype=new GameObject;JSUtils.addMethod(PolygonObject.prototype,"initialize",function(x,y,points,fillStyle,fillStroke){this.initialize(x,y,0,0);this.points=points;ComponentUtils.addComponent(this,(new PolygonRenderComponent).initialize(fillStyle,fillStroke));ComponentUtils.addComponent(this,(new ScaleComponent).initialize(1,1));ComponentUtils.addComponent(this,(new TranslateComponent).initialize(0,0));ComponentUtils.addComponent(this,(new RotateComponent).initialize(0));return this});PolygonObject.prototype.createBodyShape=function(){var shape=new b2PolyDef;shape.vertexCount=this.points.length;var scale=ComponentUtils.getComponent(this,"SCALE_COMPONENT");for(var i=0;i<shape.vertexCount;i++){var point=this.points[i];if(scale){shape.vertices[i].Set(point.x*Math.abs(scale.scalePoint.x),point.y*Math.abs(scale.scalePoint.y))}else{shape.vertices[i].Set(point.x,point.y)}}return shape};PolygonObject.prototype.getPoints=function(){if(this.body){var poly=this.body.m_shapeList;var newPoints=[];for(var i=0;i<poly.m_vertexCount;i++){var v=b2Math.AddVV(poly.m_position,b2Math.b2MulMV(poly.m_R,poly.m_vertices[i]));newPoints[i]=(new Point2D).initialize(v.x,v.y)}return newPoints}return this.points};PolygonObject.prototype.getTag=function(){return"POLYGON_OBJECT"};function Point2D(){}JSUtils.addMethod(Point2D.prototype,"initialize",function(x,y){this.x=x;this.y=y;return this});Point2D.prototype.toString=function(){return"["+this.x+","+this.y+"]"};var KeySystem=new function(){this.fireKeyDownListener=function(evt){ComponentUtils.fireComponentEvent(KeySystem.getListName(),"onKeyDown",[evt.keyCode])};this.fireKeyUpListener=function(evt){ComponentUtils.fireComponentEvent(KeySystem.getListName(),"onKeyUp",[evt.keyCode])};this.getTag=function(){return"KEY_SYSTEM"};this.getListName=function(){return"listComponentsKey"}};window.addEventListener("keydown",KeySystem.fireKeyDownListener);window.addEventListener("keyup",KeySystem.fireKeyUpListener);var LogicSystem=new function(){this.listCollides={};this.fireUpdateListener=function(deltaTime){ComponentUtils.fireComponentEvent(LogicSystem.getListName(),"onUpdate",[deltaTime])};this.fireCollideListener=function(){for(var i in this.listCollides){var collide=this.listCollides[i];for(var j in collide.gameObject1[LogicSystem.getListName()]){var component=collide.gameObject1[LogicSystem.getListName()][j];component.onCollide(collide.gameObject2)}for(var j in collide.gameObject2[LogicSystem.getListName()]){var component=collide.gameObject2[LogicSystem.getListName()][j];component.onCollide(collide.gameObject1)}}this.clearCollideInfo()};this.putCollideInfo=function(gameObject1,gameObject2){var keyCollide1=this.getCollideKey(gameObject1,gameObject2);var keyCollide2=this.getCollideKey(gameObject2,gameObject1);if(!ArrayUtils.getElementByKey(this.listCollides,keyCollide1)&&!ArrayUtils.getElementByKey(this.listCollides,keyCollide2)){var collideInfo=(new CollideInfo).initialize(gameObject1,gameObject2);this.listCollides=ArrayUtils.putElement(this.listCollides,keyCollide1,collideInfo)}};this.getCollideKey=function(gameObject1,gameObject2){return"KEY_"+gameObject1.id+"_"+gameObject2.id};this.clearCollideInfo=function(){this.listCollides={}};this.getTag=function(){return"LOGIC_SYSTEM"};this.getListName=function(){return"listComponentsLogic"}};var MouseSystem=new function(){this.getNormalizedCoordinate=function(x,y){x-=-Game.camera.centerPoint.x+Game.canvas.width/2;y-=-Game.camera.centerPoint.y+Game.canvas.height/2;x-=Game.camera.centerPoint.x;x/=Game.camera.scale.scalePoint.x;x+=Game.camera.centerPoint.x;y-=Game.camera.centerPoint.y;y/=Game.camera.scale.scalePoint.y;y+=Game.camera.centerPoint.y;x-=Game.camera.translate.translatePoint.x;y-=Game.camera.translate.translatePoint.y;var sine=Math.sin(-Game.camera.rotate.angle);var cosine=Math.cos(-Game.camera.rotate.angle);x-=Game.camera.centerPoint.x;y-=Game.camera.centerPoint.y;var xn=x*cosine-y*sine;var yn=x*sine+y*cosine;x=xn+Game.camera.centerPoint.x;y=yn+Game.camera.centerPoint.y;return(new Point2D).initialize(x,y)};this.fireClickListener=function(evt){var x=evt.offsetX||evt.layerX;var y=evt.offsetY||evt.layerY;var wich=evt.wich;ComponentUtils.fireComponentEvent(MouseSystem.getListName(),"onClick",[x,y,wich])};this.fireMouseDownListener=function(evt){var x=evt.offsetX||evt.layerX;var y=evt.offsetY||evt.layerY;var wich=evt.wich;ComponentUtils.fireComponentEvent(MouseSystem.getListName(),"onMouseDown",[x,y,wich])};this.fireMouseUpListener=function(evt){var x=evt.offsetX||evt.layerX;var y=evt.offsetY||evt.layerY;var wich=evt.wich;ComponentUtils.fireComponentEvent(MouseSystem.getListName(),"onMouseUp",[x,y,wich])};this.fireMouseMoveListener=function(evt){var x=evt.offsetX||evt.layerX;var y=evt.offsetY||evt.layerY;ComponentUtils.fireComponentEvent(MouseSystem.getListName(),"onMouseMove",[x,y])};this.getTag=function(){return"MOUSE_SYSTEM"};this.getListName=function(){return"listComponentsMouse"}};window.addEventListener("click",MouseSystem.fireClickListener);window.addEventListener("mousedown",MouseSystem.fireMouseDownListener);window.addEventListener("mouseup",MouseSystem.fireMouseUpListener);window.addEventListener("mousemove",MouseSystem.fireMouseMoveListener);var RenderSystem=new function(){this.clearCanvas=true;this.fireRenderListener=function(context){if(RenderSystem.clearCanvas==true){context.setTransform(1,0,0,1,0,0);context.clearRect(0,0,Game.canvas.width,Game.canvas.height)}context.save();if(Game.camera){context.translate(-Game.camera.centerPoint.x+Game.canvas.width/2,-Game.camera.centerPoint.y+Game.canvas.height/2);Game.camera.scale.onBeforeRender(context);Game.camera.translate.onBeforeRender(context);Game.camera.rotate.onBeforeRender(context)}if(Game.scene){for(var i in Game.scene[RenderSystem.getListName()]){var component=Game.scene[RenderSystem.getListName()][i];component.onBeforeRender(context)}for(var i in Game.scene[RenderSystem.getListName()]){var component=Game.scene[RenderSystem.getListName()][i];component.onRender(context)}for(var i=0;i<Game.scene.listLayers.length;i++){var layer=Game.scene.listLayers[i];for(var j in layer[RenderSystem.getListName()]){var component=layer[RenderSystem.getListName()][j];component.onBeforeRender(context)}for(var j in layer[RenderSystem.getListName()]){var component=layer[RenderSystem.getListName()][j];component.onRender(context)}for(var j=0;j<layer.listGameObjects.length;j++){var gameObject=layer.listGameObjects[j];context.save();for(var k in gameObject[RenderSystem.getListName()]){var component=gameObject[RenderSystem.getListName()][k];component.onBeforeRender(context)}for(var k in gameObject[RenderSystem.getListName()]){var component=gameObject[RenderSystem.getListName()][k];component.onRender(context)}context.restore()}}}context.restore();for(var i in Game[RenderSystem.getListName()]){var component=Game[RenderSystem.getListName()][i];component.onBeforeRender(context)}for(var i in Game[RenderSystem.getListName()]){var component=Game[RenderSystem.getListName()][i];component.onRender(context)}};this.getTag=function(){return"RENDER_SYSTEM"};this.getListName=function(){return"listComponentsRender"}};var KinectSystem=new function(){this.fireHandDownListener=function(x,y){var rect=Game.canvas.getBoundingClientRect();x=x-rect.left;y=y-rect.top;ComponentUtils.fireComponentEvent(KinectSystem.getListName(),"onMouseDown",[x,y,-1])};this.fireHandUpListener=function(x,y){var rect=Game.canvas.getBoundingClientRect();x=x-rect.left;y=y-rect.top;ComponentUtils.fireComponentEvent(KinectSystem.getListName(),"onMouseUp",[x,y,-1])};this.fireHandMoveListener=function(x,y){var rect=Game.canvas.getBoundingClientRect();x=x-rect.left;y=y-rect.top;ComponentUtils.fireComponentEvent(KinectSystem.getListName(),"onMouseMove",[x,y])};this.onLoadKinect=function(){var c=zig.controls.Cursor();var ce=document.createElement("div");ce.id="mycursor";document.body.appendChild(ce);zig.singleUserSession.addEventListener("sessionstart",function(focusPosition){ce.style.display="block"});zig.singleUserSession.addEventListener("sessionend",function(){ce.style.display="none"});c.addEventListener("move",function(cursor){ce.style.left=c.x*window.innerWidth-ce.offsetWidth/2+"px";ce.style.top=c.y*window.innerHeight-ce.offsetHeight/2+"px";var x=ce.style.left.replace("px","");var y=ce.style.top.replace("px","");KinectSystem.fireHandMoveListener(x,y)});c.addEventListener("push",function(c){ce.classList.add("pushed");var x=ce.style.left.replace("px","");var y=ce.style.top.replace("px","");KinectSystem.fireHandDownListener(x,y)});c.addEventListener("release",function(c){ce.classList.remove("pushed");var x=ce.style.left.replace("px","");var y=ce.style.top.replace("px","");KinectSystem.fireHandUpListener(x,y)});zig.singleUserSession.addListener(c)};this.getTag=function(){return"KINECT_SYSTEM"};this.getListName=function(){return"listComponentsKinect"}};document.addEventListener("DOMContentLoaded",KinectSystem.onLoadKinect,false);var GamepadSystem=new function(){this.TYPICAL_BUTTON_COUNT=16;this.TYPICAL_AXIS_COUNT=4;this.ticking=false;this.gamepads=[];this.prevRawGamepadTypes=[];this.prevTimestamps=[];this.ANALOGUE_BUTTON_THRESHOLD=.5;this.STICK_OFFSET=25;this.pressedButtons=new Array;this.init=function(){var gamepadSupportAvailable=!!navigator.webkitGetGamepads||!!navigator.webkitGamepads||navigator.userAgent.indexOf("Firefox/")!=-1;if(gamepadSupportAvailable){window.addEventListener("MozGamepadConnected",GamepadSystem.onGamepadConnect,false);window.addEventListener("MozGamepadDisconnected",GamepadSystem.onGamepadDisconnect,false);if(!!navigator.webkitGamepads||!!navigator.webkitGetGamepads){GamepadSystem.startPolling()}}};this.onGamepadConnect=function(event){GamepadSystem.gamepads.push(event.gamepad);GamepadSystem.startPolling()};this.onGamepadDisconnect=function(event){for(var i in GamepadSystem.gamepads){if(GamepadSystem.gamepads[i].index==event.gamepad.index){GamepadSystem.gamepads.splice(i,1);break}}if(GamepadSystem.gamepads.length==0){GamepadSystem.stopPolling()}};this.startPolling=function(){if(!GamepadSystem.ticking){GamepadSystem.ticking=true;GamepadSystem.tick()}};this.stopPolling=function(){GamepadSystem.ticking=false};this.tick=function(){GamepadSystem.pollStatus();GamepadSystem.scheduleNextTick()};this.scheduleNextTick=function(){if(GamepadSystem.ticking){if(window.requestAnimationFrame){window.requestAnimationFrame(GamepadSystem.tick)}else if(window.mozRequestAnimationFrame){window.mozRequestAnimationFrame(GamepadSystem.tick)}else if(window.webkitRequestAnimationFrame){window.webkitRequestAnimationFrame(GamepadSystem.tick)}}};this.pollStatus=function(){GamepadSystem.pollGamepads();for(var i in GamepadSystem.gamepads){var gamepad=GamepadSystem.gamepads[i];if(gamepad.timestamp&&gamepad.timestamp==GamepadSystem.prevTimestamps[i]){continue}GamepadSystem.prevTimestamps[i]=gamepad.timestamp;GamepadSystem.updateDisplay(i)}};this.pollGamepads=function(){var rawGamepads=navigator.webkitGetGamepads&&navigator.webkitGetGamepads()||navigator.webkitGamepads;if(rawGamepads){GamepadSystem.gamepads=[];var gamepadsChanged=false;for(var i=0;i<rawGamepads.length;i++){if(typeof rawGamepads[i]!=GamepadSystem.prevRawGamepadTypes[i]){gamepadsChanged=true;GamepadSystem.prevRawGamepadTypes[i]=typeof rawGamepads[i]}if(rawGamepads[i]){GamepadSystem.gamepads.push(rawGamepads[i])}}}};this.updateDisplay=function(gamepadId){var gamepad=GamepadSystem.gamepads[gamepadId];if(gamepad.buttons){GamepadSystem.updateButton(gamepad.buttons[0],gamepadId,"button-1");GamepadSystem.updateButton(gamepad.buttons[1],gamepadId,"button-2");GamepadSystem.updateButton(gamepad.buttons[2],gamepadId,"button-3");GamepadSystem.updateButton(gamepad.buttons[3],gamepadId,"button-4");GamepadSystem.updateButton(gamepad.buttons[4],gamepadId,"button-left-shoulder-top");GamepadSystem.updateButton(gamepad.buttons[6],gamepadId,"button-left-shoulder-bottom");GamepadSystem.updateButton(gamepad.buttons[5],gamepadId,"button-right-shoulder-top");GamepadSystem.updateButton(gamepad.buttons[7],gamepadId,"button-right-shoulder-bottom");GamepadSystem.updateButton(gamepad.buttons[8],gamepadId,"button-select");GamepadSystem.updateButton(gamepad.buttons[9],gamepadId,"button-start");GamepadSystem.updateButton(gamepad.buttons[10],gamepadId,"stick-1");GamepadSystem.updateButton(gamepad.buttons[11],gamepadId,"stick-2");GamepadSystem.updateButton(gamepad.buttons[12],gamepadId,"button-dpad-top");GamepadSystem.updateButton(gamepad.buttons[13],gamepadId,"button-dpad-bottom");GamepadSystem.updateButton(gamepad.buttons[14],gamepadId,"button-dpad-left");GamepadSystem.updateButton(gamepad.buttons[15],gamepadId,"button-dpad-right")}if(gamepad.axes){GamepadSystem.updateAxis(gamepad.axes[0],gamepadId,"stick-1-axis-x","stick-1",true);GamepadSystem.updateAxis(gamepad.axes[1],gamepadId,"stick-1-axis-y","stick-1",false);GamepadSystem.updateAxis(gamepad.axes[2],gamepadId,"stick-2-axis-x","stick-2",true);GamepadSystem.updateAxis(gamepad.axes[3],gamepadId,"stick-2-axis-y","stick-2",false)}};this.updateButton=function(value,gamepadId,id){if(value>GamepadSystem.ANALOGUE_BUTTON_THRESHOLD){GamepadSystem.fireButtonPressed(id);this.pressedButtons=ArrayUtils.addElement(this.pressedButtons,id)}else if(ArrayUtils.contains(this.pressedButtons,id)){this.pressedButtons=ArrayUtils.removeElement(this.pressedButtons,id);GamepadSystem.fireButtonReleased(id)}};this.updateAxis=function(value,gamepadId,labelId,stickId,horizontal){var offsetVal=value*GamepadSystem.STICK_OFFSET;if(horizontal){GamepadSystem.fireStickMoved(offsetVal,stickId,"HORIZONTAL")}else{GamepadSystem.fireStickMoved(offsetVal,stickId,"VERTICAL")}};this.fireStickMoved=function(value,stick,direction){ComponentUtils.fireComponentEvent(GamepadSystem.getListName(),"onStickMoved",[value,stick,direction])};this.fireButtonPressed=function(button){ComponentUtils.fireComponentEvent(GamepadSystem.getListName(),"onButtonPressed",[button])};this.fireButtonReleased=function(button){ComponentUtils.fireComponentEvent(GamepadSystem.getListName(),"onButtonReleased",[button])};this.getTag=function(){return"GAMEPAD_SYSTEM"};this.getListName=function(){return"listComponentsGamepad"}};GamepadSystem.init();var TouchSystem=new function(){this.fireTouchStartListener=function(evt){if(evt.target.nodeName=="CANVAS"){evt.preventDefault()}if(evt.changedTouches&&evt.changedTouches.length>0){ComponentUtils.fireComponentEvent(TouchSystem.getListName(),"onTouchStart",[evt.touches,evt.changedTouches])}};this.fireTouchMoveListener=function(evt){if(evt.target.nodeName=="CANVAS"){evt.preventDefault()}if(evt.changedTouches&&evt.changedTouches.length>0){ComponentUtils.fireComponentEvent(TouchSystem.getListName(),"onTouchMove",[evt.touches,evt.changedTouches])}};this.fireTouchEndListener=function(evt){if(evt.target.nodeName=="CANVAS"){evt.preventDefault()}if(evt.changedTouches&&evt.changedTouches.length>0){ComponentUtils.fireComponentEvent(TouchSystem.getListName(),"onTouchEnd",[evt.touches,evt.changedTouches])}};this.getTag=function(){return"TOUCH_SYSTEM"};this.getListName=function(){return"listComponentsTouch"}};window.addEventListener("touchstart",TouchSystem.fireTouchStartListener);window.addEventListener("touchmove",TouchSystem.fireTouchMoveListener);window.addEventListener("touchend",TouchSystem.fireTouchEndListener);